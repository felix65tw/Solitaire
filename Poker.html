<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¶“å…¸æ¥é¾</title>
    <style>
        /* CSS è®Šæ•¸å®šç¾©ï¼Œæ–¹ä¾¿å…¨åŸŸèª¿æ•´æ¨£å¼ */
        :root {
            --bg-color: #35654d; /* éŠæˆ²èƒŒæ™¯é¡è‰² */
            --card-width: 13vw; /* å¡ç‰‡é è¨­å¯¬åº¦ (è¦–çª—å¯¬åº¦ç™¾åˆ†æ¯”) 13 */
            --card-height: 20vw; /* å¡ç‰‡é è¨­é«˜åº¦ (è¦–çª—å¯¬åº¦ç™¾åˆ†æ¯”) 18.2 */
            --max-w: 100px; /* å¡ç‰‡æœ€å¤§å¯¬åº¦ */
            --max-h: 140px; /* å¡ç‰‡æœ€å¤§é«˜åº¦ */
            --gap: 2vw; /* å¡ç‰‡é–“è· */
            --animation-draw-speed: 0.2s; /* åƒæ•¸ï¼šç¿»ç‰Œå‹•ç•«é€Ÿåº¦ */
            --animation-move-speed: 0.15s; /* åƒæ•¸ï¼šå¡ç‰‡ç§»å‹•å‹•ç•«é€Ÿåº¦ */
            --animation-magic-speed: 0.5s; /* åƒæ•¸ï¼šé­”æ³•å‹•ç•«é€Ÿåº¦ */
            --animation-pulse-speed: 0.8s; /* åƒæ•¸ï¼šè„ˆè¡å‹•ç•«é€Ÿåº¦ */
            --animation-shake-speed: 0.4s; /* åƒæ•¸ï¼šæŠ–å‹•å‹•ç•«é€Ÿåº¦ */
            
            --animation-auto-fly-delay: 0.02s; /* åƒæ•¸ï¼šè‡ªå‹•é£›ç‰Œæ¯å¼µç‰Œä¹‹é–“çš„å»¶é² */
    				--animation-auto-fly-queue-delay: 0.01s; /* åƒæ•¸ï¼šè‡ªå‹•é£›ç‰ŒéšŠåˆ—è™•ç†å»¶é² */
    				--animation-auto-fly-initial-delay: 0.01s; /* åƒæ•¸ï¼šè‡ªå‹•é£›ç‰Œé–‹å§‹å»¶é² */
        }

        /* å…¨åŸŸæ¨£å¼è¨­å®š */
        body {
            background-color: var(--bg-color); /* ä½¿ç”¨CSSè®Šæ•¸è¨­å®šèƒŒæ™¯è‰² */
            margin: 0;
            overflow: hidden; /* éš±è—æ»¾å‹•æ¢ */
            user-select: none; /* ç¦æ­¢æ–‡å­—é¸å– */
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; /* å­—å‹è¨­å®š */
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç§»å‹•ç«¯é»æ“Šé«˜äº® */
            touch-action: manipulation; /* æ”¹å–„è§¸æ§éŸ¿æ‡‰ */
        }

        /* å·¥å…·æ¬„æ¨£å¼ */
        .toolbar {
            height: 50px; /* å·¥å…·æ¬„é«˜åº¦ */
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px; /* æ‰‹æ©Ÿä¸Šæ¸›å°‘padding */
            color: white;
            background: rgba(0,0,0,0.2); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
        }
        
        /* å·¥å…·æ¬„å·¦å´å€å¡Š */
        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 15px; /* å…ƒç´ é–“è· */
        }
        
        /* æ™‚é–“èˆ‡æ­¥æ•¸é¡¯ç¤º - ä¿®æ”¹ç‚ºå›ºå®šå¯¬åº¦ */
        .time-moves-display {
            font-size: 14px;
            font-weight: bold;
            color: white;
            padding: 2px 8px;
            background: rgba(0,0,0,0.3); /* åŠé€æ˜èƒŒæ™¯ */
            border-radius: 10px; /* åœ“è§’ */
            min-width: 120px; /* å›ºå®šå¯¬åº¦ï¼Œå®¹ç´4ä½æ•¸ */
            text-align: center;
            font-variant-numeric: tabular-nums; /* ç­‰å¯¬æ•¸å­— */
            cursor: pointer; /* æ·»åŠ æ‰‹å½¢æ¸¸æ¨™ï¼Œè¡¨ç¤ºå¯é»æ“Š */
            transition: transform 0.2s, background 0.2s; /* æ·»åŠ éæ¸¡æ•ˆæœ */
        }
        
        /* æ™‚é–“èˆ‡æ­¥æ•¸é¡¯ç¤ºé»æ“Šæ•ˆæœ */
        .time-moves-display:active {
            transform: scale(0.95); /* é»æ“Šæ™‚ç¸®å° */
        }
        
        /* åˆ†æ•¸é¡¯ç¤º - ä¿®æ”¹ç‚ºå›ºå®šå¯¬åº¦ */
        .score-display {
            font-size: 14px;
            font-weight: bold;
            color: #FFD700; /* é‡‘è‰²æ–‡å­— */
            padding: 2px 8px;
            background: rgba(0,0,0,0.3); /* åŠé€æ˜èƒŒæ™¯ */
            border-radius: 10px; /* åœ“è§’ */
            min-width: 140px; /* å¢åŠ å¯¬åº¦ä»¥å®¹ç´é­”æ³•æ¬¡æ•¸ */
            text-align: center;
            font-variant-numeric: tabular-nums; /* ç­‰å¯¬æ•¸å­— */
            cursor: pointer; /* æ·»åŠ æ‰‹å½¢æ¸¸æ¨™ï¼Œè¡¨ç¤ºå¯é»æ“Š */
            transition: transform 0.2s, background 0.2s; /* æ·»åŠ éæ¸¡æ•ˆæœ */
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }
        
        /* åˆ†æ•¸é¡¯ç¤ºé»æ“Šæ•ˆæœ */
        .score-display:active {
            transform: scale(0.95); /* é»æ“Šæ™‚ç¸®å° */
        }
        
        /* é­”æ³•æ¬¡æ•¸é¡¯ç¤º */
        .magic-count {
            color: #00FFFF; /* é’è‰² */
            font-weight: bold;
            margin-left: 5px;
        }
        
        /* è¨­å®šæŒ‰éˆ•æ¨£å¼ */
        #settings-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 2px solid rgba(255,255,255,0.5);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        #settings-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
        }
        
        /* å·¥å…·æ¬„æŒ‰éˆ•å€å¡Š - ç¾åŒ–ç‰ˆ */
        .toolbar-buttons {
            display: flex;
            gap: 10px; /* å¢åŠ é–“è·ä½¿æŒ‰éˆ•æ›´æ˜é¡¯ */
        }
        
        /* æŒ‰éˆ•åŸºç¤æ¨£å¼ - ç¾åŒ–ç‰ˆ */
        .toolbar-buttons button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 25px; /* å¢åŠ åœ“è§’ */
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); /* æ·»åŠ é™°å½± */
            transition: all 0.3s ease;
            min-width: 80px; /* è¨­ç½®æœ€å°å¯¬åº¦ */
            text-align: center;
        }
        
        /* æŒ‰éˆ•æ‡¸åœæ•ˆæœ - ç¾åŒ–ç‰ˆ */
        .toolbar-buttons button:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.25);
        }
        
        /* æŒ‰éˆ•æŒ‰ä¸‹æ•ˆæœ - ç¾åŒ–ç‰ˆ */
        .toolbar-buttons button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* é­”æ³•æŒ‰éˆ•ç‰¹æ®Šæ¨£å¼ - ä¿®æ”¹ç‚ºèˆ‡æ‰‹æ©Ÿç‰ˆç›¸åŒçš„ä¸ƒå½©é¡è‰² */
        #magic-btn {
            background: linear-gradient(135deg, 
                #FF0000 0%, 
                #FF9900 15%, 
                #FFFF00 30%, 
                #00FF00 45%, 
                #0000FF 60%,  /* è—è‰²èª¿æ•´åˆ°ä¸­é–“ä½ç½® */
                #00FFFF 75%, 
                #FF00FF 90%, 
                #FF0000 100%);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.8);
            background-size: 200% 200%;
            animation: rainbowBackground 3s infinite linear;
        }
        
        @keyframes rainbowBackground {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        #magic-btn:hover {
            background: linear-gradient(135deg, 
                #FF0000 0%, 
                #FF9900 15%, 
                #FFFF00 30%, 
                #00FF00 45%, 
                #0000FF 60%, 
                #00FFFF 75%, 
                #FF00FF 90%, 
                #FF0000 100%);
            background-size: 200% 200%;
            animation: rainbowBackground 3s infinite linear;
            box-shadow: 0 6px 20px rgba(0, 0, 255, 0.4);
        }
        
        #magic-btn:disabled {
            background: linear-gradient(135deg, #cccccc 0%, #999999 100%);
            color: #666;
            border: 2px solid #999;
            box-shadow: none;
            transform: none;
            animation: none;
        }
        

        
        /* ç¦ç”¨æŒ‰éˆ•æ¨£å¼ */
        .toolbar-buttons button:disabled {
            background: linear-gradient(135deg, #cccccc 0%, #999999 100%);
            color: #666;
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
        }
        
        /* è¨Šæ¯æç¤ºæ¡† */
        #message {
            position: fixed; /* å›ºå®šå®šä½ */
            top: 60px;
            left: 50%;
            transform: translateX(-50%); /* æ°´å¹³å±…ä¸­ */
            background: rgba(0,0,0,0.8); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
            color: white;
            padding: 10px 20px;
            border-radius: 5px; /* åœ“è§’ */
            z-index: 10000; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
            display: none; /* é è¨­éš±è— */
            font-size: 14px;
            max-width: 90%; /* æœ€å¤§å¯¬åº¦ */
            text-align: center; /* æ–‡å­—å±…ä¸­ */
        }

        /* éŠæˆ²ä¸»å€åŸŸ */
        #game-board {
            position: relative; /* ç›¸å°å®šä½ */
            width: 100vw; /* å…¨è¦–çª—å¯¬åº¦ */
            height: calc(100vh - 50px); /* æ¸›å»å·¥å…·æ¬„é«˜åº¦ */
            max-width: 800px; /* æœ€å¤§å¯¬åº¦é™åˆ¶ */
            margin: 0 auto; /* æ°´å¹³å±…ä¸­ */
            margin-top: 5px; /* æ‰‹æ©Ÿä¸Šæ¸›å°‘ä¸Šé‚Šè· */
            overflow: hidden; /* é˜²æ­¢æº¢å‡º */
        }

        /* å¡ç‰‡ä½ç½®æ§½ä½ */
        .slot {
            position: absolute; /* çµ•å°å®šä½ */
            width: var(--card-width); /* ä½¿ç”¨CSSè®Šæ•¸è¨­å®šå¯¬åº¦ */
            height: var(--card-height); /* ä½¿ç”¨CSSè®Šæ•¸è¨­å®šé«˜åº¦ */
            max-width: var(--max-w); /* æœ€å¤§å¯¬åº¦é™åˆ¶ */
            max-height: var(--max-h); /* æœ€å¤§é«˜åº¦é™åˆ¶ */
            border: 2px solid rgba(255,255,255,0.2); /* åŠé€æ˜é‚Šæ¡† */
            border-radius: 8px; /* åœ“è§’ */
            box-sizing: border-box; /* ç›’æ¨¡å‹è¨­å®š */
        }

        /* å¡ç‰‡åŸºç¤æ¨£å¼ */
        .card {
            position: absolute; /* çµ•å°å®šä½ */
            width: var(--card-width); /* ä½¿ç”¨CSSè®Šæ•¸è¨­å®šå¯¬åº¦ */
            height: var(--card-height); /* ä½¿ç”¨CSSè®Šæ•¸è¨­å®šé«˜åº¦ */
            max-width: var(--max-w); /* æœ€å¤§å¯¬åº¦é™åˆ¶ */
            max-height: var(--max-h); /* å¡ç‰‡æœ€å¤§é«˜åº¦é™åˆ¶ */
            background-color: white; /* ç™½è‰²èƒŒæ™¯ */
            border-radius: 6px; /* åœ“è§’ */
            box-shadow: 1px 1px 3px rgba(0,0,0,0.4); /* é™°å½±æ•ˆæœ */
            display: flex;
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            z-index: 10; /* åœ–å±¤é †åº */
            cursor: pointer; /* æ¸¸æ¨™æ‰‹å½¢ */
            box-sizing: border-box; /* ç›’æ¨¡å‹è¨­å®š */
            transition: box-shadow 0.2s; /* é™°å½±éæ¸¡æ•ˆæœ */
            -webkit-user-drag: none; /* é˜²æ­¢æ‹–æ›³åœ–ç‰‡ */
        }

        /* ç”¨æ–¼è‡ªå‹•ç§»å‹•æ™‚çš„é£›è¡Œå¡ç‰‡ */
        .flying-card {
            position: fixed; /* å›ºå®šå®šä½ */
            z-index: 99999; /* æœ€é«˜åœ–å±¤ */
            pointer-events: none; /* ç¦æ­¢è§¸ç™¼äº‹ä»¶ */
            transition: all var(--animation-move-speed) ease-in-out; /* åƒæ•¸ï¼šä½¿ç”¨å¡ç‰‡ç§»å‹•å‹•ç•«é€Ÿåº¦ */
        }

        /* å¡ç‰‡é¢ */
        .card-face {
            width: 100%;
            height: 100%;
            position: relative; /* ç›¸å°å®šä½ */
            pointer-events: none; /* ç¦æ­¢è§¸ç™¼äº‹ä»¶ */
        }

        /* å·¦ä¸Šè§’æ•¸å­— */
        .card-num { 
            font-size: 1.8rem; 
            font-weight: 800; 
            line-height: 1;
            position: absolute;
            top: 4px; /* æ¸›å°‘ä¸Šé‚Šè· */
            left: 4px; /* æ¸›å°‘å·¦é‚Šè· */
        }
        
        /* å³ä¸Šè§’èŠ±è‰² */
        .card-suit-top { 
            font-size: 1.8rem; 
            line-height: 1; 
            position: absolute;
            top: 4px; /* æ¸›å°‘ä¸Šé‚Šè· */
            right: 4px; /* æ¸›å°‘å³é‚Šè· */
        }
        
        /* å¡ç‰‡ä¸­é–“çš„å¤§èŠ±è‰² */
        .card-center-suit {
            position: absolute;
            top: 62%; /* åŸæœ¬æ˜¯ 50%ï¼Œæ”¹æˆ 62% å¾€ä¸‹ç§» */
            left: 50%;
            transform: translate(-50%, -50%); /* å±…ä¸­å°é½Š */
            font-size: 4rem;
            font-weight: normal;
        }
        
        /* ç´…è‰²èŠ±è‰² */
        .red { color: #d32f2f; }
        /* é»‘è‰²èŠ±è‰² */
        .black { color: #212121; }

        /* å¡ç‰‡èƒŒé¢æ¨£å¼ */
        .back {
            background: repeating-linear-gradient( /* é‡è¤‡ç·šæ€§æ¼¸è®Š */
                45deg, /* 45åº¦è§’ */
                #1565c0, /* é¡è‰²1 */
                #1565c0 10px, /* é¡è‰²1çµæŸä½ç½® */
                #0d47a1 10px, /* é¡è‰²2é–‹å§‹ä½ç½® */
                #0d47a1 20px /* é¡è‰²2çµæŸä½ç½® */
            );
            border: 2px solid #fff; /* ç™½è‰²é‚Šæ¡† */
        }
        
        /* ç‰Œå †å¡ç‰‡ä¸Šçš„å‰©é¤˜æ•¸é‡é¡¯ç¤º */
        .card-count {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            z-index: 2;
            transition: opacity 0.3s;
        }
        
        /* éš±è—ç‰Œå †æ•¸å­—é¡¯ç¤º */
        .card-count.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* æ‹–æ›³ä¸­çš„å¡ç‰‡ */
        .dragging-card {
            position: fixed; /* å›ºå®šå®šä½ */
            z-index: 9999; /* é«˜åœ–å±¤ */
            pointer-events: none; /* ç¦æ­¢è§¸ç™¼äº‹ä»¶ */
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5); /* æ›´æ˜é¡¯çš„é™°å½± */
            opacity: 0.9; /* åŠé€æ˜ */
        }

        /* é‡æ–°æ•´ç†æŒ‰éˆ• */
        .refresh-btn {
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            font-size: 2rem; color: rgba(255,255,255,0.5);
            cursor: pointer;
        }

        /* é«˜å…‰æ•ˆæœï¼šå¢åŠ  pointer-events: none é˜²æ­¢æ“‹ä½é»æ“Š */
        .highlight {
            animation: yellowPulse var(--animation-pulse-speed) infinite alternate; /* åƒæ•¸ï¼šä½¿ç”¨è„ˆè¡å‹•ç•«é€Ÿåº¦ */
            box-shadow: 0 0 0 4px #FFEB3B, 0 0 20px 8px #FFEB3B !important;
            border: 2px solid #FFEB3B !important;
            z-index: 1000;
            pointer-events: none; /* é—œéµä¿®å¾©ï¼šè®“é»æ“Šç©¿é€é«˜å…‰æ¡† */
        }

        /* ç›®æ¨™é«˜å…‰æ•ˆæœ */
        .target-highlight {
            animation: targetPulse var(--animation-pulse-speed) infinite alternate; /* åƒæ•¸ï¼šä½¿ç”¨è„ˆè¡å‹•ç•«é€Ÿåº¦ */
            box-shadow: 0 0 0 4px #4CAF50, 0 0 20px 8px #4CAF50 !important;
            border: 2px solid #4CAF50 !important;
            z-index: 999;
            pointer-events: none; /* é—œéµä¿®å¾© */
        }

        /* é»ƒè‰²è„ˆè¡å‹•ç•« */
        @keyframes yellowPulse {
            0% { box-shadow: 0 0 0 4px #FFEB3B, 0 0 20px 8px #FFEB3B !important; transform: scale(1.02); }
            100% { box-shadow: 0 0 0 6px #FFEB3B, 0 0 30px 12px #FFEB3B !important; transform: scale(1.05); }
        }

        /* ç¶ è‰²è„ˆè¡å‹•ç•« */
        @keyframes targetPulse {
            0% { box-shadow: 0 0 0 4px #4CAF50, 0 0 20px 8px #4CAF50 !important; transform: scale(1.02); }
            100% { box-shadow: 0 0 0 6px #4CAF50, 0 0 30px 12px #4CAF50 !important; transform: scale(1.05); }
        }

        /* é‡‘å…‰é–ƒé–ƒå‹•ç•« - é­”æ³•æŒ‰éˆ•å°ˆç”¨ (åŠ å¼·ç‰ˆ) */
        .golden-glow {
            animation: goldenPulse 0.5s infinite alternate;
            box-shadow: 
                0 0 30px #FFD700, 
                0 0 60px #FFD700, 
                0 0 90px #FFD700,
                0 0 120px #FFD700,
                0 0 150px #FFD700 !important;
            border: 4px solid #FFD700 !important;
            z-index: 99999;
            filter: brightness(1.5);
        }

        @keyframes goldenPulse {
            0% { 
                box-shadow: 
                    0 0 20px #FFD700, 
                    0 0 40px #FFD700, 
                    0 0 60px #FFD700,
                    0 0 80px #FFD700 !important; 
                transform: scale(1.05);
                filter: brightness(1.2);
            }
            100% { 
                box-shadow: 
                    0 0 40px #FFD700, 
                    0 0 80px #FFD700, 
                    0 0 120px #FFD700,
                    0 0 160px #FFD700 !important; 
                transform: scale(1.15);
                filter: brightness(1.8);
            }
        }

        /* æŠ–å‹•å‹•ç•« */
        .shake {
            animation: shake var(--animation-shake-speed) ease-in-out; /* åƒæ•¸ï¼šä½¿ç”¨æŠ–å‹•å‹•ç•«é€Ÿåº¦ */
        }

        /* æŠ–å‹•å‹•ç•«é—œéµå½±æ ¼ */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            16% { transform: translateX(-6px); }
            33% { transform: translateX(6px); }
            50% { transform: translateX(-6px); }
            66% { transform: translateX(6px); }
            83% { transform: translateX(-6px); }
        }

        /* ç¿»ç‰Œå‹•ç•«å¡ç‰‡ */
        .draw-animation-card {
            position: fixed;
            z-index: 99998;
            pointer-events: none;
            transition: all var(--animation-draw-speed) ease-in-out; /* åƒæ•¸ï¼šä½¿ç”¨ç¿»ç‰Œå‹•ç•«é€Ÿåº¦ */
            transform-origin: center;
            background-color: white !important; /* ç¢ºä¿å‹•ç•«å¡ç‰‡èƒŒæ™¯ç‚ºç™½è‰² */
        }
        
        /* é­”æ³•å‹•ç•«å¡ç‰‡ */
        .magic-animation-card {
            position: fixed;
            z-index: 99997;
            pointer-events: none;
            transition: all var(--animation-magic-speed) ease-in-out; /* åƒæ•¸ï¼šä½¿ç”¨é­”æ³•å‹•ç•«é€Ÿåº¦ */
            transform-origin: center;
            background-color: white !important;
            border: 2px solid #667eea;
            box-shadow: 0 0 20px #667eea !important;
        }
        
        /* æ‰‹æ©Ÿç‰ˆåŠŸèƒ½éµå®¹å™¨ - ç¾åŒ–ç‰ˆ - ä¿®æ­£ï¼šå±…ä¸­å°é½Š */
        .mobile-toolbar-container {
            display: none;
            position: fixed; /* æ”¹ç‚ºå›ºå®šå®šä½ */
            bottom: 80px; /* èª¿æ•´ä½ç½®åˆ°é é¢åº•éƒ¨ */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0, 0, 0, 0.6); /* æ”¹ç‚ºæ·±è‰²åŠé€æ˜èƒŒæ™¯ */
            border-radius: 20px; /* åœ“è§’ */
            padding: 10px 12px; /* èª¿æ•´å…§é‚Šè· */
            box-shadow: 0 10px 30px rgba(0,0,0,0.4); /* é™°å½±æ•ˆæœ */
            flex-direction: row; /* æ©«å‘æ’åˆ— */
            gap: 6px; /* æŒ‰éˆ•é–“è· */
            flex-wrap: nowrap; /* é˜²æ­¢æ›è¡Œ */
            justify-content: center;
            align-items: center;
            min-width: 280px; /* æœ€å°å¯¬åº¦ */
            max-width: 90vw; /* ç¢ºä¿ä¸è¶…å‡ºè¢å¹•å¯¬åº¦ */
            backdrop-filter: blur(15px); /* æ¯›ç»ç’ƒæ•ˆæœ */
            border: 1px solid rgba(255, 255, 255, 0.3); /* é‚Šæ¡† */
            box-sizing: border-box; /* åŒ…å«å…§é‚Šè·å’Œé‚Šæ¡†åœ¨å¯¬åº¦å…§ */
        }
        
        /* æ‰‹æ©Ÿç‰ˆåŠŸèƒ½æŒ‰éˆ•ç¾åŒ– */
        .mobile-toolbar-container button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* æ¼¸è®ŠèƒŒæ™¯ */
            color: white;
            border: none;
            border-radius: 15px; /* åœ“è§’ */
            padding: 8px 10px; /* èª¿æ•´å…§é‚Šè· */
            font-weight: bold;
            font-size: 13px; /* å­—é«”å¤§å° */
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* é™°å½±æ•ˆæœ */
            transition: all 0.3s ease;
            min-width: 55px; /* æœ€å°å¯¬åº¦ */
            white-space: nowrap;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            flex: 1; /* ç­‰å¯¬æŒ‰éˆ• */
        }
        
        /* æ‰‹æ©Ÿç‰ˆé­”æ³•æŒ‰éˆ•ä¸ƒå½©é¡è‰² - èª¿æ•´ç‚ºè—è‰²æ”¾ä¸­é–“ */
        .mobile-toolbar-container #mobile-magic-btn {
            background: linear-gradient(135deg, 
                #FF0000 0%, 
                #FF9900 15%, 
                #FFFF00 30%, 
                #00FF00 45%, 
                #0000FF 60%,  /* è—è‰²èª¿æ•´åˆ°ä¸­é–“ä½ç½® */
                #00FFFF 75%, 
                #FF00FF 90%, 
                #FF0000 100%);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.8);
            background-size: 200% 200%;
            animation: rainbowBackground 3s infinite linear;
        }
        

        
        @keyframes rainbowBackground {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* æ‰‹æ©ŸæŒ‰éˆ•æ‡¸åœæ•ˆæœ */
        .mobile-toolbar-container button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
        }
        
        /* æ‰‹æ©ŸæŒ‰éˆ•æŒ‰ä¸‹æ•ˆæœ */
        .mobile-toolbar-container button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        /* æ‰‹æ©Ÿç¦ç”¨æŒ‰éˆ•æ¨£å¼ */
        .mobile-toolbar-container button:disabled {
            background: linear-gradient(135deg, #cccccc 0%, #999999 100%);
            color: #666;
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
        }
        
        /* æ–°ç‰Œå±€å°è©±æ¡†æ¨£å¼ */
        .new-game-dialog {
            display: none;
            position: fixed;
            top: 25%; /* å‘ä¸Šèª¿æ•´å››åˆ†ä¹‹ä¸€çš„è·é›¢ */
            left: 50%;
            transform: translate(-50%, -25%); /* å°æ‡‰èª¿æ•´ */
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 100000;
            min-width: 250px;
            text-align: center;
        }
        
        .new-game-dialog h3 {
            margin-top: 0;
            color: #35654d;
            font-size: 18px;
        }
        
        .new-game-dialog button {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .new-game-dialog .new-game-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
        }
        
        .new-game-dialog .restart-game-btn {
            background: linear-gradient(135deg, #2196F3 0%, #0D47A1 100%);
            color: white;
        }
        
        .new-game-dialog .cancel-btn {
            background: #f5f5f5;
            color: #333;
        }
        
        .new-game-dialog .new-game-btn:hover {
            background: linear-gradient(135deg, #2E7D32 0%, #4CAF50 100%);
        }
        
        .new-game-dialog .restart-game-btn:hover {
            background: linear-gradient(135deg, #0D47A1 0%, #2196F3 100%);
        }
        
        .new-game-dialog .cancel-btn:hover {
            background: #e0e0e0;
        }
        
        /* è¨­å®šå°è©±æ¡†æ¨£å¼ */
        .settings-dialog {
            display: none;
            position: fixed;
            top: 25%; /* å‘ä¸Šèª¿æ•´å››åˆ†ä¹‹ä¸€çš„è·é›¢ */
            left: 50%;
            transform: translate(-50%, -25%); /* å°æ‡‰èª¿æ•´ */
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            z-index: 100001;
            min-width: 280px;
            max-width: 90%;
            text-align: center;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        
        .settings-dialog h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #35654d;
            font-size: 20px;
            font-weight: 700;
        }
        
        .settings-dialog .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .settings-dialog .setting-item:last-child {
            border-bottom: none;
        }
        
        .settings-dialog .setting-label {
            font-size: 16px;
            color: #333;
            font-weight: 600;
            text-align: left;
            flex: 1;
        }
        
        .settings-dialog .setting-value {
            font-size: 14px;
            color: #666;
        }
        
        /* é–‹é—œæ¨£å¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        /* æ¨¡å¼åˆ‡æ›æŒ‰éˆ• */
        .mode-options {
            display: flex;
            gap: 8px;
        }
        
        .mode-option {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #ddd;
            background: #f8f8f8;
            color: #666;
        }
        
        .mode-option.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        /* è¨­å®šæŒ‰éˆ•å®¹å™¨ */
        .settings-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .settings-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .settings-buttons .cancel-btn {
            background: #f5f5f5;
            color: #333;
            width: 100%;
        }
        
        .settings-buttons .cancel-btn:hover {
            background: #e0e0e0;
        }
        
        /* å°è©±æ¡†é®ç½© */
        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 99999;
        }
        
        /* ==================== å‹åˆ©ç•«é¢æ¨£å¼ ==================== */
        .victory-dialog {
            display: none;
            position: fixed;
            top: 25%; /* å‘ä¸Šèª¿æ•´å››åˆ†ä¹‹ä¸€çš„è·é›¢ */
            left: 50%;
            transform: translate(-50%, -25%); /* å°æ‡‰èª¿æ•´ */
            background: rgba(0, 0, 0, 0.85);
            border-radius: 20px;
            padding: 30px;
            z-index: 100002;
            min-width: 300px;
            max-width: 90%;
            text-align: center;
            color: white;
            backdrop-filter: blur(10px);
            border: 2px solid transparent;
            animation: neonBorder 2s infinite alternate;
            overflow: hidden;
        }
        
        /* éœ“è™¹ç‡ˆé‚Šæ¡†å‹•ç•« */
        @keyframes neonBorder {
            0% {
                box-shadow: 0 0 10px #ff00ff, 0 0 20px #ff00ff, 0 0 30px #ff00ff, 0 0 40px #ff00ff, 0 0 50px #ff00ff;
                border-color: #ff00ff;
            }
            25% {
                box-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff, 0 0 30px #00ffff, 0 0 40px #00ffff, 0 0 50px #00ffff;
                border-color: #00ffff;
            }
            50% {
                box-shadow: 0 0 10px #ffff00, 0 0 20px #ffff00, 0 0 30px #ffff00, 0 0 40px #ffff00, 0 0 50px #ffff00;
                border-color: #ffff00;
            }
            75% {
                box-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00, 0 0 30px #00ff00, 0 0 40px #00ff00, 0 0 50px #00ff00;
                border-color: #00ff00;
            }
            100% {
                box-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000, 0 0 30px #ff0000, 0 0 40px #ff0000, 0 0 50px #ff0000;
                border-color: #ff0000;
            }
        }
        
        .victory-dialog h2 {
            font-size: 2.5rem;
            margin-top: 0;
            margin-bottom: 20px;
            color: #FFD700;
            text-shadow: 0 0 10px #FFD700;
            animation: pulse 1.5s infinite alternate;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }
        
        .victory-stats {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }
        
        .victory-stat {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 1.2rem;
        }
        
        .victory-stat-label {
            color: #aaa;
        }
        
        .victory-stat-value {
            color: #fff;
            font-weight: bold;
        }
        
        .victory-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .victory-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .victory-new-game-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            width: 100%; /* æ”¹ç‚ºæ»¿å¯¬åº¦ */
        }
        
        /* ç§»é™¤ç¹¼çºŒæ…¶ç¥æŒ‰éˆ• */
        .victory-close-btn {
            display: none; /* éš±è—ç¹¼çºŒæ…¶ç¥æŒ‰éˆ• */
        }
        
        .victory-buttons button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        /* ç…™èŠ±Canvas */
        #fireworks-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100005;
            display: none;
        }
                /* æ¡Œé¢ç‰ˆæ¨£å¼ - ç¶­æŒåŸå§‹æ–‡å­—å’ŒèŠ±è‰²å¤§å° */
        @media (min-width: 600px) {
            :root {
                --card-width: 80px; /* æ¡Œé¢ç‰ˆå›ºå®šå¯¬åº¦ */
                --card-height: 112px; /* æ¡Œé¢ç‰ˆå›ºå®šé«˜åº¦ */
                --gap: 15px; /* æ¡Œé¢ç‰ˆå›ºå®šé–“è· */
            }
            
            /* æ¡Œé¢ç‰ˆä¿æŒåŸå§‹å¤§å° */
            .card-num, .card-suit-top { font-size: 1.8rem; }
            .card-center-suit { font-size: 4rem; }
            
            /* æ¡Œé¢ç‰ˆæ•¸å­—10ä¿æŒæ­£å¸¸ */
            .card[data-text="10"] .card-num {
                font-size: 1.8rem !important;
                transform: none !important;
                left: 4px !important;
            }
            
            .toolbar {
                padding: 0 20px; /* æ¡Œé¢ç‰ˆå¢åŠ padding */
            }
            
            .time-moves-display {
                font-size: 16px; /* æ¡Œé¢ç‰ˆå­—é«”ç¨å¤§ */
                padding: 4px 12px; /* æ¡Œé¢ç‰ˆpaddingç¨å¤§ */
            }
            
            .toolbar-buttons {
                gap: 12px; /* æ¡Œé¢ç‰ˆæŒ‰éˆ•é–“è·ç¨å¤§ */
            }
            
            /* æ¡Œé¢ç‰ˆæŒ‰éˆ•ç¾åŒ– */
            .toolbar-buttons button {
                padding: 10px 20px; /* æ¡Œé¢ç‰ˆæŒ‰éˆ•ç¨å¤§ */
                font-size: 15px; /* æ¡Œé¢ç‰ˆå­—é«”ç¨å¤§ */
                min-width: 90px; /* å¢åŠ æœ€å°å¯¬åº¦ */
                border-radius: 30px; /* å¢åŠ åœ“è§’ */
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                font-weight: 700;
            }
            
            .toolbar-buttons button:hover {
                box-shadow: 0 7px 20px rgba(0,0,0,0.25);
                transform: translateY(-3px);
            }
            
            .toolbar-buttons button:active {
                transform: translateY(1px);
                box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            }
            
            .score-display {
                font-size: 16px; /* æ¡Œé¢ç‰ˆå­—é«”ç¨å¤§ */
                padding: 4px 12px; /* æ¡Œé¢ç‰ˆpaddingç¨å¤§ */
                min-width: 160px; /* å¢åŠ å¯¬åº¦ä»¥å®¹ç´é­”æ³•æ¬¡æ•¸ */
            }
            
            .settings-dialog {
                min-width: 350px;
                padding: 30px;
            }
            
            .settings-dialog h3 {
                font-size: 22px;
            }
            
            .new-game-dialog {
                min-width: 300px;
                padding: 25px;
            }
            
            .new-game-dialog h3 {
                font-size: 20px;
            }
            
            /* å‹åˆ©ç•«é¢æ¡Œé¢ç‰ˆæ¨£å¼ */
            .victory-dialog {
                min-width: 400px;
                padding: 40px;
            }
            
            .victory-dialog h2 {
                font-size: 3rem;
            }
        }

        /* æ‰‹æ©Ÿç‰ˆå°ˆç”¨æ¨£å¼ - å·²èª¿æ•´ */
        @media (max-width: 599px) {
            :root {
                --card-width: 12.5vw; /* å¡ç‰‡å¯¬åº¦ (å¾11vwå¢åŠ ) */
                --card-height: 17.5vw; /* å¡ç‰‡é«˜åº¦ (å¾15.4vwå¢åŠ ) */
                --gap: 1vw; /* ç¸®å°ç‰Œé–“è· (å¾1.5vwæ¸›å°‘) */
            }
            
            /* é¡¯ç¤ºæ‰‹æ©Ÿç‰ˆåŠŸèƒ½éµå®¹å™¨ */
            .mobile-toolbar-container {
                display: flex;
            }
            
            /* éš±è—æ¡Œé¢ç‰ˆå·¥å…·æ¬„æŒ‰éˆ• */
            .toolbar-buttons {
                display: none;
            }
            
            /* éš±è—æ‰‹æ©Ÿç‰ˆä¸Šæ–¹çš„è¨­å®šæŒ‰éµ */
            #settings-btn {
                display: none !important;
            }
            
            /* æ‰‹æ©Ÿä¸Šå¡ç‰‡å­—é«”èª¿æ•´ */
            .card-num { 
                font-size: 2.5rem; /* èª¿æ•´ç‚º2.5rem (å¾3remæ¸›å°‘) */
                font-weight: 800;
                position: absolute;
                top: 0.1px;
                left: 1.3px;
                line-height: 0.8;
            }
            
            /* ç‰¹æ®Šè™•ç†æ•¸å­—"10" - åªåœ¨æ‰‹æ©Ÿç‰ˆç¸®å°å¯¬åº¦ä¸ç¸®å°é«˜åº¦ */
            .card[data-text="10"] .card-num {
                font-size: 2.5rem; /* èª¿æ•´å­—é«”å¤§å° */
                transform: scaleX(0.75); /* å£“ç¸®å¯¬åº¦ç‚º80% */
                transform-origin: left top; /* å¾å·¦ä¸Šè§’é–‹å§‹ç¸®æ”¾ */
                left: 0.8px; /* èª¿æ•´ä½ç½® */
            }
            
            .card-suit-top {
                font-size: 0.8rem;
                position: absolute;
                top: 6px;
                right: 2px;
                line-height: 1;
            }
            
            /* æ‰‹æ©Ÿä¸Šä¸­é–“èŠ±è‰²èª¿æ•´ */
            .card-center-suit { 
                font-size: 2.2rem; /* å¾2.2remå¢åŠ åˆ°2.5rem */
                position: absolute;
                top: 25px;
                left: 50%;
                transform: translateX(-50%);
                font-weight: normal;
            }
            
            /* æ‰‹æ©Ÿä¸Šå·¥å…·æ¬„èª¿æ•´ */
            .toolbar {
                height: 45px; /* æ‰‹æ©Ÿç‰ˆå·¥å…·æ¬„ç¨çŸ® */
                padding: 0 8px; /* æ‰‹æ©Ÿç‰ˆpaddingç¨å° */
            }
            
            .toolbar-left {
                gap: 8px; /* æ‰‹æ©Ÿç‰ˆå·¥å…·æ¬„å·¦å´é–“è·ç¨å° */
            }
            
            .time-moves-display {
                font-size: 11px; /* æ‰‹æ©Ÿç‰ˆå­—é«”ç¨å° */
                padding: 2px 6px; /* æ‰‹æ©Ÿç‰ˆpaddingç¨å° */
                min-width: 100px; /* å›ºå®šå¯¬åº¦ï¼Œå®¹ç´4ä½æ•¸ */
            }
            
            .score-display {
                font-size: 11px; /* æ‰‹æ©Ÿç‰ˆå­—é«”ç¨å° */
                padding: 2px 6px; /* æ‰‹æ©Ÿç‰ˆpaddingç¨å° */
                min-width: 120px; /* å¢åŠ å¯¬åº¦ä»¥å®¹ç´é­”æ³•æ¬¡æ•¸ */
            }
            
            #game-board {
                height: calc(100vh - 45px); /* æ¸›å»å·¥å…·æ¬„é«˜åº¦ */
                margin-top: 3px; /* æ‰‹æ©Ÿç‰ˆä¸Šé‚Šè·ç¨å° */
            }
            
            /* æ‰‹æ©Ÿä¸Šè¨Šæ¯æ¡†èª¿æ•´ */
            #message {
                font-size: 12px; /* æ‰‹æ©Ÿç‰ˆå­—é«”ç¨å° */
                padding: 8px 15px; /* æ‰‹æ©Ÿç‰ˆpaddingç¨å° */
                top: 50px; /* èª¿æ•´ä½ç½® */
                max-width: 95%; /* æœ€å¤§å¯¬åº¦é™åˆ¶ */
            }
            
            /* æ‰‹æ©Ÿç‰ˆè“‹ç‰Œä¸Šçš„æ•¸å­—é¡¯ç¤ºèª¿æ•´ */
            .card-count {
                font-size: 2.0rem; /* èª¿æ•´è“‹ç‰Œæ•¸å­—å¤§å° (å¾2.5remèª¿æ•´) */
            }
            
            /* è¨­å®šå°è©±æ¡†èª¿æ•´ - å¢å¤§æ–‡å­— */
            .settings-dialog {
                padding: 25px;
                min-width: 280px;
            }
            
            .settings-dialog h3 {
                font-size: 22px; /* å¢å¤§æ¨™é¡Œå­—é«” */
                margin-bottom: 20px;
            }
            
            .settings-dialog .setting-label {
                font-size: 16px; /* å¢å¤§è¨­å®šé …ç›®æ¨™ç±¤å­—é«” */
            }
            
            .settings-dialog .setting-value {
                font-size: 16px; /* å¢å¤§è¨­å®šæ•¸å€¼å­—é«” */
            }
            
            .mode-option {
                padding: 8px 16px;
                font-size: 14px; /* å¢å¤§æ¨¡å¼é¸é …å­—é«” */
            }
            
            /* æ–°ç‰Œå±€å°è©±æ¡†èª¿æ•´ - å¢å¤§æ–‡å­— */
            .new-game-dialog {
                padding: 25px;
                min-width: 280px;
            }
            
            .new-game-dialog h3 {
                font-size: 22px; /* å¢å¤§æ¨™é¡Œå­—é«” */
            }
            
            .new-game-dialog button {
                font-size: 16px; /* å¢å¤§æŒ‰éˆ•æ–‡å­— */
                padding: 14px;
            }
            
            /* å‹åˆ©ç•«é¢æ‰‹æ©Ÿç‰ˆèª¿æ•´ - å¢å¤§æ–‡å­— */
            .victory-dialog {
                min-width: 300px;
                padding: 30px;
            }
            
            .victory-dialog h2 {
                font-size: 2.1rem; /* å¢å¤§æ¨™é¡Œå­—é«” */
            }
            
            .victory-stat {
                font-size: 1.2rem; /* å¢å¤§çµ±è¨ˆæ–‡å­— */
            }
            
            .victory-buttons button {
                font-size: 1.1rem; /* å¢å¤§æŒ‰éˆ•æ–‡å­— */
                padding: 14px;
            }
            
            /* ç‰¹åˆ¥å°çš„æ‰‹æ©Ÿ */
            @media (max-width: 320px) {
                :root {
                    --card-width: 12vw; /* ç¨å¾®èª¿æ•´ */
                    --card-height: 16.8vw; /* ç­‰æ¯”ä¾‹èª¿æ•´ */
                    --gap: 0.8vw; /* æ›´å°çš„é–“è· */
                }
                
                .time-moves-display {
                    font-size: 10px; /* æ›´å°çš„å­—é«” */
                    min-width: 90px; /* å›ºå®šå¯¬åº¦ï¼Œå®¹ç´4ä½æ•¸ */
                }
                
                .score-display {
                    font-size: 10px; /* æ›´å°çš„å­—é«” */
                    min-width: 100px; /* å¢åŠ å¯¬åº¦ä»¥å®¹ç´é­”æ³•æ¬¡æ•¸ */
                }
                
                /* åœ¨ç‰¹åˆ¥å°çš„å±å¹•ä¸Šé€²ä¸€æ­¥èª¿æ•´å¡ç‰‡å­—é«” */
                .card-num { 
                    font-size: 2.2rem; /* æ¯”2.5remç¨å°ä¸€é» */
                    top: 1.3px; /* ä¿æŒ1.3pxé‚Šè· */
                    left: 1.3px; /* ä¿æŒ1.3pxé‚Šè· */
                }
                
                /* ç‰¹åˆ¥å°çš„å±å¹•ä¸Šæ•¸å­—"10"çš„è™•ç† */
                .card[data-text="10"] .card-num {
                    font-size: 1.6rem; /* æ•¸å­—10ä½¿ç”¨æ›´å°çš„å­—é«” */
                    transform: scaleX(0.8); /* å£“ç¸®å¯¬åº¦ç‚º80% */
                    transform-origin: left top; /* å¾å·¦ä¸Šè§’é–‹å§‹ç¸®æ”¾ */
                    left: 0.5px; /* ç¨å¾®èª¿æ•´ä½ç½® */
                }
                
                .card-suit-top {
                    font-size: 0.9rem; /* æ¯”1.1remç¨å°ä¸€é» */
                    top: 1.3px; /* ä¿æŒ1.3pxé‚Šè· */
                    right: 1.3px; /* ä¿æŒ1.3pxé‚Šè· */
                }
                
                .card-center-suit { 
                    font-size: 2.2rem; /* å¾2remå¢åŠ åˆ°2.2rem */
                    bottom: 1.1px; /* ä¿æŒé›¢åº•ç«¯1.1px */
                }
                
                /* ç‰¹åˆ¥å°çš„æ‰‹æ©Ÿä¸Šè“‹ç‰Œä¸Šçš„æ•¸å­—é¡¯ç¤ºèª¿æ•´ */
                .card-count {
                    font-size: 1.8rem; /* èª¿æ•´è“‹ç‰Œæ•¸å­—å¤§å° (å¾2.0remèª¿æ•´) */
                }
                
                /* åœ¨ç‰¹åˆ¥å°çš„å±å¹•ä¸Šèª¿æ•´æ‰‹æ©ŸåŠŸèƒ½å€ - å±…ä¸­å°é½Š */
                .mobile-toolbar-container {
                    gap: 5px; /* æ¸›å°‘é–“è· */
                    padding: 8px 10px; /* èª¿æ•´padding */
                    min-width: 260px; /* èª¿æ•´æœ€å°å¯¬åº¦ */
                    border-radius: 15px; /* ç¨å¾®æ¸›å°åœ“è§’ */
                    bottom: 70px; /* èª¿æ•´ä½ç½® */
                }
                
                .mobile-toolbar-container button {
                    padding: 6px 8px; /* èª¿æ•´æŒ‰éˆ•å¤§å° */
                    font-size: 11px; /* èª¿æ•´å­—é«”å¤§å° */
                    min-width: 50px; /* èª¿æ•´æœ€å°å¯¬åº¦ */
                    border-radius: 10px; /* æ¸›å°‘åœ“è§’ */
                }
                
                /* ç‰¹åˆ¥å°çš„æ‰‹æ©Ÿä¸Šå°è©±æ¡†èª¿æ•´ */
                .settings-dialog {
                    padding: 20px;
                    min-width: 260px;
                }
                
                .settings-dialog h3 {
                    font-size: 20px;
                }
                
                .new-game-dialog {
                    padding: 20px;
                    min-width: 260px;
                }
                
                .new-game-dialog h3 {
                    font-size: 20px;
                }
                
                /* ç‰¹åˆ¥å°çš„æ‰‹æ©Ÿä¸Šå‹åˆ©ç•«é¢èª¿æ•´ */
                .victory-dialog {
                    min-width: 280px;
                    padding: 25px;
                }
                
                .victory-dialog h2 {
                    font-size: 2.2rem;
                }
                
                .victory-stat {
                    font-size: 1.1rem;
                }
            }
        }
    </style>
</head>
<body>

<!-- å·¥å…·æ¬„å€å¡Š -->
<div class="toolbar">
    <div class="toolbar-left">
        <div class="time-moves-display" id="time-moves">00:00 | 0000æ­¥</div>
        <div class="score-display" id="score-display">åˆ†æ•¸: <span id="current-score">0000</span> | é­”æ³•: <span id="magic-count">0</span></div>
        <button id="settings-btn" onclick="playButtonSound(); showSettingsDialog()">âš™ï¸ è¨­å®š</button>
    </div>
    <div class="toolbar-buttons">
        <button onclick="playButtonSound(); showNewGameDialog()" id="new-game-btn">æ–°ç‰Œå±€</button>
        <button onclick="playButtonSound(); undoMove()" id="undo-btn" disabled>æ’¤å›</button>
        <button onclick="playButtonSound(); magicMove()" id="magic-btn" disabled>é­”æ³•</button>

    </div>
</div>

<!-- è¨Šæ¯æç¤ºæ¡† -->
<div id="message"></div>

<!-- æ–°ç‰Œå±€å°è©±æ¡† -->
<div class="dialog-overlay" id="dialog-overlay" onclick="closeNewGameDialog()"></div>
<div class="new-game-dialog" id="new-game-dialog">
    <h3>æ–°ç‰Œå±€é¸é …</h3>
    <button class="new-game-btn" onclick="playButtonSound(); startNewGame()">æ–°çš„éŠæˆ²</button>
    <button class="restart-game-btn" onclick="playButtonSound(); restartCurrentGame()">é‡ç©æ­¤å±€</button>
    <button class="cancel-btn" onclick="playButtonSound(); closeNewGameDialog()">è¿”å›éŠæˆ²</button>
</div>

<!-- è¨­å®šå°è©±æ¡† -->
<div class="dialog-overlay" id="settings-overlay" onclick="closeSettingsDialog()"></div>
<div class="settings-dialog" id="settings-dialog">
    <h3>âš™ï¸ éŠæˆ²è¨­å®š</h3>
    
    <div class="setting-item">
        <span class="setting-label">éŸ³æ•ˆé–‹é—œ</span>
        <label class="switch">
            <input type="checkbox" id="sound-toggle" onclick="playButtonSound()">
            <span class="slider"></span>
        </label>
    </div>
    
    <div class="setting-item">
        <span class="setting-label">é¡¯ç¤ºè“‹ç‰Œå‰©é¤˜ç‰Œæ•¸</span>
        <label class="switch">
            <input type="checkbox" id="show-card-count-toggle" onclick="playButtonSound()">
            <span class="slider"></span>
        </label>
    </div>
    
    <div class="setting-item">
        <span class="setting-label">çµæŸæ™‚è‡ªå‹•é£›ç‰Œ</span>
        <label class="switch">
            <input type="checkbox" id="auto-fly-toggle" onclick="playButtonSound()">
            <span class="slider"></span>
        </label>
    </div>
    
    <div class="setting-item">
        <span class="setting-label">å·¦å³æ‰‹æ¨¡å¼</span>
        <div class="mode-options">
            <div class="mode-option" id="hand-right-btn" onclick="playButtonSound(); setHandModeUI('right')">å³æ‰‹</div>
            <div class="mode-option" id="hand-left-btn" onclick="playButtonSound(); setHandModeUI('left')">å·¦æ‰‹</div>
        </div>
    </div>
    
    <div class="setting-item">
        <span class="setting-label">ç¿»ç‰Œæ¨¡å¼</span>
        <div class="mode-options">
            <div class="mode-option" id="draw-1-btn" onclick="playButtonSound(); setDrawModeUI(1)">1å¼µ</div>
            <div class="mode-option" id="draw-3-btn" onclick="playButtonSound(); setDrawModeUI(3)">3å¼µ</div>
        </div>
    </div>
    
    <div class="settings-buttons">
        <button class="cancel-btn" onclick="playButtonSound(); closeSettingsDialog()">è¿”å›éŠæˆ²</button>
    </div>
</div>

<!-- å‹åˆ©å°è©±æ¡† -->
<div class="dialog-overlay" id="victory-overlay" onclick="closeVictoryDialog()"></div>
<div class="victory-dialog" id="victory-dialog">
    <h2>ğŸ‰ YOU WINï¼ ğŸ‰</h2>
    <div class="victory-stats">
        <div class="victory-stat">
            <span class="victory-stat-label">éŠæˆ²æ™‚é–“:</span>
            <span class="victory-stat-value" id="victory-time">00:00</span>
        </div>
        <div class="victory-stat">
            <span class="victory-stat-label">ç§»å‹•æ­¥æ•¸:</span>
            <span class="victory-stat-value" id="victory-moves">0000</span>
        </div>
        <div class="victory-stat">
            <span class="victory-stat-label">æœ€çµ‚åˆ†æ•¸:</span>
            <span class="victory-stat-value" id="victory-score">0000</span>
        </div>
        <div class="victory-stat">
            <span class="victory-stat-label">é­”æ³•ä½¿ç”¨æ¬¡æ•¸:</span>
            <span class="victory-stat-value" id="victory-magic">0</span>
        </div>
    </div>
    <div class="victory-buttons">
        <button class="victory-new-game-btn" onclick="playButtonSound(); closeVictoryDialog(); startNewGame()">æ–°éŠæˆ²</button>
    </div>
</div>

<!-- ç…™èŠ±Canvas -->
<canvas id="fireworks-canvas"></canvas>

<!-- éŠæˆ²ä¸»å€åŸŸ -->
<div id="game-board">
    <!-- æ‰‹æ©Ÿç‰ˆåŠŸèƒ½éµå®¹å™¨ - ç¾åŒ–ç‰ˆ -->
    <div class="mobile-toolbar-container">
        <button onclick="playButtonSound(); showNewGameDialog()" id="mobile-new-game-btn">æ–°ç‰Œå±€</button>
        <button onclick="playButtonSound(); undoMove()" id="mobile-undo-btn" disabled>æ’¤å›</button>
        <button onclick="playButtonSound(); magicMove()" id="mobile-magic-btn" disabled>é­”æ³•</button>

        <button onclick="playButtonSound(); showSettingsDialog()" id="mobile-settings-btn">âš™ï¸</button>
    </div>

    <!-- å››å€‹èŠ±è‰²å€æ§½ä½ (å®‰ç½®å€) - ä½ç½®ç”±æ‰‹åˆ¥æ¨¡å¼æ±ºå®š -->
    <div id="slot-f0" class="slot" data-type="foundation" data-idx="0"></div>
    <div id="slot-f1" class="slot" data-type="foundation" data-idx="1"></div>
    <div id="slot-f2" class="slot" data-type="foundation" data-idx="2"></div>
    <div id="slot-f3" class="slot" data-type="foundation" data-idx="3"></div>

    <!-- å»¢ç‰Œå †æ§½ä½ - ä½ç½®ç”±æ‰‹åˆ¥æ¨¡å¼æ±ºå®š -->
    <div id="slot-waste" class="slot"></div>
    
    <!-- ç‰Œå †æ§½ä½ (è“‹ç‰Œå€) - ä½ç½®ç”±æ‰‹åˆ¥æ¨¡å¼æ±ºå®š -->
    <div id="slot-stock" class="slot"></div>

    <!-- ä¸ƒåˆ—è¡¨æ ¼æ§½ä½ -->
    <div id="slot-t0" class="slot" data-type="tableau" data-idx="0"></div>
    <div id="slot-t1" class="slot" data-type="tableau" data-idx="1"></div>
    <div id="slot-t2" class="slot" data-type="tableau" data-idx="2"></div>
    <div id="slot-t3" class="slot" data-type="tableau" data-idx="3"></div>
    <div id="slot-t4" class="slot" data-type="tableau" data-idx="4"></div>
    <div id="slot-t5" class="slot" data-type="tableau" data-idx="5"></div>
    <div id="slot-t6" class="slot" data-type="tableau" data-idx="6"></div>

    <!-- å¡ç‰‡åœ–å±¤ -->
    <div id="card-layer"></div>
</div>
<script>
    // ==================== éŠæˆ²å¸¸æ•¸å®šç¾© ====================
    const SUITS = ['â™ ', 'â™¥', 'â™£', 'â™¦']; // èŠ±è‰²é™£åˆ—
    const COLORS = { 'â™ ': 'black', 'â™¥': 'red', 'â™£': 'black', 'â™¦': 'red' }; // èŠ±è‰²å°æ‡‰é¡è‰²
    const RANKS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K']; // ç‰Œé¢å€¼é™£åˆ—

    // ==================== éŠæˆ²ç‹€æ…‹è®Šæ•¸ ====================
    let state = {
        stock: [],          // ç‰Œå † (è“‹ç‰Œå€)
        waste: [],          // å»¢ç‰Œå †
        foundations: [[], [], [], []], // å››å€‹èŠ±è‰²å€
        tableau: [[], [], [], [], [], [], []], // ä¸ƒåˆ—è¡¨æ ¼
        moves: 0,           // ç§»å‹•æ¬¡æ•¸
        score: 0,           // åˆ†æ•¸
        magicCount: 0,      // é­”æ³•ä½¿ç”¨æ¬¡æ•¸
        startTime: 0,       // éŠæˆ²é–‹å§‹æ™‚é–“
        timerInterval: null, // è¨ˆæ™‚å™¨
        gameMode: '',       // éŠæˆ²æ¨¡å¼
        soundEnabled: true, // éŸ³æ•ˆé–‹é—œ
        drawMode: 1,        // ç¿»ç‰Œæ¨¡å¼ (1 æˆ– 3)
        handMode: 'right',  // æ‰‹åˆ¥æ¨¡å¼ (right æˆ– left)
        showCardCount: true, // é¡¯ç¤ºè“‹ç‰Œå‰©é¤˜ç‰Œæ•¸
        autoFlyEnabled: true // è‡ªå‹•é£›ç‰Œé–‹é—œ
    };


let autoFlyTiming = {
    delay: 1,          // æ¯å¼µç‰Œä¹‹é–“çš„å»¶é²ï¼ˆæ¯«ç§’ï¼‰ - é è¨­å€¼ 50
    queueDelay: 1,    // éšŠåˆ—è™•ç†å»¶é²ï¼ˆæ¯«ç§’ï¼‰ - é è¨­å€¼ 100
    initialDelay: 0   // é–‹å§‹å»¶é²ï¼ˆæ¯«ç§’ï¼‰ - é è¨­å€¼ 300
};


    let initialGameState = null; // åˆå§‹éŠæˆ²ç‹€æ…‹ (ç”¨æ–¼é‡ç©)
    let history = []; // éŠæˆ²æ­·å²ç´€éŒ„ (ç”¨æ–¼æ’¤å›)
    let slotPositions = {}; // æ§½ä½ä½ç½®è³‡è¨Š
    let cardSize = {width: 0, height: 0}; // å¡ç‰‡å°ºå¯¸
    let drag = { // æ‹–æ›³ç‹€æ…‹
        isDragging: false,
        pending: false,
        startX: 0,
        startY: 0,
        offset: {x: 0, y: 0},
        origin: {type: '', pileIdx: 0, cardIdx: 0},
        cards: [],
        elGhosts: [],
        gameBoardRect: null
    };
    let lastClickCardId = null; // æœ€å¾Œé»æ“Šçš„å¡ç‰‡ID
    let lastClickTime = 0; // æœ€å¾Œé»æ“Šæ™‚é–“
    let isDrawing = false; // ç¿»ç‰Œå‹•ç•«æ¨™èªŒ
    let isAnimating = false; // å‹•ç•«é€²è¡Œä¸­æ¨™èªŒ
    let isAutoFlying = false; // è‡ªå‹•é£›ç‰Œé€²è¡Œä¸­æ¨™èªŒ
    let autoFlyQueue = []; // è‡ªå‹•é£›ç‰ŒéšŠåˆ—
    let autoFlyTimeout = null; // è‡ªå‹•é£›ç‰Œè¨ˆæ™‚å™¨
    let autoFlyCycleCount = 0; // è‡ªå‹•é£›ç‰Œå¾ªç’°è¨ˆæ•¸
    const MAX_AUTOFLY_CYCLES = 100; // æœ€å¤§è‡ªå‹•é£›ç‰Œå¾ªç’°æ¬¡æ•¸
    let autoMoveOnClick = false; // å–®æ“Šè‡ªå‹•ç§»å‹•æ¨¡å¼
    let fireworks = { // ç…™èŠ±æ•ˆæœ
        canvas: null,
        ctx: null,
        particles: [],
        isActive: false,
        animationId: null
    };
    let scoreClickCount = 0; // åˆ†æ•¸é»æ“Šè¨ˆæ•¸
    let lastScoreClickTime = 0; // æœ€å¾Œåˆ†æ•¸é»æ“Šæ™‚é–“
    const SCORE_CLICK_TIMEOUT = 2000; // åˆ†æ•¸é»æ“Šè¶…æ™‚æ™‚é–“





    // ==================== éŸ³æ•ˆç³»çµ± ====================
    function initAudio() {
        // éŸ³æ•ˆåˆå§‹åŒ–
    }
    
    function playButtonSound() {
        if (!state.soundEnabled) return;
        // æ’­æ”¾æŒ‰éˆ•éŸ³æ•ˆ
    }
    
    function playMoveSound() {
        if (!state.soundEnabled) return;
        // æ’­æ”¾ç§»å‹•éŸ³æ•ˆ
    }
    
    function playFlipSound() {
        if (!state.soundEnabled) return;
        // æ’­æ”¾ç¿»ç‰ŒéŸ³æ•ˆ
    }
    
    function playFoundationSound() {
        if (!state.soundEnabled) return;
        // æ’­æ”¾æ”¾ç½®åˆ°èŠ±è‰²å€éŸ³æ•ˆ
    }
    
    function playVictorySound() {
        if (!state.soundEnabled) return;
        // æ’­æ”¾å‹åˆ©éŸ³æ•ˆ
    }
    
    function playErrorSound() {
        if (!state.soundEnabled) return;
        // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
    }


// ==================== CSSè®Šæ•¸è®€å–å‡½æ•¸ ====================
/**
 * å¾CSSè®Šæ•¸ä¸­ç²å–æ™‚é–“å€¼ä¸¦è½‰æ›ç‚ºæ¯«ç§’
 * @param {string} varName - CSSè®Šæ•¸åç¨±
 * @param {number} defaultValue - é è¨­å€¼ï¼ˆæ¯«ç§’ï¼‰
 * @returns {number} - æ™‚é–“å€¼ï¼ˆæ¯«ç§’ï¼‰
 */
function getCssTimeValue(varName, defaultValue) {
    try {
        const value = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        if (!value) return defaultValue;
        
        // è§£ææ™‚é–“å€¼ï¼ˆæ”¯æ´ç§’så’Œæ¯«ç§’msï¼‰
        if (value.endsWith('ms')) {
            return parseFloat(value);
        } else if (value.endsWith('s')) {
            return parseFloat(value) * 1000;
        }
        return parseFloat(value);
    } catch (e) {
        console.warn(`ç„¡æ³•è®€å–CSSè®Šæ•¸ ${varName}:`, e);
        return defaultValue;
    }
}


/**
 * åˆå§‹åŒ–è‡ªå‹•é£›ç‰Œé–“éš”æ™‚é–“ï¼ˆå¾CSSè®Šæ•¸è®€å–ï¼‰
 */
function initAutoFlyTiming() {
    // å¾CSSè®Šæ•¸è®€å–è‡ªå‹•é£›ç‰Œé–“éš”æ™‚é–“
    autoFlyTiming.delay = getCssTimeValue('--animation-auto-fly-delay', 50);
    autoFlyTiming.queueDelay = getCssTimeValue('--animation-auto-fly-queue-delay', 100);
    autoFlyTiming.initialDelay = getCssTimeValue('--animation-auto-fly-initial-delay', 300);
    
    console.log('è‡ªå‹•é£›ç‰Œé–“éš”æ™‚é–“åˆå§‹åŒ–:', autoFlyTiming);
}



/* %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% */






function createVerifiedSolvableDeck() {
    console.log("=== ç”Ÿæˆæ–°ç‰Œå±€ï¼ˆä¿®æ­£ç‰ˆï¼‰===");
    
    // ä½¿ç”¨æ™‚é–“ç¢ºä¿è®ŠåŒ–
    const variation = Date.now() % 1000000;
    
    // ==================== éšæ®µ 1ï¼šå‰µå»ºå®Œæ•´ç‰Œçµ„ ====================
    
    let allCards = [];
    for (let s = 0; s < 4; s++) {
        for (let r = 0; r < 13; r++) {
            allCards.push({
                suit: SUITS[s],
                rank: r + 1,
                text: RANKS[r],
                value: r + 1,
                color: COLORS[SUITS[s]],
                faceUp: false,
                id: SUITS[s] + "-" + RANKS[r] + "-var" + variation
            });
        }
    }
    
    // åŸºæ–¼è®ŠåŒ–å› å­é€²è¡Œå¾ªç’°ç§»ä½
    const shiftAmount = variation % allCards.length;
    allCards = allCards.slice(shiftAmount).concat(allCards.slice(0, shiftAmount));
    
    // ==================== éšæ®µ 2ï¼šæ§‹å»ºtableau ====================
    
    let tableau = [[], [], [], [], [], [], []];
    
    // æ¨™æº–ç™¼ç‰Œï¼šç¬¬1åˆ—1å¼µï¼Œç¬¬2åˆ—2å¼µ...ç¬¬7åˆ—7å¼µ
    let cardIndex = 0;
    
    for (let col = 0; col < 7; col++) {
        for (let row = 0; row <= col; row++) {
            if (cardIndex < allCards.length) {
                tableau[col].push({
                    suit: allCards[cardIndex].suit,
                    rank: allCards[cardIndex].rank,
                    text: allCards[cardIndex].text,
                    value: allCards[cardIndex].value,
                    color: allCards[cardIndex].color,
                    faceUp: false,
                    id: allCards[cardIndex].id + "-tableau"
                });
                cardIndex++;
            }
        }
    }
    
    // ==================== éšæ®µ 3ï¼šæ§‹å»ºstock ====================
    
    let stock = [];
    for (let i = 0; i < 24 && cardIndex < allCards.length; i++) {
        stock.push({
            suit: allCards[cardIndex].suit,
            rank: allCards[cardIndex].rank,
            text: allCards[cardIndex].text,
            value: allCards[cardIndex].value,
            color: allCards[cardIndex].color,
            faceUp: false,
            id: allCards[cardIndex].id + "-stock"
        });
        cardIndex++;
    }
    
    // ==================== éšæ®µ 4ï¼šç¢ºä¿100%å¯è§£ ====================
    
    // ç¢ºä¿éŠæˆ²å¯ä»¥é–‹å§‹
    let gameCanStart = false;
    
    // æª¢æŸ¥æ˜¯å¦æœ‰Aåœ¨é ‚éƒ¨
    for (let col = 0; col < 7; col++) {
        if (tableau[col].length > 0 && tableau[col][tableau[col].length - 1].value === 1) {
            gameCanStart = true;
            break;
        }
    }
    
    // å¦‚æœæ²’æœ‰Aåœ¨é ‚éƒ¨ï¼Œé€²è¡Œèª¿æ•´
    if (!gameCanStart) {
        // ä½¿ç”¨è®ŠåŒ–å› å­æ±ºå®šèª¿æ•´å“ªä¸€åˆ—
        let targetCol = variation % 7;
        
        // åœ¨è©²åˆ—ä¸­æ‰¾A
        for (let pos = 0; pos < tableau[targetCol].length - 1; pos++) {
            if (tableau[targetCol][pos].value === 1) {
                let ace = tableau[targetCol].splice(pos, 1)[0];
                ace.faceUp = true;
                if (tableau[targetCol].length > 0) {
                    tableau[targetCol][tableau[targetCol].length - 1].faceUp = false;
                }
                tableau[targetCol].push(ace);
                gameCanStart = true;
                break;
            }
        }
    }
    
    // ==================== éšæ®µ 5ï¼šè¨­ç½®æ­£ç¢ºçš„ç‰Œé¢æœå‘ ====================
    
    // ç¢ºä¿æ¯åˆ—åªæœ‰é ‚éƒ¨ç‰Œæ­£é¢æœä¸Š
    for (let col = 0; col < 7; col++) {
        for (let i = 0; i < tableau[col].length; i++) {
            tableau[col][i].faceUp = (i === tableau[col].length - 1);
        }
    }
    
    // ==================== éšæ®µ 6ï¼šæœ€çµ‚é©—è­‰ ====================
    
    let totalCards = 0;
    for (let col = 0; col < 7; col++) {
        totalCards += tableau[col].length;
    }
    totalCards += stock.length;
    
    console.log("âœ“ ä¿®æ­£ç‰ˆæ§‹å»ºå®Œæˆ");
    console.log("âœ“ è®ŠåŒ–å› å­:", variation);
    console.log("âœ“ Tableauæ§‹å»ºå®Œæˆï¼Œå„åˆ—é«˜åº¦:", tableau.map(p => p.length));
    console.log("âœ“ Stockæœ‰", stock.length, "å¼µç‰Œ (ç›®æ¨™24å¼µ)");
    console.log("âœ“ æ¯åˆ—é ‚éƒ¨ç‰Œå·²æ­£é¢æœä¸Š");
    console.log("âœ“ éŠæˆ²å¯é–‹å§‹: æ˜¯");
    console.log("=== 100%å¯è§£ç‰Œå±€ç”Ÿæˆå®Œæˆ ===");
    console.log("ç¸½ç‰Œæ•¸:", totalCards, "(æ‡‰ç‚º 52)");
    
    if (totalCards !== 52) {
        console.error("âŒ éŒ¯èª¤ï¼šç‰Œæ•¸ä¸å°ï¼", totalCards);
    }
    
    if (stock.length !== 24) {
        console.error("âŒ éŒ¯èª¤ï¼šStockç‰Œæ•¸ä¸æ­£ç¢ºï¼", stock.length);
    }
    
    return {
        stock: stock,
        waste: [],
        foundations: [[], [], [], []],
        tableau: tableau
    };
}




function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}





/* %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% */
    
    
    
    
    /**
     * å‰µå»ºéš¨æ©Ÿç‰Œå±€
     */
    function createRandomDeck() {
        // å‰µå»ºæ‰€æœ‰ç‰Œçš„é™£åˆ—
        let allCards = [];
        for (let s = 0; s < 4; s++) {
            for (let r = 1; r <= 13; r++) {
                allCards.push({
                    suit: SUITS[s],
                    rank: r,
                    text: RANKS[r - 1],
                    color: COLORS[SUITS[s]],
                    faceUp: false,
                    id: Math.random().toString(36).substr(2, 9)
                });
            }
        }
        
        // æ´—ç‰Œ
        for (let i = allCards.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [allCards[i], allCards[j]] = [allCards[j], allCards[i]];
        }
        
        // åˆ†é…åˆ°ä¸ƒåˆ—è¡¨æ ¼
        let tableau = [[], [], [], [], [], [], []];
        let cardIdx = 0;
        for (let col = 0; col < 7; col++) {
            for (let row = 0; row <= col; row++) {
                let card = allCards[cardIdx++];
                card.faceUp = (row === col); // æ¯åˆ—æœ€ä¸Šé¢ä¸€å¼µç‰Œç¿»é–‹
                tableau[col].push(card);
            }
        }
        
        // å‰©é¤˜ç‰Œæ”¾å…¥ç‰Œå †
        let stock = allCards.slice(cardIdx);
        
        return { tableau, stock, waste: [] };
    }
    
    /**
     * å‰µå»ºå„ªåŒ–ç‰Œå±€ï¼ˆé«˜å‹ç‡ç‰ˆï¼‰
     * é‚è¼¯ï¼šå…ˆéš¨æ©Ÿæ´—ç‰Œ -> å†èª¿æ•´é—œéµç‰Œä½ç½® -> ç¢ºä¿èµ·æ‰‹æœ‰ç‰Œå¯æ‰“
     */
    function createOptimizedDeck() {
        console.log("æ­£åœ¨ç”Ÿæˆé«˜å‹ç‡å‹å–„ç‰Œå±€...");

        // 1. å»ºç«‹æ¨™æº–ç‰Œçµ„
        let allCards = [];
        for (let s = 0; s < 4; s++) {
            for (let r = 1; r <= 13; r++) {
                allCards.push({
                    suit: SUITS[s],
                    rank: r,
                    text: RANKS[r - 1],
                    color: COLORS[SUITS[s]],
                    faceUp: false,
                    id: Math.random().toString(36).substr(2, 9)
                });
            }
        }

        // 2. åŸºç¤æ´—ç‰Œ (Fisher-Yates) - é€™æ˜¯ç‚ºäº†è®“ç‰Œçœ‹èµ·ä¾†è‡ªç„¶
        for (let i = allCards.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [allCards[i], allCards[j]] = [allCards[j], allCards[i]];
        }

        // ================= æ™ºæ…§èª¿æ•´å€åŸŸ =================
        
        // A. ç¢ºä¿ Aces ä¸æœƒåŸ‹å¤ªæ·± (é—œéµï¼)
        // å¦‚æœ A åœ¨ç¬¬ 30 å¼µä¹‹å¾Œï¼ŒæŠŠå®ƒæ›åˆ°å‰ 20 å¼µã€‚é€™èƒ½ä¿è­‰ç©å®¶å¤§æ¦‚ç¿»å€‹å¹¾è¼ªå°±èƒ½çœ‹åˆ° Aã€‚
        for (let i = 0; i < allCards.length; i++) {
            if (allCards[i].rank === 1 && i > 30) {
                // æ‰¾ä¸€å€‹å‰ 20 å¼µè£¡ä¸æ˜¯ A çš„ç‰Œäº¤æ›
                let swapTargetIndex = Math.floor(Math.random() * 20);
                // ç°¡å–®é˜²å‘†ï¼šå¦‚æœéš¨æ©Ÿåˆ°å‰›å¥½ä¹Ÿæ˜¯ Aï¼Œå°±å¾€å‰æ‰¾ä¸€å¼µ
                while(allCards[swapTargetIndex].rank === 1) {
                    swapTargetIndex = (swapTargetIndex + 1) % 20;
                }
                [allCards[i], allCards[swapTargetIndex]] = [allCards[swapTargetIndex], allCards[i]];
            }
        }

        // B. ç¢ºä¿èµ·æ‰‹ç¿»é–‹çš„ 7 å¼µç‰Œæ˜¯ "å¯ç©çš„"
        // æ¨™æº–ç™¼ç‰Œé †åºä¸­ï¼ŒTableau ç¿»é–‹çš„ç‰Œåœ¨ allCards çš„ index ä½ç½®æ˜¯ï¼š0, 2, 5, 9, 14, 20, 27
        const faceUpIndices = [0, 2, 5, 9, 14, 20, 27];
        let redCount = 0;
        let highCardCount = 0;

        faceUpIndices.forEach(idx => {
            if (allCards[idx].color === 'red') redCount++;
            if (allCards[idx].rank > 10) highCardCount++; // J, Q, K
        });

        // å¦‚æœèµ·æ‰‹ç¿»é–‹çš„ç‰Œç´…è‰²å¤ªå¤šï¼ˆå…¨ç´…æˆ–6ç´…ï¼‰ï¼Œå¾ˆé›£ä¸²æ¥ï¼Œå¼·è¡Œæ›ä¸€å¼µé»‘è‰²çš„é€²ä¾†
        if (redCount >= 6) {
            // åœ¨ç‰Œåº«å‰ 30 å¼µæ‰¾ä¸€å¼µé»‘è‰²å°ç‰Œ (<= 10)
            for (let i = 0; i < 30; i++) {
                if (allCards[i].color === 'black' && allCards[i].rank <= 10) {
                    // éš¨æ©Ÿé¸ä¸€å€‹ç¿»é–‹çš„ç´…è‰²å¤§ç‰Œä¾†äº¤æ›
                    let badFaceUpIdx = faceUpIndices[Math.floor(Math.random() * faceUpIndices.length)];
                    // ç¢ºä¿æ›çš„æ˜¯ç´…è‰²çš„ï¼Œé¿å…å‰›å¥½æ›åˆ°å”¯ä¸€ä¸€å¼µé»‘è‰²çš„
                    while (allCards[badFaceUpIdx].color === 'black') {
                        badFaceUpIdx = faceUpIndices[Math.floor(Math.random() * faceUpIndices.length)];
                    }
                    [allCards[i], allCards[badFaceUpIdx]] = [allCards[badFaceUpIdx], allCards[i]];
                    break;
                }
            }
        }
        
        // ================= èª¿æ•´çµæŸ =================

        // 3. åˆ†é…ç‰Œå±€
        let tableau = [[], [], [], [], [], [], []];
        let cardIdx = 0;

        for (let col = 0; col < 7; col++) {
            for (let row = 0; row <= col; row++) {
                let card = allCards[cardIdx++];
                card.faceUp = (row === col); // åªæœ‰æ¯åˆ—æœ€å¾Œä¸€å¼µæ˜¯ç¿»é–‹çš„
                tableau[col].push(card);
            }
        }

        let stock = allCards.slice(cardIdx);

        return { tableau, stock, waste: [] };
    }

    /**
     * å°‹æ‰¾å¾å»¢ç‰Œå †ç§»å‹•åˆ°è¡¨æ ¼çš„ç§»å‹•
     */
    function findMoveFromWasteToTableau() {
        if (state.waste.length === 0) return null;
        
        const card = state.waste[state.waste.length - 1];
        for (let col = 0; col < 7; col++) {
            if (canMoveToTableau(card, state.tableau[col])) {
                return {
                    type: 'toTableau',
                    sourceType: 'waste',
                    sourceCol: 0,
                    sourceIdx: state.waste.length - 1,
                    targetCol: col,
                    card: card
                };
            }
        }
        return null;
    }
    
    /**
     * å°‹æ‰¾å¯ä»¥ç§»å‹•åˆ°èŠ±è‰²å€çš„ç‰Œ
     */
    function findMoveToFoundation() {
        // æª¢æŸ¥ä¸ƒåˆ—è¡¨æ ¼
        for (let col = 0; col < 7; col++) {
            const pile = state.tableau[col];
            if (pile.length === 0) continue;
            
            const card = pile[pile.length - 1];
            if (!card.faceUp) continue;
            
            // æª¢æŸ¥æ˜¯å¦å¯ä»¥ç§»å‹•åˆ°èŠ±è‰²å€
            for (let foundIdx = 0; foundIdx < 4; foundIdx++) {
                const foundation = state.foundations[foundIdx];
                if (canMoveToFoundation(card, foundation)) {
                    return {
                        type: 'toFoundation',
                        sourceType: 'tableau',
                        sourceCol: col,
                        sourceIdx: pile.length - 1,
                        targetFoundation: foundIdx,
                        card: card
                    };
                }
            }
        }
        
        // æª¢æŸ¥å»¢ç‰Œå †
        if (state.waste.length > 0) {
            const card = state.waste[state.waste.length - 1];
            for (let foundIdx = 0; foundIdx < 4; foundIdx++) {
                const foundation = state.foundations[foundIdx];
                if (canMoveToFoundation(card, foundation)) {
                    return {
                        type: 'toFoundation',
                        sourceType: 'waste',
                        sourceCol: 0,
                        sourceIdx: state.waste.length - 1,
                        targetFoundation: foundIdx,
                        card: card
                    };
                }
            }
        }
        
        return null;
    }
    
    /**
     * å°‹æ‰¾å¯ä»¥ç¿»é–‹çš„è“‹ç‰Œ
     */
    function findMoveToFlipCard() {
        // æª¢æŸ¥ä¸ƒåˆ—è¡¨æ ¼ä¸­æ˜¯å¦æœ‰è“‹ç‰Œå¯ä»¥ç¿»é–‹
        for (let col = 0; col < 7; col++) {
            const pile = state.tableau[col];
            if (pile.length === 0) continue;
            
            const topCard = pile[pile.length - 1];
            if (!topCard.faceUp) {
                return {
                    type: 'flip',
                    col: col
                };
            }
        }
        
        return null;
    }
    
    /**
     * å°‹æ‰¾å¯ä»¥ç§»å‹•ç‰Œä»¥é‡‹æ”¾è“‹ç‰Œ
     */
    function findMoveToFreeCard() {
        // å°‹æ‰¾å¯ä»¥ç§»å‹•çš„ç‰Œä»¥é‡‹æ”¾ä¸‹é¢çš„è“‹ç‰Œ
        for (let sourceCol = 0; sourceCol < 7; sourceCol++) {
            const sourcePile = state.tableau[sourceCol];
            if (sourcePile.length === 0) continue;
            
            // å°‹æ‰¾æœ€ä¸Šé¢çš„ç¿»é–‹çš„ç‰Œ
            let topFaceUpIndex = -1;
            for (let i = sourcePile.length - 1; i >= 0; i--) {
                if (sourcePile[i].faceUp) {
                    topFaceUpIndex = i;
                    break;
                }
            }
            
            if (topFaceUpIndex === -1) continue;
            
            const card = sourcePile[topFaceUpIndex];
            
            // æª¢æŸ¥æ˜¯å¦å¯ä»¥ç§»å‹•åˆ°å…¶ä»–è¡¨æ ¼åˆ—
            for (let targetCol = 0; targetCol < 7; targetCol++) {
                if (sourceCol === targetCol) continue;
                
                const targetPile = state.tableau[targetCol];
                
                // Kingå¯ä»¥ç§»å‹•åˆ°ç©ºåˆ—
                if (card.rank === 13 && targetPile.length === 0) {
                    return {
                        type: 'tableauToTableau',
                        sourceCol: sourceCol,
                        sourceIdx: topFaceUpIndex,
                        targetCol: targetCol,
                        card: card
                    };
                }
                
                // æª¢æŸ¥æ¨™æº–ç§»å‹•è¦å‰‡
                if (targetPile.length > 0 && canMoveToTableau(card, targetPile)) {
                    return {
                        type: 'tableauToTableau',
                        sourceCol: sourceCol,
                        sourceIdx: topFaceUpIndex,
                        targetCol: targetCol,
                        card: card
                    };
                }
            }
        }
        
        return null;
    }
    
    /**
     * åŸ·è¡ŒAIç§»å‹•
     */
    function executeAIMove(move) {
        switch (move.type) {
            case 'toFoundation':
                executeAIMoveToFoundation(move);
                break;
            case 'flip':
                executeAIFlipCard(move);
                break;
            case 'toTableau':
                if (move.sourceType === 'waste') {
                    executeAIWasteToTableau(move);
                } else {
                    executeAITableauToTableau(move);
                }
                break;
            case 'tableauToTableau':
                executeAITableauToTableau(move);
                break;
            case 'draw':
                executeAIDraw();
                break;
            case 'reset':
                executeAIReset();
                break;
        }
    }

    /**
     * åŸ·è¡ŒAIå¾å»¢ç‰Œå †ç§»å‹•åˆ°è¡¨æ ¼
     */
    function executeAIWasteToTableau(move) {
        const { targetCol, card } = move;
        
        // å¾å»¢ç‰Œå †ç§»é™¤
        state.waste.pop();
        
        // æ·»åŠ åˆ°ç›®æ¨™è¡¨æ ¼åˆ—
        state.tableau[targetCol].push(card);
        
        // æ›´æ–°éŠæˆ²ç‹€æ…‹
        state.moves++;
        addScore(5);
        
        // é‡æ–°æ¸²æŸ“
        render();
        updateTimer();
        updateMagicButton();
        
        // æ’­æ”¾éŸ³æ•ˆ
        playMoveSound();
    }
    
    /**
     * åŸ·è¡ŒAIç§»å‹•åˆ°èŠ±è‰²å€
     */
    function executeAIMoveToFoundation(move) {
        const { sourceType, sourceCol, sourceIdx, targetFoundation, card } = move;
        
        // å¾ä¾†æºç§»é™¤å¡ç‰‡
        if (sourceType === 'tableau') {
            state.tableau[sourceCol].splice(sourceIdx, 1);
            // å¦‚æœé‚„æœ‰ç‰Œï¼Œç¿»é–‹æœ€ä¸Šé¢ä¸€å¼µ
            if (state.tableau[sourceCol].length > 0) {
                state.tableau[sourceCol][state.tableau[sourceCol].length - 1].faceUp = true;
            }
        } else if (sourceType === 'waste') {
            state.waste.pop();
        }
        
        // æ·»åŠ åˆ°èŠ±è‰²å€
        state.foundations[targetFoundation].push(card);
        
        // æ›´æ–°éŠæˆ²ç‹€æ…‹
        state.moves++;
        addScore(10);
        
        // é‡æ–°æ¸²æŸ“
        render();
        updateTimer();
        updateMagicButton();
        
        // æ’­æ”¾éŸ³æ•ˆ
        playFoundationSound();
    }
    
    /**
     * åŸ·è¡ŒAIç¿»ç‰Œ
     */
    function executeAIFlipCard(move) {
        const { col } = move;
        const pile = state.tableau[col];
        
        if (pile.length > 0) {
            const topCard = pile[pile.length - 1];
            if (!topCard.faceUp) {
                topCard.faceUp = true;
                state.moves++;
                addScore(5);
                render();
                updateTimer();
                updateMagicButton();
                playFlipSound();
            }
        }
    }
    
    /**
     * åŸ·è¡ŒAIè¡¨æ ¼åˆ—é–“ç§»å‹•
     */
    function executeAITableauToTableau(move) {
        const { sourceCol, sourceIdx, targetCol, card } = move;
        const sourcePile = state.tableau[sourceCol];
        
        // ç²å–è¦ç§»å‹•çš„æ‰€æœ‰ç‰Œ
        const cardsToMove = sourcePile.slice(sourceIdx);
        
        // å¾ä¾†æºç§»é™¤å¡ç‰‡
        state.tableau[sourceCol].splice(sourceIdx, cardsToMove.length);
        
        // å¦‚æœé‚„æœ‰ç‰Œï¼Œç¿»é–‹æœ€ä¸Šé¢ä¸€å¼µ
        if (state.tableau[sourceCol].length > 0) {
            state.tableau[sourceCol][state.tableau[sourceCol].length - 1].faceUp = true;
        }
        
        // æ·»åŠ åˆ°ç›®æ¨™
        state.tableau[targetCol].push(...cardsToMove);
        
        // æ›´æ–°éŠæˆ²ç‹€æ…‹
        state.moves++;
        addScore(5 * cardsToMove.length);
        
        // é‡æ–°æ¸²æŸ“
        render();
        updateTimer();
        updateMagicButton();
        
        // æ’­æ”¾éŸ³æ•ˆ
        playMoveSound();
    }
    
    /**
     * åŸ·è¡ŒAIç¿»ç‰Œ
     */
    function executeAIDraw() {
        if (state.stock.length === 0) return;
        
        const drawCount = Math.min(state.drawMode, state.stock.length);
        const cardsToDraw = [];
        
        for (let i = 0; i < drawCount; i++) {
            const cardIndex = state.stock.length - 1 - i;
            cardsToDraw.unshift(state.stock[cardIndex]);
        }
        
        // å¾éŠæˆ²ç‹€æ…‹ä¸­ç§»é™¤é€™äº›ç‰Œ
        for (let i = 0; i < drawCount; i++) {
            state.stock.pop();
        }
        
        // å°‡å–å‡ºçš„ç‰ŒåŠ å…¥å»¢ç‰Œå †
        cardsToDraw.forEach(card => {
            card.faceUp = true;
            state.waste.push(card);
        });
        
        state.moves++;
        addScore(5 * drawCount);
        
        render();
        updateTimer();
        playFlipSound();
    }
    
    /**
     * åŸ·è¡ŒAIé‡ç½®ç‰Œå †
     */
    function executeAIReset() {
        if (state.waste.length === 0) return;
        
        state.stock = state.waste.reverse().map(c => { 
            c.faceUp = false;
            return c; 
        });
        state.waste = [];
        state.moves++;
        addScore(-100);
        
        render();
        updateTimer();
    }
    
    // ==================== å‹åˆ©ç•«é¢å‡½æ•¸ ====================
    /**
     * åˆå§‹åŒ–ç…™èŠ±æ•ˆæœ
     */
    function initFireworks() {
        fireworks.canvas = document.getElementById('fireworks-canvas');
        fireworks.ctx = fireworks.canvas.getContext('2d');
        
        // è¨­å®šCanvaså¤§å°
        function resizeCanvas() {
            fireworks.canvas.width = window.innerWidth;
            fireworks.canvas.height = window.innerHeight;
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
    }
    
    /**
     * é–‹å§‹ç…™èŠ±æ•ˆæœ
     */
    function startFireworks() {
        if (fireworks.isActive) return;
        
        fireworks.isActive = true;
        fireworks.canvas.style.display = 'block';
        
        // æ¸…ç©ºç²’å­
        fireworks.particles = [];
        
        // å‰µå»ºåˆå§‹ç…™èŠ±
        createFirework();
        
        // é–‹å§‹å‹•ç•«å¾ªç’°
        animateFireworks();
    }
    
    /**
     * åœæ­¢ç…™èŠ±æ•ˆæœ
     */
    function stopFireworks() {
        fireworks.isActive = false;
        fireworks.canvas.style.display = 'none';
        
        if (fireworks.animationId) {
            cancelAnimationFrame(fireworks.animationId);
            fireworks.animationId = null;
        }
    }
    
    /**
     * å‰µå»ºä¸€å€‹ç…™èŠ±
     */
    function createFirework() {
        if (!fireworks.isActive) return;
        
        // éš¨æ©Ÿä½ç½®
        const x = Math.random() * fireworks.canvas.width;
        const y = Math.random() * fireworks.canvas.height * 0.5; // ä¸ŠåŠéƒ¨åˆ†
        
        // éš¨æ©Ÿé¡è‰²
        const colors = [
            '#FF0000', '#FF9900', '#FFFF00', '#00FF00', 
            '#00FFFF', '#0000FF', '#FF00FF', '#FFFFFF'
        ];
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        // å‰µå»ºçˆ†ç‚¸ç²’å­
        const particleCount = 80 + Math.random() * 50;
        for (let i = 0; i < particleCount; i++) {
            fireworks.particles.push({
                x: x,
                y: y,
                color: color,
                radius: Math.random() * 2 + 1,
                speed: Math.random() * 5 + 2,
                angle: Math.random() * Math.PI * 2,
                friction: 0.95,
                gravity: 0.1,
                opacity: 1,
                decay: Math.random() * 0.02 + 0.005,
                spark: Math.random() > 0.8 // æ˜¯å¦ç‚ºç«èŠ±
            });
        }
        
        // éš¨æ©Ÿé–“éš”å¾Œå‰µå»ºä¸‹ä¸€å€‹ç…™èŠ±
        setTimeout(() => {
            if (fireworks.isActive) {
                createFirework();
            }
        }, Math.random() * 500 + 10);
    }
    
    /**
     * å‹•ç•«ç…™èŠ±æ•ˆæœ
     */
    function animateFireworks() {
        if (!fireworks.isActive) return;
        
        // æ¸…ç©ºCanvas
        fireworks.ctx.clearRect(0, 0, fireworks.canvas.width, fireworks.canvas.height);
        
        // æ›´æ–°å’Œç¹ªè£½æ¯å€‹ç²’å­
        for (let i = fireworks.particles.length - 1; i >= 0; i--) {
            const p = fireworks.particles[i];
            
            // æ›´æ–°ä½ç½®
            p.x += Math.cos(p.angle) * p.speed;
            p.y += Math.sin(p.angle) * p.speed + p.gravity;
            
            // æ‡‰ç”¨æ‘©æ“¦åŠ›å’Œé‡åŠ›
            p.speed *= p.friction;
            p.gravity += 0.01;
            
            // æ¸›å°‘ä¸é€æ˜åº¦
            p.opacity -= p.decay;
            
            // ç¹ªè£½ç²’å­
            fireworks.ctx.beginPath();
            fireworks.ctx.globalAlpha = p.opacity;
            fireworks.ctx.fillStyle = p.color;
            
            if (p.spark) {
                // ç¹ªè£½ç«èŠ±ï¼ˆç·šæ¢ï¼‰
                fireworks.ctx.fillRect(p.x, p.y, p.radius * 2, p.radius * 0.5);
            } else {
                // ç¹ªè£½åœ“å½¢ç²’å­
                fireworks.ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                fireworks.ctx.fill();
            }
            
            // å¦‚æœç²’å­å®Œå…¨é€æ˜ï¼Œç§»é™¤å®ƒ
            if (p.opacity <= 0) {
                fireworks.particles.splice(i, 1);
            }
        }
        
        // ç¹¼çºŒå‹•ç•«å¾ªç’°
        fireworks.animationId = requestAnimationFrame(animateFireworks);
    }
    
    /**
     * é¡¯ç¤ºå‹åˆ©ç•«é¢
     */
    function showVictoryDialog() {
        
        // åœæ­¢è¨ˆæ™‚å™¨
        stopTimer();
        
        // è¨ˆç®—éŠæˆ²æ™‚é–“
        const elapsed = Date.now() - state.startTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // æ›´æ–°å‹åˆ©ç•«é¢æ•¸æ“š
        document.getElementById('victory-time').textContent = timeString;
        document.getElementById('victory-moves').textContent = state.moves.toString().padStart(4, '0');
        document.getElementById('victory-score').textContent = state.score.toString().padStart(4, '0');
        document.getElementById('victory-magic').textContent = state.magicCount;
        
        // æ’­æ”¾å‹åˆ©éŸ³æ•ˆ
        playVictorySound();
        
        // é¡¯ç¤ºå‹åˆ©ç•«é¢
        document.getElementById('victory-overlay').style.display = 'block';
        document.getElementById('victory-dialog').style.display = 'block';
        
        // é–‹å§‹ç…™èŠ±æ•ˆæœ
        startFireworks();
    }
    
    /**
     * é—œé–‰å‹åˆ©ç•«é¢
     */
    function closeVictoryDialog() {
        document.getElementById('victory-overlay').style.display = 'none';
        document.getElementById('victory-dialog').style.display = 'none';
        
        // åœæ­¢ç…™èŠ±æ•ˆæœ
        stopFireworks();
    }
    
    /**
     * è™•ç†åˆ†æ•¸æ¡†é»æ“Šäº‹ä»¶ï¼ˆæ¸¬è©¦åŠŸèƒ½ï¼‰
     */
    function handleScoreClick() {
        const now = Date.now();
        
        // å¦‚æœè·é›¢ä¸Šæ¬¡é»æ“Šè¶…é2ç§’ï¼Œé‡ç½®è¨ˆæ•¸å™¨
        if (now - lastScoreClickTime > SCORE_CLICK_TIMEOUT) {
            scoreClickCount = 0;
        }
        
        // æ›´æ–°é»æ“Šè¨ˆæ•¸
        scoreClickCount++;
        lastScoreClickTime = now;
        
        // å¦‚æœé»æ“Šäº†3æ¬¡ï¼Œè§¸ç™¼å‹åˆ©ç•«é¢
        if (scoreClickCount >= 3) {
            scoreClickCount = 0; // é‡ç½®è¨ˆæ•¸å™¨
            showVictoryDialog(); // é¡¯ç¤ºå‹åˆ©ç•«é¢
        }
    }
    
    // ==================== è¨­å®šå°è©±æ¡†å‡½æ•¸ ====================
    /**
     * é¡¯ç¤ºè¨­å®šå°è©±æ¡†
     */
    function showSettingsDialog() {
        // æ›´æ–°è¨­å®šå°è©±æ¡†ä¸­çš„ç‹€æ…‹
        document.getElementById('sound-toggle').checked = state.soundEnabled;
        document.getElementById('show-card-count-toggle').checked = state.showCardCount;
        document.getElementById('auto-fly-toggle').checked = state.autoFlyEnabled;
        
        // æ›´æ–°æ‰‹åˆ¥æ¨¡å¼æŒ‰éˆ•
        document.getElementById('hand-right-btn').classList.toggle('active', state.handMode === 'right');
        document.getElementById('hand-left-btn').classList.toggle('active', state.handMode === 'left');
        
        // æ›´æ–°ç¿»ç‰Œæ¨¡å¼æŒ‰éˆ•
        document.getElementById('draw-1-btn').classList.toggle('active', state.drawMode === 1);
        document.getElementById('draw-3-btn').classList.toggle('active', state.drawMode === 3);
        
        // é¡¯ç¤ºè¨­å®šå°è©±æ¡†
        document.getElementById('settings-overlay').style.display = 'block';
        document.getElementById('settings-dialog').style.display = 'block';
    }
    
    /**
     * é—œé–‰è¨­å®šå°è©±æ¡†
     */
    function closeSettingsDialog() {
        // é—œé–‰å‰ä¿å­˜æ‰€æœ‰è¨­å®šæ›´æ”¹
        saveAllSettings();
        
        // é—œé–‰è¨­å®šå°è©±æ¡†
        document.getElementById('settings-overlay').style.display = 'none';
        document.getElementById('settings-dialog').style.display = 'none';
    }
    
    /**
     * ä¿å­˜æ‰€æœ‰è¨­å®š
     */
    function saveAllSettings() {
        // ä¿å­˜éŸ³æ•ˆè¨­å®š
        state.soundEnabled = document.getElementById('sound-toggle').checked;
        
        // ä¿å­˜è“‹ç‰Œé¡¯ç¤ºè¨­å®š
        const showCardCount = document.getElementById('show-card-count-toggle').checked;
        if (state.showCardCount !== showCardCount) {
            state.showCardCount = showCardCount;
            // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°è“‹ç‰Œé¡¯ç¤º
            render();
        }
        
        // ä¿å­˜è‡ªå‹•é£›ç‰Œè¨­å®š
        state.autoFlyEnabled = document.getElementById('auto-fly-toggle').checked;
        
        // ä¿å­˜åˆ°æœ¬åœ°å„²å­˜
        saveSettingsToLocalStorage();
        
        // é¡¯ç¤ºç¢ºèªè¨Šæ¯
        showMessage("è¨­å®šå·²æ›´æ–°", 1000);
    }
    
    /**
     * å¾æœ¬åœ°å„²å­˜è¼‰å…¥è¨­å®š
     */
    function loadSettingsFromLocalStorage() {
        const savedSettings = localStorage.getItem('solitaire-settings');
        if (savedSettings) {
            try {
                const settings = JSON.parse(savedSettings);
                state.soundEnabled = settings.soundEnabled !== undefined ? settings.soundEnabled : true;
                state.drawMode = settings.drawMode || 1;
                state.handMode = settings.handMode || 'right';
                state.showCardCount = settings.showCardCount !== undefined ? settings.showCardCount : true;
                state.autoFlyEnabled = settings.autoFlyEnabled !== undefined ? settings.autoFlyEnabled : true;
                state.magicCount = settings.magicCount || 0; // è¼‰å…¥é­”æ³•æ¬¡æ•¸
            } catch (e) {
                console.log("è¼‰å…¥è¨­å®šå¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼");
            }
        }
    }
    
    /**
     * å„²å­˜è¨­å®šåˆ°æœ¬åœ°å„²å­˜
     */
    function saveSettingsToLocalStorage() {
        const settings = {
            soundEnabled: state.soundEnabled,
            drawMode: state.drawMode,
            handMode: state.handMode,
            showCardCount: state.showCardCount,
            autoFlyEnabled: state.autoFlyEnabled,
            magicCount: state.magicCount // ä¿å­˜é­”æ³•æ¬¡æ•¸
        };
        localStorage.setItem('solitaire-settings', JSON.stringify(settings));
    }
    
    /**
     * è¨­å®šæ‰‹åˆ¥æ¨¡å¼ (UIç‰ˆæœ¬)
     */
    function setHandModeUI(mode) {
        if (mode !== 'left' && mode !== 'right') return;
        
        // ç«‹å³æ›´æ–°è¨­å®š
        state.handMode = mode;
        
        // æ›´æ–°UIé¡¯ç¤º
        document.getElementById('hand-right-btn').classList.toggle('active', mode === 'right');
        document.getElementById('hand-left-btn').classList.toggle('active', mode === 'left');
        
        // ç«‹å³æ‡‰ç”¨è¨­å®š
        saveSettingsToLocalStorage();
        layoutSlots();
        render();
        
        // é¡¯ç¤ºç¢ºèªè¨Šæ¯
        showMessage(`å·²åˆ‡æ›ç‚º${mode === 'right' ? 'å³æ‰‹' : 'å·¦æ‰‹'}æ¨¡å¼`, 1000);
    }
    
    /**
     * è¨­å®šç¿»ç‰Œæ¨¡å¼ (UIç‰ˆæœ¬)
     */
    function setDrawModeUI(mode) {
        if (mode !== 1 && mode !== 3) return;
        
        // ç«‹å³æ›´æ–°è¨­å®š
        state.drawMode = mode;
        
        // æ›´æ–°UIé¡¯ç¤º
        document.getElementById('draw-1-btn').classList.toggle('active', mode === 1);
        document.getElementById('draw-3-btn').classList.toggle('active', mode === 3);
        
        // ç«‹å³æ‡‰ç”¨è¨­å®š
        saveSettingsToLocalStorage();
        render();
        
        // é¡¯ç¤ºç¢ºèªè¨Šæ¯
        showMessage(`å·²åˆ‡æ›ç‚ºä¸€æ¬¡ç¿»${mode}å¼µç‰Œæ¨¡å¼`, 1000);
    }
    
    // ==================== åˆ†æ•¸è¨ˆç®—èˆ‡æ›´æ–°å‡½æ•¸ ====================
    /**
     * æ›´æ–°åˆ†æ•¸å’Œé­”æ³•æ¬¡æ•¸é¡¯ç¤º
     */
    function updateScoreDisplay() {
        const scoreElement = document.getElementById('current-score');
        const magicElement = document.getElementById('magic-count');
        
        // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
        if (state.score >= 0) {
            // æ­£æ•¸æˆ–é›¶ï¼šæ ¼å¼åŒ–ç‚º4ä½æ•¸å­—ï¼Œå‰é¢è£œé›¶
            const formattedScore = Math.abs(state.score).toString().padStart(4, '0');
            scoreElement.textContent = formattedScore;
        } else {
            // è² æ•¸ï¼šé¡¯ç¤ºè² è™Ÿå’Œæ•¸å­—ï¼Œç¢ºä¿ç¸½å¯¬åº¦ç‚º4å€‹å­—ç¬¦
            const absScore = Math.abs(state.score);
            if (absScore < 10) {
                scoreElement.textContent = `-00${absScore}`;
            } else if (absScore < 100) {
                scoreElement.textContent = `-0${absScore}`;
            } else if (absScore < 1000) {
                scoreElement.textContent = `-${absScore}`;
            } else {
                // å¦‚æœè² æ•¸çµ•å°å€¼å¤§æ–¼999ï¼Œé¡¯ç¤ºå®Œæ•´æ•¸å­—ï¼ˆæœƒè¶…é4ä½ï¼Œä½†é€™æ˜¯æ¥µç«¯æƒ…æ³ï¼‰
                scoreElement.textContent = `-${absScore}`;
            }
        }
        
        // æ›´æ–°é­”æ³•æ¬¡æ•¸é¡¯ç¤º
        if (magicElement) {
            magicElement.textContent = state.magicCount;
        }
    }
    
    /**
     * å¢åŠ åˆ†æ•¸
     * @param {number} points - è¦å¢åŠ çš„åˆ†æ•¸
     */
    function addScore(points) {
        state.score += points;
        updateScoreDisplay();
    }
    
    /**
     * å¢åŠ é­”æ³•ä½¿ç”¨æ¬¡æ•¸
     */
    function addMagicCount() {
        state.magicCount++;
        updateScoreDisplay();
    }
    
    // ==================== æ–°ç‰Œå±€å°è©±æ¡†å‡½æ•¸ ====================
    /**
     * é¡¯ç¤ºæ–°ç‰Œå±€å°è©±æ¡†
     */
    function showNewGameDialog() {
        document.getElementById('dialog-overlay').style.display = 'block';
        document.getElementById('new-game-dialog').style.display = 'block';
    }
    
    /**
     * é—œé–‰æ–°ç‰Œå±€å°è©±æ¡†
     */
    function closeNewGameDialog() {
        document.getElementById('dialog-overlay').style.display = 'none';
        document.getElementById('new-game-dialog').style.display = 'none';
    }
    
    /**
     * é–‹å§‹æ–°éŠæˆ²
     */
    function startNewGame() {
        
        closeNewGameDialog();
        initGame('guaranteed');
    }
    
    /**
     * é‡ç©ç•¶å‰éŠæˆ²
     */
    function restartCurrentGame() {
        
        closeNewGameDialog();
        
        if (!initialGameState) {
            showMessage("ç„¡æ³•é‡ç©æ­¤å±€ï¼Œè«‹é–‹å§‹æ–°éŠæˆ²", 2000);
            return;
        }
        
        // æ¢å¾©åˆ°åˆå§‹éŠæˆ²ç‹€æ…‹
        state.stock = JSON.parse(JSON.stringify(initialGameState.stock));
        state.waste = JSON.parse(JSON.stringify(initialGameState.waste));
        state.foundations = JSON.parse(JSON.stringify(initialGameState.foundations));
        state.tableau = JSON.parse(JSON.stringify(initialGameState.tableau));
        state.moves = 0;
        state.score = 0;
        state.magicCount = 0; // é‡ç½®é­”æ³•æ¬¡æ•¸
        state.startTime = Date.now();
        
        // é‡ç½®æ­·å²
        history = [];
        saveStateToHistory();
        
        // é‡æ–°æ¸²æŸ“
        render();
        startTimer();
        updateTimer();
        updateScoreDisplay();
        
        showMessage("éŠæˆ²å·²é‡æ–°é–‹å§‹", 1500);
    }
    
    // ==================== è¨ˆæ™‚å™¨ç›¸é—œå‡½æ•¸ ====================
    /**
     * é–‹å§‹è¨ˆæ™‚å™¨
     */
    function startTimer() {
        if (state.timerInterval) clearInterval(state.timerInterval); // æ¸…é™¤ç¾æœ‰è¨ˆæ™‚å™¨
        state.startTime = Date.now(); // è¨˜éŒ„é–‹å§‹æ™‚é–“
        state.timerInterval = setInterval(updateTimer, 1000); // æ¯ç§’æ›´æ–°ä¸€æ¬¡
    }
    
    /**
     * æ›´æ–°è¨ˆæ™‚å™¨é¡¯ç¤º
     */
    function updateTimer() {
        if (!state.startTime) return;
        
        // è¨ˆç®—ç¶“éçš„æ™‚é–“
        const elapsed = Date.now() - state.startTime;
        const minutes = Math.floor(elapsed / 60000); // è¨ˆç®—åˆ†é˜
        const seconds = Math.floor((elapsed % 60000) / 1000); // è¨ˆç®—ç§’æ•¸
        
        // æ ¼å¼åŒ–æ­¥æ•¸ç‚º4ä½æ•¸å­—ï¼Œå‰é¢è£œé›¶
        const formattedMoves = state.moves.toString().padStart(4, '0');
        
        // æ›´æ–°æ™‚é–“å’Œæ­¥æ•¸é¡¯ç¤º
        const timeMovesElement = document.getElementById('time-moves');
        if (timeMovesElement) {
            timeMovesElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} | ${formattedMoves}æ­¥`;
        }
    }
    
    /**
     * åœæ­¢è¨ˆæ™‚å™¨
     */
    function stopTimer() {
        if (state.timerInterval) {
            clearInterval(state.timerInterval);
            state.timerInterval = null;
        }
    }
    
    // ==================== éŠæˆ²åˆå§‹åŒ–å‡½æ•¸ ====================
    /**
     * åˆå§‹åŒ–éŠæˆ²ï¼ˆä½¿ç”¨å¯è§£ç‰Œå±€ç”Ÿæˆå™¨ï¼‰
     */
    function initGame(mode = 'guaranteed') {
        // å…ˆåœæ­¢å¯èƒ½å­˜åœ¨çš„è¨ˆæ™‚å™¨
        if (state.timerInterval) {
            clearInterval(state.timerInterval);
            state.timerInterval = null;
        }
        
        
        // åœæ­¢ç…™èŠ±æ•ˆæœ
        stopFireworks();
        
        // åœæ­¢è‡ªå‹•é£›ç‰Œ
        stopAutoFly();
        
        state.gameMode = mode; // è¨­å®šéŠæˆ²æ¨¡å¼
        state.moves = 0; // é‡ç½®ç§»å‹•æ¬¡æ•¸
        state.score = 0; // é‡ç½®åˆ†æ•¸ç‚º0
        state.magicCount = 0; // é‡ç½®é­”æ³•ä½¿ç”¨æ¬¡æ•¸
        history = []; // æ¸…ç©ºæ­·å²ç´€éŒ„
        updateUndoButton(); // æ›´æ–°æ’¤å›æŒ‰éˆ•ç‹€æ…‹
        updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
        
        let gameState = null;
        if (mode === 'guaranteed') {
            gameState = createVerifiedSolvableDeck(); // ä½¿ç”¨å„ªåŒ–ç‰Œå±€ç”Ÿæˆå™¨
        } else {
            // å‚™ç”¨æ¨¡å¼ï¼ˆæ­£å¸¸éš¨æ©Ÿï¼‰
            gameState = createRandomDeck();
        }

        // é‡ç½®éŠæˆ²ç‹€æ…‹
        state.stock = gameState.stock || [];
        state.waste = gameState.waste || [];
        state.foundations = [[], [], [], []];
        state.tableau = gameState.tableau || [[], [], [], [], [], [], []];

        console.log("éŠæˆ²åˆå§‹åŒ–å®Œæˆï¼š");
        console.log("- è¡¨æ ¼ç‰Œæ•¸ï¼š", state.tableau.map(pile => pile.length));
        console.log("- ç‰Œå †ç‰Œæ•¸ï¼š", state.stock.length);
        
        // å„²å­˜åˆå§‹éŠæˆ²ç‹€æ…‹ç”¨æ–¼é‡ç©
        initialGameState = {
            stock: JSON.parse(JSON.stringify(state.stock)),
            waste: JSON.parse(JSON.stringify(state.waste)),
            foundations: JSON.parse(JSON.stringify(state.foundations)),
            tableau: JSON.parse(JSON.stringify(state.tableau))
        };
        
        saveStateToHistory(); // å„²å­˜åˆå§‹ç‹€æ…‹åˆ°æ­·å²ç´€éŒ„
        layoutSlots(); // ä½ˆå±€æ§½ä½
        render(); // æ¸²æŸ“éŠæˆ²ç•«é¢
        startTimer(); // é–‹å§‹è¨ˆæ™‚
        updateTimer(); // æ›´æ–°æ™‚é–“é¡¯ç¤º
        updateScoreDisplay(); // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
    }
    
    // ==================== æ­·å²ç´€éŒ„ç›¸é—œå‡½æ•¸ ====================
    /**
     * å„²å­˜ç•¶å‰éŠæˆ²ç‹€æ…‹åˆ°æ­·å²ç´€éŒ„
     */
    function saveStateToHistory() {
        const stateCopy = {
            stock: JSON.parse(JSON.stringify(state.stock)), // æ·±æ‹·è²ç‰Œå †
            waste: JSON.parse(JSON.stringify(state.waste)), // æ·±æ‹·è²å»¢ç‰Œå †
            foundations: JSON.parse(JSON.stringify(state.foundations)), // æ·±æ‹·è²èŠ±è‰²å€
            tableau: JSON.parse(JSON.stringify(state.tableau)), // æ·±æ‹·è²è¡¨æ ¼
            moves: state.moves, // ç§»å‹•æ¬¡æ•¸
            gameMode: state.gameMode, // éŠæˆ²æ¨¡å¼
            startTime: state.startTime, // é–‹å§‹æ™‚é–“
            score: state.score, // åˆ†æ•¸
            drawMode: state.drawMode, // ç¿»ç‰Œæ¨¡å¼
            handMode: state.handMode, // æ‰‹åˆ¥æ¨¡å¼
            autoFlyEnabled: state.autoFlyEnabled, // è‡ªå‹•é£›ç‰Œè¨­å®š
            magicCount: state.magicCount // é­”æ³•ä½¿ç”¨æ¬¡æ•¸
        };
        history.push(stateCopy); // åŠ å…¥æ­·å²ç´€éŒ„
        updateUndoButton(); // æ›´æ–°æ’¤å›æŒ‰éˆ•ç‹€æ…‹
        updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
    }
    
    /**
     * æ’¤å›ä¸Šä¸€æ­¥ç§»å‹•
     */
    function undoMove() {
        if (isAnimating || isAutoFlying ) return; // å‹•ç•«ä¸­æˆ–è‡ªå‹•é£›ç‰Œä¸­æˆ–AIè¨—ç®¡ä¸­ç¦æ­¢æ’¤å›
        if (history.length <= 1) return; // æ²’æœ‰æ­·å²ç´€éŒ„å¯æ’¤å›
        history.pop(); // ç§»é™¤ç•¶å‰ç‹€æ…‹
        const prevState = history[history.length - 1]; // å–å¾—ä¸Šä¸€å€‹ç‹€æ…‹
        
        // æ¢å¾©ä¸Šä¸€å€‹ç‹€æ…‹
        state.stock = JSON.parse(JSON.stringify(prevState.stock));
        state.waste = JSON.parse(JSON.stringify(prevState.waste));
        state.foundations = JSON.parse(JSON.stringify(prevState.foundations));
        state.tableau = JSON.parse(JSON.stringify(prevState.tableau));
        state.moves = prevState.moves;
        state.gameMode = prevState.gameMode;
        state.startTime = prevState.startTime;
        state.score = prevState.score;
        state.drawMode = prevState.drawMode;
        state.handMode = prevState.handMode;
        state.autoFlyEnabled = prevState.autoFlyEnabled;
        state.magicCount = prevState.magicCount; // æ¢å¾©é­”æ³•æ¬¡æ•¸
        
        updateUndoButton(); // æ›´æ–°æ’¤å›æŒ‰éˆ•ç‹€æ…‹
        updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
        render(); // é‡æ–°æ¸²æŸ“
        updateTimer(); // æ›´æ–°æ™‚é–“é¡¯ç¤º
        updateScoreDisplay(); // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
    }
    
    /**
     * æ›´æ–°æ’¤å›æŒ‰éˆ•ç‹€æ…‹
     */
    function updateUndoButton() {
        const isDisabled = history.length <= 1;
        document.getElementById('undo-btn').disabled = isDisabled;
        document.getElementById('mobile-undo-btn').disabled = isDisabled;
    }
    
    /**
     * æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹ - ä¿®æ”¹ç‚ºå‹•ç•«æœŸé–“ä¸ç¦ç”¨
     */
    function updateMagicButton() {
        // æª¢æŸ¥ä¸ƒåˆ—è¡¨æ ¼ä¸­æ˜¯å¦æœ‰æœªç¿»é–‹çš„ç‰Œ
        const hasFacedDownCards = state.tableau.some(pile => 
            pile.some(card => !card.faceUp)
        );
        // ä¿®æ”¹ï¼šåªåœ¨æ²’æœ‰è“‹ç‰Œæ™‚ç¦ç”¨ï¼Œå‹•ç•«æœŸé–“ä¸ç¦ç”¨
        const isDisabled = !hasFacedDownCards;
        document.getElementById('magic-btn').disabled = isDisabled;
        document.getElementById('mobile-magic-btn').disabled = isDisabled;
    }
    
    // ==================== è¨Šæ¯é¡¯ç¤ºå‡½æ•¸ ====================
    /**
     * é¡¯ç¤ºè¨Šæ¯
     * @param {string} text - è¨Šæ¯å…§å®¹
     * @param {number} duration - é¡¯ç¤ºæŒçºŒæ™‚é–“(æ¯«ç§’)
     */
    function showMessage(text, duration = 2000) {
        const messageEl = document.getElementById('message');
        messageEl.textContent = text;
        messageEl.style.display = 'block';
        setTimeout(() => {
            messageEl.style.display = 'none';
        }, duration);
    }
    
    // ==================== ç§»å‹•è¦å‰‡æª¢æŸ¥å‡½æ•¸ ====================
    /**
     * æª¢æŸ¥æ˜¯å¦å¯ä»¥ç§»å‹•åˆ°èŠ±è‰²å€
     * @param {Object} card - å¡ç‰‡ç‰©ä»¶
     * @param {Array} foundation - èŠ±è‰²å€é™£åˆ—
     * @returns {boolean} - æ˜¯å¦å¯ä»¥ç§»å‹•
     */
    function canMoveToFoundation(card, foundation) {
        if (foundation.length === 0) return card.rank === 1; // ç©ºçš„èŠ±è‰²å€åªèƒ½æ”¾Ace
        const topCard = foundation[foundation.length - 1]; // èŠ±è‰²å€æœ€ä¸Šé¢çš„ç‰Œ
        return card.suit === topCard.suit && card.rank === topCard.rank + 1; // åŒèŠ±è‰²ä¸”æ•¸å­—é€£çºŒ
    }
    
    /**
     * æª¢æŸ¥æ˜¯å¦å¯ä»¥ç§»å‹•åˆ°è¡¨æ ¼
     * @param {Object} card - å¡ç‰‡ç‰©ä»¶
     * @param {Array} tableauPile - è¡¨æ ¼åˆ—é™£åˆ—
     * @returns {boolean} - æ˜¯å¦å¯ä»¥ç§»å‹•
     */
    function canMoveToTableau(card, tableauPile) {
        if (tableauPile.length === 0) return card.rank === 13; // ç©ºçš„è¡¨æ ¼åˆ—åªèƒ½æ”¾King
        const topCard = tableauPile[tableauPile.length - 1]; // è¡¨æ ¼åˆ—æœ€ä¸Šé¢çš„ç‰Œ
        return card.color !== topCard.color && card.rank === topCard.rank - 1; // ä¸åŒé¡è‰²ä¸”æ•¸å­—é€£çºŒ
    }

    // ==================== ä½ˆå±€è¨ˆç®—å‡½æ•¸ ====================
    
    /**
     * ä½ˆå±€æ‰€æœ‰æ§½ä½
     */
    function layoutSlots() {
        const board = document.getElementById('game-board');
        const w = board.clientWidth; // éŠæˆ²å€åŸŸå¯¬åº¦
        
        // å»ºç«‹æ¸¬é‡å…ƒç´ è¨ˆç®—å¡ç‰‡å°ºå¯¸ - ä¿®æ­£ç‰ˆæœ¬
        const measure = document.createElement('div');
        measure.className = 'slot';
        measure.style.position = 'absolute';
        measure.style.visibility = 'hidden';
        board.appendChild(measure);
        
        // å¼·åˆ¶é‡æ–°è¨ˆç®—æ¨£å¼
        void measure.offsetWidth;
        
        // ä½¿ç”¨ getComputedStyle ç¢ºä¿ç²å–æ­£ç¢ºçš„å°ºå¯¸
        const computedStyle = getComputedStyle(measure);
        cardSize.width = parseFloat(computedStyle.width);
        cardSize.height = parseFloat(computedStyle.height);
        
        // å¦‚æœå°ºå¯¸ç‚º0ï¼Œä½¿ç”¨ CSS è®Šæ•¸è¨ˆç®—
        if (cardSize.width === 0 || cardSize.height === 0) {
            const rootStyle = getComputedStyle(document.documentElement);
            const cardWidth = rootStyle.getPropertyValue('--card-width').trim();
            const cardHeight = rootStyle.getPropertyValue('--card-height').trim();
            const maxW = rootStyle.getPropertyValue('--max-w').trim();
            const maxH = rootStyle.getPropertyValue('--max-h').trim();
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºç™¾åˆ†æ¯”å€¼
            if (cardWidth.includes('vw')) {
                const vwValue = parseFloat(cardWidth) / 100 * window.innerWidth;
                const maxWValue = parseFloat(maxW);
                cardSize.width = Math.min(vwValue, maxWValue);
            } else {
                cardSize.width = parseFloat(cardWidth);
            }
            
            if (cardHeight.includes('vw')) {
                const vwValue = parseFloat(cardHeight) / 100 * window.innerWidth;
                const maxHValue = parseFloat(maxH);
                cardSize.height = Math.min(vwValue, maxHValue);
            } else {
                cardSize.height = parseFloat(cardHeight);
            }
        }
        
        board.removeChild(measure);

        // æª¢æŸ¥æ˜¯å¦ç‚ºæ‰‹æ©Ÿç‰ˆ
        const isMobile = window.innerWidth < 600;
        if (isMobile) {
            // é™åˆ¶æ‰‹æ©Ÿä¸Šæœ€å¤§å¡ç‰‡å°ºå¯¸
            const maxCardWidth = Math.min(cardSize.width, 75); // å¾70å¢åŠ åˆ°75
            const maxCardHeight = Math.min(cardSize.height, 105); // å¾98å¢åŠ åˆ°105
            cardSize.width = maxCardWidth;
            cardSize.height = maxCardHeight;
        }

        // è¨ˆç®—é–“è·
        const gap = Math.max(0.5, (w - (cardSize.width * 7)) / 8); // æœ€å°é–“è·0.5px
        
        /**
         * è¨­å®šæ§½ä½ä½ç½®
         * @param {string} id - æ§½ä½ID
         * @param {number} x - Xåº§æ¨™
         * @param {number} y - Yåº§æ¨™
         */
        const setPos = (id, x, y) => {
            const el = document.getElementById(id);
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            // å„²å­˜ä½ç½®è³‡è¨Š
            slotPositions[id] = { 
                left: x, top: y, right: x + cardSize.width, bottom: y + cardSize.height,
                cx: x + cardSize.width/2, cy: y + cardSize.height/2
            };
        };

        // ä¸Šæ–¹å€åŸŸä½ˆå±€
        const topRowY = 10;
        
        // è¨ˆç®—ä¸‰å¼µç‰Œéœ€è¦çš„ç¸½å¯¬åº¦ï¼šå¡ç‰‡å¯¬åº¦ + 2 * (å¡ç‰‡å¯¬åº¦ * 0.3)
        const wasteTotalWidth = cardSize.width * (1 + 0.3 * 2);
        
        if (state.handMode === 'right') {
            // å³æ‰‹æ¨¡å¼ï¼šèŠ±è‰²å€åœ¨å·¦ï¼Œå»¢ç‰Œå †åœ¨ä¸­é–“ï¼ˆé å³ï¼‰ï¼Œç‰Œå †åœ¨æœ€å³é‚Š
            // 1. å››å€‹èŠ±è‰²å€ï¼ˆå®‰ç½®å€ï¼‰æ”¾åœ¨æœ€å·¦é‚Š
            for(let i=0; i<4; i++) {
                setPos(`slot-f${i}`, gap + i * (cardSize.width + gap), topRowY);
            }
            
            // 2. å»¢ç‰Œå †æ”¾åœ¨ç‰Œå †å·¦é‚Šï¼Œä½†è¦ç‚ºä¸‰å¼µç‰Œç•™å‡ºç©ºé–“ï¼Œå‘å·¦ç§»å‹•
            const wasteX = w - gap - cardSize.width - wasteTotalWidth - gap;
            setPos('slot-waste', wasteX, topRowY);
            
            // 3. ç‰Œå †ï¼ˆè“‹ç‰Œå€ï¼‰æ”¾åœ¨æœ€å³é‚Š
            const stockX = w - gap - cardSize.width;
            setPos('slot-stock', stockX, topRowY);
        } else {
            // å·¦æ‰‹æ¨¡å¼ï¼šç‰Œå †åœ¨å·¦ï¼Œå»¢ç‰Œå †åœ¨ç‰Œå †å³é‚Šï¼ŒèŠ±è‰²å€åœ¨å³é‚Š
            const stockX = gap;
            setPos('slot-stock', stockX, topRowY);
            
            const wasteX = stockX + cardSize.width + gap;
            setPos('slot-waste', wasteX, topRowY);
            
            const foundationsTotalWidth = 4 * cardSize.width + 3 * gap;
            const foundationsRight = w - gap;
            const foundationsLeft = foundationsRight - foundationsTotalWidth;
            
            for(let i=0; i<4; i++) {
                const foundationX = foundationsLeft + i * (cardSize.width + gap);
                setPos(`slot-f${i}`, foundationX, topRowY);
            }
        }
        
        // ä¸‹æ–¹ä¸ƒåˆ—è¡¨æ ¼ä½ˆå±€
        const tableauY = topRowY + cardSize.height + (isMobile ? 10 : 30); // æ‰‹æ©Ÿä¸Šæ¸›å°‘é–“è·
        for(let i=0; i<7; i++) {
            let x = gap * (i+1) + cardSize.width * i;
            setPos(`slot-t${i}`, x, tableauY);
        }
    }

    // ==================== æ¸²æŸ“å¼•æ“å‡½æ•¸ ====================
    /**
     * æ¸²æŸ“éŠæˆ²ç•«é¢
     */
    function render() {
        const layer = document.getElementById('card-layer');
        layer.innerHTML = ''; // æ¸…ç©ºåœ–å±¤

        /**
         * ç¹ªè£½å–®å¼µå¡ç‰‡
         * @param {Object} card - å¡ç‰‡ç‰©ä»¶
         * @param {number} x - Xåº§æ¨™
         * @param {number} y - Yåº§æ¨™
         * @param {string} type - å¡ç‰‡é¡å‹
         * @param {number} pileIdx - æ‰€åœ¨å †ç–Šç´¢å¼•
         * @param {number} cardIdx - å¡ç‰‡åœ¨å †ç–Šä¸­çš„ç´¢å¼•
         * @param {boolean} isWaste - æ˜¯å¦ç‚ºå»¢ç‰Œå †å¡ç‰‡
         * @param {number} wasteOffset - å»¢ç‰Œå †åç§»é‡
         */
        const drawCard = (card, x, y, type, pileIdx, cardIdx, isWaste = false, wasteOffset = 0) => {
            const div = document.createElement('div');
            div.className = `card ${card.faceUp ? '' : 'back'}`;
            
            // è¨ˆç®—å¡ç‰‡ä½ç½®
            let finalX = x;
            if (isWaste && wasteOffset > 0) {
                finalX += wasteOffset;
            }
            
            div.style.left = finalX + 'px';
            div.style.top = y + 'px';
            div.dataset.id = card.id;
            div.dataset.type = type;
            div.dataset.pileIdx = pileIdx;
            div.dataset.cardIdx = cardIdx;
            div.dataset.text = card.text; // æ·»åŠ ç‰Œé¢æ–‡å­—ç”¨æ–¼CSSé¸æ“‡å™¨

            if (card.faceUp) {
                div.classList.add(card.color);
                div.innerHTML = `
                    <div class="card-face">
                        <div class="card-num ${card.color}">${card.text}</div>
                        <div class="card-suit-top ${card.color}">${card.suit}</div>
                        <div class="card-center-suit ${card.color}">${card.suit}</div>
                    </div>
                `;
                
                // æ·»åŠ æ‹–æ›³äº‹ä»¶ç›£è½å™¨
                if (type !== 'waste' || cardIdx === state.waste.length - 1) {
                    div.addEventListener('mousedown', (e) => startDrag(e, type, pileIdx, cardIdx));
                    div.addEventListener('touchstart', (e) => startDrag(e, type, pileIdx, cardIdx), {passive: false});
                }
                
            } else {
                // èƒŒé¢æœä¸Šçš„å¡ç‰‡æ·»åŠ é»æ“Šäº‹ä»¶
                if (type === 'stock') {
                    div.addEventListener('click', () => drawStockWithAnimation());
                } else if (type === 'tableau') {
                    const pile = state.tableau[pileIdx];
                    if (cardIdx === pile.length - 1) {
                        div.addEventListener('click', () => flipTableauCard(pileIdx));
                    }
                }
            }
            layer.appendChild(div);
        };

        // ç¹ªè£½ç‰Œå †
        const sPos = slotPositions['slot-stock'];
        if (state.stock.length > 0) {
            // å‰µå»ºç‰Œå †å¡ç‰‡
            const stockDiv = document.createElement('div');
            stockDiv.className = 'card back';
            stockDiv.style.left = sPos.left + 'px';
            stockDiv.style.top = sPos.top + 'px';
            stockDiv.dataset.type = 'stock';
            
            // æ·»åŠ ç‰Œå †å‰©é¤˜æ•¸é‡é¡¯ç¤ºï¼ˆæ ¹æ“šè¨­å®šæ±ºå®šæ˜¯å¦é¡¯ç¤ºï¼‰
            if (state.showCardCount) {
                const countDiv = document.createElement('div');
                countDiv.className = 'card-count';
                countDiv.textContent = state.stock.length;
                stockDiv.appendChild(countDiv);
            }
            
            stockDiv.addEventListener('click', () => drawStockWithAnimation());
            layer.appendChild(stockDiv);
        } else {
            // ç‰Œå †ç‚ºç©ºæ™‚é¡¯ç¤ºé‡æ–°æ•´ç†æŒ‰éˆ•
            const emptyStock = document.createElement('div');
            emptyStock.style.cssText = `position:absolute; left:${sPos.left}px; top:${sPos.top}px; width:${cardSize.width}px; height:${cardSize.height}px;`;
            emptyStock.innerHTML = '<div class="refresh-btn">â†º</div>';
            emptyStock.addEventListener('click', resetStock);
            layer.appendChild(emptyStock);
        }

        // ç¹ªè£½å»¢ç‰Œå †
        const wPos = slotPositions['slot-waste'];
        const wasteLen = state.waste.length;
        
        if (wasteLen > 0) {
            if (state.drawMode === 3 && wasteLen >= 3) {
                // ä¸‰å¼µæ¨¡å¼ï¼šé¡¯ç¤ºæœ€è¿‘çš„ä¸‰å¼µç‰Œ
                const displayCards = state.waste.slice(-3); // å–æœ€å¾Œä¸‰å¼µç‰Œ
                
                for (let i = 0; i < 3; i++) {
                    const card = displayCards[i];
                    const offset = i * (cardSize.width * 0.3);
                    drawCard(card, wPos.left, wPos.top, 'waste', 0, wasteLen-3+i, true, offset);
                }
            } else if (state.drawMode === 3 && wasteLen < 3) {
                for (let i = 0; i < wasteLen; i++) {
                    const card = state.waste[i];
                    const offset = i * (cardSize.width * 0.3);
                    drawCard(card, wPos.left, wPos.top, 'waste', 0, i, true, offset);
                }
            } else {
                // ä¸€å¼µæ¨¡å¼ï¼šåªé¡¯ç¤ºæœ€ä¸Šé¢çš„ä¸€å¼µç‰Œ
                const topWasteCard = state.waste[wasteLen - 1];
                drawCard(topWasteCard, wPos.left, wPos.top, 'waste', 0, wasteLen - 1);
            }
        }

        // ç¹ªè£½å››å€‹èŠ±è‰²å€
        for(let i=0; i<4; i++) {
            const pos = slotPositions[`slot-f${i}`];
            const pile = state.foundations[i];
            if (pile.length > 0) {
                drawCard(pile[pile.length-1], pos.left, pos.top, 'foundation', i, pile.length-1);
            }
        }

        // ç¹ªè£½ä¸ƒåˆ—è¡¨æ ¼
        for(let i=0; i<7; i++) {
            const pos = slotPositions[`slot-t${i}`];
            const pile = state.tableau[i];
            let currentOffset = 0; // ç•¶å‰åç§»é‡
            pile.forEach((card, idx) => {
                if (idx > 0) {
                    const prevCard = pile[idx - 1];
                    
                    // åˆ†é–‹æ‰‹æ©Ÿç‰ˆå’Œç¶²é ç‰ˆçš„é‡ç–Šæ¯”ä¾‹è¨ˆç®—é‚è¼¯
                    let overlapRatio;
                    const isMobile = window.innerWidth < 600;
                    
                    if (isMobile) {
                        if (prevCard.faceUp) {
                            overlapRatio = card.faceUp ? 0.5 : 0.9;
                        } else {
                            overlapRatio = 0.9;
                        }
                    } else {
                        if (prevCard.faceUp) {
                            overlapRatio = card.faceUp ? 0.7 : 0.9;
                        } else {
                            overlapRatio = 0.9;
                        }
                    }
                    
                    currentOffset += cardSize.height * (1 - overlapRatio); // è¨ˆç®—åç§»é‡
                }
                drawCard(card, pos.left, pos.top + currentOffset, 'tableau', i, idx);
            });
        }
        
        // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
        updateMagicButton();
    }
    
    /**
     * ç¿»é–‹è¡¨æ ¼ä¸­çš„å¡ç‰‡
     * @param {number} pileIdx - è¡¨æ ¼åˆ—ç´¢å¼•
     */
    function flipTableauCard(pileIdx) {
        if (isAnimating || isAutoFlying ) return;
        const pile = state.tableau[pileIdx];
        if (pile.length > 0) {
            const topCard = pile[pile.length - 1];
            if (!topCard.faceUp) {
                // æ’­æ”¾ç¿»ç‰ŒéŸ³æ•ˆ
                playFlipSound();
                
                topCard.faceUp = true; // ç¿»é–‹å¡ç‰‡
                state.moves++; // å¢åŠ ç§»å‹•æ¬¡æ•¸
                addScore(5); // ç¿»é–‹ä¸€å¼µç‰Œå¾—5åˆ†
                saveStateToHistory(); // å„²å­˜ç‹€æ…‹
                render(); // é‡æ–°æ¸²æŸ“
                updateTimer(); // æ›´æ–°è¨ˆæ™‚å™¨
                updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
                // æª¢æŸ¥æ˜¯å¦è§¸ç™¼è‡ªå‹•é£›ç‰Œ
                checkAutoFlyAfterMove();
            }
        }
    }

    // ==================== ç¿»ç‰Œå‹•ç•«é‚è¼¯ ====================
    
    /**
     * å¾ç‰Œå †æŠ½ç‰Œï¼ˆå¸¶å‹•ç•«ï¼‰
     */
    function drawStockWithAnimation() {
        if (isDrawing || isAutoFlying) return; // åªæª¢æŸ¥ç¿»ç‰Œå‹•ç•«ç‹€æ…‹å’Œè‡ªå‹•é£›ç‰Œç‹€æ…‹
        if (state.stock.length === 0) return;
        
        isDrawing = true; // æ¨™è¨˜ç¿»ç‰Œå‹•ç•«é–‹å§‹
        
        const drawCount = Math.min(state.drawMode, state.stock.length); // å¯¦éš›è¦ç¿»é–‹çš„ç‰Œæ•¸
        
        // å…ˆå¾ç‰Œå †ä¸­å–å‡ºç‰Œï¼Œä¿æŒæ­£ç¢ºçš„é †åº
        const cardsToDraw = [];
        for (let i = 0; i < drawCount; i++) {
            // å¾ç‰Œå †é ‚éƒ¨å–ç‰Œï¼ˆæœ€å¾Œä¸€å¼µæ˜¯æœ€ä¸Šé¢çš„ç‰Œï¼‰
            const cardIndex = state.stock.length - 1 - i;
            cardsToDraw.unshift(state.stock[cardIndex]); // ä½¿ç”¨ unshift ç¢ºä¿é †åºæ­£ç¢º
        }
        
        // å¾éŠæˆ²ç‹€æ…‹ä¸­ç§»é™¤é€™äº›ç‰Œï¼ˆç«‹å³æ›´æ–°ç‹€æ…‹ï¼‰
        for (let i = 0; i < drawCount; i++) {
            state.stock.pop();
        }
        
        // ç«‹å³é‡æ–°æ¸²æŸ“ï¼Œæ¶ˆé™¤è“‹ç‰Œå€çš„ç‰ŒèƒŒ
        render();
        
        // å–å¾—ç‰Œå †å’Œå»¢ç‰Œå †çš„è¦–çª—åº§æ¨™ï¼ˆåœ¨é‡æ–°æ¸²æŸ“å¾Œç²å–ï¼‰
        const stockSlot = document.getElementById('slot-stock');
        const wasteSlot = document.getElementById('slot-waste');
        
        if (!stockSlot || !wasteSlot) {
            isDrawing = false;
            return;
        }
        
        const stockRect = stockSlot.getBoundingClientRect();
        const wasteRect = wasteSlot.getBoundingClientRect();
        
        // ç‚ºæ¯å¼µç‰Œå‰µå»ºå‹•ç•«å¡ç‰‡
        const animationCards = [];
        
        // å‰µå»ºå‹•ç•«å¡ç‰‡ï¼Œå¾æœ€èˆŠçš„ç‰Œé–‹å§‹å‹•ç•«
        for (let i = 0; i < drawCount; i++) {
            const card = cardsToDraw[i];
            const animCard = document.createElement('div');
            animCard.className = `card draw-animation-card back`;
            animCard.style.left = stockRect.left + 'px';
            animCard.style.top = stockRect.top + 'px';
            animCard.style.width = stockRect.width + 'px';
            animCard.style.height = stockRect.height + 'px';
            
            // æ·»åŠ data-textå±¬æ€§ï¼Œä»¥ä¾¿CSSæ¨£å¼æ­£ç¢ºæ‡‰ç”¨
            animCard.dataset.text = card.text;
            
            // ç¢ºä¿èƒŒæ™¯ç‚ºç™½è‰²
            animCard.style.backgroundColor = 'white';
            
            document.body.appendChild(animCard);
            animationCards.push({card, element: animCard, index: i});
        }
        
        // ä¿æŒé †åºï¼Œæœ€èˆŠçš„ç‰Œå…ˆå‹•ç•«ï¼Œæœ€æ–°çš„ç‰Œæœ€å¾Œå‹•ç•«
        animationCards.forEach((item, animIndex) => {
            const {card, element: animCard, index: originalIndex} = item;
            
            // å¼·åˆ¶ç€è¦½å™¨ Reflow ä»¥ç¢ºä¿å‹•ç•«ç™¼ç”Ÿ
            void animCard.offsetWidth;
            
            // è¨ˆç®—ç›®æ¨™ä½ç½®
            let targetLeft = wasteRect.left + (originalIndex * (cardSize.width * 0.3));
            let targetTop = wasteRect.top;
            
            // è¨­ç½®å‹•ç•«
            animCard.style.left = targetLeft + 'px';
            animCard.style.top = targetTop + 'px';
            
            // æ¯å¼µç‰Œå»¶é²50æ¯«ç§’ç¿»é¢ï¼Œæœ€èˆŠçš„ç‰Œå…ˆç¿»é¢
            setTimeout(() => {
                animCard.classList.remove('back');
                animCard.classList.add(card.color);
                
                // é‡å°æ•¸å­—10çš„ç‰¹æ®Šè™•ç† - åªåœ¨æ‰‹æ©Ÿç‰ˆæ‡‰ç”¨
                let numHtml = `<div class="card-num ${card.color}">${card.text}</div>`;
                const isMobile = window.innerWidth < 600;
                if (card.text === "10" && isMobile) {
                    // å¦‚æœæ˜¯10ä¸”æ˜¯æ‰‹æ©Ÿç‰ˆï¼Œæ·»åŠ ç‰¹æ®Šçš„CSSé¡
                    numHtml = `<div class="card-num ${card.color}" style="font-size: 2.5rem; transform: scaleX(0.75); transform-origin: left top; left: 0.8px;">${card.text}</div>`;
                } else if (card.text === "10") {
                    // å¦‚æœæ˜¯10ä¸”æ˜¯æ¡Œé¢ç‰ˆï¼Œä½¿ç”¨æ­£å¸¸æ¨£å¼
                    numHtml = `<div class="card-num ${card.color}" style="font-size: 1.8rem;">${card.text}</div>`;
                }
                
                animCard.innerHTML = `
                    <div class="card-face">
                        ${numHtml}
                        <div class="card-suit-top ${card.color}">${card.suit}</div>
                        <div class="card-center-suit ${card.color}">${card.suit}</div>
                    </div>
                `;
                
                // æ’­æ”¾ç¿»ç‰ŒéŸ³æ•ˆ
                playFlipSound();
            }, animIndex * 50);
        });
        
        // å‹•ç•«å®Œæˆå¾Œæ›´æ–°éŠæˆ²ç‹€æ…‹
        setTimeout(() => {
            // ç§»é™¤å‹•ç•«å¡ç‰‡
            animationCards.forEach(item => item.element.remove());
            
            // å°‡å–å‡ºçš„ç‰ŒåŠ å…¥å»¢ç‰Œå †
            cardsToDraw.forEach(card => {
                card.faceUp = true;
                state.waste.push(card); // push ç¢ºä¿æœ€æ–°çš„ç‰Œåœ¨æœ€å¾Œï¼ˆæœ€ä¸Šé¢ï¼‰
            });
            
            state.moves++; // å¢åŠ ç§»å‹•æ¬¡æ•¸
            addScore(5 * drawCount); // æ¯å¼µç‰Œå¾—5åˆ†
            saveStateToHistory(); // å„²å­˜ç‹€æ…‹
            render(); // é‡æ–°æ¸²æŸ“
            updateTimer(); // æ›´æ–°è¨ˆæ™‚å™¨
            
            isDrawing = false; // æ¨™è¨˜ç¿»ç‰Œå‹•ç•«çµæŸ
            updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
            // æª¢æŸ¥æ˜¯å¦è§¸ç™¼è‡ªå‹•é£›ç‰Œ
            checkAutoFlyAfterMove();
        }, 400 + (drawCount * 50));
    }

    /**
     * é‡ç½®ç‰Œå †ï¼ˆå°‡å»¢ç‰Œå †æ”¾å›ç‰Œå †ï¼‰
     */
    function resetStock() {
        if (isDrawing || isAutoFlying) return; // åªæª¢æŸ¥ç¿»ç‰Œå‹•ç•«ç‹€æ…‹
        if (state.waste.length === 0) return;
        
        // åœ¨ä¸‰å¼µæ¨¡å¼ä¸‹ï¼Œéœ€è¦ä¿æŒå»¢ç‰Œå †çš„é †åº
        // ç¶“å…¸æ¥é¾è¦å‰‡ï¼šç•¶ç‰Œå †ç”¨å®Œæ™‚ï¼Œå°‡å»¢ç‰Œå †çš„ç‰Œç¿»è½‰å¾Œé‡æ–°æˆç‚ºç‰Œå †ï¼Œé †åºä¸è®Š
        state.stock = state.waste.reverse().map(c => { 
            c.faceUp = false; // å°‡ç‰Œé¢æœä¸‹
            return c; 
        });
        state.waste = []; // æ¸…ç©ºå»¢ç‰Œå †
        state.moves++; // å¢åŠ ç§»å‹•æ¬¡æ•¸
        addScore(-100); // é‡æ–°å¾ªç’°å»¢ç‰Œå †æ‰£100åˆ†
        saveStateToHistory(); // å„²å­˜ç‹€æ…‹
        render(); // é‡æ–°æ¸²æŸ“
        updateTimer(); // æ›´æ–°è¨ˆæ™‚å™¨
        updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
        // æª¢æŸ¥æ˜¯å¦è§¸ç™¼è‡ªå‹•é£›ç‰Œ
        checkAutoFlyAfterMove();
    }

    // ==================== è‡ªå‹•ç§»å‹•å‹•ç•«å‡½æ•¸ ====================
    /**
     * åŸ·è¡Œå¡ç‰‡ç§»å‹•å‹•ç•« - ä¿®å¾©ï¼šç‚ºå¤šå¼µç‰Œæ­£ç¢ºè¨ˆç®—ç›®æ¨™ä½ç½®åç§»
     * @param {Array} cards - è¦ç§»å‹•çš„å¡ç‰‡é™£åˆ—
     * @param {Object} sourceRect - ä¾†æºä½ç½®çŸ©å½¢
     * @param {Object} targetRect - ç›®æ¨™ä½ç½®çŸ©å½¢ï¼ˆç¬¬ä¸€å¼µç‰Œçš„ä½ç½®ï¼‰
     * @param {Function} onComplete - å‹•ç•«å®Œæˆå¾Œçš„å›å‘¼å‡½æ•¸
     * @param {string} moveType - ç§»å‹•é¡å‹ ('tableau', 'foundation', 'waste')
     * @param {number} overlapRatio - é‡ç–Šæ¯”ä¾‹ï¼ˆå¯é¸ï¼Œå¦‚æœæœªæä¾›å‰‡æ ¹æ“šè¨­å‚™è¨ˆç®—ï¼‰
     */
    function animateMove(cards, sourceRect, targetRect, onComplete, moveType = 'tableau', overlapRatio = null) {
        isAnimating = true; // æ¨™è¨˜å‹•ç•«é–‹å§‹
        const ghosts = []; // å¹½éˆå¡ç‰‡é™£åˆ—
        
        // åˆ†é–‹æ‰‹æ©Ÿç‰ˆå’Œç¶²é ç‰ˆçš„é‡ç–Šæ¯”ä¾‹
        const isMobile = window.innerWidth < 600;
        const actualOverlapRatio = overlapRatio !== null ? overlapRatio : (isMobile ? 0.5 : 0.7);
        
        // è¨ˆç®—æ¯å¼µç‰Œä¹‹é–“çš„é–“è·ï¼ˆéœ²å‡ºéƒ¨åˆ†çš„é«˜åº¦ï¼‰
        // ä¿®æ­£ï¼šé‡ç–Šæ¯”ä¾‹ç‚º0.7æ„å‘³è‘—é‡ç–Š70%ï¼Œéœ²å‡º30%
        const spacingHeight = cardSize.height * (1 - actualOverlapRatio);
        
        // å»ºç«‹å¹½éˆå¡ç‰‡
        cards.forEach((card, i) => {
            const ghost = document.createElement('div');
            ghost.className = `card flying-card ${card.color}`;
            ghost.style.backgroundColor = 'white'; // ç¢ºä¿èƒŒæ™¯ç‚ºç™½è‰²
            
            // æ·»åŠ data-textå±¬æ€§
            ghost.dataset.text = card.text;
            
            // é‡å°æ•¸å­—10çš„ç‰¹æ®Šè™•ç† - åªåœ¨æ‰‹æ©Ÿç‰ˆæ‡‰ç”¨
            let numHtml = `<div class="card-num ${card.color}">${card.text}</div>`;
            if (card.text === "10" && isMobile) {
                // å¦‚æœæ˜¯10ä¸”æ˜¯æ‰‹æ©Ÿç‰ˆï¼Œæ·»åŠ ç‰¹æ®Šçš„CSSæ¨£å¼
                numHtml = `<div class="card-num ${card.color}" style="font-size: 2.5rem; transform: scaleX(0.75); transform-origin: left top; left: 0.8px;">${card.text}</div>`;
            } else if (card.text === "10") {
                // å¦‚æœæ˜¯10ä¸”æ˜¯æ¡Œé¢ç‰ˆï¼Œä½¿ç”¨æ­£å¸¸æ¨£å¼
                numHtml = `<div class="card-num ${card.color}" style="font-size: 1.8rem;">${card.text}</div>`;
            }
            
            ghost.innerHTML = `
                <div class="card-face">
                    ${numHtml}
                    <div class="card-suit-top ${card.color}">${card.suit}</div>
                    <div class="card-center-suit ${card.color}">${card.suit}</div>
                </div>
            `;
            
            // è¨ˆç®—å †ç–Šåç§»é‡
            const ghostOffset = i * spacingHeight;
            
            // è¨­å®šåˆå§‹ä½ç½®
            ghost.style.left = sourceRect.left + 'px';
            ghost.style.top = (sourceRect.top + ghostOffset) + 'px';
            ghost.style.width = cardSize.width + 'px';
            ghost.style.height = cardSize.height + 'px';
            
            document.body.appendChild(ghost);
            ghosts.push({ghost, offset: ghostOffset});
        });

        // å¼·åˆ¶ç€è¦½å™¨ Reflow ä»¥ç¢ºä¿å‹•ç•«ç™¼ç”Ÿ
        void ghosts[0].ghost.offsetWidth;

        // è¨­å®šç›®æ¨™ä½ç½® - ä¿®å¾©ï¼šæ¯å¼µç‰Œéƒ½æœ‰æ­£ç¢ºçš„åç§»
        ghosts.forEach((item) => {
            const {ghost, offset} = item;
            
            ghost.style.left = targetRect.left + 'px';
            ghost.style.top = (targetRect.top + offset) + 'px';
        });

        // æ ¹æ“šç§»å‹•é¡å‹æ’­æ”¾å°æ‡‰éŸ³æ•ˆ
        if (moveType === 'foundation') {
            playFoundationSound();
        } else {
            playMoveSound();
        }

        // å‹•ç•«çµæŸå¾Œæ¸…ç†
        setTimeout(() => {
            ghosts.forEach(g => g.ghost.remove()); // ç§»é™¤å¹½éˆå¡ç‰‡
            isAnimating = false; // æ¨™è¨˜å‹•ç•«çµæŸ
            if (onComplete) onComplete(); // åŸ·è¡Œå›å‘¼å‡½æ•¸
            updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
        }, 300); // é…åˆ CSS transition 0.3s
    }

    // ==================== é­”æ³•æŒ‰éˆ•åŠŸèƒ½ ====================
    /**
     * é­”æ³•ç§»å‹•ï¼šéš¨æ©Ÿç¿»é–‹ä¸€å¼µè“‹ç‰Œä¸¦ç§»å‹•åˆ°å»¢ç‰Œå †
     */
    function magicMove() {
        if (isDrawing || isAutoFlying) return; // åªæª¢æŸ¥ç¿»ç‰Œå‹•ç•«ç‹€æ…‹å’Œè‡ªå‹•é£›ç‰Œç‹€æ…‹
        
        // æ”¶é›†æ‰€æœ‰è“‹è‘—çš„ç‰Œï¼ˆåªæ”¶é›†æ¯åˆ—æœ€ä¸Šé¢ä¸€å¼µè“‹ç‰Œï¼‰
        const facedDownCards = [];
        for (let col = 0; col < 7; col++) {
            const pile = state.tableau[col];
            // æ‰¾åˆ°æ¯åˆ—æœ€ä¸Šé¢ä¸€å¼µè“‹ç‰Œ
            for (let i = pile.length - 1; i >= 0; i--) {
                if (!pile[i].faceUp) {
                    // ç¢ºä¿é€™æ˜¯è©²åˆ—æœ€ä¸Šé¢çš„è“‹ç‰Œï¼ˆä¸Šé¢æ²’æœ‰å…¶ä»–è“‹ç‰Œï¼‰
                    if (i === pile.length - 1 || pile[i+1].faceUp) {
                        facedDownCards.push({
                            card: pile[i],
                            pileIdx: col,
                            cardIdx: i,
                            pile: pile
                        });
                        break; // åªå–æœ€ä¸Šé¢ä¸€å¼µè“‹ç‰Œ
                    }
                }
            }
        }
        
        // å¦‚æœæ²’æœ‰è“‹è‘—çš„ç‰Œï¼Œç¦ç”¨æŒ‰éˆ•ä¸¦è¿”å›
        if (facedDownCards.length === 0) {
            updateMagicButton();
            showMessage("æ²’æœ‰å¯ç¿»é–‹çš„è“‹ç‰Œ", 1500);
            return;
        }
        
        // éš¨æ©Ÿé¸æ“‡ä¸€å¼µè“‹ç‰Œ
        const randomIndex = Math.floor(Math.random() * facedDownCards.length);
        const selected = facedDownCards[randomIndex];
        const { card, pileIdx, cardIdx, pile } = selected;
        
        // å…ˆå¾è¡¨æ ¼ä¸­ç§»é™¤å¡ç‰‡
        pile.splice(cardIdx, 1);
        
        // å¦‚æœè¡¨æ ¼åˆ—é‚„æœ‰ç‰Œï¼Œç¢ºä¿æœ€ä¸Šé¢ä¸€å¼µæ˜¯ç¿»é–‹çš„
        if (state.tableau[pileIdx].length > 0) {
            const newTopCard = state.tableau[pileIdx][state.tableau[pileIdx].length - 1];
            if (!newTopCard.faceUp) {
                newTopCard.faceUp = true;
            }
        }
        
        // ç«‹å³æ¸²æŸ“ä¸€æ¬¡ï¼Œè®“è“‹ç‰Œæ¶ˆå¤±ï¼Œæ–°çš„ç‰Œç¿»é–‹
        render();
        
        isAnimating = true; // æ¨™è¨˜å‹•ç•«é–‹å§‹
        updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
        
        // å–å¾—å»¢ç‰Œå †ä½ç½®
        const wasteSlot = document.getElementById('slot-waste');
        if (!wasteSlot) return;
        
        const wasteRect = wasteSlot.getBoundingClientRect();
        
        // ç²å–é¸ä¸­å¡ç‰‡çš„ä½ç½®ï¼ˆæ³¨æ„ï¼šæ­¤æ™‚å¡ç‰‡å·²ç¶“å¾DOMä¸­ç§»é™¤ï¼Œæˆ‘å€‘éœ€è¦ä¹‹å‰è¨˜éŒ„çš„ä½ç½®ï¼‰
        // æˆ‘å€‘åœ¨æ›´æ–°ç‹€æ…‹å’Œæ¸²æŸ“ä¹‹å‰ï¼Œå…ˆç²å–å¡ç‰‡çš„ä½ç½®
        const cardElement = document.querySelector(`[data-id="${card.id}"]`);
        let sourceRect;
        if (cardElement) {
            sourceRect = cardElement.getBoundingClientRect();
        } else {
            // å¦‚æœå¡ç‰‡å…ƒç´ ä¸å­˜åœ¨ï¼Œå‰‡ä½¿ç”¨è©²åˆ—çš„slotä½ç½®ï¼ˆä¸ç²¾ç¢ºï¼Œä½†ä½œç‚ºå‚™ç”¨ï¼‰
            const slotEl = document.getElementById(`slot-t${pileIdx}`);
            if (slotEl) {
                sourceRect = slotEl.getBoundingClientRect();
            } else {
                // å¦‚æœéƒ½æ²’æœ‰ï¼Œå‰‡ä½¿ç”¨å»¢ç‰Œå †çš„ä½ç½®ï¼ˆé€™æ¨£å‹•ç•«å°±ä¸æœƒç§»å‹•ï¼‰
                sourceRect = wasteRect;
            }
        }
        
        // å‰µå»ºé­”æ³•å‹•ç•«å¡ç‰‡ï¼ˆå¸¶åŠ å¼·ç‰ˆé‡‘å…‰é–ƒé–ƒæ•ˆæœï¼‰
        const magicCard = document.createElement('div');
        magicCard.className = `card magic-animation-card back golden-glow`;
        magicCard.style.left = sourceRect.left + 'px';
        magicCard.style.top = sourceRect.top + 'px';
        magicCard.style.width = sourceRect.width + 'px';
        magicCard.style.height = sourceRect.height + 'px';
        
        // æ·»åŠ data-textå±¬æ€§
        magicCard.dataset.text = card.text;
        
        // ç¢ºä¿èƒŒæ™¯ç‚ºç™½è‰²
        magicCard.style.backgroundColor = 'white';
        
        document.body.appendChild(magicCard);
        
        // å¼·åˆ¶ç€è¦½å™¨ Reflow ä»¥ç¢ºä¿å‹•ç•«ç™¼ç”Ÿ
        void magicCard.offsetWidth;
        
        // è¨ˆç®—ç›®æ¨™ä½ç½®ï¼ˆå»¢ç‰Œå †æœ€å³é‚Šçš„ä½ç½®ï¼‰
        let targetLeft, targetTop;
        if (state.drawMode === 3 && state.waste.length >= 3) {
            // ä¸‰å¼µæ¨¡å¼ï¼Œå·²æœ‰ä¸‰å¼µç‰Œï¼Œæ–°ç‰Œæ”¾åœ¨æœ€å³é‚Š
            targetLeft = wasteRect.left + (2 * (cardSize.width * 0.3));
        } else if (state.drawMode === 3 && state.waste.length < 3) {
            // ä¸‰å¼µæ¨¡å¼ï¼Œç‰Œä¸å¤ ä¸‰å¼µï¼Œæ–°ç‰Œæ”¾åœ¨é©ç•¶ä½ç½®
            targetLeft = wasteRect.left + (state.waste.length * (cardSize.width * 0.3));
        } else {
            // ä¸€å¼µæ¨¡å¼ï¼Œæ–°ç‰Œæ”¾åœ¨å»¢ç‰Œå †ä½ç½®
            targetLeft = wasteRect.left;
        }
        targetTop = wasteRect.top;
        
        // è¨­ç½®å‹•ç•«
        magicCard.style.left = targetLeft + 'px';
        magicCard.style.top = targetTop + 'px';
        
        // å‹•ç•«ä¸­é€”ç¿»é–‹å¡ç‰‡
        setTimeout(() => {
            magicCard.classList.remove('back');
            magicCard.classList.add(card.color);
            
            // é‡å°æ•¸å­—10çš„ç‰¹æ®Šè™•ç† - åªåœ¨æ‰‹æ©Ÿç‰ˆæ‡‰ç”¨
            const isMobile = window.innerWidth < 600;
            let numHtml = `<div class="card-num ${card.color}">${card.text}</div>`;
            if (card.text === "10" && isMobile) {
                // å¦‚æœæ˜¯10ä¸”æ˜¯æ‰‹æ©Ÿç‰ˆï¼Œæ·»åŠ ç‰¹æ®Šçš„CSSæ¨£å¼
                numHtml = `<div class="card-num ${card.color}" style="font-size: 2.5rem; transform: scaleX(0.75); transform-origin: left top; left: 0.8px;">${card.text}</div>`;
            } else if (card.text === "10") {
                // å¦‚æœæ˜¯10ä¸”æ˜¯æ¡Œé¢ç‰ˆï¼Œä½¿ç”¨æ­£å¸¸æ¨£å¼
                numHtml = `<div class="card-num ${card.color}" style="font-size: 1.8rem;">${card.text}</div>`;
            }
            
            magicCard.innerHTML = `
                <div class="card-face">
                    ${numHtml}
                    <div class="card-suit-top ${card.color}">${card.suit}</div>
                    <div class="card-center-suit ${card.color}">${card.suit}</div>
                </div>
            `;
            
            // æ’­æ”¾ç¿»ç‰ŒéŸ³æ•ˆ
            playFlipSound();
        }, 250);
        
        // å‹•ç•«å®Œæˆå¾Œæ›´æ–°éŠæˆ²ç‹€æ…‹ï¼šå°‡ç‰Œæ·»åŠ åˆ°å»¢ç‰Œå †ï¼Œä¸¦æ›´æ–°åˆ†æ•¸ç­‰
        setTimeout(() => {
            // ç§»é™¤å‹•ç•«å¡ç‰‡
            magicCard.remove();
            
            // ç¿»é–‹å¡ç‰‡
            card.faceUp = true;
            
            // æ·»åŠ åˆ°å»¢ç‰Œå †ï¼ˆæœ€ä¸Šé¢ï¼‰
            state.waste.push(card);
            
            // æ›´æ–°éŠæˆ²ç‹€æ…‹
            state.moves++; // å¢åŠ ç§»å‹•æ¬¡æ•¸
            addScore(-20); // ä½¿ç”¨é­”æ³•æ‰£20åˆ†
            addMagicCount(); // å¢åŠ é­”æ³•ä½¿ç”¨æ¬¡æ•¸
            
            saveStateToHistory(); // å„²å­˜ç‹€æ…‹
            render(); // é‡æ–°æ¸²æŸ“ï¼Œè®“å»¢ç‰Œå †é¡¯ç¤ºé€™å¼µç‰Œ
            updateTimer(); // æ›´æ–°è¨ˆæ™‚å™¨
            
            isAnimating = false; // æ¨™è¨˜å‹•ç•«çµæŸ
            updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
            
            showMessage(`é­”æ³•ç™¼å‹•ï¼ç¿»é–‹äº†${card.text}${card.suit}`, 1500);
            // æª¢æŸ¥æ˜¯å¦è§¸ç™¼è‡ªå‹•é£›ç‰Œ
            checkAutoFlyAfterMove();
        }, 500);
    }
    
    // ==================== é›™æ“Šè‡ªå‹•ç§»å‹•é‚è¼¯ - ä¿®å¾©ï¼šæ­£ç¢ºè¨ˆç®—å¤šå¼µç‰Œçš„ç›®æ¨™ä½ç½® ====================
/**
 * è™•ç†é›™æ“Šäº‹ä»¶
 * @param {string} type - å¡ç‰‡é¡å‹
 * @param {number} pileIdx - å †ç–Šç´¢å¼•
 * @param {number} cardIdx - å¡ç‰‡ç´¢å¼•
 * @param {string} cardId - å¡ç‰‡ID
 */
function handleDoubleClick(type, pileIdx, cardIdx, cardId) {
    if (type === 'foundation') return;
    if (isDrawing || isAutoFlying) return;
    
    let sourcePile, card, cardsToMove = [];
    if (type === 'tableau') {
        sourcePile = state.tableau[pileIdx];
        if (cardIdx < 0 || cardIdx >= sourcePile.length) return;
        card = sourcePile[cardIdx];
        if (!card.faceUp) return;
        
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ç§»å‹•æ•´ç–Šç‰Œ
        for (let i = cardIdx + 1; i < sourcePile.length; i++) {
            if (!sourcePile[i].faceUp) {
                shakeCard(cardId);
                return;
            }
        }
        
        // å–å¾—è¦ç§»å‹•çš„æ‰€æœ‰ç‰Œï¼ˆå¾é»æ“Šçš„ç‰Œåˆ°æœ€å¾Œä¸€å¼µï¼‰
        cardsToMove = sourcePile.slice(cardIdx);
    } else if (type === 'waste') {
        sourcePile = state.waste;
        if (cardIdx !== sourcePile.length - 1) return; // åªèƒ½ç§»å‹•æœ€ä¸Šé¢çš„ç‰Œ
        card = sourcePile[cardIdx];
        cardsToMove = [card];
    } else {
        return;
    }

    // å–å¾—ä¾†æºä½ç½® (ç”¨æ–¼å‹•ç•«)
    const cardEl = document.querySelector(`[data-id="${cardId}"]`);
    if (!cardEl) return;
    const sourceRect = cardEl.getBoundingClientRect();
    
    // ==================== ä¿®æ”¹ï¼šæ ¹æ“šç‰Œæ•¸æ±ºå®šå„ªå…ˆç´š ====================
    
    // 1. å¦‚æœæ˜¯å–®å¼µç‰Œï¼Œå…ˆæª¢æŸ¥èŠ±è‰²å€
    if (cardsToMove.length === 1) {
        for (let i = 0; i < 4; i++) {
            const foundation = state.foundations[i];
            if (canMoveToFoundation(card, foundation)) {
                // èŠ±è‰²å€åªèƒ½ç§»å‹•æœ€ä¸Šé¢çš„å–®å¼µç‰Œ
                if (cardsToMove.length > 1) {
                    shakeCard(cardId); // ä¸èƒ½ç§»å‹•å¤šå¼µç‰Œåˆ°èŠ±è‰²å€
                    return;
                }
                
                // å¾åŸå§‹ä½ç½®ç§»é™¤ç‰Œ
                if (type === 'tableau') {
                    state.tableau[pileIdx].splice(cardIdx, 1);
                    // å¦‚æœé‚„æœ‰ç‰Œï¼Œç¿»é–‹æœ€ä¸Šé¢ä¸€å¼µ
                    if (state.tableau[pileIdx].length > 0) {
                        state.tableau[pileIdx][state.tableau[pileIdx].length - 1].faceUp = true;
                    }
                } else if (type === 'waste') {
                    state.waste.pop();
                }
                
                // ç«‹å³é‡æ–°æ¸²æŸ“ä»¥ç§»é™¤åŸå§‹ä½ç½®çš„ç‰Œ
                render();
                
                // å–å¾—ç›®æ¨™ä½ç½®
                const targetEl = document.getElementById(`slot-f${i}`);
                const targetRect = targetEl.getBoundingClientRect();
                
                // æ’­æ”¾å‹•ç•« - èŠ±è‰²å€ç§»å‹•ä½¿ç”¨é‡ç–Šæ¯”ä¾‹0
                animateMove(cardsToMove, sourceRect, targetRect, () => {
                    // å‹•ç•«çµæŸå¾Œå°‡ç‰Œæ·»åŠ åˆ°ç›®æ¨™ä½ç½®
                    state.foundations[i].push(...cardsToMove);
                    
                    state.moves++;
                    // æ ¹æ“šç§»å‹•é¡å‹åŠ åˆ†
                    if (type === 'waste') {
                        addScore(10); // å¾å»¢ç‰Œå †ç§»å‹•åˆ°èŠ±è‰²å€å¾—10åˆ†
                    } else {
                        addScore(10); // å¾è¡¨æ ¼åˆ—ç§»å‹•åˆ°èŠ±è‰²å€å¾—10åˆ†
                    }
                    saveStateToHistory();
                    render(); // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºç›®æ¨™ä½ç½®çš„ç‰Œ
                    updateTimer();
                    updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
                    checkWin(); // æª¢æŸ¥æ˜¯å¦ç²å‹
                    // æª¢æŸ¥æ˜¯å¦è§¸ç™¼è‡ªå‹•é£›ç‰Œ
                    checkAutoFlyAfterMove();
                }, 'foundation', 0); // èŠ±è‰²å€é‡ç–Šæ¯”ä¾‹ç‚º0
                return; 
            }
        }
    }
    
    // ==================== ä¿®æ”¹çµæŸ ====================
    
    // 2. ç„¡è«–å¦‚ä½•ï¼Œéƒ½æª¢æŸ¥ä¸ƒåˆ—è¡¨æ ¼ï¼ˆå–®å¼µç‰ŒèŠ±è‰²å€æª¢æŸ¥å¤±æ•—ï¼Œæˆ–å¤šå¼µç‰Œç›´æ¥æª¢æŸ¥ä¸ƒåˆ—è¡¨æ ¼ï¼‰
    for (let targetIdx = 0; targetIdx < 7; targetIdx++) {
        if (type === 'tableau' && targetIdx === pileIdx) continue;
        const targetPile = state.tableau[targetIdx];
        
        // ä¿®å¾©ï¼šç•¶å¡ç‰‡æ˜¯Kingä¸”ç›®æ¨™åˆ—æ˜¯ç©ºåˆ—æ™‚ï¼Œå…è¨±ç§»å‹•
        if (card.rank === 13 && targetPile.length === 0) {
            // å¾åŸå§‹ä½ç½®ç§»é™¤ç‰Œ
            if (type === 'tableau') {
                state.tableau[pileIdx].splice(cardIdx, cardsToMove.length);
                // å¦‚æœé‚„æœ‰ç‰Œï¼Œç¿»é–‹æœ€ä¸Šé¢ä¸€å¼µ
                if (state.tableau[pileIdx].length > 0) {
                    state.tableau[pileIdx][state.tableau[pileIdx].length - 1].faceUp = true;
                }
            } else if (type === 'waste') {
                state.waste.pop();
            }
            
            // ç«‹å³é‡æ–°æ¸²æŸ“ä»¥ç§»é™¤åŸå§‹ä½ç½®çš„ç‰Œ
            render();
            
            // å–å¾—ç›®æ¨™ä½ç½®
            const targetEl = document.getElementById(`slot-t${targetIdx}`);
            const targetRect = targetEl.getBoundingClientRect();
            
            // è¨ˆç®—é‡ç–Šæ¯”ä¾‹ - ç©ºåˆ—ä½¿ç”¨æ­£å¸¸é‡ç–Šæ¯”ä¾‹
            const isMobile = window.innerWidth < 600;
            const overlapRatio = isMobile ? 0.5 : 0.7; // æ‰‹æ©Ÿç‰ˆ0.5ï¼Œç¶²é ç‰ˆ0.7
            
            // æ’­æ”¾å‹•ç•« - ä½¿ç”¨æ­£ç¢ºçš„é‡ç–Šæ¯”ä¾‹
            animateMove(cardsToMove, sourceRect, targetRect, () => {
                // å‹•ç•«çµæŸå¾Œå°‡ç‰Œæ·»åŠ åˆ°ç›®æ¨™ä½ç½®
                state.tableau[targetIdx].push(...cardsToMove);
                
                state.moves++;
                // æ ¹æ“šç§»å‹•é¡å‹åŠ åˆ†
                if (type === 'waste') {
                    addScore(5); // å¾å»¢ç‰Œå †ç§»å‹•åˆ°è¡¨æ ¼åˆ—å¾—5åˆ†
                } else {
                    addScore(5 * cardsToMove.length); // å¾è¡¨æ ¼åˆ—ç§»å‹•åˆ°è¡¨æ ¼åˆ—ï¼Œæ¯å¼µç‰Œå¾—5åˆ†
                }
                saveStateToHistory();
                render(); // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºç›®æ¨™ä½ç½®çš„ç‰Œ
                updateTimer();
                updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
                checkWin(); // æª¢æŸ¥æ˜¯å¦ç²å‹
                // æª¢æŸ¥æ˜¯å¦è§¸ç™¼è‡ªå‹•é£›ç‰Œ
                checkAutoFlyAfterMove();
            }, 'tableau', overlapRatio);
            return;
        }
        
        // æ¨™æº–ç§»å‹•è¦å‰‡æª¢æŸ¥
        if (canMoveToTableau(card, targetPile)) {
            // å¾åŸå§‹ä½ç½®ç§»é™¤ç‰Œ
            if (type === 'tableau') {
                state.tableau[pileIdx].splice(cardIdx, cardsToMove.length);
                // å¦‚æœé‚„æœ‰ç‰Œï¼Œç¿»é–‹æœ€ä¸Šé¢ä¸€å¼µ
                if (state.tableau[pileIdx].length > 0) {
                    state.tableau[pileIdx][state.tableau[pileIdx].length - 1].faceUp = true;
                }
            } else if (type === 'waste') {
                state.waste.pop();
            }
            
            // ç«‹å³é‡æ–°æ¸²æŸ“ä»¥ç§»é™¤åŸå§‹ä½ç½®çš„ç‰Œ
            render();
            
            // è¨ˆç®—é‡ç–Šæ¯”ä¾‹
            let overlapRatio;
            const isMobile = window.innerWidth < 600;
            
            if (targetPile.length > 0) {
                const topCard = targetPile[targetPile.length - 1];
                if (topCard.faceUp) {
                    // ç›®æ¨™åˆ—æœ€ä¸Šé¢ä¸€å¼µç‰Œæ˜¯ç¿»é–‹çš„
                    // é‡ç–Šæ¯”ä¾‹ç‚º0.7æ„å‘³è‘—é‡ç–Š70%ï¼Œéœ²å‡º30%
                    overlapRatio = isMobile ? 0.5 : 0.7;
                } else {
                    // ç›®æ¨™åˆ—æœ€ä¸Šé¢ä¸€å¼µç‰Œæ˜¯è“‹è‘—çš„
                    // é‡ç–Šæ¯”ä¾‹ç‚º0.9æ„å‘³è‘—é‡ç–Š90%ï¼Œéœ²å‡º10%
                    overlapRatio = 0.9;
                }
            } else {
                // ç©ºåˆ—ï¼Œä½¿ç”¨æ­£å¸¸é‡ç–Šæ¯”ä¾‹
                overlapRatio = isMobile ? 0.5 : 0.7;
            }
            
            // è¨ˆç®—ç›®æ¨™ä½ç½®
            let targetRect;
            if (targetPile.length > 0) {
                const topCardId = targetPile[targetPile.length - 1].id;
                const topCardEl = document.querySelector(`[data-id="${topCardId}"]`);
                if (topCardEl) {
                    const rect = topCardEl.getBoundingClientRect();
                    // ç¬¬ä¸€å¼µç‰Œæ”¾åœ¨ç›®æ¨™åˆ—æœ€ä¸Šé¢ä¸€å¼µç‰Œçš„ä¸‹é¢
                    // é‡ç–Šæ¯”ä¾‹ç‚º0.7ï¼Œæ‰€ä»¥è·é›¢ = å¡ç‰‡é«˜åº¦ * (1 - 0.7) = å¡ç‰‡é«˜åº¦ * 0.3
                    targetRect = { 
                        left: rect.left, 
                        top: rect.top + (cardSize.height * (1 - overlapRatio))
                    };
                } else {
                    const slotEl = document.getElementById(`slot-t${targetIdx}`);
                    targetRect = slotEl.getBoundingClientRect();
                }
            } else {
                const slotEl = document.getElementById(`slot-t${targetIdx}`);
                targetRect = slotEl.getBoundingClientRect();
            }

            // æ’­æ”¾å‹•ç•« - ä½¿ç”¨æ­£ç¢ºçš„é‡ç–Šæ¯”ä¾‹
            animateMove(cardsToMove, sourceRect, targetRect, () => {
                // å‹•ç•«çµæŸå¾Œå°‡ç‰Œæ·»åŠ åˆ°ç›®æ¨™ä½ç½®
                state.tableau[targetIdx].push(...cardsToMove);
                
                state.moves++;
                // æ ¹æ“šç§»å‹•é¡å‹åŠ åˆ†
                if (type === 'waste') {
                    addScore(5); // å¾å»¢ç‰Œå †ç§»å‹•åˆ°è¡¨æ ¼åˆ—å¾—5åˆ†
                } else {
                    addScore(5 * cardsToMove.length); // å¾è¡¨æ ¼åˆ—ç§»å‹•åˆ°è¡¨æ ¼åˆ—ï¼Œæ¯å¼µç‰Œå¾—5åˆ†
                }
                saveStateToHistory();
                render(); // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºç›®æ¨™ä½ç½®çš„ç‰Œ
                updateTimer();
                updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
                checkWin(); // æª¢æŸ¥æ˜¯å¦ç²å‹
                // æª¢æŸ¥æ˜¯å¦è§¸ç™¼è‡ªå‹•é£›ç‰Œ
                checkAutoFlyAfterMove();
            }, 'tableau', overlapRatio);
            return;
        }
    }
    
    // 3. å¦‚æœéƒ½ä¸èƒ½ç§»å‹•ï¼Œå‰‡éœ‡å‹•å¡ç‰‡
    shakeCard(cardId);
}
    
    /**
     * éœ‡å‹•å¡ç‰‡æ•ˆæœ
     * @param {string} cardId - å¡ç‰‡ID
     */
    function shakeCard(cardId) {
        const cardElement = document.querySelector(`[data-id="${cardId}"]`);
        if (cardElement) {
            cardElement.classList.remove('shake');
            void cardElement.offsetWidth; // å¼·åˆ¶é‡ç¹ª
            cardElement.classList.add('shake');
            // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
            playErrorSound();
            setTimeout(() => { cardElement.classList.remove('shake'); }, 400);
        }
    }

    // ==================== æ‹–æ›³ç³»çµ±å‡½æ•¸ ====================
    /**
     * é–‹å§‹æ‹–æ›³
     * @param {Event} e - äº‹ä»¶ç‰©ä»¶
     * @param {string} type - å¡ç‰‡é¡å‹
     * @param {number} pileIdx - å †ç–Šç´¢å¼•
     * @param {number} cardIdx - å¡ç‰‡ç´¢å¼•
     */
    function startDrag(e, type, pileIdx, cardIdx) {
        if (isDrawing || isAutoFlying) return; // åªæª¢æŸ¥ç¿»ç‰Œå‹•ç•«ç‹€æ…‹å’Œè‡ªå‹•é£›ç‰Œç‹€æ…‹
        e.stopPropagation(); // åœæ­¢äº‹ä»¶å†’æ³¡
        
        const now = Date.now(); // ç•¶å‰æ™‚é–“
        
        // æ ¹æ“šé¡å‹å–å¾—ä¾†æºå †ç–Šå’Œå¡ç‰‡
        let sourcePile = (type === 'tableau') ? state.tableau[pileIdx] : (type === 'waste' ? state.waste : []);
        if (type === 'foundation') sourcePile = state.foundations[pileIdx];
        const clickedCard = sourcePile[cardIdx];
        if (!clickedCard) return;

        // å¦‚æœå–®æ“Šè‡ªå‹•ç§»å‹•æ¨¡å¼é–‹å•Ÿï¼Œå‰‡å˜—è©¦å–®æ“Šè‡ªå‹•ç§»å‹•
        if (autoMoveOnClick) {
            handleDoubleClick(type, pileIdx, cardIdx, clickedCard.id);
            return;
        }
        
        // é›™æ“Šæª¢æ¸¬
        if (clickedCard.id === lastClickCardId && now - lastClickTime < 350) {
            handleDoubleClick(type, pileIdx, cardIdx, clickedCard.id);
            lastClickCardId = null;
            lastClickTime = 0;
            return;
        }
        
        lastClickCardId = clickedCard.id;
        lastClickTime = now;

        if (drag.isDragging || drag.pending) return; // å·²åœ¨æ‹–æ›³ä¸­

        if (!clickedCard.faceUp) return; // èƒŒé¢æœä¸Šçš„ç‰Œä¸èƒ½æ‹–æ›³
        
        // åœ¨ä¸‰å¼µæ¨¡å¼ä¸‹ï¼Œå»¢ç‰Œå †åªèƒ½æ‹–æ›³æœ€ä¸Šé¢çš„ç‰Œ
        if (type === 'waste' && cardIdx !== sourcePile.length - 1) return;
        
        // èŠ±è‰²å€çš„ç‰Œåªèƒ½æ‹–æ›³æœ€ä¸Šé¢çš„ç‰Œ
        if ((type === 'waste' || type === 'foundation') && cardIdx !== sourcePile.length - 1) return;
        
        drag.pending = true; // æ¨™è¨˜ç‚ºç­‰å¾…æ‹–æ›³
        drag.isDragging = false;
        
        // å–å¾—è§¸æ§/æ»‘é¼ åº§æ¨™
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        
        drag.startX = clientX;
        drag.startY = clientY;
        drag.origin = { type, pileIdx, cardIdx };
        
        // è¨­å®šè¦æ‹–æ›³çš„å¡ç‰‡
        drag.cards = [];
        if (type === 'tableau') {
            // è¡¨æ ¼ä¸­æ‹–æ›³å¾é»æ“Šä½ç½®åˆ°æœ€ä¸‹é¢çš„æ‰€æœ‰ç‰Œ
            for (let i = cardIdx; i < sourcePile.length; i++) {
                drag.cards.push(sourcePile[i]);
            }
        } else {
            // å»¢ç‰Œå †ã€èŠ±è‰²å€åªèƒ½æ‹–æ›³ä¸€å¼µç‰Œ
            drag.cards.push(clickedCard);
        }

        // å–å¾—éŠæˆ²å€åŸŸé‚Šç•Œ
        const gameBoard = document.getElementById('game-board');
        drag.gameBoardRect = gameBoard.getBoundingClientRect();
        
        // è¨ˆç®—åç§»é‡
        const cardEl = document.querySelector(`[data-id="${clickedCard.id}"]`);
        if (cardEl) {
            const rect = cardEl.getBoundingClientRect();
            drag.offset.x = clientX - rect.left;
            drag.offset.y = clientY - rect.top;
        }

        // æ·»åŠ äº‹ä»¶ç›£è½å™¨
        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('mouseup', onDragEnd);
        document.addEventListener('touchmove', onDragMove, { passive: false });
        document.addEventListener('touchend', onDragEnd);
    }

    /**
     * å»ºç«‹æ‹–æ›³æ™‚çš„å¹½éˆå¡ç‰‡
     */
    function createGhosts() {
        if (!drag.cards.length) return;
        
        const startCardEl = document.querySelector(`[data-id="${drag.cards[0].id}"]`);
        if (!startCardEl) return;
        const rect = startCardEl.getBoundingClientRect();

        // ç‚ºæ¯å¼µæ‹–æ›³ä¸­çš„å¡ç‰‡å»ºç«‹å¹½éˆå¡ç‰‡
        drag.cards.forEach((card, i) => {
            // è¤‡è£½åŸå§‹å¡ç‰‡å…ƒç´ ï¼Œè€Œä¸æ˜¯å‰µå»ºæ–°çš„
            const originalCardEl = document.querySelector(`[data-id="${card.id}"]`);
            if (!originalCardEl) return;
            
            const ghost = originalCardEl.cloneNode(true);
            ghost.className = `card dragging-card ${card.color}`;
            ghost.style.backgroundColor = 'white'; // ç¢ºä¿èƒŒæ™¯ç‚ºç™½è‰²
            
            // ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›£è½å™¨
            ghost.replaceWith(ghost.cloneNode(true));
            
            // åˆ†é–‹æ‰‹æ©Ÿç‰ˆå’Œç¶²é ç‰ˆçš„é‡ç–Šæ¯”ä¾‹
            const isMobile = window.innerWidth < 600;
            // é‡ç–Šæ¯”ä¾‹ç‚º0.7æ„å‘³è‘—é‡ç–Š70%ï¼Œéœ²å‡º30%
            const overlapRatio = isMobile ? 0.5 : 0.7;
            const spacingHeight = cardSize.height * (1 - overlapRatio); // éœ²å‡ºéƒ¨åˆ†çš„é«˜åº¦
            const ghostOffset = i * spacingHeight;
            
            // è¨­å®šåˆå§‹ä½ç½®
            ghost.style.left = rect.left + 'px';
            ghost.style.top = (rect.top + ghostOffset) + 'px';
            ghost.style.width = rect.width + 'px';
            ghost.style.height = rect.height + 'px';
            ghost.style.position = 'fixed';
            ghost.style.zIndex = '9999';
            ghost.style.pointerEvents = 'none';
            ghost.style.boxShadow = '5px 5px 15px rgba(0,0,0,0.5)';
            ghost.style.opacity = '0.9';
            ghost.style.transform = ''; // æ¸…é™¤ä»»ä½•transform
            
            // ç§»é™¤ä»»ä½•å¯èƒ½å½±éŸ¿é¡¯ç¤ºçš„é¡å¤–æ¨£å¼
            ghost.style.fontSize = '';
            ghost.style.transformOrigin = '';
            
            // æ·»åŠ åˆ°æ–‡æª”
            document.body.appendChild(ghost);
            drag.elGhosts.push(ghost);
        });

        // å°‡åŸå§‹å¡ç‰‡è¨­ç‚ºåŠé€æ˜
        drag.cards.forEach(card => {
            const el = document.querySelector(`[data-id="${card.id}"]`);
            if (el) el.style.opacity = '0.3';
        });
    }

    /**
     * æ‹–æ›³ç§»å‹•è™•ç†å‡½æ•¸
     * @param {Event} e - äº‹ä»¶ç‰©ä»¶
     */
    function onDragMove(e) {
        if (!drag.pending && !drag.isDragging) return;
        
        // å–å¾—è§¸æ§/æ»‘é¼ åº§æ¨™
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        
        // æª¢æŸ¥æ˜¯å¦çœŸæ­£é–‹å§‹æ‹–æ›³ï¼ˆç§»å‹•è·é›¢è¶…é5pxï¼‰
        if (drag.pending) {
            const moveX = Math.abs(clientX - drag.startX);
            const moveY = Math.abs(clientY - drag.startY);
            
            if (moveX > 5 || moveY > 5) {
                drag.pending = false;
                drag.isDragging = true;
                createGhosts(); // å»ºç«‹å¹½éˆå¡ç‰‡
            } else {
                return;
            }
        }
        
        // æ›´æ–°å¹½éˆå¡ç‰‡ä½ç½®
        if (drag.isDragging) {
            if (e.cancelable) e.preventDefault(); // é˜²æ­¢é è¨­è¡Œç‚º
            
            drag.elGhosts.forEach((el, i) => {
                // åˆ†é–‹æ‰‹æ©Ÿç‰ˆå’Œç¶²é ç‰ˆçš„é‡ç–Šæ¯”ä¾‹
                const isMobile = window.innerWidth < 600;
                // é‡ç–Šæ¯”ä¾‹ç‚º0.7æ„å‘³è‘—é‡ç–Š70%ï¼Œéœ²å‡º30%
                const overlapRatio = isMobile ? 0.5 : 0.7;
                const spacingHeight = cardSize.height * (1 - overlapRatio); // éœ²å‡ºéƒ¨åˆ†çš„é«˜åº¦
                const ghostOffset = i * spacingHeight;
                
                el.style.left = (clientX - drag.offset.x) + 'px';
                el.style.top = (clientY - drag.offset.y + ghostOffset) + 'px';
            });
        }
    }

    /**
     * æ‹–æ›³çµæŸè™•ç†å‡½æ•¸ - ä¿®æ­£ç§»å‹•ä½ç½®è¨ˆç®—å•é¡Œ
     * @param {Event} e - äº‹ä»¶ç‰©ä»¶
     */
    function onDragEnd(e) {
        // ç§»é™¤äº‹ä»¶ç›£è½å™¨
        document.removeEventListener('mousemove', onDragMove);
        document.removeEventListener('mouseup', onDragEnd);
        document.removeEventListener('touchmove', onDragMove);
        document.removeEventListener('touchend', onDragEnd);

        // è™•ç†ç­‰å¾…æ‹–æ›³ç‹€æ…‹
        if (drag.pending) {
            drag.pending = false;
            return;
        }

        if (!drag.isDragging) return; // æœªåœ¨æ‹–æ›³ä¸­

        // å–å¾—å¹½éˆå¡ç‰‡ä½ç½®ï¼ˆä½¿ç”¨ç¬¬ä¸€å¼µå¹½éˆå¡ç‰‡ä½œç‚ºåƒè€ƒé»ï¼‰
        const headGhost = drag.elGhosts[0];
        if (!headGhost) return;
        
        const ghostRect = headGhost.getBoundingClientRect();
        
        // è¨ˆç®—å¹½éˆå¡ç‰‡çš„ä¸­å¿ƒé»ï¼ˆç›¸å°æ–¼éŠæˆ²å€åŸŸï¼‰
        const ghostCenterX = ghostRect.left + ghostRect.width/2 - drag.gameBoardRect.left;
        const ghostCenterY = ghostRect.top + ghostRect.height/2 - drag.gameBoardRect.top;

        let target = null; // ç›®æ¨™ä½ç½®
        let minDist = Infinity;
        
        // å¢åŠ å¸é™„å€åŸŸé–¾å€¼ - æé«˜éˆæ•åº¦
        const threshold = cardSize.width * 2.5; // å¾å¡ç‰‡å¯¬åº¦çš„1å€å¢åŠ åˆ°2.5å€
        
        // æª¢æŸ¥æ‰€æœ‰å¯èƒ½çš„ç›®æ¨™æ§½ä½ï¼ˆèŠ±è‰²å€å’Œè¡¨æ ¼åˆ—ï¼‰
        const allSlots = [];
        
        // èŠ±è‰²å€
        for (let i = 0; i < 4; i++) {
            const slotId = `slot-f${i}`;
            if (slotPositions[slotId]) {
                allSlots.push({
                    type: 'foundation',
                    idx: i,
                    cx: slotPositions[slotId].cx,
                    cy: slotPositions[slotId].cy
                });
            }
        }
        
        // è¡¨æ ¼åˆ— - éœ€è¦è€ƒæ…®æ¯åˆ—æœ€ä¸Šé¢çš„å¡ç‰‡ä½ç½®
        for (let i = 0; i < 7; i++) {
            const slotId = `slot-t${i}`;
            if (slotPositions[slotId]) {
                const pile = state.tableau[i];
                let targetX, targetY;
                
                if (pile.length > 0) {
                    // å¦‚æœåˆ—ä¸­æœ‰ç‰Œï¼Œè¨ˆç®—æœ€ä¸Šé¢ä¸€å¼µç‰Œçš„ä¸­å¿ƒä½ç½®
                    const topCard = pile[pile.length - 1];
                    const topCardElement = document.querySelector(`[data-id="${topCard.id}"]`);
                    if (topCardElement) {
                        const cardRect = topCardElement.getBoundingClientRect();
                        targetX = cardRect.left + cardRect.width/2 - drag.gameBoardRect.left;
                        targetY = cardRect.top + cardRect.height/2 - drag.gameBoardRect.top;
                    } else {
                        // å¦‚æœæ‰¾ä¸åˆ°å¡ç‰‡å…ƒç´ ï¼Œä½¿ç”¨æ§½ä½ä¸­å¿ƒ
                        targetX = slotPositions[slotId].cx;
                        targetY = slotPositions[slotId].cy;
                    }
                } else {
                    // ç©ºåˆ—ä½¿ç”¨æ§½ä½ä¸­å¿ƒ
                    targetX = slotPositions[slotId].cx;
                    targetY = slotPositions[slotId].cy;
                }
                
                allSlots.push({
                    type: 'tableau',
                    idx: i,
                    cx: targetX,
                    cy: targetY
                });
            }
        }
        
        // å°‹æ‰¾æœ€è¿‘çš„æ§½ä½
        for (let i = 0; i < allSlots.length; i++) {
            const slot = allSlots[i];
            const distX = ghostCenterX - slot.cx;
            const distY = ghostCenterY - slot.cy;
            const dist = Math.sqrt(distX * distX + distY * distY);
            
            if (dist < minDist) {
                minDist = dist;
                if (dist < threshold) {
                    target = { type: slot.type, idx: slot.idx };
                }
            }
        }

        // å˜—è©¦ç§»å‹•å¡ç‰‡
        let success = false;
        if (target) {
            success = tryMove(drag.cards, drag.origin, target);
        }

        // æ¸…ç†å¹½éˆå¡ç‰‡
        drag.elGhosts.forEach(el => el.remove());
        drag.elGhosts = [];
        drag.isDragging = false;
        
        // æ¢å¾©åŸå§‹å¡ç‰‡é€æ˜åº¦
        drag.cards.forEach(card => {
            const el = document.querySelector(`[data-id="${card.id}"]`);
            if (el) el.style.opacity = '1';
        });

        // æ ¹æ“šç§»å‹•çµæœæ›´æ–°éŠæˆ²
        if (success) {
            state.moves++;
            saveStateToHistory();
            render();
            updateTimer();
            updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
            checkWin(); // æª¢æŸ¥æ˜¯å¦ç²å‹
            // æª¢æŸ¥æ˜¯å¦è§¸ç™¼è‡ªå‹•é£›ç‰Œ
            checkAutoFlyAfterMove();
        } else {
            render(); // ç§»å‹•å¤±æ•—ï¼Œé‡æ–°æ¸²æŸ“æ¢å¾©åŸç‹€
        }
    }

    /**
     * å˜—è©¦ç§»å‹•å¡ç‰‡
     * @param {Array} cards - è¦ç§»å‹•çš„å¡ç‰‡é™£åˆ—
     * @param {Object} source - ä¾†æºè³‡è¨Š
     * @param {Object} target - ç›®æ¨™è³‡è¨Š
     * @returns {boolean} - ç§»å‹•æ˜¯å¦æˆåŠŸ
     */
    function tryMove(cards, source, target) {
        if (!cards || cards.length === 0) return false;
        const moveCard = cards[0]; // ç§»å‹•çš„ç¬¬ä¸€å¼µå¡ç‰‡
        
        // ç§»å‹•åˆ°èŠ±è‰²å€
        if (target.type === 'foundation') {
            if (cards.length > 1) return false; // èŠ±è‰²å€åªèƒ½ç§»å‹•ä¸€å¼µç‰Œ
            
            // å¦‚æœæ˜¯å¾èŠ±è‰²å€ç§»å‹•åˆ°èŠ±è‰²å€ï¼Œä¸å…è¨±
            if (source.type === 'foundation') return false;
            
            const foundation = state.foundations[target.idx];
            if (foundation.length === 0) {
                if (moveCard.rank !== 1) return false; // ç©ºçš„èŠ±è‰²å€åªèƒ½æ”¾Ace
            } else {
                const topCard = foundation[foundation.length - 1];
                if (moveCard.suit !== topCard.suit || moveCard.rank !== topCard.rank + 1) return false; // å¿…é ˆåŒèŠ±è‰²ä¸”é€£çºŒ
            }
            performMove(source, target, cards); // åŸ·è¡Œç§»å‹•
            return true;
        }
        
        // ç§»å‹•åˆ°è¡¨æ ¼
        if (target.type === 'tableau') {
            if (source.type === 'tableau' && source.pileIdx === target.idx) return false; // ä¸èƒ½ç§»å‹•åˆ°åŒä¸€åˆ—
            
            const tableau = state.tableau[target.idx];
            if (tableau.length === 0) {
                if (moveCard.rank !== 13) return false; // ç©ºçš„è¡¨æ ¼åˆ—åªèƒ½æ”¾King
            } else {
                const topCard = tableau[tableau.length - 1];
                if (moveCard.color === topCard.color || moveCard.rank !== topCard.rank - 1) return false; // å¿…é ˆä¸åŒé¡è‰²ä¸”é€£çºŒ
            }
            performMove(source, target, cards); // åŸ·è¡Œç§»å‹•
            return true;
        }
        return false;
    }

    /**
     * åŸ·è¡Œç§»å‹•æ“ä½œ
     * @param {Object} source - ä¾†æºè³‡è¨Š
     * @param {Object} target - ç›®æ¨™è³‡è¨Š
     * @param {Array} cards - è¦ç§»å‹•çš„å¡ç‰‡é™£åˆ—
     */
    function performMove(source, target, cards) {
        // å¾ä¾†æºç§»é™¤å¡ç‰‡
        if (source.type === 'waste') {
            state.waste.splice(source.cardIdx, 1);
        } else if (source.type === 'tableau') {
            state.tableau[source.pileIdx].splice(source.cardIdx, cards.length);
            if (state.tableau[source.pileIdx].length > 0) {
                state.tableau[source.pileIdx][state.tableau[source.pileIdx].length - 1].faceUp = true; // ç¿»é–‹ä¸‹ä¸€å¼µç‰Œ
            }
        } else if (source.type === 'foundation') {
            state.foundations[source.pileIdx].splice(source.cardIdx, 1);
        }
        
        // æ·»åŠ åˆ°ç›®æ¨™
        if (target.type === 'foundation') {
            state.foundations[target.idx].push(...cards);
            // æ ¹æ“šä¾†æºåŠ åˆ†
            if (source.type === 'waste') {
                addScore(10); // å¾å»¢ç‰Œå †ç§»å‹•åˆ°èŠ±è‰²å€å¾—10åˆ†
            } else if (source.type === 'tableau') {
                addScore(10); // å¾è¡¨æ ¼åˆ—ç§»å‹•åˆ°èŠ±è‰²å€å¾—10åˆ†
            }
            // æ’­æ”¾æ”¾ç½®å€éŸ³æ•ˆ
            playFoundationSound();
        } else if (target.type === 'tableau') {
            state.tableau[target.idx].push(...cards);
            // æ ¹æ“šä¾†æºåŠ åˆ†
            if (source.type === 'waste') {
                addScore(5); // å¾å»¢ç‰Œå †ç§»å‹•åˆ°è¡¨æ ¼åˆ—å¾—5åˆ†
            } else if (source.type === 'tableau') {
                addScore(5 * cards.length); // å¾è¡¨æ ¼åˆ—ç§»å‹•åˆ°è¡¨æ ¼åˆ—ï¼Œæ¯å¼µç‰Œå¾—5åˆ†
            } else if (source.type === 'foundation') {
                addScore(-15); // å¾èŠ±è‰²å€ç§»å‹•åˆ°è¡¨æ ¼åˆ—æ‰£15åˆ†
            }
            // æ’­æ”¾ç§»å‹•éŸ³æ•ˆ
            playMoveSound();
        }
    }

    // ==================== è‡ªå‹•é£›ç‰Œç³»çµ± ====================
    
/**
 * æª¢æŸ¥æ˜¯å¦å¯ä»¥è§¸ç™¼è‡ªå‹•é£›ç‰Œ
 * ä¿®æ”¹ï¼šæ·»åŠ èª¿è©¦æ—¥èªŒ
 */
function checkAutoFlyCondition() {
    // å¦‚æœæ­£åœ¨å‹•ç•«ä¸­æˆ–æ­£åœ¨è‡ªå‹•é£›ç‰Œï¼Œå‰‡ä¸æª¢æŸ¥
    if (isDrawing || isAutoFlying) {
        console.log("è‡ªå‹•é£›ç‰Œæ¢ä»¶ï¼šæ­£åœ¨å‹•ç•«ä¸­æˆ–æ­£åœ¨è‡ªå‹•é£›ç‰Œ");
        return false;
    }
    
    // æª¢æŸ¥è‡ªå‹•é£›ç‰Œé–‹é—œæ˜¯å¦é–‹å•Ÿ
    if (!state.autoFlyEnabled) {
        console.log("è‡ªå‹•é£›ç‰Œæ¢ä»¶ï¼šé–‹é—œæœªé–‹å•Ÿ");
        return false;
    }
    
    // æª¢æŸ¥ä¸ƒåˆ—è¡¨æ ¼æ˜¯å¦é‚„æœ‰è“‹ç‰Œ
    let hasFaceDownCards = false;
    for (let col = 0; col < 7; col++) {
        const pile = state.tableau[col];
        for (let i = 0; i < pile.length; i++) {
            if (!pile[i].faceUp) {
                hasFaceDownCards = true;
                break;
            }
        }
        if (hasFaceDownCards) break;
    }
    
    // ä¿®æ”¹ï¼šå¦‚æœæ²’æœ‰è“‹ç‰Œï¼Œæª¢æŸ¥æ˜¯å¦æœ‰å¯é£›çš„ç‰Œ
    if (!hasFaceDownCards) {
        console.log("ä¸ƒåˆ—è¡¨æ ¼æ‰€æœ‰ç‰Œéƒ½å·²ç¿»é–‹ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰å¯é£›çš„ç‰Œ");
        const hasFlyable = hasFlyableCards();
        console.log("è‡ªå‹•é£›ç‰Œæ¢ä»¶ï¼šæ‰€æœ‰ç‰Œç¿»é–‹ä¸”å¯é£›=", hasFlyable);
        return hasFlyable;
    }
    
    console.log("è‡ªå‹•é£›ç‰Œæ¢ä»¶ï¼šä¸ƒåˆ—è¡¨æ ¼é‚„æœ‰è“‹ç‰Œ");
    return false;
}
    
/**
 * æª¢æŸ¥æ˜¯å¦é‚„æœ‰å¯é£›çš„ç‰Œ
 * ä¿®æ”¹ï¼šæ”¹é€²æª¢æŸ¥é‚è¼¯ï¼Œå„ªå…ˆæª¢æŸ¥ä¸ƒåˆ—è¡¨æ ¼
 */
function hasFlyableCards() {
    console.log("æª¢æŸ¥æ˜¯å¦æœ‰å¯é£›çš„ç‰Œ...");
    
    // 1. å„ªå…ˆæª¢æŸ¥ä¸ƒåˆ—è¡¨æ ¼ä¸­æ˜¯å¦æœ‰ç‰Œå¯ä»¥é£›åˆ°èŠ±è‰²å€
    for (let col = 0; col < 7; col++) {
        const pile = state.tableau[col];
        if (pile.length === 0) continue;
        
        const card = pile[pile.length - 1];
        if (!card.faceUp) continue;
        
        for (let foundIdx = 0; foundIdx < 4; foundIdx++) {
            const foundation = state.foundations[foundIdx];
            if (canMoveToFoundation(card, foundation)) {
                console.log("ä¸ƒåˆ—è¡¨æ ¼æœ‰å¯é£›çš„ç‰Œ:", card.text + card.suit, "åœ¨ç¬¬" + (col+1) + "åˆ—");
                return true;
            }
        }
    }
    
    // 2. æª¢æŸ¥å»¢ç‰Œå †ä¸­æ˜¯å¦æœ‰ç‰Œå¯ä»¥é£›åˆ°èŠ±è‰²å€
    if (state.waste.length > 0) {
        const wasteCard = state.waste[state.waste.length - 1];
        for (let foundIdx = 0; foundIdx < 4; foundIdx++) {
            const foundation = state.foundations[foundIdx];
            if (canMoveToFoundation(wasteCard, foundation)) {
                console.log("å»¢ç‰Œå †æœ‰å¯é£›çš„ç‰Œ:", wasteCard.text + wasteCard.suit);
                return true;
            }
        }
    }
    
    // 3. æª¢æŸ¥ç‰Œå †ä¸­æ˜¯å¦æœ‰ç‰Œï¼ˆç¿»ç‰Œå¾Œå¯èƒ½æœ‰å¯é£›çš„ç‰Œï¼‰
    if (state.stock.length > 0) {
        console.log("ç‰Œå †æœ‰ç‰Œï¼Œç¿»ç‰Œå¾Œå¯èƒ½æœ‰å¯é£›çš„ç‰Œ");
        return true;
    }
    
    // 4. æª¢æŸ¥å»¢ç‰Œå †æ˜¯å¦å¯ä»¥é‡ç½®
    if (state.waste.length > 0) {
        console.log("å»¢ç‰Œå †æœ‰ç‰Œï¼Œé‡ç½®å¾Œå¯èƒ½æ‰¾åˆ°å¯é£›çš„ç‰Œ");
        return true;
    }
    
    // 5. æª¢æŸ¥è¡¨æ ¼é–“æ˜¯å¦æœ‰å¯ç§»å‹•çš„ç‰Œï¼ˆç§»å‹•å¾Œå¯èƒ½é‡‹æ”¾å¯é£›çš„ç‰Œï¼‰
    for (let sourceCol = 0; sourceCol < 7; sourceCol++) {
        const sourcePile = state.tableau[sourceCol];
        if (sourcePile.length === 0) continue;
        
        const sourceCard = sourcePile[sourcePile.length - 1];
        if (!sourceCard.faceUp) continue;
        
        for (let targetCol = 0; targetCol < 7; targetCol++) {
            if (sourceCol === targetCol) continue;
            
            const targetPile = state.tableau[targetCol];
            
            // Kingå¯ä»¥ç§»å‹•åˆ°ç©ºåˆ—
            if (sourceCard.rank === 13 && targetPile.length === 0) {
                console.log("ç™¼ç¾Kingå¯ä»¥ç§»å‹•åˆ°ç©ºåˆ—");
                return true;
            }
            
            // æ¨™æº–ç§»å‹•è¦å‰‡
            if (targetPile.length > 0 && canMoveToTableau(sourceCard, targetPile)) {
                console.log("ç™¼ç¾è¡¨æ ¼é–“ç§»å‹•:", sourceCard.text + sourceCard.suit, "å¾åˆ—" + (sourceCol+1) + "åˆ°åˆ—" + (targetCol+1));
                return true;
            }
        }
    }
    
    console.log("æ²’æœ‰ç™¼ç¾å¯é£›çš„ç‰Œ");
    return false;
}
    
/**
 * é–‹å§‹è‡ªå‹•é£›ç‰Œæµç¨‹
 */
function startAutoFly() {
    if (isAutoFlying || isDrawing) {
        /* console.log("è‡ªå‹•é£›ç‰Œï¼šæ­£åœ¨é€²è¡Œä¸­æˆ–æ­£åœ¨ç¿»ç‰Œ"); */
        return;
    }
    
    // å…ˆæª¢æŸ¥æ˜¯å¦æœ‰å¯é£›çš„ç‰Œ
    if (!hasFlyableCards()) {
        /* console.log("è‡ªå‹•é£›ç‰Œï¼šæ²’æœ‰å¯é£›çš„ç‰Œ"); */
        return;
    }
    
    // æª¢æŸ¥è‡ªå‹•é£›ç‰Œæ¢ä»¶
    if (!checkAutoFlyCondition()) {
        /* console.log("è‡ªå‹•é£›ç‰Œï¼šæ¢ä»¶ä¸æ»¿è¶³"); */
        return;
    }
    
    console.log("å•Ÿå‹•è‡ªå‹•é£›ç‰Œ...");
    
    // é‡ç½®å¾ªç’°è¨ˆæ•¸å™¨
    autoFlyCycleCount = 0;
    
    isAutoFlying = true;
    
    // å»ºç«‹è‡ªå‹•é£›ç‰ŒéšŠåˆ—
    buildAutoFlyQueue();
    
    // å¦‚æœéšŠåˆ—ç‚ºç©ºï¼Œåœæ­¢è‡ªå‹•é£›ç‰Œ
    if (autoFlyQueue.length === 0) {
        /* console.log("è‡ªå‹•é£›ç‰Œåœæ­¢ï¼šéšŠåˆ—ç‚ºç©º"); */
        isAutoFlying = false;
        return;
    }
    
    /* console.log("è‡ªå‹•é£›ç‰ŒéšŠåˆ—å¤§å°:", autoFlyQueue.length); */
    
    // é–‹å§‹è™•ç†éšŠåˆ—
    processAutoFlyQueue();
}
    
    /**
 * ç›£æ§è‡ªå‹•é£›ç‰Œç‹€æ…‹
 * ä¿®æ”¹ï¼šé¿å…æ­»å¾ªç’°
 */
function monitorAutoFlyState() {
    // æ¯10ç§’æª¢æŸ¥ä¸€æ¬¡ï¼Œé¿å…è‡ªå‹•é£›ç‰Œé™·å…¥æ­»å¾ªç’°
    setInterval(() => {
        if (isAutoFlying) {
            // å¦‚æœè‡ªå‹•é£›ç‰ŒæŒçºŒè¶…é30ç§’ï¼Œå¼·åˆ¶åœæ­¢
            if (autoFlyCycleCount > 300) { // å‡è¨­æ¯æ¬¡å¾ªç’°ç´„100ms
                console.warn("è‡ªå‹•é£›ç‰Œå¯èƒ½é™·å…¥æ­»å¾ªç’°ï¼Œå¼·åˆ¶åœæ­¢");
                stopAutoFly();
                showMessage("è‡ªå‹•é£›ç‰Œå·²åœæ­¢ï¼Œå¯èƒ½é™·å…¥æ­»å¾ªç’°", 2000);
            }
        }
    }, 10000);
}

// åœ¨ window.addEventListener('load', ...) ä¸­æ·»åŠ ï¼š
window.addEventListener('load', () => {
    // ... å…¶ä»–åˆå§‹åŒ–ä»£ç¢¼ ...
    
    // å•Ÿå‹•è‡ªå‹•é£›ç‰Œç‹€æ…‹ç›£æ§
    monitorAutoFlyState();
    
    // ... å…¶ä»–åˆå§‹åŒ–ä»£ç¢¼ ...
});
    
    
    
    /**
     * åœæ­¢è‡ªå‹•é£›ç‰Œ
     */
    function stopAutoFly() {
        isAutoFlying = false;
        autoFlyQueue = [];
        if (autoFlyTimeout) {
            clearTimeout(autoFlyTimeout);
            autoFlyTimeout = null;
        }
        autoFlyCycleCount = 0; // é‡ç½®å¾ªç’°è¨ˆæ•¸å™¨
    }
    
/**
 * å»ºç«‹è‡ªå‹•é£›ç‰Œä»»å‹™éšŠåˆ—
 * ä¿®æ”¹ï¼šä¿®æ­£è®Šæ•¸åç‚º state.tableauï¼Œä¸¦é˜²æ­¢è‡ªå‹•é£›ç‰Œæ™‚çš„åˆ—é–“ç§»å‹•æ­»å¾ªç’°
 */
function buildAutoFlyQueue() {
    // console.log("å»ºç«‹è‡ªå‹•é£›ç‰ŒéšŠåˆ—...");
    autoFlyQueue = [];

    // 1. å„ªå…ˆæª¢æŸ¥ä¸¦æ”¶é›†æ‰€æœ‰å¯ä»¥ç§»å¾€ã€ŒèŠ±è‰²å€ (Foundation)ã€çš„ç‰Œ
    // æª¢æŸ¥ 7 å€‹æ’åˆ—å€ (Tableau) çš„æœ€å¾Œä¸€å¼µç‰Œ
    for (let i = 0; i < 7; i++) {
        const pile = state.tableau[i]; // ä¿®æ­£é»ï¼šä½¿ç”¨ state.tableau
        if (pile.length > 0) {
            const card = pile[pile.length - 1];
            // éæ­· 4 å€‹èŠ±è‰²å€ï¼Œæª¢æŸ¥æ˜¯å¦å¯ä»¥é£›ä¸Šå»
            for (let foundIdx = 0; foundIdx < 4; foundIdx++) {
                if (canMoveToFoundation(card, state.foundations[foundIdx])) {
                    autoFlyQueue.push({
                        type: 'tableau',
                        sourceCol: i,
                        sourceIdx: pile.length - 1,
                        card: card,
                        targetFoundation: foundIdx,
                        message: `è‡ªå‹•é£›ç‰Œï¼šå°‡ç¬¬${i+1}åˆ—çš„${card.text}${card.suit}é£›åˆ°èŠ±è‰²å€`
                    });
                    break; 
                }
            }
        }
    }

    // æª¢æŸ¥å»¢ç‰Œå † (Waste) çš„æœ€å¾Œä¸€å¼µç‰Œæ˜¯å¦å¯ä»¥é£›
    if (state.waste.length > 0) {
        const card = state.waste[state.waste.length - 1];
        for (let foundIdx = 0; foundIdx < 4; foundIdx++) {
            if (canMoveToFoundation(card, state.foundations[foundIdx])) {
                autoFlyQueue.push({
                    type: 'waste',
                    sourceIdx: state.waste.length - 1,
                    card: card,
                    targetFoundation: foundIdx,
                    message: `è‡ªå‹•é£›ç‰Œï¼šå°‡å»¢ç‰Œå€çš„${card.text}${card.suit}é£›åˆ°èŠ±è‰²å€`
                });
                break;
            }
        }
    }

    // 2. åªæœ‰åœ¨ã€Œéã€è‡ªå‹•é£›ç‰Œç‹€æ…‹ä¸‹ï¼ˆä¾‹å¦‚ç©å®¶é»æ“Šæç¤ºï¼‰ï¼Œæ‰å…è¨±æª¢æŸ¥åˆ—èˆ‡åˆ—ä¹‹é–“çš„ç§»å‹•
    // é€™æ¨£åœ¨å…¨è‡ªå‹•æ”¶å°¾éšæ®µï¼Œç³»çµ±å°±ä¸æœƒæŠŠ K ç§»ä¾†ç§»å»é€ æˆæ­»å¾ªç’°
    if (!isAutoFlying) {
        const tableauMoves = findTableauToTableauMoves(); // èª¿ç”¨æ‚¨ç¾æœ‰çš„å°‹æ‰¾è·¯å¾‘å‡½æ•¸
        if (tableauMoves.length > 0) {
            // åªå–ç¬¬ä¸€å€‹æœ‰æ•ˆç§»å‹•
            autoFlyQueue.push(tableauMoves[0]);
        }
    }

    // 3. å¦‚æœé‚„æ˜¯æ²’äº‹åšï¼Œä¸”ç‰Œå †é‚„æœ‰ç‰Œï¼Œå‰‡å˜—è©¦ç¿»ç‰Œ
    if (autoFlyQueue.length === 0 && state.stock.length > 0) {
        autoFlyQueue.push({ type: 'draw', message: 'è‡ªå‹•é£›ç‰Œï¼šç¿»ç‰Œ' });
    }
}

/**
 * å°‹æ‰¾è¡¨æ ¼é–“çš„ç§»å‹•
 */
function findTableauToTableauMoves() {
    let moves = [];
    
    for (let sourceCol = 0; sourceCol < 7; sourceCol++) {
        const sourcePile = state.tableau[sourceCol];
        if (sourcePile.length === 0) continue;
        
        const card = sourcePile[sourcePile.length - 1];
        if (!card.faceUp) continue;
        
        for (let targetCol = 0; targetCol < 7; targetCol++) {
            if (sourceCol === targetCol) continue;
            
            const targetPile = state.tableau[targetCol];
            
            // Kingå¯ä»¥ç§»å‹•åˆ°ç©ºåˆ—
            if (card.rank === 13 && targetPile.length === 0) {
                moves.push({
                    type: 'tableau-to-tableau',
                    sourceCol: sourceCol,
                    sourceIdx: sourcePile.length - 1,
                    targetCol: targetCol,
                    card: card,
                    priority: 8,
                    message: `è‡ªå‹•é£›ç‰Œï¼šå°‡ç¬¬${sourceCol+1}åˆ—çš„${card.text}${card.suit}ç§»åˆ°ç¬¬${targetCol+1}åˆ—`
                });
                break;
            }
            
            // æ¨™æº–ç§»å‹•è¦å‰‡
            if (targetPile.length > 0 && canMoveToTableau(card, targetPile)) {
                moves.push({
                    type: 'tableau-to-tableau',
                    sourceCol: sourceCol,
                    sourceIdx: sourcePile.length - 1,
                    targetCol: targetCol,
                    card: card,
                    priority: 9,
                    message: `è‡ªå‹•é£›ç‰Œï¼šå°‡ç¬¬${sourceCol+1}åˆ—çš„${card.text}${card.suit}ç§»åˆ°ç¬¬${targetCol+1}åˆ—`
                });
                break;
            }
        }
    }
    
    return moves;
}
    
    
    
/**
 * è™•ç†è‡ªå‹•é£›ç‰Œä»»å‹™éšŠåˆ—
 * å„ªåŒ–ï¼šä»»å‹™çµæŸå¾Œç«‹å³æƒæä¸‹ä¸€æ³¢ï¼Œå¯¦ç¾çµ²æ»‘åˆ‡æ›ï¼ˆä¾‹å¦‚ 3 é£›å®Œç«‹åˆ»é£› 4ï¼‰
 */
function processAutoFlyQueue() {
    if (!isAutoFlying) return;

    // å¦‚æœç›®å‰çš„éšŠåˆ—ç©ºäº†ï¼Œç«‹å³é‡æ–°æƒæï¼ˆä¾‹å¦‚è™•ç†å®Œæ‰€æœ‰ 3 å¾Œï¼Œå»ºç«‹ 4 çš„éšŠåˆ—ï¼‰
    if (autoFlyQueue.length === 0) {
        buildAutoFlyQueue();
        
        // å¦‚æœé‡æ–°å»ºç«‹å¾Œä¾ç„¶æ˜¯ç©ºçš„ï¼Œä»£è¡¨çœŸçš„æ²’ç‰Œå¯å‹•äº†ï¼Œåœæ­¢è‡ªå‹•æ¨¡å¼
        if (autoFlyQueue.length === 0) {
            isAutoFlying = false;
            checkWin(); // åŸ·è¡Œæœ€å¾Œçš„å‹åˆ©æª¢æŸ¥
            return;
        }
    }

    // å–å‡ºä¸‹ä¸€å€‹ä»»å‹™
    const task = autoFlyQueue.shift();
    
    // å¢åŠ å®‰å…¨è¨ˆæ•¸ï¼Œé…åˆ monitorAutoFlyState ç›£æ§
    autoFlyCycleCount++;

    // åŸ·è¡Œå°æ‡‰çš„å‹•ç•«èˆ‡é‚è¼¯
    switch (task.type) {
        case 'tableau':
        case 'waste':
        case 'stock':
            performAutoFlyToFoundation(task); // è™•ç†é£›å¾€èŠ±è‰²å€
            break;
            
        case 'tableau-to-tableau':
            performAutoFlyTableauToTableau(task); // è™•ç†åˆ—é–“ç§»å‹•
            break;
            
        case 'draw':
            performAutoFlyDraw(task); // è™•ç†ç¿»ç‰Œ
            break;
            
        case 'check':
            buildAutoFlyQueue();
            processAutoFlyQueue();
            break;
            
        default:
            // é‡åˆ°æœªçŸ¥ä»»å‹™æ™‚ï¼Œå¾®å°å»¶é²å¾Œç¹¼çºŒï¼Œé¿å…ç¨‹åºå¡æ­»
            setTimeout(() => {
                processAutoFlyQueue();
            }, 50);
    }
}
    
    /**
 * åŸ·è¡Œç¿»ç‰Œä¸¦æª¢æŸ¥ä»»å‹™ï¼ˆæ–°å¢ï¼‰
 * ç¿»ç‰Œå¾Œç«‹å³æª¢æŸ¥æ˜¯å¦å¯ä»¥é£›
 */
function performAutoFlyDrawWithCheck(task) {
    if (state.stock.length === 0) {
        // å¦‚æœç‰Œå †ç©ºäº†ï¼Œé‡æ–°å»ºç«‹éšŠåˆ—
        setTimeout(() => {
            buildAutoFlyQueue();
            processAutoFlyQueue();
        }, autoFlyTiming.queueDelay);
        return;
    }
    
    // åŸ·è¡Œç¿»ç‰Œ
    const drawCount = Math.min(state.drawMode, state.stock.length);
    const cardsToDraw = [];
    
    for (let i = 0; i < drawCount; i++) {
        const cardIndex = state.stock.length - 1 - i;
        cardsToDraw.unshift(state.stock[cardIndex]);
    }
    
    // å¾éŠæˆ²ç‹€æ…‹ä¸­ç§»é™¤é€™äº›ç‰Œ
    for (let i = 0; i < drawCount; i++) {
        state.stock.pop();
    }
    
    // å°‡å–å‡ºçš„ç‰ŒåŠ å…¥å»¢ç‰Œå †
    cardsToDraw.forEach(card => {
        card.faceUp = true;
        state.waste.push(card);
    });
    
    state.moves++;
    addScore(5 * drawCount);
    
    // æ›´æ–°é¡¯ç¤º
    updateStockPile();
    updateWastePile();
    updateTimer();
    
    // ç¿»ç‰Œå¾Œæª¢æŸ¥å»¢ç‰Œå †æœ€ä¸Šé¢çš„ç‰Œæ˜¯å¦å¯ä»¥é£›
    if (state.waste.length > 0) {
        const wasteCard = state.waste[state.waste.length - 1];
        let canFlyNow = false;
        
        for (let foundIdx = 0; foundIdx < 4; foundIdx++) {
            const foundation = state.foundations[foundIdx];
            if (canMoveToFoundation(wasteCard, foundation)) {
                canFlyNow = true;
                // ç«‹å³å‰µå»ºé£›ç‰Œä»»å‹™
                autoFlyQueue.unshift({
                    type: 'waste',
                    sourceCol: 0,
                    sourceIdx: state.waste.length - 1,
                    card: wasteCard,
                    targetFoundation: foundIdx,
                    priority: 1,
                    message: `è‡ªå‹•é£›ç‰Œï¼šå°‡å‰›ç¿»å‡ºçš„${wasteCard.text}${wasteCard.suit}é£›åˆ°èŠ±è‰²å€`
                });
                break;
            }
        }
        
        if (canFlyNow) {
            console.log("ç¿»ç‰Œå¾Œç™¼ç¾å¯é£›çš„ç‰Œï¼Œç«‹å³è™•ç†");
            // ç«‹å³è™•ç†é€™å€‹é£›ç‰Œä»»å‹™
            setTimeout(() => {
                processAutoFlyQueue();
            }, autoFlyTiming.queueDelay);
            return;
        }
    }
    
    // å¦‚æœç¿»ç‰Œå¾Œæ²’æœ‰å¯é£›çš„ç‰Œï¼Œé‡æ–°å»ºç«‹éšŠåˆ—
    setTimeout(() => {
        buildAutoFlyQueue();
        processAutoFlyQueue();
    }, autoFlyTiming.queueDelay);
}
    
    
    
/**
 * åŸ·è¡Œé£›åˆ°èŠ±è‰²å€çš„è‡ªå‹•é£›ç‰Œ - ä¿®æ­£ï¼šå…ˆç²å–å¡ç‰‡ä½ç½®å†ç§»é™¤
 */
function performAutoFlyToFoundation(task) {
    if (isDrawing) return;
    
    const { type, sourceCol, sourceIdx, card, targetFoundation } = task;
    
    // ç¬¬ä¸€æ­¥ï¼šå…ˆç²å–åŸä½ç½®ï¼ˆåœ¨ç§»é™¤ç‰Œä¹‹å‰ï¼‰
    let sourceRect;
    const cardElement = document.querySelector(`[data-id="${card.id}"]`);
    if (cardElement) {
        // å¦‚æœæ‰¾åˆ°å¡ç‰‡å…ƒç´ ï¼Œä½¿ç”¨å¡ç‰‡å…ƒç´ çš„å¯¦éš›ä½ç½®
        sourceRect = cardElement.getBoundingClientRect();
    } else {
        // å¦‚æœæ‰¾ä¸åˆ°å¡ç‰‡å…ƒç´ ï¼Œä½¿ç”¨æ§½ä½ä½ç½®ä½œç‚ºå‚™ç”¨
        if (type === 'tableau') {
            const slotElement = document.getElementById(`slot-t${sourceCol}`);
            if (slotElement) {
                sourceRect = slotElement.getBoundingClientRect();
            } else {
                sourceRect = { left: 100, top: 100, width: cardSize.width, height: cardSize.height };
            }
        } else if (type === 'waste') {
            const wasteSlot = document.getElementById('slot-waste');
            if (wasteSlot) {
                const wasteRect = wasteSlot.getBoundingClientRect();
                // è¨ˆç®—å»¢ç‰Œå †ä¸­è©²ç‰Œçš„åç§»ä½ç½®
                let offset = 0;
                if (state.drawMode === 3) {
                    const wasteLen = state.waste.length;
                    // è¨ˆç®—å»¢ç‰Œå †ä¸­è©²ç‰Œçš„é¡¯ç¤ºä½ç½®
                    // å¦‚æœæ˜¯ä¸‰å¼µæ¨¡å¼ï¼Œé¡¯ç¤ºæœ€è¿‘çš„3å¼µç‰Œ
                    if (wasteLen >= 3) {
                        const displayIndex = sourceIdx - (wasteLen - 3);
                        if (displayIndex >= 0) {
                            offset = displayIndex * (cardSize.width * 0.3);
                        }
                    } else {
                        offset = sourceIdx * (cardSize.width * 0.3);
                    }
                }
                sourceRect = {
                    left: wasteRect.left + offset,
                    top: wasteRect.top,
                    width: cardSize.width,
                    height: cardSize.height
                };
            } else {
                sourceRect = { left: 200, top: 100, width: cardSize.width, height: cardSize.height };
            }
        } else if (type === 'stock') {
            const stockSlot = document.getElementById('slot-stock');
            if (stockSlot) {
                sourceRect = stockSlot.getBoundingClientRect();
            } else {
                sourceRect = { left: 300, top: 100, width: cardSize.width, height: cardSize.height };
            }
        }
    }
    
    // ç¬¬äºŒæ­¥ï¼šå¾éŠæˆ²ç‹€æ…‹ä¸­ç§»é™¤ç‰Œ
    removeCardFromSourceBeforeAnimation(task);
    
    // ç¬¬ä¸‰æ­¥ï¼šç«‹å³é‡æ–°æ¸²æŸ“ï¼Œè®“åŸä½ç½®çš„ç‰Œæ¶ˆå¤±
    render();
    
    // ç¬¬å››æ­¥ï¼šç²å–ç›®æ¨™ä½ç½®
    const targetElement = document.getElementById(`slot-f${targetFoundation}`);
    if (!targetElement) {
        // å¦‚æœæ‰¾ä¸åˆ°ç›®æ¨™ï¼Œç›´æ¥å®Œæˆé£›ç‰Œé‚è¼¯
        finishAutoFlyToFoundation(task);
        return;
    }
    
    const targetRect = targetElement.getBoundingClientRect();
    
    // ç¬¬äº”æ­¥ï¼šå‰µå»ºé£›è¡Œå‹•ç•«å¡ç‰‡
    const flyCard = document.createElement('div');
    flyCard.className = `card flying-card ${card.color}`;
    flyCard.style.backgroundColor = 'white';
    flyCard.dataset.text = card.text;
    
    // é‡å°æ•¸å­—10çš„ç‰¹æ®Šè™•ç†
    const isMobile = window.innerWidth < 600;
    let numHtml = `<div class="card-num ${card.color}">${card.text}</div>`;
    if (card.text === "10" && isMobile) {
        numHtml = `<div class="card-num ${card.color}" style="font-size: 2.5rem; transform: scaleX(0.75); transform-origin: left top; left: 0.8px;">${card.text}</div>`;
    } else if (card.text === "10") {
        numHtml = `<div class="card-num ${card.color}" style="font-size: 1.8rem;">${card.text}</div>`;
    }
    
    flyCard.innerHTML = `
        <div class="card-face">
            ${numHtml}
            <div class="card-suit-top ${card.color}">${card.suit}</div>
            <div class="card-center-suit ${card.color}">${card.suit}</div>
        </div>
    `;
    
    // è¨­ç½®åˆå§‹ä½ç½®ï¼ˆå¾åŸä½ç½®é–‹å§‹ï¼‰
    flyCard.style.left = sourceRect.left + 'px';
    flyCard.style.top = sourceRect.top + 'px';
    flyCard.style.width = sourceRect.width + 'px';
    flyCard.style.height = sourceRect.height + 'px';
    
    document.body.appendChild(flyCard);
    
    // å¼·åˆ¶ç€è¦½å™¨Reflow
    void flyCard.offsetWidth;
    
    // è¨­ç½®ç›®æ¨™ä½ç½®
    flyCard.style.left = targetRect.left + 'px';
    flyCard.style.top = targetRect.top + 'px';
    
    // æ’­æ”¾éŸ³æ•ˆ
    playFoundationSound();
    
    // å‹•ç•«å®Œæˆå¾Œæ›´æ–°éŠæˆ²ç‹€æ…‹
    setTimeout(() => {
        // ç§»é™¤å‹•ç•«å¡ç‰‡
        flyCard.remove();
        
        // å®Œæˆé£›ç‰Œé‚è¼¯ï¼šå°‡ç‰Œæ·»åŠ åˆ°ç›®æ¨™ä½ç½®
        finishAutoFlyToFoundation(task);
        
    }, 200);
}
    
    /**
     * åœ¨å‹•ç•«é–‹å§‹å‰å¾æºä½ç½®ç§»é™¤ç‰Œ
     * ä¿®æ”¹ï¼šç«‹å³å¾éŠæˆ²ç‹€æ…‹ä¸­ç§»é™¤ç‰Œ
     */
    function removeCardFromSourceBeforeAnimation(task) {
        const { type, sourceCol, sourceIdx, card } = task;
        
        // æ›´æ–°éŠæˆ²ç‹€æ…‹
        if (type === 'tableau') {
            // å¾è¡¨æ ¼ç§»é™¤ç‰Œ
            state.tableau[sourceCol].splice(sourceIdx, 1);
            // å¦‚æœé‚„æœ‰ç‰Œï¼Œç¿»é–‹æœ€ä¸Šé¢ä¸€å¼µ
            if (state.tableau[sourceCol].length > 0) {
                state.tableau[sourceCol][state.tableau[sourceCol].length - 1].faceUp = true;
            }
        } else if (type === 'waste') {
            // å¾å»¢ç‰Œå †ç§»é™¤ç‰Œ
            state.waste.pop();
        } else if (type === 'stock') {
            // å¾ç‰Œå †ç§»é™¤ç‰Œ
            state.stock.pop();
        }
    }
    
/**
 * å®Œæˆé£›åˆ°èŠ±è‰²å€çš„é‚è¼¯ï¼ˆå„ªåŒ–ç‰ˆï¼‰
 */
function finishAutoFlyToFoundation(task) {
    const { type, sourceCol, sourceIdx, card, targetFoundation } = task;
    
    // ç¿»é–‹ç‰Œï¼ˆå¦‚æœæ˜¯å¾ç‰Œå †ä¾†çš„ï¼‰
    if (type === 'stock') {
        card.faceUp = true;
    }
    
    // æ·»åŠ åˆ°èŠ±è‰²å€
    state.foundations[targetFoundation].push(card);
    
    // æ›´æ–°éŠæˆ²ç‹€æ…‹
    state.moves++;
    addScore(10); // è‡ªå‹•é£›ç‰Œå¾—10åˆ†
    
    // æ›´æ–°é¡¯ç¤º
    render();
    
    updateTimer();
    updateMagicButton();
    
    // æª¢æŸ¥æ˜¯å¦ç²å‹
    checkWin();
    
const nextDelay = autoFlyQueue.length > 0 ? autoFlyTiming.delay : 0;
setTimeout(() => {
    processAutoFlyQueue();
}, nextDelay);
}
    
/**
 * åŸ·è¡Œè¡¨æ ¼åˆ°è¡¨æ ¼çš„è‡ªå‹•é£›ç‰Œ - ä¿®æ­£ï¼šå…ˆç²å–å¡ç‰‡ä½ç½®å†ç§»é™¤
 */
function performAutoFlyTableauToTableau(task) {
    if (isDrawing) return;
    
    const { sourceCol, sourceIdx, targetCol, card } = task;
    
    // ç¬¬ä¸€æ­¥ï¼šå…ˆç²å–åŸä½ç½®ï¼ˆåœ¨ç§»é™¤ç‰Œä¹‹å‰ï¼‰
    let sourceRect;
    const cardElement = document.querySelector(`[data-id="${card.id}"]`);
    if (cardElement) {
        // å¦‚æœæ‰¾åˆ°å¡ç‰‡å…ƒç´ ï¼Œä½¿ç”¨å¡ç‰‡å…ƒç´ çš„å¯¦éš›ä½ç½®
        sourceRect = cardElement.getBoundingClientRect();
    } else {
        // å¦‚æœæ‰¾ä¸åˆ°å¡ç‰‡å…ƒç´ ï¼Œä½¿ç”¨æ§½ä½ä½ç½®ä½œç‚ºå‚™ç”¨
        const slotElement = document.getElementById(`slot-t${sourceCol}`);
        if (slotElement) {
            sourceRect = slotElement.getBoundingClientRect();
        } else {
            sourceRect = { left: 100, top: 200, width: cardSize.width, height: cardSize.height };
        }
    }
    
    // ç¬¬äºŒæ­¥ï¼šå¾éŠæˆ²ç‹€æ…‹ä¸­ç§»é™¤ç‰Œ
    removeCardFromSourceBeforeTableauToTableau(task);
    
    // ç¬¬ä¸‰æ­¥ï¼šç«‹å³é‡æ–°æ¸²æŸ“ï¼Œè®“åŸä½ç½®çš„ç‰Œæ¶ˆå¤±
    render();
    
    // ç¬¬å››æ­¥ï¼šç²å–ç›®æ¨™ä½ç½®
    let targetRect;
    const targetPile = state.tableau[targetCol];
    if (targetPile.length > 0) {
        const topCardId = targetPile[targetPile.length - 1].id;
        const topCardElement = document.querySelector(`[data-id="${topCardId}"]`);
        if (topCardElement) {
            const rect = topCardElement.getBoundingClientRect();
            // è¨ˆç®—é‡ç–Šä½ç½®
            const isMobile = window.innerWidth < 600;
            const overlapRatio = isMobile ? 0.5 : 0.7;
            targetRect = { 
                left: rect.left, 
                top: rect.top + (cardSize.height * (1 - overlapRatio))
            };
        } else {
            const slotEl = document.getElementById(`slot-t${targetCol}`);
            targetRect = slotEl.getBoundingClientRect();
        }
    } else {
        const slotEl = document.getElementById(`slot-t${targetCol}`);
        targetRect = slotEl.getBoundingClientRect();
    }
    
    // ç¬¬äº”æ­¥ï¼šå‰µå»ºé£›è¡Œå‹•ç•«å¡ç‰‡
    const flyCard = document.createElement('div');
    flyCard.className = `card flying-card ${card.color}`;
    flyCard.style.backgroundColor = 'white';
    flyCard.dataset.text = card.text;
    
    // é‡å°æ•¸å­—10çš„ç‰¹æ®Šè™•ç†
    const isMobile = window.innerWidth < 600;
    let numHtml = `<div class="card-num ${card.color}">${card.text}</div>`;
    if (card.text === "10" && isMobile) {
        numHtml = `<div class="card-num ${card.color}" style="font-size: 2.5rem; transform: scaleX(0.75); transform-origin: left top; left: 0.8px;">${card.text}</div>`;
    } else if (card.text === "10") {
        numHtml = `<div class="card-num ${card.color}" style="font-size: 1.8rem;">${card.text}</div>`;
    }
    
    flyCard.innerHTML = `
        <div class="card-face">
            ${numHtml}
            <div class="card-suit-top ${card.color}">${card.suit}</div>
            <div class="card-center-suit ${card.color}">${card.suit}</div>
        </div>
    `;
    
    // è¨­ç½®åˆå§‹ä½ç½®ï¼ˆå¾åŸä½ç½®é–‹å§‹ï¼‰
    flyCard.style.left = sourceRect.left + 'px';
    flyCard.style.top = sourceRect.top + 'px';
    flyCard.style.width = sourceRect.width + 'px';
    flyCard.style.height = sourceRect.height + 'px';
    
    document.body.appendChild(flyCard);
    
    // å¼·åˆ¶ç€è¦½å™¨Reflow
    void flyCard.offsetWidth;
    
    // è¨­ç½®ç›®æ¨™ä½ç½®
    flyCard.style.left = targetRect.left + 'px';
    flyCard.style.top = targetRect.top + 'px';
    
    // æ’­æ”¾éŸ³æ•ˆ
    playMoveSound();
    
    // å‹•ç•«å®Œæˆå¾Œæ›´æ–°éŠæˆ²ç‹€æ…‹
    setTimeout(() => {
        // ç§»é™¤å‹•ç•«å¡ç‰‡
        flyCard.remove();
        
        // å®Œæˆé£›ç‰Œé‚è¼¯ï¼šå°‡ç‰Œæ·»åŠ åˆ°ç›®æ¨™ä½ç½®
        finishAutoFlyTableauToTableau(task);
        
    }, 300);
}
    
    /**
     * åœ¨å‹•ç•«é–‹å§‹å‰å¾æºè¡¨æ ¼åˆ—ç§»é™¤ç‰Œ
     */
    function removeCardFromSourceBeforeTableauToTableau(task) {
        const { sourceCol, sourceIdx, card } = task;
        
        // å¾ä¾†æºè¡¨æ ¼åˆ—ç§»é™¤ç‰Œ
        state.tableau[sourceCol].splice(sourceIdx, 1);
        
        // å¦‚æœé‚„æœ‰ç‰Œï¼Œç¿»é–‹æœ€ä¸Šé¢ä¸€å¼µ
        if (state.tableau[sourceCol].length > 0) {
            state.tableau[sourceCol][state.tableau[sourceCol].length - 1].faceUp = true;
        }
    }
    
/**
 * å®Œæˆè¡¨æ ¼åˆ°è¡¨æ ¼çš„é£›ç‰Œé‚è¼¯ï¼ˆå„ªåŒ–ç‰ˆï¼‰
 */
function finishAutoFlyTableauToTableau(task) {
    const { sourceCol, sourceIdx, targetCol, card } = task;
    
    // æ·»åŠ åˆ°ç›®æ¨™è¡¨æ ¼åˆ—
    state.tableau[targetCol].push(card);
    
    // æ›´æ–°éŠæˆ²ç‹€æ…‹
    state.moves++;
    addScore(5); // è¡¨æ ¼é–“ç§»å‹•å¾—5åˆ†
    
    // æ›´æ–°é¡¯ç¤º
    render();
    
    updateTimer();
    updateMagicButton();
    
    // ç¹¼çºŒè™•ç†éšŠåˆ—ï¼ˆä½¿ç”¨CSSè®Šæ•¸æ§åˆ¶çš„å»¶é²æ™‚é–“ï¼‰
    setTimeout(() => {
        processAutoFlyQueue();
    }, autoFlyTiming.delay); // æ¯å¼µç‰Œä¹‹é–“çš„å»¶é²
}
    
/**
 * åŸ·è¡Œç¿»ç‰Œä»»å‹™ï¼ˆå„ªåŒ–ç‰ˆï¼‰
 * ä¿®æ”¹ï¼šç¿»ç‰Œå¾Œé‡æ–°æª¢æŸ¥ç‹€æ…‹
 */
function performAutoFlyDraw(task) {
    // æ¨¡æ“¬ç¿»ç‰Œæ“ä½œ
    if (state.stock.length === 0) {
        // å¦‚æœç‰Œå †ç©ºäº†ï¼Œé‡æ–°å»ºç«‹éšŠåˆ—
        setTimeout(() => {
            buildAutoFlyQueue();
            processAutoFlyQueue();
        }, autoFlyTiming.queueDelay);
        return;
    }
    
    // åŸ·è¡Œç¿»ç‰Œ
    const drawCount = Math.min(state.drawMode, state.stock.length);
    const cardsToDraw = [];
    
    for (let i = 0; i < drawCount; i++) {
        const cardIndex = state.stock.length - 1 - i;
        cardsToDraw.unshift(state.stock[cardIndex]);
    }
    
    // å¾éŠæˆ²ç‹€æ…‹ä¸­ç§»é™¤é€™äº›ç‰Œ
    for (let i = 0; i < drawCount; i++) {
        state.stock.pop();
    }
    
    // å°‡å–å‡ºçš„ç‰ŒåŠ å…¥å»¢ç‰Œå †
    cardsToDraw.forEach(card => {
        card.faceUp = true;
        state.waste.push(card);
    });
    
    state.moves++;
    addScore(5 * drawCount);
    
    // æ›´æ–°é¡¯ç¤º
    updateStockPile();
    updateWastePile();
    updateTimer();
    
    // ç¿»ç‰Œå¾Œé‡æ–°å»ºç«‹éšŠåˆ—
    setTimeout(() => {
        buildAutoFlyQueue();
        processAutoFlyQueue();
    }, autoFlyTiming.queueDelay);
}
    
/**
 * åŸ·è¡Œé‡ç½®ç‰Œå †ä»»å‹™ï¼ˆå„ªåŒ–ç‰ˆï¼‰
 */
function performAutoFlyReset(task) {
    // æ¨¡æ“¬é‡ç½®ç‰Œå †æ“ä½œ
    if (state.waste.length === 0) {
        // å¦‚æœå»¢ç‰Œå †ç©ºäº†ï¼Œç›´æ¥è™•ç†éšŠåˆ—
        setTimeout(() => {
            processAutoFlyQueue();
        }, autoFlyTiming.queueDelay); // ä½¿ç”¨CSSè®Šæ•¸æ§åˆ¶çš„éšŠåˆ—è™•ç†å»¶é²
        return;
    }
    
    // åŸ·è¡Œé‡ç½®ï¼ˆç°¡åŒ–ï¼Œä¸é¡¯ç¤ºå‹•ç•«ï¼‰
    state.stock = state.waste.reverse().map(c => { 
        c.faceUp = false;
        return c; 
    });
    state.waste = [];
    state.moves++;
    addScore(-100);
    
    // æ›´æ–°ç‰¹å®šå€åŸŸ
    updateStockPile();
    updateWastePile();
    
    updateTimer();
    
    // é‡ç½®å¾Œç¹¼çºŒè™•ç†éšŠåˆ—ï¼ˆä½¿ç”¨CSSè®Šæ•¸æ§åˆ¶çš„å»¶é²æ™‚é–“ï¼‰
    setTimeout(() => {
        processAutoFlyQueue();
    }, autoFlyTiming.queueDelay); // ä½¿ç”¨CSSè®Šæ•¸æ§åˆ¶çš„éšŠåˆ—è™•ç†å»¶é²
}
    
    // ==================== æ–°å¢ï¼šå„ªåŒ–è‡ªå‹•é£›ç‰Œå¾Œçš„æ¸²æŸ“å‡½æ•¸ ====================
    /**
     * æ›´æ–°ç‰Œå †
     */
    function updateStockPile() {
        const sPos = slotPositions['slot-stock'];
        
        // ç§»é™¤ç‰Œå †å¡ç‰‡
        const stockCard = document.querySelector('[data-type="stock"]');
        if (stockCard) stockCard.remove();
        
        // ç§»é™¤é‡æ–°æ•´ç†æŒ‰éˆ•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const refreshBtn = document.querySelector('.refresh-btn');
        if (refreshBtn && refreshBtn.parentElement) {
            refreshBtn.parentElement.remove();
        }
        
        // ç¹ªè£½ç‰Œå †
        if (state.stock.length > 0) {
            const stockDiv = document.createElement('div');
            stockDiv.className = 'card back';
            stockDiv.style.left = sPos.left + 'px';
            stockDiv.style.top = sPos.top + 'px';
            stockDiv.dataset.type = 'stock';
            
            // æ·»åŠ ç‰Œå †å‰©é¤˜æ•¸é‡é¡¯ç¤ºï¼ˆæ ¹æ“šè¨­å®šæ±ºå®šæ˜¯å¦é¡¯ç¤ºï¼‰
            if (state.showCardCount) {
                const countDiv = document.createElement('div');
                countDiv.className = 'card-count';
                countDiv.textContent = state.stock.length;
                stockDiv.appendChild(countDiv);
            }
            
            stockDiv.addEventListener('click', () => drawStockWithAnimation());
            document.getElementById('card-layer').appendChild(stockDiv);
        } else {
            // ç‰Œå †ç‚ºç©ºæ™‚é¡¯ç¤ºé‡æ–°æ•´ç†æŒ‰éˆ•
            const emptyStock = document.createElement('div');
            emptyStock.style.cssText = `position:absolute; left:${sPos.left}px; top:${sPos.top}px; width:${cardSize.width}px; height:${cardSize.height}px;`;
            emptyStock.innerHTML = '<div class="refresh-btn">â†º</div>';
            emptyStock.addEventListener('click', resetStock);
            document.getElementById('card-layer').appendChild(emptyStock);
        }
    }
    
    /**
     * æ›´æ–°ç‰¹å®šè¡¨æ ¼åˆ—
     * @param {number} col - åˆ—ç´¢å¼•
     */
    function updateTableauColumn(col) {
        const pile = state.tableau[col];
        const pos = slotPositions[`slot-t${col}`];
        
        // ç§»é™¤è©²åˆ—çš„æ‰€æœ‰å¡ç‰‡
        document.querySelectorAll(`[data-type="tableau"][data-pile-idx="${col}"]`).forEach(el => {
            el.remove();
        });
        
        // é‡æ–°ç¹ªè£½è©²åˆ—
        let currentOffset = 0;
        pile.forEach((card, idx) => {
            if (idx > 0) {
                const prevCard = pile[idx - 1];
                
                // åˆ†é–‹æ‰‹æ©Ÿç‰ˆå’Œç¶²é ç‰ˆçš„é‡ç–Šæ¯”ä¾‹è¨ˆç®—é‚è¼¯
                let overlapRatio;
                const isMobile = window.innerWidth < 600;
                
                if (isMobile) {
                    if (prevCard.faceUp) {
                        overlapRatio = card.faceUp ? 0.5 : 0.9;
                    } else {
                        overlapRatio = 0.9;
                    }
                } else {
                    if (prevCard.faceUp) {
                        overlapRatio = card.faceUp ? 0.7 : 0.9;
                    } else {
                        overlapRatio = 0.9;
                    }
                }
                
                // ä¿®æ­£ï¼šé‡ç–Šæ¯”ä¾‹ç‚º0.7æ„å‘³è‘—é‡ç–Š70%ï¼Œéœ²å‡º30%
                // æ‰€ä»¥åç§»é‡æ‡‰è©²æ˜¯å¡ç‰‡é«˜åº¦ * (1 - é‡ç–Šæ¯”ä¾‹)
                currentOffset += cardSize.height * (1 - overlapRatio);
            }
            
            // å‰µå»ºå¡ç‰‡å…ƒç´ 
            const div = document.createElement('div');
            div.className = `card ${card.faceUp ? '' : 'back'}`;
            div.style.left = pos.left + 'px';
            div.style.top = pos.top + currentOffset + 'px';
            div.dataset.id = card.id;
            div.dataset.type = 'tableau';
            div.dataset.pileIdx = col;
            div.dataset.cardIdx = idx;
            div.dataset.text = card.text;

            if (card.faceUp) {
                div.classList.add(card.color);
                div.innerHTML = `
                    <div class="card-face">
                        <div class="card-num ${card.color}">${card.text}</div>
                        <div class="card-suit-top ${card.color}">${card.suit}</div>
                        <div class="card-center-suit ${card.color}">${card.suit}</div>
                    </div>
                `;
                
                // æ·»åŠ æ‹–æ›³äº‹ä»¶ç›£è½å™¨
                div.addEventListener('mousedown', (e) => startDrag(e, 'tableau', col, idx));
                div.addEventListener('touchstart', (e) => startDrag(e, 'tableau', col, idx), {passive: false});
            } else {
                // åªæœ‰æœ€ä¸Šé¢çš„è“‹ç‰Œå¯ä»¥é»æ“Š
                if (idx === pile.length - 1) {
                    div.addEventListener('click', () => flipTableauCard(col));
                }
            }
            
            document.getElementById('card-layer').appendChild(div);
        });
    }
    
    /**
     * æ›´æ–°èŠ±è‰²å€
     * @param {number} foundationIdx - èŠ±è‰²å€ç´¢å¼•
     */
    function updateFoundationPile(foundationIdx) {
        const pile = state.foundations[foundationIdx];
        const pos = slotPositions[`slot-f${foundationIdx}`];
        
        // ç§»é™¤è©²èŠ±è‰²å€çš„æ‰€æœ‰å¡ç‰‡
        document.querySelectorAll(`[data-type="foundation"][data-pile-idx="${foundationIdx}"]`).forEach(el => {
            el.remove();
        });
        
        // å¦‚æœèŠ±è‰²å€æœ‰ç‰Œï¼Œé‡æ–°ç¹ªè£½
        if (pile.length > 0) {
            const card = pile[pile.length - 1];
            const div = document.createElement('div');
            div.className = `card ${card.color}`;
            div.style.left = pos.left + 'px';
            div.style.top = pos.top + 'px';
            div.dataset.id = card.id;
            div.dataset.type = 'foundation';
            div.dataset.pileIdx = foundationIdx;
            div.dataset.cardIdx = pile.length - 1;
            div.dataset.text = card.text;
            div.innerHTML = `
                <div class="card-face">
                    <div class="card-num ${card.color}">${card.text}</div>
                    <div class="card-suit-top ${card.color}">${card.suit}</div>
                    <div class="card-center-suit ${card.color}">${card.suit}</div>
                </div>
            `;
            
            // æ·»åŠ æ‹–æ›³äº‹ä»¶ç›£è½å™¨
            div.addEventListener('mousedown', (e) => startDrag(e, 'foundation', foundationIdx, pile.length - 1));
            div.addEventListener('touchstart', (e) => startDrag(e, 'foundation', foundationIdx, pile.length - 1), {passive: false});
            
            document.getElementById('card-layer').appendChild(div);
        }
    }
    
    /**
     * æ›´æ–°å»¢ç‰Œå †
     */
    function updateWastePile() {
        const wasteLen = state.waste.length;
        const wPos = slotPositions['slot-waste'];
        
        // ç§»é™¤å»¢ç‰Œå †çš„æ‰€æœ‰å¡ç‰‡
        document.querySelectorAll('[data-type="waste"]').forEach(el => {
            el.remove();
        });
        
        // é‡æ–°ç¹ªè£½å»¢ç‰Œå †
        if (wasteLen > 0) {
            if (state.drawMode === 3 && wasteLen >= 3) {
                // ä¸‰å¼µæ¨¡å¼ï¼šé¡¯ç¤ºæœ€è¿‘çš„ä¸‰å¼µç‰Œ
                const displayCards = state.waste.slice(-3);
                
                for (let i = 0; i < 3; i++) {
                    const card = displayCards[i];
                    const offset = i * (cardSize.width * 0.3);
                    
                    const div = document.createElement('div');
                    div.className = `card ${card.color}`;
                    div.style.left = wPos.left + offset + 'px';
                    div.style.top = wPos.top + 'px';
                    div.dataset.id = card.id;
                    div.dataset.type = 'waste';
                    div.dataset.pileIdx = 0;
                    div.dataset.cardIdx = wasteLen-3+i;
                    div.dataset.text = card.text;
                    div.innerHTML = `
                        <div class="card-face">
                            <div class="card-num ${card.color}">${card.text}</div>
                            <div class="card-suit-top ${card.color}">${card.suit}</div>
                            <div class="card-center-suit ${card.color}">${card.suit}</div>
                        </div>
                    `;
                    
                    // åªæœ‰æœ€ä¸Šé¢çš„ç‰Œå¯ä»¥æ‹–æ›³
                    if (i === 2) {
                        div.addEventListener('mousedown', (e) => startDrag(e, 'waste', 0, wasteLen - 1));
                        div.addEventListener('touchstart', (e) => startDrag(e, 'waste', 0, wasteLen - 1), {passive: false});
                    }
                    
                    document.getElementById('card-layer').appendChild(div);
                }
            } else if (state.drawMode === 3 && wasteLen < 3) {
                // ä¸‰å¼µæ¨¡å¼ä½†ç‰Œä¸å¤ ä¸‰å¼µ
                for (let i = 0; i < wasteLen; i++) {
                    const card = state.waste[i];
                    const offset = i * (cardSize.width * 0.3);
                    
                    const div = document.createElement('div');
                    div.className = `card ${card.color}`;
                    div.style.left = wPos.left + offset + 'px';
                    div.style.top = wPos.top + 'px';
                    div.dataset.id = card.id;
                    div.dataset.type = 'waste';
                    div.dataset.pileIdx = 0;
                    div.dataset.cardIdx = i;
                    div.dataset.text = card.text;
                    div.innerHTML = `
                        <div class="card-face">
                            <div class="card-num ${card.color}">${card.text}</div>
                            <div class="card-suit-top ${card.color}">${card.suit}</div>
                            <div class="card-center-suit ${card.color}">${card.suit}</div>
                        </div>
                    `;
                    
                    // åªæœ‰æœ€ä¸Šé¢çš„ç‰Œå¯ä»¥æ‹–æ›³
                    if (i === wasteLen - 1) {
                        div.addEventListener('mousedown', (e) => startDrag(e, 'waste', 0, wasteLen - 1));
                        div.addEventListener('touchstart', (e) => startDrag(e, 'waste', 0, wasteLen - 1), {passive: false});
                    }
                    
                    document.getElementById('card-layer').appendChild(div);
                }
            } else {
                // ä¸€å¼µæ¨¡å¼ï¼šåªé¡¯ç¤ºæœ€ä¸Šé¢çš„ä¸€å¼µç‰Œ
                const topWasteCard = state.waste[wasteLen - 1];
                const div = document.createElement('div');
                div.className = `card ${topWasteCard.color}`;
                div.style.left = wPos.left + 'px';
                div.style.top = wPos.top + 'px';
                div.dataset.id = topWasteCard.id;
                div.dataset.type = 'waste';
                div.dataset.pileIdx = 0;
                div.dataset.cardIdx = wasteLen - 1;
                div.dataset.text = topWasteCard.text;
                div.innerHTML = `
                    <div class="card-face">
                        <div class="card-num ${topWasteCard.color}">${topWasteCard.text}</div>
                        <div class="card-suit-top ${topWasteCard.color}">${topWasteCard.suit}</div>
                        <div class="card-center-suit ${topWasteCard.color}">${topWasteCard.suit}</div>
                    </div>
                `;
                
                // æ·»åŠ æ‹–æ›³äº‹ä»¶ç›£è½å™¨
                div.addEventListener('mousedown', (e) => startDrag(e, 'waste', 0, wasteLen - 1));
                div.addEventListener('touchstart', (e) => startDrag(e, 'waste', 0, wasteLen - 1), {passive: false});
                
                document.getElementById('card-layer').appendChild(div);
            }
        }
    }
    
/**
 * ç§»å‹•å¾Œæª¢æŸ¥æ˜¯å¦è§¸ç™¼è‡ªå‹•é£›ç‰Œï¼ˆå„ªåŒ–ç‰ˆï¼‰
 */
function checkAutoFlyAfterMove() {
    // å¦‚æœæ­£åœ¨è‡ªå‹•é£›ç‰Œä¸­ï¼Œä¸é‡è¤‡è§¸ç™¼
    if (isAutoFlying || isDrawing) return;
    
    // ç§»é™¤ä¹‹å‰çš„å»¶é²ï¼Œç«‹å³æª¢æŸ¥
    if (checkAutoFlyCondition() && hasFlyableCards()) {
        // å»¶é²å•Ÿå‹•è‡ªå‹•é£›ç‰Œï¼Œçµ¦ç©å®¶ä¸€é»åæ‡‰æ™‚é–“
        autoFlyTimeout = setTimeout(() => {
            startAutoFly();
        }, autoFlyTiming.initialDelay); // ä½¿ç”¨CSSè®Šæ•¸æ§åˆ¶çš„å»¶é²æ™‚é–“ï¼ˆå·²ç¸®çŸ­ç‚º0.1sï¼‰
    }
}

    // ==================== éŠæˆ²çµæŸæª¢æŸ¥ ====================
    /**
     * æª¢æŸ¥æ˜¯å¦ç²å‹
     */
    function checkWin() {
        let totalCards = 0;
        state.foundations.forEach(pile => totalCards += pile.length); // è¨ˆç®—èŠ±è‰²å€ç¸½ç‰Œæ•¸
        if (totalCards === 52) { // æ‰€æœ‰ç‰Œéƒ½åœ¨èŠ±è‰²å€
            stopTimer(); // åœæ­¢è¨ˆæ™‚å™¨
            stopAutoFly(); // åœæ­¢è‡ªå‹•é£›ç‰Œ
            setTimeout(() => {
                showVictoryDialog(); // é¡¯ç¤ºå‹åˆ©ç•«é¢
            }, 500);
        }
    }

    // ==================== é é¢è¼‰å…¥å’Œäº‹ä»¶ç›£è½ ====================
    window.addEventListener('load', () => {
        // åˆå§‹åŒ–éŸ³æ•ˆç³»çµ±
        initAudio();
        
        // åˆå§‹åŒ–ç…™èŠ±æ•ˆæœ
        initFireworks();
        
        // å¾æœ¬åœ°å„²å­˜è¼‰å…¥è¨­å®š
        loadSettingsFromLocalStorage();
        
        // åˆå§‹åŒ–éŠæˆ²
        initGame('guaranteed'); // åˆå§‹åŒ–éŠæˆ²
        
        // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–
        window.addEventListener('resize', layoutSlots);
        
        // æ·»åŠ åˆ†æ•¸æ¡†é»æ“Šäº‹ä»¶ç›£è½å™¨ï¼ˆæ¸¬è©¦åŠŸèƒ½ï¼‰
        document.getElementById('score-display').addEventListener('click', handleScoreClick);
        
    // æ·»åŠ æ­¥æ•¸é¡¯ç¤ºé›™æ“Šäº‹ä»¶ç›£è½å™¨
    const timeMovesElement = document.getElementById('time-moves');
    let lastTimeMovesClick = 0;
    timeMovesElement.addEventListener('click', function() {
        const now = Date.now();
        if (now - lastTimeMovesClick < 500) {
            autoMoveOnClick = !autoMoveOnClick;
            showMessage(autoMoveOnClick ? "å·²åˆ‡æ›åˆ°å–®æ“Šè‡ªå‹•ç§»å‹•æ¨¡å¼" : "å·²åˆ‡æ›åˆ°é›™æ“Šè‡ªå‹•ç§»å‹•æ¨¡å¼", 1500);
            lastTimeMovesClick = 0;
        } else {
            lastTimeMovesClick = now;
        }
    });
});
    
    // é˜²æ­¢æ‰‹æ©Ÿé›™æŒ‡ç¸®æ”¾
    document.addEventListener('gesturestart', function (e) {
        e.preventDefault();
    });
</script>
</body>
</html>