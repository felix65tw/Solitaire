<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¶“å…¸æ¥é¾</title>
    <style>
        /* CSS è®Šæ•¸å®šç¾©ï¼Œæ–¹ä¾¿å…¨åŸŸèª¿æ•´æ¨£å¼ */
        :root {
            --bg-color: #35654d; /* éŠæˆ²èƒŒæ™¯é¡è‰² */
            --card-width: 13vw; /* å¡ç‰‡é è¨­å¯¬åº¦ (è¦–çª—å¯¬åº¦ç™¾åˆ†æ¯”) */
            --card-height: 18.2vw; /* å¡ç‰‡é è¨­é«˜åº¦ (è¦–çª—å¯¬åº¦ç™¾åˆ†æ¯”) */
            --max-w: 100px; /* å¡ç‰‡æœ€å¤§å¯¬åº¦ */
            --max-h: 140px; /* å¡ç‰‡æœ€å¤§é«˜åº¦ */
            --gap: 2vw; /* å¡ç‰‡é–“è· */
            --animation-draw-speed: 0.1s; /* åƒæ•¸ï¼šç¿»ç‰Œå‹•ç•«é€Ÿåº¦ */
            --animation-move-speed: 0.1s; /* åƒæ•¸ï¼šå¡ç‰‡ç§»å‹•å‹•ç•«é€Ÿåº¦ */
            --animation-magic-speed: 0.5s; /* åƒæ•¸ï¼šé­”æ³•å‹•ç•«é€Ÿåº¦ */
            --animation-pulse-speed: 0.8s; /* åƒæ•¸ï¼šè„ˆè¡å‹•ç•«é€Ÿåº¦ */
            --animation-shake-speed: 0.4s; /* åƒæ•¸ï¼šæŠ–å‹•å‹•ç•«é€Ÿåº¦ */
        }

        /* å…¨åŸŸæ¨£å¼è¨­å®š */
        body {
            background-color: var(--bg-color); /* ä½¿ç”¨CSSè®Šæ•¸è¨­å®šèƒŒæ™¯è‰² */
            margin: 0;
            overflow: hidden; /* éš±è—æ»¾å‹•æ¢ */
            user-select: none; /* ç¦æ­¢æ–‡å­—é¸å– */
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; /* å­—å‹è¨­å®š */
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç§»å‹•ç«¯é»æ“Šé«˜äº® */
            touch-action: manipulation; /* æ”¹å–„è§¸æ§éŸ¿æ‡‰ */
        }

        /* å·¥å…·æ¬„æ¨£å¼ */
        .toolbar {
            height: 50px; /* å·¥å…·æ¬„é«˜åº¦ */
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px; /* æ‰‹æ©Ÿä¸Šæ¸›å°‘padding */
            color: white;
            background: rgba(0,0,0,0.2); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
        }
        
        /* å·¥å…·æ¬„å·¦å´å€å¡Š */
        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 15px; /* å…ƒç´ é–“è· */
        }
        
        /* æ™‚é–“èˆ‡æ­¥æ•¸é¡¯ç¤º - ä¿®æ”¹ç‚ºå›ºå®šå¯¬åº¦ */
        .time-moves-display {
            font-size: 14px;
            font-weight: bold;
            color: white;
            padding: 2px 8px;
            background: rgba(0,0,0,0.3); /* åŠé€æ˜èƒŒæ™¯ */
            border-radius: 10px; /* åœ“è§’ */
            min-width: 120px; /* å›ºå®šå¯¬åº¦ï¼Œå®¹ç´4ä½æ•¸ */
            text-align: center;
            font-variant-numeric: tabular-nums; /* ç­‰å¯¬æ•¸å­— */
        }
        
        /* åˆ†æ•¸é¡¯ç¤º - ä¿®æ”¹ç‚ºå›ºå®šå¯¬åº¦ */
        .score-display {
            font-size: 14px;
            font-weight: bold;
            color: #FFD700; /* é‡‘è‰²æ–‡å­— */
            padding: 2px 8px;
            background: rgba(0,0,0,0.3); /* åŠé€æ˜èƒŒæ™¯ */
            border-radius: 10px; /* åœ“è§’ */
            min-width: 80px; /* å›ºå®šå¯¬åº¦ï¼Œå®¹ç´4ä½æ•¸ */
            text-align: center;
            font-variant-numeric: tabular-nums; /* ç­‰å¯¬æ•¸å­— */
            cursor: pointer; /* æ·»åŠ æ‰‹å½¢æ¸¸æ¨™ï¼Œè¡¨ç¤ºå¯é»æ“Š */
            transition: transform 0.2s, background 0.2s; /* æ·»åŠ éæ¸¡æ•ˆæœ */
        }
        
        /* åˆ†æ•¸é¡¯ç¤ºé»æ“Šæ•ˆæœ */
        .score-display:active {
            transform: scale(0.95); /* é»æ“Šæ™‚ç¸®å° */
        }
        
        /* è¨­å®šæŒ‰éˆ•æ¨£å¼ */
        #settings-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 2px solid rgba(255,255,255,0.5);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        #settings-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
        }
        
        /* å·¥å…·æ¬„æŒ‰éˆ•å€å¡Š - ç¾åŒ–ç‰ˆ */
        .toolbar-buttons {
            display: flex;
            gap: 10px; /* å¢åŠ é–“è·ä½¿æŒ‰éˆ•æ›´æ˜é¡¯ */
        }
        
        /* æŒ‰éˆ•åŸºç¤æ¨£å¼ - ç¾åŒ–ç‰ˆ */
        .toolbar-buttons button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 25px; /* å¢åŠ åœ“è§’ */
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); /* æ·»åŠ é™°å½± */
            transition: all 0.3s ease;
            min-width: 80px; /* è¨­ç½®æœ€å°å¯¬åº¦ */
            text-align: center;
        }
        
        /* æŒ‰éˆ•æ‡¸åœæ•ˆæœ - ç¾åŒ–ç‰ˆ */
        .toolbar-buttons button:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.25);
        }
        
        /* æŒ‰éˆ•æŒ‰ä¸‹æ•ˆæœ - ç¾åŒ–ç‰ˆ */
        .toolbar-buttons button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* é­”æ³•æŒ‰éˆ•ç‰¹æ®Šæ¨£å¼ - ä¿®æ”¹ç‚ºèˆ‡æ‰‹æ©Ÿç‰ˆç›¸åŒçš„ä¸ƒå½©é¡è‰² */
        #magic-btn {
            background: linear-gradient(135deg, 
                #FF0000 0%, 
                #FF9900 15%, 
                #FFFF00 30%, 
                #00FF00 45%, 
                #0000FF 60%,  /* è—è‰²èª¿æ•´åˆ°ä¸­é–“ä½ç½® */
                #00FFFF 75%, 
                #FF00FF 90%, 
                #FF0000 100%);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.8);
            background-size: 200% 200%;
            animation: rainbowBackground 3s infinite linear;
        }
        
        @keyframes rainbowBackground {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        #magic-btn:hover {
            background: linear-gradient(135deg, 
                #FF0000 0%, 
                #FF9900 15%, 
                #FFFF00 30%, 
                #00FF00 45%, 
                #0000FF 60%, 
                #00FFFF 75%, 
                #FF00FF 90%, 
                #FF0000 100%);
            background-size: 200% 200%;
            animation: rainbowBackground 3s infinite linear;
            box-shadow: 0 6px 20px rgba(0, 0, 255, 0.4);
        }
        
        #magic-btn:disabled {
            background: linear-gradient(135deg, #cccccc 0%, #999999 100%);
            color: #666;
            border: 2px solid #999;
            box-shadow: none;
            transform: none;
            animation: none;
        }
        
        /* ç¦ç”¨æŒ‰éˆ•æ¨£å¼ */
        .toolbar-buttons button:disabled {
            background: linear-gradient(135deg, #cccccc 0%, #999999 100%);
            color: #666;
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
        }
        
        /* è¨Šæ¯æç¤ºæ¡† */
        #message {
            position: fixed; /* å›ºå®šå®šä½ */
            top: 60px;
            left: 50%;
            transform: translateX(-50%); /* æ°´å¹³å±…ä¸­ */
            background: rgba(0,0,0,0.8); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
            color: white;
            padding: 10px 20px;
            border-radius: 5px; /* åœ“è§’ */
            z-index: 10000; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
            display: none; /* é è¨­éš±è— */
            font-size: 14px;
            max-width: 90%; /* æœ€å¤§å¯¬åº¦ */
            text-align: center; /* æ–‡å­—å±…ä¸­ */
        }

        /* éŠæˆ²ä¸»å€åŸŸ */
        #game-board {
            position: relative; /* ç›¸å°å®šä½ */
            width: 100vw; /* å…¨è¦–çª—å¯¬åº¦ */
            height: calc(100vh - 50px); /* æ¸›å»å·¥å…·æ¬„é«˜åº¦ */
            max-width: 800px; /* æœ€å¤§å¯¬åº¦é™åˆ¶ */
            margin: 0 auto; /* æ°´å¹³å±…ä¸­ */
            margin-top: 5px; /* æ‰‹æ©Ÿä¸Šæ¸›å°‘ä¸Šé‚Šè· */
            overflow: hidden; /* é˜²æ­¢æº¢å‡º */
        }

        /* å¡ç‰‡ä½ç½®æ§½ä½ */
        .slot {
            position: absolute; /* çµ•å°å®šä½ */
            width: var(--card-width); /* ä½¿ç”¨CSSè®Šæ•¸è¨­å®šå¯¬åº¦ */
            height: var(--card-height); /* ä½¿ç”¨CSSè®Šæ•¸è¨­å®šé«˜åº¦ */
            max-width: var(--max-w); /* æœ€å¤§å¯¬åº¦é™åˆ¶ */
            max-height: var(--max-h); /* æœ€å¤§é«˜åº¦é™åˆ¶ */
            border: 2px solid rgba(255,255,255,0.2); /* åŠé€æ˜é‚Šæ¡† */
            border-radius: 8px; /* åœ“è§’ */
            box-sizing: border-box; /* ç›’æ¨¡å‹è¨­å®š */
        }

        /* å¡ç‰‡åŸºç¤æ¨£å¼ */
        .card {
            position: absolute; /* çµ•å°å®šä½ */
            width: var(--card-width); /* ä½¿ç”¨CSSè®Šæ•¸è¨­å®šå¯¬åº¦ */
            height: var(--card-height); /* ä½¿ç”¨CSSè®Šæ•¸è¨­å®šé«˜åº¦ */
            max-width: var(--max-w); /* æœ€å¤§å¯¬åº¦é™åˆ¶ */
            max-height: var(--max-h); /* å¡ç‰‡æœ€å¤§é«˜åº¦é™åˆ¶ */
            background-color: white; /* ç™½è‰²èƒŒæ™¯ */
            border-radius: 6px; /* åœ“è§’ */
            box-shadow: 1px 1px 3px rgba(0,0,0,0.4); /* é™°å½±æ•ˆæœ */
            display: flex;
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            z-index: 10; /* åœ–å±¤é †åº */
            cursor: pointer; /* æ¸¸æ¨™æ‰‹å½¢ */
            box-sizing: border-box; /* ç›’æ¨¡å‹è¨­å®š */
            transition: box-shadow 0.2s; /* é™°å½±éæ¸¡æ•ˆæœ */
            -webkit-user-drag: none; /* é˜²æ­¢æ‹–æ›³åœ–ç‰‡ */
        }

        /* ç”¨æ–¼è‡ªå‹•ç§»å‹•æ™‚çš„é£›è¡Œå¡ç‰‡ */
        .flying-card {
            position: fixed; /* å›ºå®šå®šä½ */
            z-index: 99999; /* æœ€é«˜åœ–å±¤ */
            pointer-events: none; /* ç¦æ­¢è§¸ç™¼äº‹ä»¶ */
            transition: all var(--animation-move-speed) ease-in-out; /* åƒæ•¸ï¼šä½¿ç”¨å¡ç‰‡ç§»å‹•å‹•ç•«é€Ÿåº¦ */
        }

        /* å¡ç‰‡é¢ */
        .card-face {
            width: 100%;
            height: 100%;
            position: relative; /* ç›¸å°å®šä½ */
            pointer-events: none; /* ç¦æ­¢è§¸ç™¼äº‹ä»¶ */
        }

        /* å·¦ä¸Šè§’æ•¸å­— */
        .card-num { 
            font-size: 1.8rem; 
            font-weight: 800; 
            line-height: 1;
            position: absolute;
            top: 4px; /* æ¸›å°‘ä¸Šé‚Šè· */
            left: 4px; /* æ¸›å°‘å·¦é‚Šè· */
        }
        
        /* å³ä¸Šè§’èŠ±è‰² */
        .card-suit-top { 
            font-size: 1.8rem; 
            line-height: 1; 
            position: absolute;
            top: 4px; /* æ¸›å°‘ä¸Šé‚Šè· */
            right: 4px; /* æ¸›å°‘å³é‚Šè· */
        }
        
        /* å¡ç‰‡ä¸­é–“çš„å¤§èŠ±è‰² */
        .card-center-suit {
            position: absolute;
            top: 62%; /* åŸæœ¬æ˜¯ 50%ï¼Œæ”¹æˆ 62% å¾€ä¸‹ç§» */
            left: 50%;
            transform: translate(-50%, -50%); /* å±…ä¸­å°é½Š */
            font-size: 4rem;
            font-weight: normal;
        }
        
        /* ç´…è‰²èŠ±è‰² */
        .red { color: #d32f2f; }
        /* é»‘è‰²èŠ±è‰² */
        .black { color: #212121; }

        /* å¡ç‰‡èƒŒé¢æ¨£å¼ */
        .back {
            background: repeating-linear-gradient( /* é‡è¤‡ç·šæ€§æ¼¸è®Š */
                45deg, /* 45åº¦è§’ */
                #1565c0, /* é¡è‰²1 */
                #1565c0 10px, /* é¡è‰²1çµæŸä½ç½® */
                #0d47a1 10px, /* é¡è‰²2é–‹å§‹ä½ç½® */
                #0d47a1 20px /* é¡è‰²2çµæŸä½ç½® */
            );
            border: 2px solid #fff; /* ç™½è‰²é‚Šæ¡† */
        }
        
        /* ç‰Œå †å¡ç‰‡ä¸Šçš„å‰©é¤˜æ•¸é‡é¡¯ç¤º */
        .card-count {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            z-index: 2;
            transition: opacity 0.3s;
        }
        
        /* éš±è—ç‰Œå †æ•¸å­—é¡¯ç¤º */
        .card-count.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* æ‹–æ›³ä¸­çš„å¡ç‰‡ */
        .dragging-card {
            position: fixed; /* å›ºå®šå®šä½ */
            z-index: 9999; /* é«˜åœ–å±¤ */
            pointer-events: none; /* ç¦æ­¢è§¸ç™¼äº‹ä»¶ */
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5); /* æ›´æ˜é¡¯çš„é™°å½± */
            opacity: 0.9; /* åŠé€æ˜ */
        }

        /* é‡æ–°æ•´ç†æŒ‰éˆ• */
        .refresh-btn {
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            font-size: 2rem; color: rgba(255,255,255,0.5);
            cursor: pointer;
        }

        /* é«˜å…‰æ•ˆæœï¼šå¢åŠ  pointer-events: none é˜²æ­¢æ“‹ä½é»æ“Š */
        .highlight {
            animation: yellowPulse var(--animation-pulse-speed) infinite alternate; /* åƒæ•¸ï¼šä½¿ç”¨è„ˆè¡å‹•ç•«é€Ÿåº¦ */
            box-shadow: 0 0 0 4px #FFEB3B, 0 0 20px 8px #FFEB3B !important;
            border: 2px solid #FFEB3B !important;
            z-index: 1000;
            pointer-events: none; /* é—œéµä¿®å¾©ï¼šè®“é»æ“Šç©¿é€é«˜å…‰æ¡† */
        }

        /* ç›®æ¨™é«˜å…‰æ•ˆæœ */
        .target-highlight {
            animation: targetPulse var(--animation-pulse-speed) infinite alternate; /* åƒæ•¸ï¼šä½¿ç”¨è„ˆè¡å‹•ç•«é€Ÿåº¦ */
            box-shadow: 0 0 0 4px #4CAF50, 0 0 20px 8px #4CAF50 !important;
            border: 2px solid #4CAF50 !important;
            z-index: 999;
            pointer-events: none; /* é—œéµä¿®å¾© */
        }

        /* é»ƒè‰²è„ˆè¡å‹•ç•« */
        @keyframes yellowPulse {
            0% { box-shadow: 0 0 0 4px #FFEB3B, 0 0 20px 8px #FFEB3B !important; transform: scale(1.02); }
            100% { box-shadow: 0 0 0 6px #FFEB3B, 0 0 30px 12px #FFEB3B !important; transform: scale(1.05); }
        }

        /* ç¶ è‰²è„ˆè¡å‹•ç•« */
        @keyframes targetPulse {
            0% { box-shadow: 0 0 0 4px #4CAF50, 0 0 20px 8px #4CAF50 !important; transform: scale(1.02); }
            100% { box-shadow: 0 0 0 6px #4CAF50, 0 0 30px 12px #4CAF50 !important; transform: scale(1.05); }
        }

        /* é‡‘å…‰é–ƒé–ƒå‹•ç•« - é­”æ³•æŒ‰éˆ•å°ˆç”¨ (åŠ å¼·ç‰ˆ) */
        .golden-glow {
            animation: goldenPulse 0.5s infinite alternate;
            box-shadow: 
                0 0 30px #FFD700, 
                0 0 60px #FFD700, 
                0 0 90px #FFD700,
                0 0 120px #FFD700,
                0 0 150px #FFD700 !important;
            border: 4px solid #FFD700 !important;
            z-index: 99999;
            filter: brightness(1.5);
        }

        @keyframes goldenPulse {
            0% { 
                box-shadow: 
                    0 0 20px #FFD700, 
                    0 0 40px #FFD700, 
                    0 0 60px #FFD700,
                    0 0 80px #FFD700 !important; 
                transform: scale(1.05);
                filter: brightness(1.2);
            }
            100% { 
                box-shadow: 
                    0 0 40px #FFD700, 
                    0 0 80px #FFD700, 
                    0 0 120px #FFD700,
                    0 0 160px #FFD700 !important; 
                transform: scale(1.15);
                filter: brightness(1.8);
            }
        }

        /* æŠ–å‹•å‹•ç•« */
        .shake {
            animation: shake var(--animation-shake-speed) ease-in-out; /* åƒæ•¸ï¼šä½¿ç”¨æŠ–å‹•å‹•ç•«é€Ÿåº¦ */
        }

        /* æŠ–å‹•å‹•ç•«é—œéµå½±æ ¼ */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            16% { transform: translateX(-6px); }
            33% { transform: translateX(6px); }
            50% { transform: translateX(-6px); }
            66% { transform: translateX(6px); }
            83% { transform: translateX(-6px); }
        }

        /* ç¿»ç‰Œå‹•ç•«å¡ç‰‡ */
        .draw-animation-card {
            position: fixed;
            z-index: 99998;
            pointer-events: none;
            transition: all var(--animation-draw-speed) ease-in-out; /* åƒæ•¸ï¼šä½¿ç”¨ç¿»ç‰Œå‹•ç•«é€Ÿåº¦ */
            transform-origin: center;
            background-color: white !important; /* ç¢ºä¿å‹•ç•«å¡ç‰‡èƒŒæ™¯ç‚ºç™½è‰² */
        }
        
        /* é­”æ³•å‹•ç•«å¡ç‰‡ */
        .magic-animation-card {
            position: fixed;
            z-index: 99997;
            pointer-events: none;
            transition: all var(--animation-magic-speed) ease-in-out; /* åƒæ•¸ï¼šä½¿ç”¨é­”æ³•å‹•ç•«é€Ÿåº¦ */
            transform-origin: center;
            background-color: white !important;
            border: 2px solid #667eea;
            box-shadow: 0 0 20px #667eea !important;
        }
        
        /* æ‰‹æ©Ÿç‰ˆåŠŸèƒ½éµå®¹å™¨ - ç¾åŒ–ç‰ˆ - ä¿®æ­£ï¼šå±…ä¸­å°é½Š */
        .mobile-toolbar-container {
            display: none;
            position: fixed; /* æ”¹ç‚ºå›ºå®šå®šä½ */
            bottom: 80px; /* èª¿æ•´ä½ç½®åˆ°é é¢åº•éƒ¨ */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0, 0, 0, 0.6); /* æ”¹ç‚ºæ·±è‰²åŠé€æ˜èƒŒæ™¯ */
            border-radius: 20px; /* åœ“è§’ */
            padding: 10px 12px; /* èª¿æ•´å…§é‚Šè· */
            box-shadow: 0 10px 30px rgba(0,0,0,0.4); /* é™°å½±æ•ˆæœ */
            flex-direction: row; /* æ©«å‘æ’åˆ— */
            gap: 6px; /* æŒ‰éˆ•é–“è· */
            flex-wrap: nowrap; /* é˜²æ­¢æ›è¡Œ */
            justify-content: center;
            align-items: center;
            min-width: 280px; /* æœ€å°å¯¬åº¦ */
            max-width: 90vw; /* ç¢ºä¿ä¸è¶…å‡ºè¢å¹•å¯¬åº¦ */
            backdrop-filter: blur(15px); /* æ¯›ç»ç’ƒæ•ˆæœ */
            border: 1px solid rgba(255, 255, 255, 0.3); /* é‚Šæ¡† */
            box-sizing: border-box; /* åŒ…å«å…§é‚Šè·å’Œé‚Šæ¡†åœ¨å¯¬åº¦å…§ */
        }
        
        /* æ‰‹æ©Ÿç‰ˆåŠŸèƒ½æŒ‰éˆ•ç¾åŒ– */
        .mobile-toolbar-container button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* æ¼¸è®ŠèƒŒæ™¯ */
            color: white;
            border: none;
            border-radius: 15px; /* åœ“è§’ */
            padding: 8px 10px; /* èª¿æ•´å…§é‚Šè· */
            font-weight: bold;
            font-size: 13px; /* å­—é«”å¤§å° */
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* é™°å½±æ•ˆæœ */
            transition: all 0.3s ease;
            min-width: 55px; /* æœ€å°å¯¬åº¦ */
            white-space: nowrap;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            flex: 1; /* ç­‰å¯¬æŒ‰éˆ• */
        }
        
        /* æ‰‹æ©Ÿç‰ˆé­”æ³•æŒ‰éˆ•ä¸ƒå½©é¡è‰² - èª¿æ•´ç‚ºè—è‰²æ”¾ä¸­é–“ */
        .mobile-toolbar-container #mobile-magic-btn {
            background: linear-gradient(135deg, 
                #FF0000 0%, 
                #FF9900 15%, 
                #FFFF00 30%, 
                #00FF00 45%, 
                #0000FF 60%,  /* è—è‰²èª¿æ•´åˆ°ä¸­é–“ä½ç½® */
                #00FFFF 75%, 
                #FF00FF 90%, 
                #FF0000 100%);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.8);
            background-size: 200% 200%;
            animation: rainbowBackground 3s infinite linear;
        }
        
        @keyframes rainbowBackground {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* æ‰‹æ©ŸæŒ‰éˆ•æ‡¸åœæ•ˆæœ */
        .mobile-toolbar-container button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
        }
        
        /* æ‰‹æ©ŸæŒ‰éˆ•æŒ‰ä¸‹æ•ˆæœ */
        .mobile-toolbar-container button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        /* æ‰‹æ©Ÿç¦ç”¨æŒ‰éˆ•æ¨£å¼ */
        .mobile-toolbar-container button:disabled {
            background: linear-gradient(135deg, #cccccc 0%, #999999 100%);
            color: #666;
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
        }
        
        /* æ–°ç‰Œå±€å°è©±æ¡†æ¨£å¼ */
        .new-game-dialog {
            display: none;
            position: fixed;
            top: 25%; /* å‘ä¸Šèª¿æ•´å››åˆ†ä¹‹ä¸€çš„è·é›¢ */
            left: 50%;
            transform: translate(-50%, -25%); /* å°æ‡‰èª¿æ•´ */
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 100000;
            min-width: 250px;
            text-align: center;
        }
        
        .new-game-dialog h3 {
            margin-top: 0;
            color: #35654d;
            font-size: 18px;
        }
        
        .new-game-dialog button {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .new-game-dialog .new-game-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
        }
        
        .new-game-dialog .restart-game-btn {
            background: linear-gradient(135deg, #2196F3 0%, #0D47A1 100%);
            color: white;
        }
        
        .new-game-dialog .cancel-btn {
            background: #f5f5f5;
            color: #333;
        }
        
        .new-game-dialog .new-game-btn:hover {
            background: linear-gradient(135deg, #2E7D32 0%, #4CAF50 100%);
        }
        
        .new-game-dialog .restart-game-btn:hover {
            background: linear-gradient(135deg, #0D47A1 0%, #2196F3 100%);
        }
        
        .new-game-dialog .cancel-btn:hover {
            background: #e0e0e0;
        }
        
        /* è¨­å®šå°è©±æ¡†æ¨£å¼ */
        .settings-dialog {
            display: none;
            position: fixed;
            top: 25%; /* å‘ä¸Šèª¿æ•´å››åˆ†ä¹‹ä¸€çš„è·é›¢ */
            left: 50%;
            transform: translate(-50%, -25%); /* å°æ‡‰èª¿æ•´ */
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            z-index: 100001;
            min-width: 280px;
            max-width: 90%;
            text-align: center;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        
        .settings-dialog h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #35654d;
            font-size: 20px;
            font-weight: 700;
        }
        
        .settings-dialog .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .settings-dialog .setting-item:last-child {
            border-bottom: none;
        }
        
        .settings-dialog .setting-label {
            font-size: 16px;
            color: #333;
            font-weight: 600;
            text-align: left;
            flex: 1;
        }
        
        .settings-dialog .setting-value {
            font-size: 14px;
            color: #666;
        }
        
        /* é–‹é—œæ¨£å¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        /* æ¨¡å¼åˆ‡æ›æŒ‰éˆ• */
        .mode-options {
            display: flex;
            gap: 8px;
        }
        
        .mode-option {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #ddd;
            background: #f8f8f8;
            color: #666;
        }
        
        .mode-option.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        /* è¨­å®šæŒ‰éˆ•å®¹å™¨ */
        .settings-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .settings-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .settings-buttons .cancel-btn {
            background: #f5f5f5;
            color: #333;
            width: 100%;
        }
        
        .settings-buttons .cancel-btn:hover {
            background: #e0e0e0;
        }
        
        /* å°è©±æ¡†é®ç½© */
        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 99999;
        }
        
        /* ==================== å‹åˆ©ç•«é¢æ¨£å¼ ==================== */
        .victory-dialog {
            display: none;
            position: fixed;
            top: 25%; /* å‘ä¸Šèª¿æ•´å››åˆ†ä¹‹ä¸€çš„è·é›¢ */
            left: 50%;
            transform: translate(-50%, -25%); /* å°æ‡‰èª¿æ•´ */
            background: rgba(0, 0, 0, 0.85);
            border-radius: 20px;
            padding: 30px;
            z-index: 100002;
            min-width: 300px;
            max-width: 90%;
            text-align: center;
            color: white;
            backdrop-filter: blur(10px);
            border: 2px solid transparent;
            animation: neonBorder 2s infinite alternate;
            overflow: hidden;
        }
        
        /* éœ“è™¹ç‡ˆé‚Šæ¡†å‹•ç•« */
        @keyframes neonBorder {
            0% {
                box-shadow: 0 0 10px #ff00ff, 0 0 20px #ff00ff, 0 0 30px #ff00ff, 0 0 40px #ff00ff, 0 0 50px #ff00ff;
                border-color: #ff00ff;
            }
            25% {
                box-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff, 0 0 30px #00ffff, 0 0 40px #00ffff, 0 0 50px #00ffff;
                border-color: #00ffff;
            }
            50% {
                box-shadow: 0 0 10px #ffff00, 0 0 20px #ffff00, 0 0 30px #ffff00, 0 0 40px #ffff00, 0 0 50px #ffff00;
                border-color: #ffff00;
            }
            75% {
                box-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00, 0 0 30px #00ff00, 0 0 40px #00ff00, 0 0 50px #00ff00;
                border-color: #00ff00;
            }
            100% {
                box-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000, 0 0 30px #ff0000, 0 0 40px #ff0000, 0 0 50px #ff0000;
                border-color: #ff0000;
            }
        }
        
        .victory-dialog h2 {
            font-size: 2.5rem;
            margin-top: 0;
            margin-bottom: 20px;
            color: #FFD700;
            text-shadow: 0 0 10px #FFD700;
            animation: pulse 1.5s infinite alternate;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }
        
        .victory-stats {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }
        
        .victory-stat {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 1.2rem;
        }
        
        .victory-stat-label {
            color: #aaa;
        }
        
        .victory-stat-value {
            color: #fff;
            font-weight: bold;
        }
        
        .victory-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .victory-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .victory-new-game-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            width: 100%; /* æ”¹ç‚ºæ»¿å¯¬åº¦ */
        }
        
        /* ç§»é™¤ç¹¼çºŒæ…¶ç¥æŒ‰éˆ• */
        .victory-close-btn {
            display: none; /* éš±è—ç¹¼çºŒæ…¶ç¥æŒ‰éˆ• */
        }
        
        .victory-buttons button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        /* ç…™èŠ±Canvas */
        #fireworks-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100001;
            display: none;
        }
        
        /* æ¡Œé¢ç‰ˆæ¨£å¼ - ç¶­æŒåŸå§‹æ–‡å­—å’ŒèŠ±è‰²å¤§å° */
        @media (min-width: 600px) {
            :root {
                --card-width: 80px; /* æ¡Œé¢ç‰ˆå›ºå®šå¯¬åº¦ */
                --card-height: 112px; /* æ¡Œé¢ç‰ˆå›ºå®šé«˜åº¦ */
                --gap: 15px; /* æ¡Œé¢ç‰ˆå›ºå®šé–“è· */
            }
            
            /* æ¡Œé¢ç‰ˆä¿æŒåŸå§‹å¤§å° */
            .card-num, .card-suit-top { font-size: 1.8rem; }
            .card-center-suit { font-size: 4rem; }
            
            /* æ¡Œé¢ç‰ˆæ•¸å­—10ä¿æŒæ­£å¸¸ */
            .card[data-text="10"] .card-num {
                font-size: 1.8rem !important;
                transform: none !important;
                left: 4px !important;
            }
            
            .toolbar {
                padding: 0 20px; /* æ¡Œé¢ç‰ˆå¢åŠ padding */
            }
            
            .time-moves-display {
                font-size: 16px; /* æ¡Œé¢ç‰ˆå­—é«”ç¨å¤§ */
                padding: 4px 12px; /* æ¡Œé¢ç‰ˆpaddingç¨å¤§ */
            }
            
            .toolbar-buttons {
                gap: 12px; /* æ¡Œé¢ç‰ˆæŒ‰éˆ•é–“è·ç¨å¤§ */
            }
            
            /* æ¡Œé¢ç‰ˆæŒ‰éˆ•ç¾åŒ– */
            .toolbar-buttons button {
                padding: 10px 20px; /* æ¡Œé¢ç‰ˆæŒ‰éˆ•ç¨å¤§ */
                font-size: 15px; /* æ¡Œé¢ç‰ˆå­—é«”ç¨å¤§ */
                min-width: 90px; /* å¢åŠ æœ€å°å¯¬åº¦ */
                border-radius: 30px; /* å¢åŠ åœ“è§’ */
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                font-weight: 700;
            }
            
            .toolbar-buttons button:hover {
                box-shadow: 0 7px 20px rgba(0,0,0,0.25);
                transform: translateY(-3px);
            }
            
            .toolbar-buttons button:active {
                transform: translateY(1px);
                box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            }
            
            .score-display {
                font-size: 16px; /* æ¡Œé¢ç‰ˆå­—é«”ç¨å¤§ */
                padding: 4px 12px; /* æ¡Œé¢ç‰ˆpaddingç¨å¤§ */
            }
            
            .settings-dialog {
                min-width: 350px;
                padding: 30px;
            }
            
            .settings-dialog h3 {
                font-size: 22px;
            }
            
            .new-game-dialog {
                min-width: 300px;
                padding: 25px;
            }
            
            .new-game-dialog h3 {
                font-size: 20px;
            }
            
            /* å‹åˆ©ç•«é¢æ¡Œé¢ç‰ˆæ¨£å¼ */
            .victory-dialog {
                min-width: 400px;
                padding: 40px;
            }
            
            .victory-dialog h2 {
                font-size: 3rem;
            }
        }

        /* æ‰‹æ©Ÿç‰ˆå°ˆç”¨æ¨£å¼ - å·²èª¿æ•´ */
        @media (max-width: 599px) {
            :root {
                --card-width: 12.5vw; /* å¡ç‰‡å¯¬åº¦ (å¾11vwå¢åŠ ) */
                --card-height: 17.5vw; /* å¡ç‰‡é«˜åº¦ (å¾15.4vwå¢åŠ ) */
                --gap: 1vw; /* ç¸®å°ç‰Œé–“è· (å¾1.5vwæ¸›å°‘) */
            }
            
            /* é¡¯ç¤ºæ‰‹æ©Ÿç‰ˆåŠŸèƒ½éµå®¹å™¨ */
            .mobile-toolbar-container {
                display: flex;
            }
            
            /* éš±è—æ¡Œé¢ç‰ˆå·¥å…·æ¬„æŒ‰éˆ• */
            .toolbar-buttons {
                display: none;
            }
            
            /* éš±è—æ‰‹æ©Ÿç‰ˆä¸Šæ–¹çš„è¨­å®šæŒ‰éµ */
            #settings-btn {
                display: none !important;
            }
            
            /* æ‰‹æ©Ÿä¸Šå¡ç‰‡å­—é«”èª¿æ•´ */
            .card-num { 
                font-size: 2.5rem; /* èª¿æ•´ç‚º2.5rem (å¾3remæ¸›å°‘) */
                font-weight: 800;
                position: absolute;
                top: 0.1px;
                left: 1.3px;
                line-height: 0.8;
            }
            
            /* ç‰¹æ®Šè™•ç†æ•¸å­—"10" - åªåœ¨æ‰‹æ©Ÿç‰ˆç¸®å°å¯¬åº¦ä¸ç¸®å°é«˜åº¦ */
            .card[data-text="10"] .card-num {
                font-size: 2.5rem; /* èª¿æ•´å­—é«”å¤§å° */
                transform: scaleX(0.75); /* å£“ç¸®å¯¬åº¦ç‚º80% */
                transform-origin: left top; /* å¾å·¦ä¸Šè§’é–‹å§‹ç¸®æ”¾ */
                left: 0.8px; /* èª¿æ•´ä½ç½® */
            }
            
            .card-suit-top {
                font-size: 0.8rem;
                position: absolute;
                top: 6px;
                right: 2px;
                line-height: 1;
            }
            
            /* æ‰‹æ©Ÿä¸Šä¸­é–“èŠ±è‰²èª¿æ•´ */
            .card-center-suit { 
                font-size: 2.2rem; /* å¾2.2remå¢åŠ åˆ°2.5rem */
                position: absolute;
                top: 25px;
                left: 50%;
                transform: translateX(-50%);
                font-weight: normal;
            }
            
            /* æ‰‹æ©Ÿä¸Šå·¥å…·æ¬„èª¿æ•´ */
            .toolbar {
                height: 45px; /* æ‰‹æ©Ÿç‰ˆå·¥å…·æ¬„ç¨çŸ® */
                padding: 0 8px; /* æ‰‹æ©Ÿç‰ˆpaddingç¨å° */
            }
            
            .toolbar-left {
                gap: 8px; /* æ‰‹æ©Ÿç‰ˆå·¥å…·æ¬„å·¦å´é–“è·ç¨å° */
            }
            
            .time-moves-display {
                font-size: 11px; /* æ‰‹æ©Ÿç‰ˆå­—é«”ç¨å° */
                padding: 2px 6px; /* æ‰‹æ©Ÿç‰ˆpaddingç¨å° */
                min-width: 100px; /* å›ºå®šå¯¬åº¦ï¼Œå®¹ç´4ä½æ•¸ */
            }
            
            .score-display {
                font-size: 11px; /* æ‰‹æ©Ÿç‰ˆå­—é«”ç¨å° */
                padding: 2px 6px; /* æ‰‹æ©Ÿç‰ˆpaddingç¨å° */
                min-width: 65px; /* å›ºå®šå¯¬åº¦ï¼Œå®¹ç´4ä½æ•¸ */
            }
            
            #game-board {
                height: calc(100vh - 45px); /* æ¸›å»å·¥å…·æ¬„é«˜åº¦ */
                margin-top: 3px; /* æ‰‹æ©Ÿç‰ˆä¸Šé‚Šè·ç¨å° */
            }
            
            /* æ‰‹æ©Ÿä¸Šè¨Šæ¯æ¡†èª¿æ•´ */
            #message {
                font-size: 12px; /* æ‰‹æ©Ÿç‰ˆå­—é«”ç¨å° */
                padding: 8px 15px; /* æ‰‹æ©Ÿç‰ˆpaddingç¨å° */
                top: 50px; /* èª¿æ•´ä½ç½® */
                max-width: 95%; /* æœ€å¤§å¯¬åº¦é™åˆ¶ */
            }
            
            /* æ‰‹æ©Ÿç‰ˆè“‹ç‰Œä¸Šçš„æ•¸å­—é¡¯ç¤ºèª¿æ•´ */
            .card-count {
                font-size: 2.0rem; /* èª¿æ•´è“‹ç‰Œæ•¸å­—å¤§å° (å¾2.5remèª¿æ•´) */
            }
            
            /* è¨­å®šå°è©±æ¡†èª¿æ•´ - å¢å¤§æ–‡å­— */
            .settings-dialog {
                padding: 25px;
                min-width: 280px;
            }
            
            .settings-dialog h3 {
                font-size: 22px; /* å¢å¤§æ¨™é¡Œå­—é«” */
                margin-bottom: 20px;
            }
            
            .settings-dialog .setting-label {
                font-size: 16px; /* å¢å¤§è¨­å®šé …ç›®æ¨™ç±¤å­—é«” */
            }
            
            .settings-dialog .setting-value {
                font-size: 16px; /* å¢å¤§è¨­å®šæ•¸å€¼å­—é«” */
            }
            
            .mode-option {
                padding: 8px 16px;
                font-size: 14px; /* å¢å¤§æ¨¡å¼é¸é …å­—é«” */
            }
            
            /* æ–°ç‰Œå±€å°è©±æ¡†èª¿æ•´ - å¢å¤§æ–‡å­— */
            .new-game-dialog {
                padding: 25px;
                min-width: 280px;
            }
            
            .new-game-dialog h3 {
                font-size: 22px; /* å¢å¤§æ¨™é¡Œå­—é«” */
            }
            
            .new-game-dialog button {
                font-size: 16px; /* å¢å¤§æŒ‰éˆ•æ–‡å­— */
                padding: 14px;
            }
            
            /* å‹åˆ©ç•«é¢æ‰‹æ©Ÿç‰ˆèª¿æ•´ - å¢å¤§æ–‡å­— */
            .victory-dialog {
                min-width: 300px;
                padding: 30px;
            }
            
            .victory-dialog h2 {
                font-size: 2.5rem; /* å¢å¤§æ¨™é¡Œå­—é«” */
            }
            
            .victory-stat {
                font-size: 1.2rem; /* å¢å¤§çµ±è¨ˆæ–‡å­— */
            }
            
            .victory-buttons button {
                font-size: 1.1rem; /* å¢å¤§æŒ‰éˆ•æ–‡å­— */
                padding: 14px;
            }
            
            /* ç‰¹åˆ¥å°çš„æ‰‹æ©Ÿ */
            @media (max-width: 320px) {
                :root {
                    --card-width: 12vw; /* ç¨å¾®èª¿æ•´ */
                    --card-height: 16.8vw; /* ç­‰æ¯”ä¾‹èª¿æ•´ */
                    --gap: 0.8vw; /* æ›´å°çš„é–“è· */
                }
                
                .time-moves-display {
                    font-size: 10px; /* æ›´å°çš„å­—é«” */
                    min-width: 90px; /* å›ºå®šå¯¬åº¦ï¼Œå®¹ç´4ä½æ•¸ */
                }
                
                .score-display {
                    font-size: 10px; /* æ›´å°çš„å­—é«” */
                    min-width: 55px; /* å›ºå®šå¯¬åº¦ï¼Œå®¹ç´4ä½æ•¸ */
                }
                
                /* åœ¨ç‰¹åˆ¥å°çš„å±å¹•ä¸Šé€²ä¸€æ­¥èª¿æ•´å¡ç‰‡å­—é«” */
                .card-num { 
                    font-size: 2.2rem; /* æ¯”2.5remç¨å°ä¸€é» */
                    top: 1.3px; /* ä¿æŒ1.3pxé‚Šè· */
                    left: 1.3px; /* ä¿æŒ1.3pxé‚Šè· */
                }
                
                /* ç‰¹åˆ¥å°çš„å±å¹•ä¸Šæ•¸å­—"10"çš„è™•ç† */
                .card[data-text="10"] .card-num {
                    font-size: 1.6rem; /* æ•¸å­—10ä½¿ç”¨æ›´å°çš„å­—é«” */
                    transform: scaleX(0.8); /* å£“ç¸®å¯¬åº¦ç‚º80% */
                    transform-origin: left top; /* å¾å·¦ä¸Šè§’é–‹å§‹ç¸®æ”¾ */
                    left: 0.5px; /* ç¨å¾®èª¿æ•´ä½ç½® */
                }
                
                .card-suit-top {
                    font-size: 0.9rem; /* æ¯”1.1remç¨å°ä¸€é» */
                    top: 1.3px; /* ä¿æŒ1.3pxé‚Šè· */
                    right: 1.3px; /* ä¿æŒ1.3pxé‚Šè· */
                }
                
                .card-center-suit { 
                    font-size: 2.2rem; /* å¾2remå¢åŠ åˆ°2.2rem */
                    bottom: 1.1px; /* ä¿æŒé›¢åº•ç«¯1.1px */
                }
                
                /* ç‰¹åˆ¥å°çš„æ‰‹æ©Ÿä¸Šè“‹ç‰Œä¸Šçš„æ•¸å­—é¡¯ç¤ºèª¿æ•´ */
                .card-count {
                    font-size: 1.8rem; /* èª¿æ•´è“‹ç‰Œæ•¸å­—å¤§å° (å¾2.0remèª¿æ•´) */
                }
                
                /* åœ¨ç‰¹åˆ¥å°çš„å±å¹•ä¸Šèª¿æ•´æ‰‹æ©ŸåŠŸèƒ½å€ - å±…ä¸­å°é½Š */
                .mobile-toolbar-container {
                    gap: 5px; /* æ¸›å°‘é–“è· */
                    padding: 8px 10px; /* èª¿æ•´padding */
                    min-width: 260px; /* èª¿æ•´æœ€å°å¯¬åº¦ */
                    border-radius: 15px; /* ç¨å¾®æ¸›å°åœ“è§’ */
                    bottom: 70px; /* èª¿æ•´ä½ç½® */
                }
                
                .mobile-toolbar-container button {
                    padding: 6px 8px; /* èª¿æ•´æŒ‰éˆ•å¤§å° */
                    font-size: 11px; /* èª¿æ•´å­—é«”å¤§å° */
                    min-width: 50px; /* èª¿æ•´æœ€å°å¯¬åº¦ */
                    border-radius: 10px; /* æ¸›å°‘åœ“è§’ */
                }
                
                /* ç‰¹åˆ¥å°çš„æ‰‹æ©Ÿä¸Šå°è©±æ¡†èª¿æ•´ */
                .settings-dialog {
                    padding: 20px;
                    min-width: 260px;
                }
                
                .settings-dialog h3 {
                    font-size: 20px;
                }
                
                .new-game-dialog {
                    padding: 20px;
                    min-width: 260px;
                }
                
                .new-game-dialog h3 {
                    font-size: 20px;
                }
                
                /* ç‰¹åˆ¥å°çš„æ‰‹æ©Ÿä¸Šå‹åˆ©ç•«é¢èª¿æ•´ */
                .victory-dialog {
                    min-width: 280px;
                    padding: 25px;
                }
                
                .victory-dialog h2 {
                    font-size: 2.2rem;
                }
                
                .victory-stat {
                    font-size: 1.1rem;
                }
            }
        }
    </style>
</head>
<body>

<!-- å·¥å…·æ¬„å€å¡Š -->
<div class="toolbar">
    <div class="toolbar-left">
        <div class="time-moves-display" id="time-moves">00:00 | 0000æ­¥</div>
        <div class="score-display" id="score-display">åˆ†æ•¸: <span id="current-score">0000</span></div>
        <button id="settings-btn" onclick="playButtonSound(); showSettingsDialog()">âš™ï¸ è¨­å®š</button>
    </div>
    <div class="toolbar-buttons">
        <button onclick="playButtonSound(); showNewGameDialog()" id="new-game-btn">æ–°ç‰Œå±€</button>
        <button onclick="playButtonSound(); undoMove()" id="undo-btn" disabled>æ’¤å›</button>
        <button onclick="playButtonSound(); showHint()" id="hint-btn">æç¤º</button>
        <button onclick="playButtonSound(); magicMove()" id="magic-btn" disabled>é­”æ³•</button>
    </div>
</div>

<!-- è¨Šæ¯æç¤ºæ¡† -->
<div id="message"></div>

<!-- æ–°ç‰Œå±€å°è©±æ¡† -->
<div class="dialog-overlay" id="dialog-overlay" onclick="closeNewGameDialog()"></div>
<div class="new-game-dialog" id="new-game-dialog">
    <h3>æ–°ç‰Œå±€é¸é …</h3>
    <button class="new-game-btn" onclick="playButtonSound(); startNewGame()">æ–°çš„éŠæˆ²</button>
    <button class="restart-game-btn" onclick="playButtonSound(); restartCurrentGame()">é‡ç©æ­¤å±€</button>
    <button class="cancel-btn" onclick="playButtonSound(); closeNewGameDialog()">è¿”å›éŠæˆ²</button>
</div>

<!-- è¨­å®šå°è©±æ¡† -->
<div class="dialog-overlay" id="settings-overlay" onclick="closeSettingsDialog()"></div>
<div class="settings-dialog" id="settings-dialog">
    <h3>âš™ï¸ éŠæˆ²è¨­å®š</h3>
    
    <div class="setting-item">
        <span class="setting-label">éŸ³æ•ˆé–‹é—œ</span>
        <label class="switch">
            <input type="checkbox" id="sound-toggle" onclick="playButtonSound()">
            <span class="slider"></span>
        </label>
    </div>
    
    <div class="setting-item">
        <span class="setting-label">é¡¯ç¤ºè“‹ç‰Œå‰©é¤˜ç‰Œæ•¸</span>
        <label class="switch">
            <input type="checkbox" id="show-card-count-toggle" onclick="playButtonSound()">
            <span class="slider"></span>
        </label>
    </div>
    
    <div class="setting-item">
        <span class="setting-label">å·¦å³æ‰‹æ¨¡å¼</span>
        <div class="mode-options">
            <div class="mode-option" id="hand-right-btn" onclick="playButtonSound(); setHandModeUI('right')">å³æ‰‹</div>
            <div class="mode-option" id="hand-left-btn" onclick="playButtonSound(); setHandModeUI('left')">å·¦æ‰‹</div>
        </div>
    </div>
    
    <div class="setting-item">
        <span class="setting-label">ç¿»ç‰Œæ¨¡å¼</span>
        <div class="mode-options">
            <div class="mode-option" id="draw-1-btn" onclick="playButtonSound(); setDrawModeUI(1)">1å¼µ</div>
            <div class="mode-option" id="draw-3-btn" onclick="playButtonSound(); setDrawModeUI(3)">3å¼µ</div>
        </div>
    </div>
    
    <div class="settings-buttons">
        <button class="cancel-btn" onclick="playButtonSound(); closeSettingsDialog()">è¿”å›éŠæˆ²</button>
    </div>
</div>

<!-- å‹åˆ©å°è©±æ¡† -->
<div class="dialog-overlay" id="victory-overlay" onclick="closeVictoryDialog()"></div>
<div class="victory-dialog" id="victory-dialog">
    <h2>ğŸ‰ æ­å–œç ´é—œï¼ ğŸ‰</h2>
    <div class="victory-stats">
        <div class="victory-stat">
            <span class="victory-stat-label">éŠæˆ²æ™‚é–“:</span>
            <span class="victory-stat-value" id="victory-time">00:00</span>
        </div>
        <div class="victory-stat">
            <span class="victory-stat-label">ç§»å‹•æ­¥æ•¸:</span>
            <span class="victory-stat-value" id="victory-moves">0000</span>
        </div>
        <div class="victory-stat">
            <span class="victory-stat-label">æœ€çµ‚åˆ†æ•¸:</span>
            <span class="victory-stat-value" id="victory-score">0000</span>
        </div>
    </div>
    <div class="victory-buttons">
        <button class="victory-new-game-btn" onclick="playButtonSound(); closeVictoryDialog(); startNewGame()">æ–°éŠæˆ²</button>
    </div>
</div>

<!-- ç…™èŠ±Canvas -->
<canvas id="fireworks-canvas"></canvas>

<!-- éŠæˆ²ä¸»å€åŸŸ -->
<div id="game-board">
    <!-- æ‰‹æ©Ÿç‰ˆåŠŸèƒ½éµå®¹å™¨ - ç¾åŒ–ç‰ˆ -->
    <div class="mobile-toolbar-container">
        <button onclick="playButtonSound(); showNewGameDialog()" id="mobile-new-game-btn">æ–°ç‰Œå±€</button>
        <button onclick="playButtonSound(); undoMove()" id="mobile-undo-btn" disabled>æ’¤å›</button>
        <button onclick="playButtonSound(); showHint()" id="mobile-hint-btn">æç¤º</button>
        <button onclick="playButtonSound(); magicMove()" id="mobile-magic-btn" disabled>é­”æ³•</button>
        <button onclick="playButtonSound(); showSettingsDialog()" id="mobile-settings-btn">âš™ï¸</button>
    </div>

    <!-- å››å€‹èŠ±è‰²å€æ§½ä½ (å®‰ç½®å€) - ä½ç½®ç”±æ‰‹åˆ¥æ¨¡å¼æ±ºå®š -->
    <div id="slot-f0" class="slot" data-type="foundation" data-idx="0"></div>
    <div id="slot-f1" class="slot" data-type="foundation" data-idx="1"></div>
    <div id="slot-f2" class="slot" data-type="foundation" data-idx="2"></div>
    <div id="slot-f3" class="slot" data-type="foundation" data-idx="3"></div>

    <!-- å»¢ç‰Œå †æ§½ä½ - ä½ç½®ç”±æ‰‹åˆ¥æ¨¡å¼æ±ºå®š -->
    <div id="slot-waste" class="slot"></div>
    
    <!-- ç‰Œå †æ§½ä½ (è“‹ç‰Œå€) - ä½ç½®ç”±æ‰‹åˆ¥æ¨¡å¼æ±ºå®š -->
    <div id="slot-stock" class="slot"></div>

    <!-- ä¸ƒåˆ—è¡¨æ ¼æ§½ä½ -->
    <div id="slot-t0" class="slot" data-type="tableau" data-idx="0"></div>
    <div id="slot-t1" class="slot" data-type="tableau" data-idx="1"></div>
    <div id="slot-t2" class="slot" data-type="tableau" data-idx="2"></div>
    <div id="slot-t3" class="slot" data-type="tableau" data-idx="3"></div>
    <div id="slot-t4" class="slot" data-type="tableau" data-idx="4"></div>
    <div id="slot-t5" class="slot" data-type="tableau" data-idx="5"></div>
    <div id="slot-t6" class="slot" data-type="tableau" data-idx="6"></div>

    <!-- å¡ç‰‡åœ–å±¤ -->
    <div id="card-layer"></div>
</div>

<script>
    // ==================== éŠæˆ²å¸¸æ•¸å®šç¾© ====================
    const SUITS = ['â™ ', 'â™¥', 'â™£', 'â™¦']; // èŠ±è‰²é™£åˆ—
    const COLORS = { 'â™ ': 'black', 'â™¥': 'red', 'â™£': 'black', 'â™¦': 'red' }; // èŠ±è‰²å°æ‡‰é¡è‰²
    const RANKS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K']; // ç‰Œé¢å€¼é™£åˆ—

    // ==================== éŠæˆ²ç‹€æ…‹è®Šæ•¸ ====================
    let state = {
        stock: [], // ç‰Œå †
        waste: [], // å»¢ç‰Œå †
        foundations: [[], [], [], []], // å››å€‹èŠ±è‰²å€
        tableau: [[], [], [], [], [], [], []], // ä¸ƒåˆ—è¡¨æ ¼
        gameMode: 'guaranteed', // éŠæˆ²æ¨¡å¼
        moves: 0, // ç§»å‹•æ¬¡æ•¸
        startTime: null, // éŠæˆ²é–‹å§‹æ™‚é–“
        timerInterval: null, // è¨ˆæ™‚å™¨é–“éš”ID
        score: 0, // åˆå§‹åˆ†æ•¸
        drawMode: 1, // ç¿»ç‰Œæ¨¡å¼ï¼š1å¼µæˆ–3å¼µï¼Œé è¨­ç‚º1å¼µ
        handMode: 'right', // æ‰‹åˆ¥æ¨¡å¼ï¼šå³æ‰‹æˆ–å·¦æ‰‹ï¼Œé è¨­ç‚ºå³æ‰‹
        soundEnabled: true, // éŸ³æ•ˆé–‹é—œï¼Œé è¨­é–‹å•Ÿ
        showCardCount: true // é¡¯ç¤ºè“‹ç‰Œå‰©é¤˜ç‰Œæ•¸ï¼Œé è¨­é–‹å•Ÿ
    };
    
    let history = []; // éŠæˆ²æ­·å²ç´€éŒ„ï¼Œç”¨æ–¼æ’¤å›åŠŸèƒ½
    let initialGameState = null; // å„²å­˜åˆå§‹éŠæˆ²ç‹€æ…‹ç”¨æ–¼é‡ç©
    let gameSeed = 1; // éŠæˆ²ç¨®å­ï¼Œç”¨æ–¼ç”Ÿæˆå¯è§£ç‰Œå±€

    // ==================== å‹åˆ©ç•«é¢æ¸¬è©¦è®Šæ•¸ ====================
    let scoreClickCount = 0; // åˆ†æ•¸æ¡†é»æ“Šè¨ˆæ•¸å™¨
    let lastScoreClickTime = 0; // ä¸Šæ¬¡é»æ“Šåˆ†æ•¸æ¡†çš„æ™‚é–“
    const SCORE_CLICK_TIMEOUT = 2000; // é»æ“Šè¶…æ™‚æ™‚é–“ï¼ˆ2ç§’ï¼‰

    // ==================== ç…™èŠ±æ•ˆæœè®Šæ•¸ ====================
    let fireworks = {
        canvas: null,
        ctx: null,
        particles: [],
        isActive: false,
        animationId: null
    };

    // ==================== æ‹–æ›³ç›¸é—œè®Šæ•¸ ====================
    let drag = {
        isDragging: false, // æ˜¯å¦æ­£åœ¨æ‹–æ›³
        pending: false, // æ˜¯å¦ç­‰å¾…æ‹–æ›³é–‹å§‹
        startX: 0, // æ‹–æ›³èµ·å§‹Xåº§æ¨™
        startY: 0, // æ‹–æ›³èµ·å§‹Yåº§æ¨™
        cards: [], // æ‹–æ›³ä¸­çš„å¡ç‰‡é™£åˆ—
        origin: null, // æ‹–æ›³ä¾†æºè³‡è¨Š
        elGhosts: [], // æ‹–æ›³æ™‚çš„å¹½éˆå¡ç‰‡å…ƒç´ é™£åˆ—
        offset: {x:0, y:0}, // æ»‘é¼ /æ‰‹æŒ‡èˆ‡å¡ç‰‡çš„åç§»é‡
        gameBoardRect: null // éŠæˆ²å€åŸŸçš„é‚Šç•Œè³‡è¨Š
    };
    
    // é›™æ“Šèˆ‡å‹•ç•«æ§åˆ¶è®Šæ•¸
    let lastClickTime = 0; // ä¸Šæ¬¡é»æ“Šæ™‚é–“
    let lastClickCardId = null; // ä¸Šæ¬¡é»æ“Šçš„å¡ç‰‡ID
    let isAnimating = false; // æ˜¯å¦æ­£åœ¨åŸ·è¡Œå‹•ç•«ï¼Œé˜²æ­¢å‹•ç•«æœŸé–“é‡è¤‡æ“ä½œ
    
    // ==================== éŸ³æ•ˆç®¡ç†ç³»çµ± ====================
    // éŸ³æ•ˆä¸Šä¸‹æ–‡
    let audioContext = null;
    
    /**
     * åˆå§‹åŒ–éŸ³æ•ˆç³»çµ±
     */
    function initAudio() {
        try {
            if (typeof AudioContext !== 'undefined') {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        } catch (e) {
            console.log("éŸ³æ•ˆåˆå§‹åŒ–å¤±æ•—ï¼Œå°‡éœéŸ³åŸ·è¡Œ");
        }
    }
    
    /**
     * æ’­æ”¾æŒ‰éˆ•é»æ“ŠéŸ³æ•ˆ - ç°¡çŸ­æœ‰åŠ›çš„éŸ³æ•ˆ
     */
    function playButtonSound() {
        if (!audioContext || !state.soundEnabled) return;
        
        try {
            const now = audioContext.currentTime;
            
            // ä¸»éŸ³èª¿ - çŸ­ä¿ƒæœ‰åŠ›çš„"å—¶"è²
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 1200; // é«˜é »ç‡ï¼Œæ¸…è„†æœ‰åŠ›
            oscillator.type = 'sine';
            
            // æ¥µçŸ­ä¿ƒçš„åŒ…çµ¡ï¼šå¿«é€Ÿä¸Šå‡ï¼Œå¿«é€Ÿè¡°æ¸›
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.2, now + 0.005); // æ¥µå¿«ä¸Šå‡
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.08); // å¿«é€Ÿè¡°æ¸›
            
            // é–‹å§‹æ’­æ”¾
            oscillator.start(now);
            oscillator.stop(now + 0.1); // æ¥µçŸ­çš„æŒçºŒæ™‚é–“
        } catch (e) {
            // éŸ³æ•ˆæ’­æ”¾å¤±æ•—ï¼Œå¿½ç•¥
        }
    }
    
    /**
     * æ’­æ”¾ç¿»ç‰ŒéŸ³æ•ˆ - æ¸…è„†çš„å–€ç­”è²
     */
    function playFlipSound() {
        if (!audioContext || !state.soundEnabled) return;
        
        try {
            const now = audioContext.currentTime;
            
            // ä¸»éŸ³èª¿ - çŸ­ä¿ƒçš„å–€ç­”è²
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800; // è¼ƒé«˜é »ç‡ï¼Œæ¸…è„†
            oscillator.type = 'sine';
            
            // æ¥µçŸ­ä¿ƒçš„åŒ…çµ¡ï¼šå¿«é€Ÿä¸Šå‡ï¼Œå¿«é€Ÿè¡°æ¸›
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.3, now + 0.01); // å¿«é€Ÿä¸Šå‡
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05); // å¿«é€Ÿè¡°æ¸›
            
            // é–‹å§‹æ’­æ”¾
            oscillator.start(now);
            oscillator.stop(now + 0.1); // æ¥µçŸ­çš„æŒçºŒæ™‚é–“
        } catch (e) {
            // éŸ³æ•ˆæ’­æ”¾å¤±æ•—ï¼Œå¿½ç•¥
        }
    }
    
    /**
     * æ’­æ”¾ç§»å‹•ç‰ŒéŸ³æ•ˆ - ç¾ä»£åŒ–çš„è¼•å¾®æ»‘å‹•è²
     */
    function playMoveSound() {
        if (!audioContext || !state.soundEnabled) return;
        
        try {
            const now = audioContext.currentTime;
            
            // ä¸»éŸ³èª¿ - ä¹¾æ·¨çš„æ»‘å‹•è²
            const oscillator1 = audioContext.createOscillator();
            const gainNode1 = audioContext.createGain();
            
            oscillator1.connect(gainNode1);
            gainNode1.connect(audioContext.destination);
            
            // å¾ä¸­é »ç‡å¿«é€Ÿæ»‘å‹•åˆ°é«˜é »ç‡ï¼Œæ¨¡æ“¬æ»‘å‹•è²
            oscillator1.frequency.setValueAtTime(300, now);
            oscillator1.frequency.exponentialRampToValueAtTime(800, now + 0.1);
            oscillator1.type = 'sine';
            
            // åŠ å…¥ä¸€é»ç™½è‰²å™ªéŸ³ï¼Œæ¨¡æ“¬å¡ç‰‡èˆ‡æ¡Œé¢çš„è¼•å¾®æ‘©æ“¦
            const noiseLength = 0.08;
            const bufferSize = audioContext.sampleRate * noiseLength;
            const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                // ä½å¼·åº¦çš„ç™½è‰²å™ªéŸ³
                output[i] = Math.random() * 0.05 - 0.025;
            }
            
            const noiseSource = audioContext.createBufferSource();
            const noiseGain = audioContext.createGain();
            
            noiseSource.buffer = noiseBuffer;
            noiseSource.connect(noiseGain);
            noiseGain.connect(audioContext.destination);
            
            // è¨­ç½®éŸ³é‡åŒ…çµ¡ - çŸ­ä¿ƒè€Œä¹¾æ·¨
            gainNode1.gain.setValueAtTime(0, now);
            gainNode1.gain.linearRampToValueAtTime(0.1, now + 0.01); // å¿«é€Ÿä¸Šå‡
            gainNode1.gain.exponentialRampToValueAtTime(0.001, now + 0.15); // è‡ªç„¶è¡°æ¸›
            
            // å™ªéŸ³éŸ³é‡åŒ…çµ¡
            noiseGain.gain.setValueAtTime(0, now);
            noiseGain.gain.linearRampToValueAtTime(0.02, now + 0.005);
            noiseGain.gain.exponentialRampToValueAtTime(0.001, now + 0.08);
            
            // é–‹å§‹æ’­æ”¾
            oscillator1.start(now);
            noiseSource.start(now);
            
            // åœæ­¢æ’­æ”¾
            oscillator1.stop(now + 0.15);
            noiseSource.stop(now + 0.08);
            
        } catch (e) {
            // éŸ³æ•ˆæ’­æ”¾å¤±æ•—ï¼Œå¿½ç•¥
        }
    }
    
    /**
     * æ’­æ”¾æ”¾ç½®å€éŸ³æ•ˆï¼ˆæˆåŠŸéŸ³æ•ˆï¼‰- æ¸…è„†çš„ä¸Šå‡éŸ³éš
     */
    function playFoundationSound() {
        if (!audioContext || !state.soundEnabled) return;
        
        try {
            const now = audioContext.currentTime;
            
            // ä¸‰å€‹çŸ­ä¿ƒçš„éŸ³éšä¸Šå‡
            const frequencies = [523.25, 659.25, 783.99]; // C5, E5, G5
            const startTimes = [0, 0.03, 0.06]; // éŒ¯é–‹é–‹å§‹æ™‚é–“
            
            frequencies.forEach((freq, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = freq;
                oscillator.type = 'sine';
                
                const startTime = now + startTimes[index];
                
                // çŸ­ä¿ƒçš„åŒ…çµ¡
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(0.2, startTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.05);
                
                // é–‹å§‹æ’­æ”¾
                oscillator.start(startTime);
                oscillator.stop(startTime + 0.06);
            });
        } catch (e) {
            // éŸ³æ•ˆæ’­æ”¾å¤±æ•—ï¼Œå¿½ç•¥
        }
    }
    
    /**
     * æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ - ç”¨æ–¼æ–æ™ƒå¡ç‰‡æ™‚
     */
    function playErrorSound() {
        if (!audioContext || !state.soundEnabled) return;
        
        try {
            const now = audioContext.currentTime;
            
            // ä¸»éŸ³èª¿ - ä½æ²‰çš„éŒ¯èª¤éŸ³æ•ˆ
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 400; // ä½é »ç‡ï¼Œè¡¨ç¤ºéŒ¯èª¤
            oscillator.type = 'sine';
            
            // çŸ­ä¿ƒçš„åŒ…çµ¡ï¼šå¿«é€Ÿä¸Šå‡ï¼Œå¿«é€Ÿè¡°æ¸›
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.2, now + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
            
            // é–‹å§‹æ’­æ”¾
            oscillator.start(now);
            oscillator.stop(now + 0.12);
        } catch (e) {
            // éŸ³æ•ˆæ’­æ”¾å¤±æ•—ï¼Œå¿½ç•¥
        }
    }
    
    /**
     * æ’­æ”¾å‹åˆ©éŸ³æ•ˆ - æ­¡å¿«çš„éŸ³æ•ˆ
     */
    function playVictorySound() {
        if (!audioContext || !state.soundEnabled) return;
        
        try {
            const now = audioContext.currentTime;
            
            // å‹åˆ©éŸ³æ•ˆåºåˆ—
            const victoryNotes = [
                {freq: 523.25, duration: 0.2}, // C5
                {freq: 659.25, duration: 0.2}, // E5
                {freq: 783.99, duration: 0.2}, // G5
                {freq: 1046.50, duration: 0.3}, // C6
                {freq: 783.99, duration: 0.1}, // G5
                {freq: 1046.50, duration: 0.5} // C6
            ];
            
            victoryNotes.forEach((note, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = note.freq;
                oscillator.type = 'sine';
                
                const startTime = now + index * 0.15;
                
                // éŸ³é‡åŒ…çµ¡
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(0.3, startTime + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + note.duration);
                
                // é–‹å§‹æ’­æ”¾
                oscillator.start(startTime);
                oscillator.stop(startTime + note.duration);
            });
        } catch (e) {
            // éŸ³æ•ˆæ’­æ”¾å¤±æ•—ï¼Œå¿½ç•¥
        }
    }
    
    // ==================== å‹åˆ©ç•«é¢å‡½æ•¸ ====================
    /**
     * åˆå§‹åŒ–ç…™èŠ±æ•ˆæœ
     */
    function initFireworks() {
        fireworks.canvas = document.getElementById('fireworks-canvas');
        fireworks.ctx = fireworks.canvas.getContext('2d');
        
        // è¨­å®šCanvaså¤§å°
        function resizeCanvas() {
            fireworks.canvas.width = window.innerWidth;
            fireworks.canvas.height = window.innerHeight;
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
    }
    
    /**
     * é–‹å§‹ç…™èŠ±æ•ˆæœ
     */
    function startFireworks() {
        if (fireworks.isActive) return;
        
        fireworks.isActive = true;
        fireworks.canvas.style.display = 'block';
        
        // æ¸…ç©ºç²’å­
        fireworks.particles = [];
        
        // å‰µå»ºåˆå§‹ç…™èŠ±
        createFirework();
        
        // é–‹å§‹å‹•ç•«å¾ªç’°
        animateFireworks();
    }
    
    /**
     * åœæ­¢ç…™èŠ±æ•ˆæœ
     */
    function stopFireworks() {
        fireworks.isActive = false;
        fireworks.canvas.style.display = 'none';
        
        if (fireworks.animationId) {
            cancelAnimationFrame(fireworks.animationId);
            fireworks.animationId = null;
        }
    }
    
    /**
     * å‰µå»ºä¸€å€‹ç…™èŠ±
     */
    function createFirework() {
        if (!fireworks.isActive) return;
        
        // éš¨æ©Ÿä½ç½®
        const x = Math.random() * fireworks.canvas.width;
        const y = Math.random() * fireworks.canvas.height * 0.5; // ä¸ŠåŠéƒ¨åˆ†
        
        // éš¨æ©Ÿé¡è‰²
        const colors = [
            '#FF0000', '#FF9900', '#FFFF00', '#00FF00', 
            '#00FFFF', '#0000FF', '#FF00FF', '#FFFFFF'
        ];
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        // å‰µå»ºçˆ†ç‚¸ç²’å­
        const particleCount = 80 + Math.random() * 50;
        for (let i = 0; i < particleCount; i++) {
            fireworks.particles.push({
                x: x,
                y: y,
                color: color,
                radius: Math.random() * 2 + 1,
                speed: Math.random() * 5 + 2,
                angle: Math.random() * Math.PI * 2,
                friction: 0.95,
                gravity: 0.1,
                opacity: 1,
                decay: Math.random() * 0.02 + 0.005,
                spark: Math.random() > 0.8 // æ˜¯å¦ç‚ºç«èŠ±
            });
        }
        
        // éš¨æ©Ÿé–“éš”å¾Œå‰µå»ºä¸‹ä¸€å€‹ç…™èŠ±
        setTimeout(() => {
            if (fireworks.isActive) {
                createFirework();
            }
        }, Math.random() * 500 + 500);
    }
    
    /**
     * å‹•ç•«ç…™èŠ±æ•ˆæœ
     */
    function animateFireworks() {
        if (!fireworks.isActive) return;
        
        // æ¸…ç©ºCanvas
        fireworks.ctx.clearRect(0, 0, fireworks.canvas.width, fireworks.canvas.height);
        
        // æ›´æ–°å’Œç¹ªè£½æ¯å€‹ç²’å­
        for (let i = fireworks.particles.length - 1; i >= 0; i--) {
            const p = fireworks.particles[i];
            
            // æ›´æ–°ä½ç½®
            p.x += Math.cos(p.angle) * p.speed;
            p.y += Math.sin(p.angle) * p.speed + p.gravity;
            
            // æ‡‰ç”¨æ‘©æ“¦åŠ›å’Œé‡åŠ›
            p.speed *= p.friction;
            p.gravity += 0.01;
            
            // æ¸›å°‘ä¸é€æ˜åº¦
            p.opacity -= p.decay;
            
            // ç¹ªè£½ç²’å­
            fireworks.ctx.beginPath();
            fireworks.ctx.globalAlpha = p.opacity;
            fireworks.ctx.fillStyle = p.color;
            
            if (p.spark) {
                // ç¹ªè£½ç«èŠ±ï¼ˆç·šæ¢ï¼‰
                fireworks.ctx.fillRect(p.x, p.y, p.radius * 2, p.radius * 0.5);
            } else {
                // ç¹ªè£½åœ“å½¢ç²’å­
                fireworks.ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                fireworks.ctx.fill();
            }
            
            // å¦‚æœç²’å­å®Œå…¨é€æ˜ï¼Œç§»é™¤å®ƒ
            if (p.opacity <= 0) {
                fireworks.particles.splice(i, 1);
            }
        }
        
        // ç¹¼çºŒå‹•ç•«å¾ªç’°
        fireworks.animationId = requestAnimationFrame(animateFireworks);
    }
    
    /**
     * é¡¯ç¤ºå‹åˆ©ç•«é¢
     */
    function showVictoryDialog() {
        // åœæ­¢è¨ˆæ™‚å™¨
        stopTimer();
        
        // è¨ˆç®—éŠæˆ²æ™‚é–“
        const elapsed = Date.now() - state.startTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // æ›´æ–°å‹åˆ©ç•«é¢æ•¸æ“š
        document.getElementById('victory-time').textContent = timeString;
        document.getElementById('victory-moves').textContent = state.moves.toString().padStart(4, '0');
        document.getElementById('victory-score').textContent = state.score.toString().padStart(4, '0');
        
        // æ’­æ”¾å‹åˆ©éŸ³æ•ˆ
        playVictorySound();
        
        // é¡¯ç¤ºå‹åˆ©ç•«é¢
        document.getElementById('victory-overlay').style.display = 'block';
        document.getElementById('victory-dialog').style.display = 'block';
        
        // é–‹å§‹ç…™èŠ±æ•ˆæœ
        startFireworks();
    }
    
    /**
     * é—œé–‰å‹åˆ©ç•«é¢
     */
    function closeVictoryDialog() {
        document.getElementById('victory-overlay').style.display = 'none';
        document.getElementById('victory-dialog').style.display = 'none';
        
        // åœæ­¢ç…™èŠ±æ•ˆæœ
        stopFireworks();
    }
    
    /**
     * è™•ç†åˆ†æ•¸æ¡†é»æ“Šäº‹ä»¶ï¼ˆæ¸¬è©¦åŠŸèƒ½ï¼‰
     */
    function handleScoreClick() {
        const now = Date.now();
        
        // å¦‚æœè·é›¢ä¸Šæ¬¡é»æ“Šè¶…é2ç§’ï¼Œé‡ç½®è¨ˆæ•¸å™¨
        if (now - lastScoreClickTime > SCORE_CLICK_TIMEOUT) {
            scoreClickCount = 0;
        }
        
        // æ›´æ–°é»æ“Šè¨ˆæ•¸
        scoreClickCount++;
        lastScoreClickTime = now;
        
        // å¦‚æœé»æ“Šäº†3æ¬¡ï¼Œè§¸ç™¼å‹åˆ©ç•«é¢
        if (scoreClickCount >= 3) {
            scoreClickCount = 0; // é‡ç½®è¨ˆæ•¸å™¨
            showVictoryDialog(); // é¡¯ç¤ºå‹åˆ©ç•«é¢
            showMessage("æ¸¬è©¦æ¨¡å¼ï¼šå‹åˆ©ç•«é¢å·²è§¸ç™¼", 1500);
        }
    }
    
    // ==================== è¨­å®šå°è©±æ¡†å‡½æ•¸ ====================
    /**
     * é¡¯ç¤ºè¨­å®šå°è©±æ¡†
     */
    function showSettingsDialog() {
        // æ›´æ–°è¨­å®šå°è©±æ¡†ä¸­çš„ç‹€æ…‹
        document.getElementById('sound-toggle').checked = state.soundEnabled;
        document.getElementById('show-card-count-toggle').checked = state.showCardCount;
        
        // æ›´æ–°æ‰‹åˆ¥æ¨¡å¼æŒ‰éˆ•
        document.getElementById('hand-right-btn').classList.toggle('active', state.handMode === 'right');
        document.getElementById('hand-left-btn').classList.toggle('active', state.handMode === 'left');
        
        // æ›´æ–°ç¿»ç‰Œæ¨¡å¼æŒ‰éˆ•
        document.getElementById('draw-1-btn').classList.toggle('active', state.drawMode === 1);
        document.getElementById('draw-3-btn').classList.toggle('active', state.drawMode === 3);
        
        // é¡¯ç¤ºè¨­å®šå°è©±æ¡†
        document.getElementById('settings-overlay').style.display = 'block';
        document.getElementById('settings-dialog').style.display = 'block';
    }
    
    /**
     * é—œé–‰è¨­å®šå°è©±æ¡†
     */
    function closeSettingsDialog() {
        // é—œé–‰å‰ä¿å­˜æ‰€æœ‰è¨­å®šæ›´æ”¹
        saveAllSettings();
        
        // é—œé–‰è¨­å®šå°è©±æ¡†
        document.getElementById('settings-overlay').style.display = 'none';
        document.getElementById('settings-dialog').style.display = 'none';
    }
    
    /**
     * ä¿å­˜æ‰€æœ‰è¨­å®š
     */
    function saveAllSettings() {
        // ä¿å­˜éŸ³æ•ˆè¨­å®š
        state.soundEnabled = document.getElementById('sound-toggle').checked;
        
        // ä¿å­˜è“‹ç‰Œé¡¯ç¤ºè¨­å®š
        const showCardCount = document.getElementById('show-card-count-toggle').checked;
        if (state.showCardCount !== showCardCount) {
            state.showCardCount = showCardCount;
            // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°è“‹ç‰Œé¡¯ç¤º
            render();
        }
        
        // ä¿å­˜åˆ°æœ¬åœ°å„²å­˜
        saveSettingsToLocalStorage();
        
        // é¡¯ç¤ºç¢ºèªè¨Šæ¯
        showMessage("è¨­å®šå·²æ›´æ–°", 1000);
    }
    
    /**
     * å¾æœ¬åœ°å„²å­˜è¼‰å…¥è¨­å®š
     */
    function loadSettingsFromLocalStorage() {
        const savedSettings = localStorage.getItem('solitaire-settings');
        if (savedSettings) {
            try {
                const settings = JSON.parse(savedSettings);
                state.soundEnabled = settings.soundEnabled !== undefined ? settings.soundEnabled : true;
                state.drawMode = settings.drawMode || 1;
                state.handMode = settings.handMode || 'right';
                state.showCardCount = settings.showCardCount !== undefined ? settings.showCardCount : true;
            } catch (e) {
                console.log("è¼‰å…¥è¨­å®šå¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼");
            }
        }
    }
    
    /**
     * å„²å­˜è¨­å®šåˆ°æœ¬åœ°å„²å­˜
     */
    function saveSettingsToLocalStorage() {
        const settings = {
            soundEnabled: state.soundEnabled,
            drawMode: state.drawMode,
            handMode: state.handMode,
            showCardCount: state.showCardCount
        };
        localStorage.setItem('solitaire-settings', JSON.stringify(settings));
    }
    
    /**
     * è¨­å®šæ‰‹åˆ¥æ¨¡å¼ (UIç‰ˆæœ¬)
     */
    function setHandModeUI(mode) {
        if (mode !== 'left' && mode !== 'right') return;
        
        // ç«‹å³æ›´æ–°è¨­å®š
        state.handMode = mode;
        
        // æ›´æ–°UIé¡¯ç¤º
        document.getElementById('hand-right-btn').classList.toggle('active', mode === 'right');
        document.getElementById('hand-left-btn').classList.toggle('active', mode === 'left');
        
        // ç«‹å³æ‡‰ç”¨è¨­å®š
        saveSettingsToLocalStorage();
        layoutSlots();
        render();
        
        // é¡¯ç¤ºç¢ºèªè¨Šæ¯
        showMessage(`å·²åˆ‡æ›ç‚º${mode === 'right' ? 'å³æ‰‹' : 'å·¦æ‰‹'}æ¨¡å¼`, 1000);
    }
    
    /**
     * è¨­å®šç¿»ç‰Œæ¨¡å¼ (UIç‰ˆæœ¬)
     */
    function setDrawModeUI(mode) {
        if (mode !== 1 && mode !== 3) return;
        
        // ç«‹å³æ›´æ–°è¨­å®š
        state.drawMode = mode;
        
        // æ›´æ–°UIé¡¯ç¤º
        document.getElementById('draw-1-btn').classList.toggle('active', mode === 1);
        document.getElementById('draw-3-btn').classList.toggle('active', mode === 3);
        
        // ç«‹å³æ‡‰ç”¨è¨­å®š
        saveSettingsToLocalStorage();
        render();
        
        // é¡¯ç¤ºç¢ºèªè¨Šæ¯
        showMessage(`å·²åˆ‡æ›ç‚ºä¸€æ¬¡ç¿»${mode}å¼µç‰Œæ¨¡å¼`, 1000);
    }
    
    // ==================== åˆ†æ•¸è¨ˆç®—èˆ‡æ›´æ–°å‡½æ•¸ ====================
    /**
     * æ›´æ–°åˆ†æ•¸é¡¯ç¤º
     */
    function updateScoreDisplay() {
        const scoreElement = document.getElementById('current-score');
        
        if (state.score >= 0) {
            // æ­£æ•¸æˆ–é›¶ï¼šæ ¼å¼åŒ–ç‚º4ä½æ•¸å­—ï¼Œå‰é¢è£œé›¶
            const formattedScore = Math.abs(state.score).toString().padStart(4, '0');
            scoreElement.textContent = formattedScore;
        } else {
            // è² æ•¸ï¼šé¡¯ç¤ºè² è™Ÿå’Œæ•¸å­—ï¼Œç¢ºä¿ç¸½å¯¬åº¦ç‚º4å€‹å­—ç¬¦
            const absScore = Math.abs(state.score);
            if (absScore < 10) {
                scoreElement.textContent = `-00${absScore}`;
            } else if (absScore < 100) {
                scoreElement.textContent = `-0${absScore}`;
            } else if (absScore < 1000) {
                scoreElement.textContent = `-${absScore}`;
            } else {
                // å¦‚æœè² æ•¸çµ•å°å€¼å¤§æ–¼999ï¼Œé¡¯ç¤ºå®Œæ•´æ•¸å­—ï¼ˆæœƒè¶…é4ä½ï¼Œä½†é€™æ˜¯æ¥µç«¯æƒ…æ³ï¼‰
                scoreElement.textContent = `-${absScore}`;
            }
        }
    }
    
    /**
     * å¢åŠ åˆ†æ•¸
     * @param {number} points - è¦å¢åŠ çš„åˆ†æ•¸
     */
    function addScore(points) {
        state.score += points;
        updateScoreDisplay();
    }
    
    // ==================== æ–°ç‰Œå±€å°è©±æ¡†å‡½æ•¸ ====================
    /**
     * é¡¯ç¤ºæ–°ç‰Œå±€å°è©±æ¡†
     */
    function showNewGameDialog() {
        document.getElementById('dialog-overlay').style.display = 'block';
        document.getElementById('new-game-dialog').style.display = 'block';
    }
    
    /**
     * é—œé–‰æ–°ç‰Œå±€å°è©±æ¡†
     */
    function closeNewGameDialog() {
        document.getElementById('dialog-overlay').style.display = 'none';
        document.getElementById('new-game-dialog').style.display = 'none';
    }
    
    /**
     * é–‹å§‹æ–°éŠæˆ²
     */
    function startNewGame() {
        closeNewGameDialog();
        initGame('guaranteed');
    }
    
    /**
     * é‡ç©ç•¶å‰éŠæˆ²
     */
    function restartCurrentGame() {
        closeNewGameDialog();
        
        if (!initialGameState) {
            showMessage("ç„¡æ³•é‡ç©æ­¤å±€ï¼Œè«‹é–‹å§‹æ–°éŠæˆ²", 2000);
            return;
        }
        
        // æ¢å¾©åˆ°åˆå§‹éŠæˆ²ç‹€æ…‹
        state.stock = JSON.parse(JSON.stringify(initialGameState.stock));
        state.waste = JSON.parse(JSON.stringify(initialGameState.waste));
        state.foundations = JSON.parse(JSON.stringify(initialGameState.foundations));
        state.tableau = JSON.parse(JSON.stringify(initialGameState.tableau));
        state.moves = 0;
        state.score = 0;
        state.startTime = Date.now();
        
        // é‡ç½®æ­·å²
        history = [];
        saveStateToHistory();
        
        // é‡æ–°æ¸²æŸ“
        render();
        startTimer();
        updateTimer();
        updateScoreDisplay();
        
        showMessage("éŠæˆ²å·²é‡æ–°é–‹å§‹", 1500);
    }
    
    // ==================== è¨ˆæ™‚å™¨ç›¸é—œå‡½æ•¸ ====================
    /**
     * é–‹å§‹è¨ˆæ™‚å™¨
     */
    function startTimer() {
        if (state.timerInterval) clearInterval(state.timerInterval); // æ¸…é™¤ç¾æœ‰è¨ˆæ™‚å™¨
        state.startTime = Date.now(); // è¨˜éŒ„é–‹å§‹æ™‚é–“
        state.timerInterval = setInterval(updateTimer, 1000); // æ¯ç§’æ›´æ–°ä¸€æ¬¡
    }
    
    /**
     * æ›´æ–°è¨ˆæ™‚å™¨é¡¯ç¤º
     */
    function updateTimer() {
        if (!state.startTime) return;
        
        // è¨ˆç®—ç¶“éçš„æ™‚é–“
        const elapsed = Date.now() - state.startTime;
        const minutes = Math.floor(elapsed / 60000); // è¨ˆç®—åˆ†é˜
        const seconds = Math.floor((elapsed % 60000) / 1000); // è¨ˆç®—ç§’æ•¸
        
        // æ ¼å¼åŒ–æ­¥æ•¸ç‚º4ä½æ•¸å­—ï¼Œå‰é¢è£œé›¶
        const formattedMoves = state.moves.toString().padStart(4, '0');
        
        // æ›´æ–°æ™‚é–“å’Œæ­¥æ•¸é¡¯ç¤º
        const timeMovesElement = document.getElementById('time-moves');
        if (timeMovesElement) {
            timeMovesElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} | ${formattedMoves}æ­¥`;
        }
    }
    
    /**
     * åœæ­¢è¨ˆæ™‚å™¨
     */
    function stopTimer() {
        if (state.timerInterval) {
            clearInterval(state.timerInterval);
            state.timerInterval = null;
        }
    }
    
    // ==================== ç¿»ç‰Œæ¨¡å¼è¨­å®šå‡½æ•¸ ====================
    /**
     * è¨­å®šç¿»ç‰Œæ¨¡å¼
     * @param {number} mode - ç¿»ç‰Œæ¨¡å¼ (1æˆ–3)
     */
    function setDrawMode(mode) {
        if (mode !== 1 && mode !== 3) return;
        
        state.drawMode = mode;
        
        // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°å»¢ç‰Œå †é¡¯ç¤º
        render();
        
        showMessage(`å·²åˆ‡æ›ç‚ºä¸€æ¬¡ç¿»${mode}å¼µç‰Œæ¨¡å¼`, 1500);
    }
    
    // ==================== æ‰‹åˆ¥æ¨¡å¼è¨­å®šå‡½æ•¸ ====================
    /**
     * è¨­å®šæ‰‹åˆ¥æ¨¡å¼
     * @param {string} mode - æ‰‹åˆ¥æ¨¡å¼ ('left' æˆ– 'right')
     */
    function setHandMode(mode) {
        if (mode !== 'left' && mode !== 'right') return;
        
        state.handMode = mode;
        
        // é‡æ–°ä½ˆå±€ä¸¦æ¸²æŸ“
        layoutSlots();
        render();
        
        showMessage(`å·²åˆ‡æ›ç‚º${mode === 'right' ? 'å³æ‰‹' : 'å·¦æ‰‹'}æ¨¡å¼`, 1500);
    }

    // ==================== éŠæˆ²åˆå§‹åŒ–å‡½æ•¸ ====================
    /**
     * åˆå§‹åŒ–éŠæˆ²
     * @param {string} mode - éŠæˆ²æ¨¡å¼
     */
    function initGame(mode = 'guaranteed') {
        // å…ˆåœæ­¢å¯èƒ½å­˜åœ¨çš„è¨ˆæ™‚å™¨
        if (state.timerInterval) {
            clearInterval(state.timerInterval);
            state.timerInterval = null;
        }
        
        // åœæ­¢ç…™èŠ±æ•ˆæœ
        stopFireworks();
        
        state.gameMode = mode; // è¨­å®šéŠæˆ²æ¨¡å¼
        state.moves = 0; // é‡ç½®ç§»å‹•æ¬¡æ•¸
        state.score = 0; // é‡ç½®åˆ†æ•¸ç‚º0
        history = []; // æ¸…ç©ºæ­·å²ç´€éŒ„
        updateUndoButton(); // æ›´æ–°æ’¤å›æŒ‰éˆ•ç‹€æ…‹
        updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
        
        let deck = []; // ç‰Œçµ„
        if (mode === 'guaranteed') {
            showMessage("æ–°ç‰Œå±€é–‹å§‹ï¼", 2000); // é¡¯ç¤ºé–‹å§‹è¨Šæ¯
            deck = createInfiniteDeck(); // ä½¿ç”¨ç„¡é™ç‰Œå‹ç”¢ç”Ÿå‡½æ•¸
        }

        // é‡ç½®éŠæˆ²ç‹€æ…‹
        state.stock = [];
        state.waste = [];
        state.foundations = [[], [], [], []];
        state.tableau = [[], [], [], [], [], [], []];

        // ç™¼ç‰Œåˆ°ä¸ƒåˆ—è¡¨æ ¼
        for (let i = 0; i < 7; i++) {
            for (let j = i; j < 7; j++) {
                if (deck.length === 0) break;
                let card = deck.pop(); // å¾ç‰Œçµ„å–ç‰Œ
                card.id = Math.random().toString(36).substr(2,9); // ç”¢ç”Ÿå”¯ä¸€ID
                card.faceUp = (i === j); // åªæœ‰æ¯åˆ—æœ€å¾Œä¸€å¼µç‰Œé¢æœä¸Š
                state.tableau[j].push(card); // æ”¾å…¥è¡¨æ ¼
            }
        }

        // å‰©é¤˜ç‰Œæ”¾å…¥ç‰Œå †
        state.stock = deck.reverse(); // åè½‰ç‰Œçµ„é †åº
        state.stock.forEach(card => {
            card.id = Math.random().toString(36).substr(2,9); // ç”¢ç”Ÿå”¯ä¸€ID
            card.faceUp = false; // ç‰Œå †ä¸­çš„ç‰Œé¢æœä¸‹
        });
        
        // å„²å­˜åˆå§‹éŠæˆ²ç‹€æ…‹ç”¨æ–¼é‡ç©
        initialGameState = {
            stock: JSON.parse(JSON.stringify(state.stock)),
            waste: JSON.parse(JSON.stringify(state.waste)),
            foundations: JSON.parse(JSON.stringify(state.foundations)),
            tableau: JSON.parse(JSON.stringify(state.tableau))
        };
        
        saveStateToHistory(); // å„²å­˜åˆå§‹ç‹€æ…‹åˆ°æ­·å²ç´€éŒ„
        layoutSlots(); // ä½ˆå±€æ§½ä½
        render(); // æ¸²æŸ“éŠæˆ²ç•«é¢
        startTimer(); // é–‹å§‹è¨ˆæ™‚
        updateTimer(); // æ›´æ–°æ™‚é–“é¡¯ç¤º
        updateScoreDisplay(); // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
    }
    
    // ==================== æ­·å²ç´€éŒ„ç›¸é—œå‡½æ•¸ ====================
    /**
     * å„²å­˜ç•¶å‰éŠæˆ²ç‹€æ…‹åˆ°æ­·å²ç´€éŒ„
     */
    function saveStateToHistory() {
        const stateCopy = {
            stock: JSON.parse(JSON.stringify(state.stock)), // æ·±æ‹·è²ç‰Œå †
            waste: JSON.parse(JSON.stringify(state.waste)), // æ·±æ‹·è²å»¢ç‰Œå †
            foundations: JSON.parse(JSON.stringify(state.foundations)), // æ·±æ‹·è²èŠ±è‰²å€
            tableau: JSON.parse(JSON.stringify(state.tableau)), // æ·±æ‹·è²è¡¨æ ¼
            moves: state.moves, // ç§»å‹•æ¬¡æ•¸
            gameMode: state.gameMode, // éŠæˆ²æ¨¡å¼
            startTime: state.startTime, // é–‹å§‹æ™‚é–“
            score: state.score, // åˆ†æ•¸
            drawMode: state.drawMode, // ç¿»ç‰Œæ¨¡å¼
            handMode: state.handMode // æ‰‹åˆ¥æ¨¡å¼
        };
        history.push(stateCopy); // åŠ å…¥æ­·å²ç´€éŒ„
        updateUndoButton(); // æ›´æ–°æ’¤å›æŒ‰éˆ•ç‹€æ…‹
        updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
    }
    
    /**
     * æ’¤å›ä¸Šä¸€æ­¥ç§»å‹•
     */
    function undoMove() {
        if (isAnimating) return; // å‹•ç•«ä¸­ç¦æ­¢æ’¤å›
        if (history.length <= 1) return; // æ²’æœ‰æ­·å²ç´€éŒ„å¯æ’¤å›
        history.pop(); // ç§»é™¤ç•¶å‰ç‹€æ…‹
        const prevState = history[history.length - 1]; // å–å¾—ä¸Šä¸€å€‹ç‹€æ…‹
        
        // æ¢å¾©ä¸Šä¸€å€‹ç‹€æ…‹
        state.stock = JSON.parse(JSON.stringify(prevState.stock));
        state.waste = JSON.parse(JSON.stringify(prevState.waste));
        state.foundations = JSON.parse(JSON.stringify(prevState.foundations));
        state.tableau = JSON.parse(JSON.stringify(prevState.tableau));
        state.moves = prevState.moves;
        state.gameMode = prevState.gameMode;
        state.startTime = prevState.startTime;
        state.score = prevState.score;
        state.drawMode = prevState.drawMode;
        state.handMode = prevState.handMode;
        
        updateUndoButton(); // æ›´æ–°æ’¤å›æŒ‰éˆ•ç‹€æ…‹
        updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
        render(); // é‡æ–°æ¸²æŸ“
        updateTimer(); // æ›´æ–°æ™‚é–“é¡¯ç¤º
        updateScoreDisplay(); // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
    }
    
    /**
     * æ›´æ–°æ’¤å›æŒ‰éˆ•ç‹€æ…‹
     */
    function updateUndoButton() {
        const isDisabled = history.length <= 1;
        document.getElementById('undo-btn').disabled = isDisabled;
        document.getElementById('mobile-undo-btn').disabled = isDisabled;
    }
    
    /**
     * æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹ - ä¿®æ”¹ç‚ºå‹•ç•«æœŸé–“ä¸ç¦ç”¨
     */
    function updateMagicButton() {
        // æª¢æŸ¥ä¸ƒåˆ—è¡¨æ ¼ä¸­æ˜¯å¦æœ‰æœªç¿»é–‹çš„ç‰Œ
        const hasFacedDownCards = state.tableau.some(pile => 
            pile.some(card => !card.faceUp)
        );
        // ä¿®æ”¹ï¼šåªåœ¨æ²’æœ‰è“‹ç‰Œæ™‚ç¦ç”¨ï¼Œå‹•ç•«æœŸé–“ä¸ç¦ç”¨
        const isDisabled = !hasFacedDownCards;
        document.getElementById('magic-btn').disabled = isDisabled;
        document.getElementById('mobile-magic-btn').disabled = isDisabled;
    }

    // ==================== æ”¹è‰¯çš„ç„¡é™ç‰Œå‹ç”¢ç”Ÿå‡½æ•¸ ====================
    /**
     * å»ºç«‹ç„¡é™ç‰Œå‹ä¸”ä¿è­‰å¯è§£çš„ç‰Œçµ„
     * ä½¿ç”¨æ”¹è‰¯çš„æ•¸å­¸æ–¹æ³•ç”Ÿæˆå¯è§£ç‰Œå±€ï¼Œç¢ºä¿æ¯æ¬¡ç”¢ç”Ÿçš„ç‰Œçµ„éƒ½æ˜¯å¯è§£çš„
     * @returns {Array} - ç‰Œçµ„é™£åˆ—
     */
    function createInfiniteDeck() {
        // å‰µå»ºæ¨™æº–52å¼µç‰Œ
        let deck = [];
        for (let suit of SUITS) {
            for (let rank = 1; rank <= 13; rank++) {
                deck.push({
                    suit: suit,
                    rank: rank,
                    text: RANKS[rank-1],
                    color: COLORS[suit],
                    faceUp: false,
                    id: Math.random().toString(36).substr(2,9)
                });
            }
        }
        
        // ä½¿ç”¨æ”¹è‰¯çš„å¯è§£ç®—æ³•æ´—ç‰Œ
        deck = improvedSolvableShuffle(deck);
        
        return deck;
    }
    
    /**
     * æ”¹è‰¯çš„å¯è§£ç®—æ³•æ´—ç‰Œ
     * é€™å€‹ç®—æ³•ç¢ºä¿ç”Ÿæˆçš„ç‰Œå±€æ˜¯å¯è§£çš„ï¼ŒåŒæ™‚æä¾›ç„¡é™è®ŠåŒ–
     * åŸºæ–¼æ•¸å­¸åŸç†ï¼šç¢ºä¿é—œéµç‰Œï¼ˆAceå’Œ2ï¼‰åœ¨å¯è¨ªå•ä½ç½®ï¼Œé¿å…æ­»å±€
     * @param {Array} deck - ç‰Œçµ„
     * @returns {Array} - æ´—ç‰Œå¾Œçš„ç‰Œçµ„
     */
    function improvedSolvableShuffle(deck) {
        // ä½¿ç”¨å¤šå±¤æ¬¡éš¨æ©Ÿç¨®å­ï¼Œå¢åŠ è®ŠåŒ–æ€§
        const timestamp = Date.now();
        const randomSeed = (timestamp % 1000000) * 1000 + Math.floor(Math.random() * 1000);
        
        // æ­¥é©Ÿ1ï¼šæŒ‰èŠ±è‰²åˆ†çµ„ï¼Œç¢ºä¿æ¯ç¨®èŠ±è‰²åˆ†å¸ƒå‡å‹»
        const suits = ['â™ ', 'â™¥', 'â™£', 'â™¦'];
        const suitsMap = {};
        
        // å°‡ç‰ŒæŒ‰èŠ±è‰²åˆ†çµ„
        suits.forEach(suit => {
            suitsMap[suit] = deck.filter(card => card.suit === suit);
        });
        
        // æ­¥é©Ÿ2ï¼šå‰µå»ºä¸€å€‹æœ‰åˆ©æ–¼éŠæˆ²çš„æ’åˆ—æ¨¡å¼
        // ç¶“å…¸æ¥é¾å¯è§£æ€§é—œéµï¼š
        // 1. Aceå’Œ2æ‡‰è©²åœ¨å¯è¨ªå•çš„ä½ç½®ï¼ˆè¡¨æ ¼åˆ—é ‚éƒ¨æˆ–å»¢ç‰Œå †ä¸­ï¼‰
        // 2. Kingä¸æ‡‰è©²å¤ªå¤šåœ¨è¡¨æ ¼åˆ—åº•éƒ¨
        // 3. æ¯å€‹èŠ±è‰²æ‡‰è©²å‡å‹»åˆ†å¸ƒåœ¨ä¸åŒçš„åˆ—
        
        let resultDeck = [];
        
        // æ­¥é©Ÿ3ï¼šä½¿ç”¨åŸºæ–¼ç¨®å­çš„ç®—æ³•å‰µå»ºç‰Œåº
        const positionSequence = generatePositionSequence(randomSeed, deck.length);
        
        // æ­¥é©Ÿ4ï¼šå°‡ç‰Œåˆ†é…åˆ°åºåˆ—ä¸­ï¼Œç¢ºä¿å¯è§£æ€§
        const positionMap = new Array(deck.length);
        
        // é¦–å…ˆæ”¾ç½®é—œéµç‰Œï¼ˆAceå’Œ2ï¼‰åˆ°æœ‰åˆ©ä½ç½®
        const keyCards = deck.filter(card => card.rank <= 2);
        const otherCards = deck.filter(card => card.rank > 2);
        
        // è¨ˆç®—æœ‰åˆ©ä½ç½®ï¼ˆå‰28å¼µç‰Œï¼Œå°æ‡‰7åˆ—è¡¨æ ¼çš„åˆå§‹ç™¼ç‰Œï¼‰
        const favorablePositions = new Set();
        for (let i = 0; i < 28; i++) {
            favorablePositions.add(positionSequence[i]);
        }
        
        // éš¨æ©Ÿé¸æ“‡ä¸€äº›ä½ç½®çµ¦Aceå’Œ2ï¼Œä½†ç¢ºä¿ä¸åœ¨åŒä¸€åˆ—çš„æœ€åº•éƒ¨
        const positionArray = Array.from(favorablePositions);
        shuffleArray(positionArray, randomSeed);
        
        // åˆ†é…é—œéµç‰Œåˆ°æœ‰åˆ©ä½ç½®
        keyCards.forEach((card, index) => {
            if (index < positionArray.length) {
                const pos = positionArray[index];
                positionMap[pos] = card;
            } else {
                // å¦‚æœæœ‰åˆ©ä½ç½®ä¸å¤ ï¼Œéš¨æ©Ÿåˆ†é…
                let randomPos = Math.floor((randomSeed + index) % deck.length);
                let attempt = 0;
                while (positionMap[randomPos] !== undefined && attempt < 10) {
                    randomPos = (randomPos + 1) % deck.length;
                    attempt++;
                }
                positionMap[randomPos] = card;
            }
        });
        
        // åˆ†é…å…¶ä»–ç‰Œåˆ°å‰©é¤˜ä½ç½®
        let cardIndex = 0;
        for (let i = 0; i < deck.length; i++) {
            if (positionMap[i] === undefined) {
                if (cardIndex < otherCards.length) {
                    positionMap[i] = otherCards[cardIndex];
                    cardIndex++;
                }
            }
        }
        
        // æ­¥é©Ÿ5ï¼šæŒ‰åºåˆ—æ§‹å»ºæœ€çµ‚ç‰Œçµ„
        for (let i = 0; i < deck.length; i++) {
            const pos = positionSequence[i];
            if (positionMap[pos]) {
                resultDeck.push(positionMap[pos]);
            }
        }
        
        // æ­¥é©Ÿ6ï¼šç¢ºä¿æ‰€æœ‰ç‰Œéƒ½è¢«åŒ…å«ï¼ˆé˜²ç¦¦æ€§æª¢æŸ¥ï¼‰
        if (resultDeck.length !== deck.length) {
            // å¦‚æœå‡ºç¾å•é¡Œï¼Œå›é€€åˆ°åŸç®—æ³•ä½†ä½¿ç”¨æ–°ç¨®å­
            console.log("ä½¿ç”¨å‚™ç”¨ç®—æ³•");
            return shuffleWithSolvableAlgorithm(deck);
        }
        
        // æ­¥é©Ÿ7ï¼šåŠ å¼·å¯è§£æ€§æª¢æŸ¥å’Œèª¿æ•´
        resultDeck = applyEnhancedAdjustments(resultDeck, randomSeed);
        
        return resultDeck;
    }
    
    /**
     * ç”Ÿæˆä½ç½®åºåˆ—ï¼ˆåŸºæ–¼ç¨®å­çš„å½éš¨æ©Ÿåºåˆ—ï¼‰
     * @param {number} seed - éš¨æ©Ÿç¨®å­
     * @param {number} length - åºåˆ—é•·åº¦
     * @returns {Array} - ä½ç½®åºåˆ—
     */
    function generatePositionSequence(seed, length) {
        const sequence = [];
        for (let i = 0; i < length; i++) {
            sequence.push(i);
        }
        
        // ä½¿ç”¨åŸºæ–¼ç¨®å­çš„æ´—ç‰Œç®—æ³•
        shuffleArray(sequence, seed);
        
        return sequence;
    }
    
    /**
     * åŸºæ–¼ç¨®å­çš„é™£åˆ—æ´—ç‰Œ
     * @param {Array} array - è¦æ´—ç‰Œçš„é™£åˆ—
     * @param {number} seed - éš¨æ©Ÿç¨®å­
     */
    function shuffleArray(array, seed) {
        // ä½¿ç”¨å¯é æ¸¬çš„éš¨æ©Ÿæ•¸ç”Ÿæˆå™¨
        const prng = new PRNG(seed);
        
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(prng.next() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        
        return array;
    }
    
    /**
     * ç°¡å–®çš„å½éš¨æ©Ÿæ•¸ç”Ÿæˆå™¨
     */
    class PRNG {
        constructor(seed) {
            this.seed = seed % 2147483647;
            if (this.seed <= 0) this.seed += 2147483646;
        }
        
        next() {
            this.seed = this.seed * 16807 % 2147483647;
            return (this.seed - 1) / 2147483646;
        }
    }
    
    /**
     * åŠ å¼·ç‰ˆçš„æœ€çµ‚èª¿æ•´ä»¥ç¢ºä¿å¯è§£æ€§
     * @param {Array} deck - ç‰Œçµ„
     * @param {number} seed - éš¨æ©Ÿç¨®å­
     * @returns {Array} - èª¿æ•´å¾Œçš„ç‰Œçµ„
     */
    function applyEnhancedAdjustments(deck, seed) {
        const result = [...deck];
        const prng = new PRNG(seed);
        
        // åŠ å¼·èª¿æ•´1ï¼šç¢ºä¿æ¯å€‹èŠ±è‰²çš„Aceä¸åœ¨ç‰Œçµ„çš„å¾ŒåŠéƒ¨åˆ†
        const acePositions = [];
        for (let i = 0; i < result.length; i++) {
            if (result[i].rank === 1) {
                acePositions.push(i);
            }
        }
        
        // å¦‚æœAceåœ¨å¾ŒåŠéƒ¨åˆ†ï¼Œç§»å‹•åˆ°å‰åŠéƒ¨åˆ†
        acePositions.forEach((acePos, index) => {
            if (acePos > 35) { // 35æ˜¯ç‰Œçµ„ä¸­é–“åå¾Œ
                // å˜—è©¦åœ¨å‰åŠéƒ¨åˆ†æ‰¾ä¸€å€‹åˆé©çš„ä½ç½®
                let targetPos = Math.floor(prng.next() * 20) + (index * 5);
                if (targetPos >= 26) targetPos = 25; // ç¢ºä¿åœ¨å‰åŠéƒ¨åˆ†
                
                // äº¤æ›ä½ç½®
                [result[acePos], result[targetPos]] = [result[targetPos], result[acePos]];
            }
        });
        
        // åŠ å¼·èª¿æ•´2ï¼šç¢ºä¿æ¯å€‹èŠ±è‰²çš„2ä¹Ÿåœ¨å¯è¨ªå•ä½ç½®
        const twoPositions = [];
        for (let i = 0; i < result.length; i++) {
            if (result[i].rank === 2) {
                twoPositions.push(i);
            }
        }
        
        // å¦‚æœ2åœ¨æœ€å¾Œ15å¼µç‰Œä¸­ï¼Œç§»å‹•åˆ°å‰é¢
        twoPositions.forEach((twoPos, index) => {
            if (twoPos > 36) { // æœ€å¾Œ15å¼µç‰Œ
                // å˜—è©¦åœ¨å‰åŠéƒ¨åˆ†æ‰¾ä¸€å€‹åˆé©çš„ä½ç½®
                let targetPos = Math.floor(prng.next() * 25) + 5;
                if (targetPos >= 30) targetPos = 29;
                
                // äº¤æ›ä½ç½®
                [result[twoPos], result[targetPos]] = [result[targetPos], result[twoPos]];
            }
        });
        
        // åŠ å¼·èª¿æ•´3ï¼šé¿å…å¤ªå¤šKingåœ¨ç‰Œçµ„æœ€å‰é¢
        const kingPositions = [];
        for (let i = 0; i < result.length; i++) {
            if (result[i].rank === 13) {
                kingPositions.push(i);
            }
        }
        
        // å¦‚æœKingåœ¨å‰10å¼µç‰Œä¸­ï¼Œç§»å‹•ä¸€äº›åˆ°å¾Œé¢
        const earlyKings = kingPositions.filter(pos => pos < 10);
        if (earlyKings.length >= 2) {
            // ç§»å‹•ä¸€å€‹Kingåˆ°å¾Œé¢
            const kingToMove = earlyKings[0];
            const targetPos = 40 + Math.floor(prng.next() * 12);
            [result[kingToMove], result[targetPos]] = [result[targetPos], result[kingToMove]];
        }
        
        // åŠ å¼·èª¿æ•´4ï¼šç¢ºä¿æ¯ç¨®èŠ±è‰²éƒ½æœ‰ç‰Œåœ¨å¯è¨ªå•ä½ç½®ï¼ˆå‰28å¼µï¼‰
        const suitsInFirst28 = new Set();
        for (let i = 0; i < 28; i++) {
            suitsInFirst28.add(result[i].suit);
        }
        
        // å¦‚æœç¼ºå°‘æŸç¨®èŠ±è‰²ï¼Œå¾å¾Œé¢ç§»å‹•ä¸€å¼µåˆ°å‰é¢
        if (suitsInFirst28.size < 4) {
            const missingSuits = SUITS.filter(suit => !suitsInFirst28.has(suit));
            for (const missingSuit of missingSuits) {
                // åœ¨å¾Œé¢æ‰¾ä¸€å¼µé€™å€‹èŠ±è‰²çš„ç‰Œ
                for (let i = 28; i < result.length; i++) {
                    if (result[i].suit === missingSuit) {
                        // èˆ‡å‰28å¼µä¸­çš„ä¸€å¼µäº¤æ›
                        const swapPos = Math.floor(prng.next() * 28);
                        [result[i], result[swapPos]] = [result[swapPos], result[i]];
                        break;
                    }
                }
            }
        }
        
        // åŠ å¼·èª¿æ•´5ï¼šæª¢æŸ¥ä¸¦é¿å…æ­»å±€æƒ…æ³
        // æª¢æŸ¥æ˜¯å¦æœ‰å¤ªå¤šåŒèŠ±è‰²çš„ç‰Œå †åœ¨ä¸€èµ·
        for (let i = 0; i < result.length - 5; i++) {
            const slice = result.slice(i, i + 5);
            const sameSuitCount = slice.filter(card => card.suit === slice[0].suit).length;
            if (sameSuitCount >= 4) {
                // äº¤æ›ä¸€å¼µç‰Œä¾†æ‰“ç ´é€£çºŒåŒèŠ±è‰²
                const swapIndex = i + Math.floor(prng.next() * 5);
                const targetIndex = (i + 15) % result.length;
                [result[swapIndex], result[targetIndex]] = [result[targetIndex], result[swapIndex]];
            }
        }
        
        // åŠ å¼·èª¿æ•´6ï¼šæœ€å¾Œä¸€æ¬¡è¼•åº¦éš¨æ©ŸåŒ–ï¼Œä½†ä¿æŒçµæ§‹
        for (let i = 0; i < 15; i++) {
            const idx1 = Math.floor(prng.next() * result.length);
            const idx2 = Math.floor(prng.next() * result.length);
            
            // åªäº¤æ›åŒèŠ±è‰²çš„ç‰Œä»¥ä¿æŒå¯è§£æ€§
            if (result[idx1].suit === result[idx2].suit) {
                [result[idx1], result[idx2]] = [result[idx2], result[idx1]];
            }
        }
        
        // åŠ å¼·èª¿æ•´7ï¼šæœ€çµ‚æª¢æŸ¥ - ç¢ºä¿æ²’æœ‰Aceåœ¨æœ€å¾Œ10å¼µç‰Œä¸­
        for (let i = result.length - 10; i < result.length; i++) {
            if (result[i].rank === 1) {
                // èˆ‡å‰åŠéƒ¨åˆ†çš„ç‰Œäº¤æ›
                const targetPos = Math.floor(prng.next() * 20);
                [result[i], result[targetPos]] = [result[targetPos], result[i]];
            }
        }
        
        return result;
    }
    
    /**
     * å‚™ç”¨ç®—æ³•ï¼šå¦‚æœæ–°ç®—æ³•å‡ºç¾å•é¡Œï¼Œä½¿ç”¨é€™å€‹
     * ä½¿ç”¨æ•¸å­¸æ–¹æ³•æ´—ç‰Œä¸¦ç¢ºä¿å¯è§£
     * @param {Array} deck - ç‰Œçµ„
     * @returns {Array} - æ´—ç‰Œå¾Œçš„ç‰Œçµ„
     */
    function shuffleWithSolvableAlgorithm(deck) {
        // ä½¿ç”¨ç•¶å‰æ™‚é–“ä½œç‚ºéš¨æ©Ÿç¨®å­
        let seed = Date.now() % 1000000;
        
        // éš¨æ©Ÿæ•¸ç”Ÿæˆå™¨
        function random() {
            seed = (seed * 9301 + 49297) % 233280;
            return seed / 233280;
        }
        
        // ç¬¬ä¸€æ­¥ï¼šå°‡ç‰Œåˆ†æˆå…©åŠä¸¦äº¤éŒ¯
        let half1 = deck.slice(0, 26);
        let half2 = deck.slice(26);
        let interleaved = [];
        
        for (let i = 0; i < 26; i++) {
            interleaved.push(half1[i]);
            interleaved.push(half2[i]);
        }
        
        // ç¬¬äºŒæ­¥ï¼šæŒ‰ç‰¹å®šæ¨¡å¼é‡æ–°æ’åˆ—
        let rearranged = [];
        let positions = [];
        
        // ç”Ÿæˆä¸€å€‹æ’åˆ—æ¨¡å¼
        for (let i = 0; i < 52; i++) {
            positions[i] = i;
        }
        
        // è²»é›ª-è€¶èŒ¨æ´—ç‰Œç®—æ³•
        for (let i = positions.length - 1; i > 0; i--) {
            let j = Math.floor(random() * (i + 1));
            [positions[i], positions[j]] = [positions[j], positions[i]];
        }
        
        // æ‡‰ç”¨æ’åˆ—
        for (let i = 0; i < 52; i++) {
            rearranged[positions[i]] = interleaved[i];
        }
        
        // ç¬¬ä¸‰æ­¥ï¼šç¢ºä¿èŠ±è‰²å’Œæ•¸å­—çš„åˆ†å¸ƒæœ‰åŠ©æ–¼å¯è§£
        // è¨ˆç®—æ¯ç¨®èŠ±è‰²çš„ç‰Œæ•¸
        let suitCounts = {'â™ ':0, 'â™¥':0, 'â™£':0, 'â™¦':0};
        for (let i = 0; i < rearranged.length; i++) {
            suitCounts[rearranged[i].suit]++;
        }
        
        // ç¬¬å››æ­¥ï¼šèª¿æ•´é †åºç¢ºä¿Aceå’ŒKingçš„ä½ç½®æœ‰åˆ©æ–¼éŠæˆ²
        // å°‡ä¸€äº›Aceç§»åˆ°å¾Œé¢ï¼Œå°‡ä¸€äº›Kingç§»åˆ°å‰é¢
        let adjusted = [];
        let aces = [];
        let kings = [];
        let others = [];
        
        for (let card of rearranged) {
            if (card.rank === 1) aces.push(card);
            else if (card.rank === 13) kings.push(card);
            else others.push(card);
        }
        
        // æ··åˆé †åºï¼šä¸€äº›Kingåœ¨å‰é¢ï¼Œç„¶å¾Œæ˜¯å…¶ä»–ç‰Œï¼Œæœ€å¾Œæ˜¯Ace
        adjusted = [...kings.slice(0, 2), ...others, ...aces, ...kings.slice(2)];
        
        // ç¬¬äº”æ­¥ï¼šæœ€å¾Œä¸€æ¬¡è¼•å¾®éš¨æ©ŸåŒ–ï¼Œä½†ä¿æŒçµæ§‹
        for (let i = 0; i < 20; i++) {
            let idx1 = Math.floor(random() * adjusted.length);
            let idx2 = Math.floor(random() * adjusted.length);
            
            // åªäº¤æ›åŒèŠ±è‰²çš„ç‰Œä»¥ä¿æŒå¯è§£æ€§
            if (adjusted[idx1].suit === adjusted[idx2].suit) {
                [adjusted[idx1], adjusted[idx2]] = [adjusted[idx2], adjusted[idx1]];
            }
        }
        
        return adjusted;
    }

    // ==================== è¨Šæ¯é¡¯ç¤ºå‡½æ•¸ ====================
    /**
     * é¡¯ç¤ºè¨Šæ¯
     * @param {string} text - è¨Šæ¯å…§å®¹
     * @param {number} duration - é¡¯ç¤ºæŒçºŒæ™‚é–“(æ¯«ç§’)
     */
    function showMessage(text, duration = 2000) {
        const messageEl = document.getElementById('message');
        messageEl.textContent = text;
        messageEl.style.display = 'block';
        setTimeout(() => {
            messageEl.style.display = 'none';
        }, duration);
    }
    
    // ==================== æç¤ºç³»çµ±å‡½æ•¸ ====================
    /**
     * é¡¯ç¤ºéŠæˆ²æç¤º
     */
    function showHint() {
        if (isAnimating) return; // å‹•ç•«ä¸­ä¸é¡¯ç¤ºæç¤º
        const hintBtn = document.getElementById('hint-btn');
        const mobileHintBtn = document.getElementById('mobile-hint-btn');
        hintBtn.disabled = true; // ç¦ç”¨æç¤ºæŒ‰éˆ•
        mobileHintBtn.disabled = true; // ç¦ç”¨æ‰‹æ©Ÿç‰ˆæç¤ºæŒ‰éˆ•
        
        // æ¸…é™¤ç¾æœ‰é«˜å…‰æ•ˆæœ
        document.querySelectorAll('.highlight, .target-highlight').forEach(el => {
            el.classList.remove('highlight', 'target-highlight');
        });
        
        let hint = null;
        
        // 1. å°‹æ‰¾Aceç§»å‹•
        hint = findAceMove();
        if (hint) {
            showMessage(hint.message, 2000);
            highlightCardPair(hint.sourceCardId, hint.targetType, hint.targetIdx, hint.targetCardId);
            setTimeout(() => { 
                hintBtn.disabled = false; 
                mobileHintBtn.disabled = false;
            }, 500);
            return;
        }
        
        // 2. å°‹æ‰¾èŠ±è‰²å€ç§»å‹•
        hint = findFoundationMove();
        if (hint) {
            showMessage(hint.message, 2000);
            highlightCardPair(hint.sourceCardId, hint.targetType, hint.targetIdx, hint.targetCardId);
            setTimeout(() => { 
                hintBtn.disabled = false; 
                mobileHintBtn.disabled = false;
            }, 500);
            return;
        }
        
        // 3. æ ¹æ“šç¿»é–‹ç‰Œæ•¸é‡å°‹æ‰¾æœ€ä½³è¡¨æ ¼ç§»å‹•
        hint = findBestTableauMoveByUncoveredCards();
        if (hint) {
            showMessage(hint.message, 2000);
            highlightCardPair(hint.sourceCardId, hint.targetType, hint.targetIdx, hint.targetCardId);
            setTimeout(() => { 
                hintBtn.disabled = false; 
                mobileHintBtn.disabled = false;
            }, 500);
            return;
        }
        
        // 4. æ ¹æ“šé€£é–é•·åº¦å°‹æ‰¾æœ€ä½³è¡¨æ ¼ç§»å‹•
        hint = findBestTableauMoveByChainLength();
        if (hint) {
            showMessage(hint.message, 2000);
            highlightCardPair(hint.sourceCardId, hint.targetType, hint.targetIdx, hint.targetCardId);
            setTimeout(() => { 
                hintBtn.disabled = false; 
                mobileHintBtn.disabled = false;
            }, 500);
            return;
        }
        
        // 5. æª¢æŸ¥å»¢ç‰Œå€ç§»å‹•
        if (state.waste.length > 0) {
            // åœ¨ä¸‰å¼µæ¨¡å¼ä¸‹ï¼Œåªèƒ½ç§»å‹•å»¢ç‰Œå †æœ€ä¸Šé¢çš„ä¸€å¼µç‰Œ
            const wasteCard = state.waste[state.waste.length - 1];
            for (let j = 0; j < 4; j++) {
                const foundation = state.foundations[j];
                if (canMoveToFoundation(wasteCard, foundation)) {
                    showMessage(`æç¤ºï¼šå°‡å»¢ç‰Œå€çš„${wasteCard.text}${wasteCard.suit}ç§»åˆ°èŠ±è‰²å€${j+1}`, 2000);
                    let targetCardId = null;
                    if (foundation.length > 0) {
                        targetCardId = foundation[foundation.length - 1].id;
                    }
                    highlightCardPair(wasteCard.id, 'foundation', j, targetCardId);
                    setTimeout(() => { 
                        hintBtn.disabled = false; 
                        mobileHintBtn.disabled = false;
                    }, 500);
                    return;
                }
            }
            for (let targetCol = 0; targetCol < 7; targetCol++) {
                const targetPile = state.tableau[targetCol];
                if (canMoveToTableau(wasteCard, targetPile)) {
                    showMessage(`æç¤ºï¼šå°‡å»¢ç‰Œå€çš„${wasteCard.text}${wasteCard.suit}ç§»åˆ°ç¬¬${targetCol+1}åˆ—`, 2000);
                    let targetCardId = null;
                    if (targetPile.length > 0) {
                        targetCardId = targetPile[targetPile.length - 1].id;
                    }
                    highlightCardPair(wasteCard.id, 'tableau', targetCol, targetCardId);
                    setTimeout(() => { 
                        hintBtn.disabled = false; 
                        mobileHintBtn.disabled = false;
                    }, 500);
                    return;
                }
            }
        }
        
        // 6. å°‹æ‰¾å¯ç¿»é–‹çš„ç‰Œ
        hint = findFlipCardHint();
        if (hint) {
            showMessage(hint.message, 2000);
            highlightCard(hint.cardId);
            setTimeout(() => { 
                hintBtn.disabled = false; 
                mobileHintBtn.disabled = false;
            }, 500);
            return;
        }
        
        // 7. é è¨­æç¤º
        if (state.stock.length > 0) {
            showMessage(`æç¤ºï¼šé»æ“Šç‰Œå †ä¾†ç¿»é–‹æ–°ç‰Œï¼ˆ${state.drawMode}å¼µæ¨¡å¼ï¼‰`, 2000);
            highlightStock();
        } else if (state.waste.length > 0) {
            showMessage("æç¤ºï¼šé»æ“Šå»¢ç‰Œå †å·¦å´çš„ç®­é ­é‡æ–°ä½¿ç”¨å»¢ç‰Œ", 2000);
            highlightStock();
        } else {
            showMessage("å˜—è©¦ç§»å‹•ä¸åŒçš„ç‰Œï¼Œæˆ–è€…é‡æ–°é–‹å§‹éŠæˆ²", 2000);
        }
        
        setTimeout(() => { 
            hintBtn.disabled = false; 
            mobileHintBtn.disabled = false;
        }, 500);
    }
    
    /**
     * å°‹æ‰¾Aceç§»å‹•
     * @returns {Object|null} - æç¤ºç‰©ä»¶æˆ–null
     */
    function findAceMove() {
        // æª¢æŸ¥è¡¨æ ¼ä¸­çš„Ace
        for (let i = 0; i < 7; i++) {
            const pile = state.tableau[i];
            if (pile.length === 0) continue;
            const topCard = pile[pile.length - 1];
            if (!topCard.faceUp) continue;
            if (topCard.rank === 1) {
                let alreadyInFoundation = false;
                // æª¢æŸ¥æ˜¯å¦å·²åœ¨èŠ±è‰²å€
                for (let j = 0; j < 4; j++) {
                    const foundation = state.foundations[j];
                    if (foundation.length > 0 && foundation[0].suit === topCard.suit) {
                        alreadyInFoundation = true;
                        break;
                    }
                }
                if (!alreadyInFoundation) {
                    return {
                        message: `æç¤ºï¼šå°‡ç¬¬${i+1}åˆ—çš„${topCard.text}${topCard.suit}ç§»åˆ°èŠ±è‰²å€`,
                        sourceCardId: topCard.id,
                        targetType: 'foundation',
                        targetIdx: getEmptyFoundationIndex(),
                        targetCardId: null
                    };
                }
            }
        }
        // æª¢æŸ¥å»¢ç‰Œå€ä¸­çš„Ace
        if (state.waste.length > 0) {
            const wasteCard = state.waste[state.waste.length - 1];
            if (wasteCard.rank === 1) {
                let alreadyInFoundation = false;
                for (let j = 0; j < 4; j++) {
                    const foundation = state.foundations[j];
                    if (foundation.length > 0 && foundation[0].suit === wasteCard.suit) {
                        alreadyInFoundation = true;
                        break;
                    }
                }
                if (!alreadyInFoundation) {
                    return {
                        message: `æç¤ºï¼šå°‡å»¢ç‰Œå€çš„${wasteCard.text}${wasteCard.suit}ç§»åˆ°èŠ±è‰²å€`,
                        sourceCardId: wasteCard.id,
                        targetType: 'foundation',
                        targetIdx: getEmptyFoundationIndex(),
                        targetCardId: null
                    };
                }
            }
        }
        return null;
    }
    
    /**
     * å–å¾—ç©ºçš„èŠ±è‰²å€ç´¢å¼•
     * @returns {number} - èŠ±è‰²å€ç´¢å¼•
     */
    function getEmptyFoundationIndex() {
        for (let i = 0; i < 4; i++) {
            if (state.foundations[i].length === 0) return i;
        }
        return 0;
    }
    
    /**
     * å°‹æ‰¾èŠ±è‰²å€ç§»å‹•
     * @returns {Object|null} - æç¤ºç‰©ä»¶æˆ–null
     */
    function findFoundationMove() {
        // æª¢æŸ¥è¡¨æ ¼ä¸­çš„ç‰Œ
        for (let i = 0; i < 7; i++) {
            const pile = state.tableau[i];
            if (pile.length === 0) continue;
            const topCard = pile[pile.length - 1];
            if (!topCard.faceUp) continue;
            for (let j = 0; j < 4; j++) {
                const foundation = state.foundations[j];
                if (canMoveToFoundation(topCard, foundation)) {
                    let targetCardId = null;
                    if (foundation.length > 0) targetCardId = foundation[foundation.length - 1].id;
                    return {
                        message: `æç¤ºï¼šå°‡ç¬¬${i+1}åˆ—çš„${topCard.text}${topCard.suit}ç§»åˆ°èŠ±è‰²å€${j+1}`,
                        sourceCardId: topCard.id,
                        targetType: 'foundation',
                        targetIdx: j,
                        targetCardId: targetCardId
                    };
                }
            }
        }
        // æª¢æŸ¥å»¢ç‰Œå€çš„ç‰Œ
        if (state.waste.length > 0) {
            const wasteCard = state.waste[state.waste.length - 1];
            for (let j = 0; j < 4; j++) {
                const foundation = state.foundations[j];
                if (canMoveToFoundation(wasteCard, foundation)) {
                    let targetCardId = null;
                    if (foundation.length > 0) targetCardId = foundation[foundation.length - 1].id;
                    return {
                        message: `æç¤ºï¼šå°‡å»¢ç‰Œå€çš„${wasteCard.text}${wasteCard.suit}ç§»åˆ°èŠ±è‰²å€${j+1}`,
                        sourceCardId: wasteCard.id,
                        targetType: 'foundation',
                        targetIdx: j,
                        targetCardId: targetCardId
                    };
                }
            }
        }
        return null;
    }
    
    /**
     * æ ¹æ“šç¿»é–‹ç‰Œæ•¸é‡å°‹æ‰¾æœ€ä½³è¡¨æ ¼ç§»å‹•
     * @returns {Object|null} - æç¤ºç‰©ä»¶æˆ–null
     */
    function findBestTableauMoveByUncoveredCards() {
        let bestMove = null;
        let bestUncoveredCount = -1;
        for (let sourceCol = 0; sourceCol < 7; sourceCol++) {
            const sourcePile = state.tableau[sourceCol];
            if (sourcePile.length === 0) continue;
            let sourceIdx = -1;
            // å°‹æ‰¾æœ€ä¸Šé¢ç¿»é–‹çš„ç‰Œ
            for (let i = sourcePile.length - 1; i >= 0; i--) {
                if (sourcePile[i].faceUp) {
                    sourceIdx = i;
                    break;
                }
            }
            if (sourceIdx === -1) continue;
            const card = sourcePile[sourceIdx];
            // æª¢æŸ¥æ‰€æœ‰ç›®æ¨™åˆ—
            for (let targetCol = 0; targetCol < 7; targetCol++) {
                if (sourceCol === targetCol) continue;
                const targetPile = state.tableau[targetCol];
                if (canMoveToTableau(card, targetPile)) {
                    // è¨ˆç®—ç§»å‹•å¾Œæœƒç¿»é–‹å¤šå°‘å¼µç‰Œ
                    let uncoveredCount = 0;
                    if (sourceIdx > 0 && !sourcePile[sourceIdx - 1].faceUp) uncoveredCount = 1;
                    // é¸æ“‡ç¿»é–‹æœ€å¤šç‰Œçš„ç§»å‹•
                    if (uncoveredCount > bestUncoveredCount) {
                        bestUncoveredCount = uncoveredCount;
                        let targetCardId = null;
                        if (targetPile.length > 0) targetCardId = targetPile[targetPile.length - 1].id;
                        bestMove = {
                            sourceCol, targetCol, card,
                            message: `æç¤ºï¼šå°‡ç¬¬${sourceCol+1}åˆ—çš„${card.text}${card.suit}ç§»åˆ°ç¬¬${targetCol+1}åˆ—`,
                            sourceCardId: card.id,
                            targetType: 'tableau',
                            targetIdx: targetCol,
                            targetCardId: targetCardId
                        };
                    }
                }
            }
        }
        return bestMove;
    }
    
    /**
     * æ ¹æ“šé€£é–é•·åº¦å°‹æ‰¾æœ€ä½³è¡¨æ ¼ç§»å‹•
     * @returns {Object|null} - æç¤ºç‰©ä»¶æˆ–null
     */
    function findBestTableauMoveByChainLength() {
        let bestMove = null;
        let bestChainLength = -1;
        for (let sourceCol = 0; sourceCol < 7; sourceCol++) {
            const sourcePile = state.tableau[sourceCol];
            if (sourcePile.length === 0) continue;
            let sourceIdx = -1;
            // å°‹æ‰¾æœ€ä¸Šé¢ç¿»é–‹çš„ç‰Œ
            for (let i = sourcePile.length - 1; i >= 0; i--) {
                if (sourcePile[i].faceUp) {
                    sourceIdx = i;
                    break;
                }
            }
            if (sourceIdx === -1) continue;
            const card = sourcePile[sourceIdx];
            const chainLength = sourcePile.length - sourceIdx; // è¨ˆç®—é€£é–é•·åº¦
            // æª¢æŸ¥æ‰€æœ‰ç›®æ¨™åˆ—
            for (let targetCol = 0; targetCol < 7; targetCol++) {
                if (sourceCol === targetCol) continue;
                const targetPile = state.tableau[targetCol];
                if (canMoveToTableau(card, targetPile)) {
                    // é¸æ“‡æœ€é•·é€£é–çš„ç§»å‹•
                    if (chainLength > bestChainLength) {
                        bestChainLength = chainLength;
                        let targetCardId = null;
                        if (targetPile.length > 0) targetCardId = targetPile[targetPile.length - 1].id;
                        bestMove = {
                            sourceCol, targetCol, card,
                            message: `æç¤ºï¼šå°‡ç¬¬${sourceCol+1}åˆ—çš„${card.text}${card.suit}ç§»åˆ°ç¬¬${targetCol+1}åˆ—`,
                            sourceCardId: card.id,
                            targetType: 'tableau',
                            targetIdx: targetCol,
                            targetCardId: targetCardId
                        };
                    }
                }
            }
        }
        return bestMove;
    }
    
    /**
     * å°‹æ‰¾å¯ç¿»é–‹çš„ç‰Œ
     * @returns {Object|null} - æç¤ºç‰©ä»¶æˆ–null
     */
    function findFlipCardHint() {
        for (let i = 0; i < 7; i++) {
            const pile = state.tableau[i];
            if (pile.length > 0) {
                const topCard = pile[pile.length - 1];
                if (!topCard.faceUp) {
                    return {
                        message: `æç¤ºï¼šé»æ“Šç¬¬${i+1}åˆ—æœ€ä¸Šé¢çš„è“‹ç‰Œä¾†ç¿»ç‰Œ`,
                        cardId: topCard.id
                    };
                }
            }
        }
        return null;
    }
    
    /**
     * é«˜å…‰é¡¯ç¤ºå–®å¼µå¡ç‰‡
     * @param {string} cardId - å¡ç‰‡ID
     */
    function highlightCard(cardId) {
        if (!cardId) return;
        const cardElement = document.querySelector(`[data-id="${cardId}"]`);
        if (cardElement) {
            cardElement.classList.add('highlight');
            setTimeout(() => { cardElement.classList.remove('highlight'); }, 2000);
        }
    }
    
    /**
     * é«˜å…‰é¡¯ç¤ºå¡ç‰‡å°ï¼ˆä¾†æºå’Œç›®æ¨™ï¼‰
     * @param {string} sourceCardId - ä¾†æºå¡ç‰‡ID
     * @param {string} targetType - ç›®æ¨™é¡å‹
     * @param {number} targetIdx - ç›®æ¨™ç´¢å¼•
     * @param {string} targetCardId - ç›®æ¨™å¡ç‰‡ID
     */
    function highlightCardPair(sourceCardId, targetType, targetIdx, targetCardId = null) {
        // é«˜å…‰æºå¡ç‰‡
        const sourceElement = document.querySelector(`[data-id="${sourceCardId}"]`);
        if (sourceElement) {
            sourceElement.classList.add('highlight');
            setTimeout(() => { sourceElement.classList.remove('highlight'); }, 2000);
        }
        // é«˜å…‰ç›®æ¨™
        if (targetCardId) {
            const targetElement = document.querySelector(`[data-id="${targetCardId}"]`);
            if (targetElement) {
                targetElement.classList.add('target-highlight');
                setTimeout(() => { targetElement.classList.remove('target-highlight'); }, 2000);
            }
        } else if (targetType === 'foundation') {
            const foundationSlot = document.querySelector(`#slot-f${targetIdx}`);
            if (foundationSlot) {
                foundationSlot.classList.add('target-highlight');
                setTimeout(() => { foundationSlot.classList.remove('target-highlight'); }, 2000);
            }
        } else if (targetType === 'tableau') {
            const tableauSlot = document.querySelector(`#slot-t${targetIdx}`);
            if (tableauSlot) {
                tableauSlot.classList.add('target-highlight');
                setTimeout(() => { tableauSlot.classList.remove('target-highlight'); }, 2000);
            }
        }
    }
    
    /**
     * é«˜å…‰é¡¯ç¤ºç‰Œå †
     */
    function highlightStock() {
        const stockElement = document.querySelector('#slot-stock');
        if (stockElement) {
            stockElement.classList.add('highlight');
            setTimeout(() => { stockElement.classList.remove('highlight'); }, 2000);
        }
    }
    
    // ==================== ç§»å‹•è¦å‰‡æª¢æŸ¥å‡½æ•¸ ====================
    /**
     * æª¢æŸ¥æ˜¯å¦å¯ä»¥ç§»å‹•åˆ°èŠ±è‰²å€
     * @param {Object} card - å¡ç‰‡ç‰©ä»¶
     * @param {Array} foundation - èŠ±è‰²å€é™£åˆ—
     * @returns {boolean} - æ˜¯å¦å¯ä»¥ç§»å‹•
     */
    function canMoveToFoundation(card, foundation) {
        if (foundation.length === 0) return card.rank === 1; // ç©ºçš„èŠ±è‰²å€åªèƒ½æ”¾Ace
        const topCard = foundation[foundation.length - 1]; // èŠ±è‰²å€æœ€ä¸Šé¢çš„ç‰Œ
        return card.suit === topCard.suit && card.rank === topCard.rank + 1; // åŒèŠ±è‰²ä¸”æ•¸å­—é€£çºŒ
    }
    
    /**
     * æª¢æŸ¥æ˜¯å¦å¯ä»¥ç§»å‹•åˆ°è¡¨æ ¼
     * @param {Object} card - å¡ç‰‡ç‰©ä»¶
     * @param {Array} tableauPile - è¡¨æ ¼åˆ—é™£åˆ—
     * @returns {boolean} - æ˜¯å¦å¯ä»¥ç§»å‹•
     */
    function canMoveToTableau(card, tableauPile) {
        if (tableauPile.length === 0) return card.rank === 13; // ç©ºçš„è¡¨æ ¼åˆ—åªèƒ½æ”¾King
        const topCard = tableauPile[tableauPile.length - 1]; // è¡¨æ ¼åˆ—æœ€ä¸Šé¢çš„ç‰Œ
        return card.color !== topCard.color && card.rank === topCard.rank - 1; // ä¸åŒé¡è‰²ä¸”æ•¸å­—é€£çºŒ
    }

    // ==================== ä½ˆå±€è¨ˆç®—å‡½æ•¸ ====================
    let slotPositions = {}; // æ§½ä½ä½ç½®è³‡è¨Š
    let cardSize = {width: 0, height: 0}; // å¡ç‰‡å°ºå¯¸
    
    /**
     * ä½ˆå±€æ‰€æœ‰æ§½ä½
     */
    function layoutSlots() {
        const board = document.getElementById('game-board');
        const w = board.clientWidth; // éŠæˆ²å€åŸŸå¯¬åº¦
        
        // å»ºç«‹æ¸¬é‡å…ƒç´ è¨ˆç®—å¡ç‰‡å°ºå¯¸
        const measure = document.createElement('div');
        measure.className = 'slot';
        board.appendChild(measure);
        cardSize.width = measure.offsetWidth;
        cardSize.height = measure.offsetHeight;
        board.removeChild(measure);

        // æª¢æŸ¥æ˜¯å¦ç‚ºæ‰‹æ©Ÿç‰ˆ
        const isMobile = window.innerWidth < 600;
        if (isMobile) {
            // é™åˆ¶æ‰‹æ©Ÿä¸Šæœ€å¤§å¡ç‰‡å°ºå¯¸
            const maxCardWidth = Math.min(cardSize.width, 75); // å¾70å¢åŠ åˆ°75
            const maxCardHeight = Math.min(cardSize.height, 105); // å¾98å¢åŠ åˆ°105
            cardSize.width = maxCardWidth;
            cardSize.height = maxCardHeight;
        }

        // è¨ˆç®—é–“è·
        const gap = Math.max(0.5, (w - (cardSize.width * 7)) / 8); // æœ€å°é–“è·0.5px
        
        /**
         * è¨­å®šæ§½ä½ä½ç½®
         * @param {string} id - æ§½ä½ID
         * @param {number} x - Xåº§æ¨™
         * @param {number} y - Yåº§æ¨™
         */
        const setPos = (id, x, y) => {
            const el = document.getElementById(id);
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            // å„²å­˜ä½ç½®è³‡è¨Š
            slotPositions[id] = { 
                left: x, top: y, right: x + cardSize.width, bottom: y + cardSize.height,
                cx: x + cardSize.width/2, cy: y + cardSize.height/2
            };
        };

        // ä¸Šæ–¹å€åŸŸä½ˆå±€
        const topRowY = 10;
        
        // è¨ˆç®—ä¸‰å¼µç‰Œéœ€è¦çš„ç¸½å¯¬åº¦ï¼šå¡ç‰‡å¯¬åº¦ + 2 * (å¡ç‰‡å¯¬åº¦ * 0.3)
        const wasteTotalWidth = cardSize.width * (1 + 0.3 * 2);
        
        if (state.handMode === 'right') {
            // å³æ‰‹æ¨¡å¼ï¼šèŠ±è‰²å€åœ¨å·¦ï¼Œå»¢ç‰Œå †åœ¨ä¸­é–“ï¼ˆé å³ï¼‰ï¼Œç‰Œå †åœ¨æœ€å³é‚Š
            // 1. å››å€‹èŠ±è‰²å€ï¼ˆå®‰ç½®å€ï¼‰æ”¾åœ¨æœ€å·¦é‚Š
            for(let i=0; i<4; i++) {
                setPos(`slot-f${i}`, gap + i * (cardSize.width + gap), topRowY);
            }
            
            // 2. å»¢ç‰Œå †æ”¾åœ¨ç‰Œå †å·¦é‚Šï¼Œä½†è¦ç‚ºä¸‰å¼µç‰Œç•™å‡ºç©ºé–“ï¼Œå‘å·¦ç§»å‹•
            const wasteX = w - gap - cardSize.width - wasteTotalWidth - gap;
            setPos('slot-waste', wasteX, topRowY);
            
            // 3. ç‰Œå †ï¼ˆè“‹ç‰Œå€ï¼‰æ”¾åœ¨æœ€å³é‚Š
            const stockX = w - gap - cardSize.width;
            setPos('slot-stock', stockX, topRowY);
        } else {
            // å·¦æ‰‹æ¨¡å¼ï¼šç‰Œå †åœ¨å·¦ï¼Œå»¢ç‰Œå †åœ¨ç‰Œå †å³é‚Šï¼ŒèŠ±è‰²å€åœ¨å³é‚Š
            // é—œéµä¿®æ­£ï¼šç‰Œå †å’Œå»¢ç‰Œå †çš„è·é›¢æ‡‰è©²èˆ‡å³æ‰‹æ¨¡å¼å°ç¨±
            // åœ¨å³æ‰‹æ¨¡å¼ä¸­ï¼Œç‰Œå †åœ¨å³ï¼Œå»¢ç‰Œå †åœ¨ç‰Œå †å·¦é‚Šä¸€å€‹gapçš„ä½ç½®ï¼ˆä½†è€ƒæ…®ä¸‰å¼µç‰Œå¯¬åº¦ï¼‰
            // åœ¨å·¦æ‰‹æ¨¡å¼ä¸­ï¼Œç‰Œå †åœ¨å·¦ï¼Œå»¢ç‰Œå †æ‡‰è©²åœ¨ç‰Œå †å³é‚Šä¸€å€‹gapçš„ä½ç½®ï¼ˆä½†è€ƒæ…®ä¸‰å¼µç‰Œå¯¬åº¦ï¼‰
            
            // 1. ç‰Œå †ï¼ˆè“‹ç‰Œå€ï¼‰æ”¾åœ¨æœ€å·¦é‚Š
            const stockX = gap;
            setPos('slot-stock', stockX, topRowY);
            
            // 2. å»¢ç‰Œå †æ”¾åœ¨ç‰Œå †å³é‚Šï¼Œè·é›¢ç‚ºä¸€å€‹gapï¼ˆèˆ‡å³æ‰‹æ¨¡å¼å°ç¨±ï¼‰
            // æ³¨æ„ï¼šé€™è£¡ä¸éœ€è¦ç‚ºä¸‰å¼µç‰Œç•™å‡ºç©ºé–“ï¼Œå› ç‚ºç‰Œæ˜¯å‘å³å±•é–‹çš„
            // ä½†åœ¨è¨ˆç®—ä½ç½®æ™‚ï¼Œæˆ‘å€‘éœ€è¦è€ƒæ…®ä¸‰å¼µç‰Œæ¨¡å¼ä¸‹çš„è¦–è¦ºå°é½Š
            const wasteX = stockX + cardSize.width + gap;
            setPos('slot-waste', wasteX, topRowY);
            
            // 3. å››å€‹èŠ±è‰²å€ï¼ˆå®‰ç½®å€ï¼‰æ”¾åœ¨æœ€å³é‚Š
            // è¨ˆç®—èŠ±è‰²å€éœ€è¦çš„ç¸½å¯¬åº¦ï¼š4å¼µå¡ç‰‡ + 3å€‹é–“è·
            const foundationsTotalWidth = 4 * cardSize.width + 3 * gap;
            // èŠ±è‰²å€å³é‚Šç·£å°é½Šå±å¹•å³é‚Šç·£æ¸›å»ä¸€å€‹gap
            const foundationsRight = w - gap;
            // èŠ±è‰²å€å·¦é‚Šç·£ä½ç½®
            const foundationsLeft = foundationsRight - foundationsTotalWidth;
            
            // è¨­ç½®èŠ±è‰²å€ä½ç½®ï¼Œå¾å·¦åˆ°å³æ’åˆ—
            for(let i=0; i<4; i++) {
                const foundationX = foundationsLeft + i * (cardSize.width + gap);
                setPos(`slot-f${i}`, foundationX, topRowY);
            }
        }
        
        // ä¸‹æ–¹ä¸ƒåˆ—è¡¨æ ¼ä½ˆå±€
        const tableauY = topRowY + cardSize.height + (isMobile ? 10 : 30); // æ‰‹æ©Ÿä¸Šæ¸›å°‘é–“è·
        for(let i=0; i<7; i++) {
            let x = gap * (i+1) + cardSize.width * i;
            setPos(`slot-t${i}`, x, tableauY);
        }
    }

    // ==================== æ¸²æŸ“å¼•æ“å‡½æ•¸ ====================
    /**
     * æ¸²æŸ“éŠæˆ²ç•«é¢
     */
    function render() {
        const layer = document.getElementById('card-layer');
        layer.innerHTML = ''; // æ¸…ç©ºåœ–å±¤

        /**
         * ç¹ªè£½å–®å¼µå¡ç‰‡
         * @param {Object} card - å¡ç‰‡ç‰©ä»¶
         * @param {number} x - Xåº§æ¨™
         * @param {number} y - Yåº§æ¨™
         * @param {string} type - å¡ç‰‡é¡å‹
         * @param {number} pileIdx - æ‰€åœ¨å †ç–Šç´¢å¼•
         * @param {number} cardIdx - å¡ç‰‡åœ¨å †ç–Šä¸­çš„ç´¢å¼•
         * @param {boolean} isWaste - æ˜¯å¦ç‚ºå»¢ç‰Œå †å¡ç‰‡
         * @param {number} wasteOffset - å»¢ç‰Œå †åç§»é‡
         */
        const drawCard = (card, x, y, type, pileIdx, cardIdx, isWaste = false, wasteOffset = 0) => {
            const div = document.createElement('div');
            div.className = `card ${card.faceUp ? '' : 'back'}`;
            
            // è¨ˆç®—å¡ç‰‡ä½ç½®
            let finalX = x;
            if (isWaste && wasteOffset > 0) {
                finalX += wasteOffset;
            }
            
            div.style.left = finalX + 'px';
            div.style.top = y + 'px';
            div.dataset.id = card.id;
            div.dataset.type = type;
            div.dataset.pileIdx = pileIdx;
            div.dataset.cardIdx = cardIdx;
            div.dataset.text = card.text; // æ·»åŠ ç‰Œé¢æ–‡å­—ç”¨æ–¼CSSé¸æ“‡å™¨

            if (card.faceUp) {
                div.classList.add(card.color);
                div.innerHTML = `
                    <div class="card-face">
                        <div class="card-num ${card.color}">${card.text}</div>
                        <div class="card-suit-top ${card.color}">${card.suit}</div>
                        <div class="card-center-suit ${card.color}">${card.suit}</div>
                    </div>
                `;
                
                // æ·»åŠ æ‹–æ›³äº‹ä»¶ç›£è½å™¨
                // åœ¨ä¸‰å¼µæ¨¡å¼ä¸‹ï¼Œå»¢ç‰Œå †åªæœ‰æœ€ä¸Šé¢çš„ç‰Œå¯ä»¥æ‹–æ›³
                if (type !== 'waste' || cardIdx === state.waste.length - 1) {
                    div.addEventListener('mousedown', (e) => startDrag(e, type, pileIdx, cardIdx));
                    div.addEventListener('touchstart', (e) => startDrag(e, type, pileIdx, cardIdx), {passive: false});
                }
                
            } else {
                // èƒŒé¢æœä¸Šçš„å¡ç‰‡æ·»åŠ é»æ“Šäº‹ä»¶
                if (type === 'stock') {
                    div.addEventListener('click', () => drawStockWithAnimation());
                } else if (type === 'tableau') {
                    const pile = state.tableau[pileIdx];
                    if (cardIdx === pile.length - 1) {
                        div.addEventListener('click', () => flipTableauCard(pileIdx));
                    }
                }
            }
            layer.appendChild(div);
        };

        // ç¹ªè£½ç‰Œå †
        const sPos = slotPositions['slot-stock'];
        if (state.stock.length > 0) {
            // å‰µå»ºç‰Œå †å¡ç‰‡
            const stockDiv = document.createElement('div');
            stockDiv.className = 'card back';
            stockDiv.style.left = sPos.left + 'px';
            stockDiv.style.top = sPos.top + 'px';
            stockDiv.dataset.type = 'stock';
            
            // æ·»åŠ ç‰Œå †å‰©é¤˜æ•¸é‡é¡¯ç¤ºï¼ˆæ ¹æ“šè¨­å®šæ±ºå®šæ˜¯å¦é¡¯ç¤ºï¼‰
            if (state.showCardCount) {
                const countDiv = document.createElement('div');
                countDiv.className = 'card-count';
                countDiv.textContent = state.stock.length;
                stockDiv.appendChild(countDiv);
            }
            
            stockDiv.addEventListener('click', () => drawStockWithAnimation());
            layer.appendChild(stockDiv);
        } else {
            // ç‰Œå †ç‚ºç©ºæ™‚é¡¯ç¤ºé‡æ–°æ•´ç†æŒ‰éˆ•
            const emptyStock = document.createElement('div');
            emptyStock.style.cssText = `position:absolute; left:${sPos.left}px; top:${sPos.top}px; width:${cardSize.width}px; height:${cardSize.height}px;`;
            emptyStock.innerHTML = '<div class="refresh-btn">â†º</div>';
            emptyStock.addEventListener('click', resetStock);
            layer.appendChild(emptyStock);
        }

        // ç¹ªè£½å»¢ç‰Œå †
        const wPos = slotPositions['slot-waste'];
        const wasteLen = state.waste.length;
        
        if (wasteLen > 0) {
            if (state.drawMode === 3 && wasteLen >= 3) {
                // ä¸‰å¼µæ¨¡å¼ï¼šé¡¯ç¤ºæœ€è¿‘çš„ä¸‰å¼µç‰Œ
                const displayCards = state.waste.slice(-3); // å–æœ€å¾Œä¸‰å¼µç‰Œ
                
                // è¨ˆç®—æ¯å¼µç‰Œçš„åç§»é‡ - ç¢ºä¿æœ€èˆŠçš„åœ¨å·¦é‚Šï¼ˆåç§»0ï¼‰ï¼Œæœ€æ–°çš„åœ¨å³é‚Šï¼ˆåç§»æœ€å¤§ï¼‰
                for (let i = 0; i < 3; i++) {
                    const card = displayCards[i];
                    // ç¬¬ä¸€å¼µï¼ˆæœ€èˆŠï¼‰åç§»0ï¼Œç¬¬äºŒå¼µåç§»30%ï¼Œç¬¬ä¸‰å¼µï¼ˆæœ€æ–°ï¼‰åç§»60%
                    const offset = i * (cardSize.width * 0.3);
                    drawCard(card, wPos.left, wPos.top, 'waste', 0, wasteLen-3+i, true, offset);
                }
            } else if (state.drawMode === 3 && wasteLen < 3) {
                // ä¸‰å¼µæ¨¡å¼ä½†ç‰Œä¸å¤ ä¸‰å¼µ
                for (let i = 0; i < wasteLen; i++) {
                    const card = state.waste[i];
                    // è¨ˆç®—åç§»ï¼šæ¯å¼µç‰Œå‘å³åç§»å¡ç‰‡å¯¬åº¦çš„30%
                    const offset = i * (cardSize.width * 0.3);
                    drawCard(card, wPos.left, wPos.top, 'waste', 0, i, true, offset);
                }
            } else {
                // ä¸€å¼µæ¨¡å¼ï¼šåªé¡¯ç¤ºæœ€ä¸Šé¢çš„ä¸€å¼µç‰Œ
                const topWasteCard = state.waste[wasteLen - 1];
                drawCard(topWasteCard, wPos.left, wPos.top, 'waste', 0, wasteLen - 1);
            }
        }

        // ç¹ªè£½å››å€‹èŠ±è‰²å€
        for(let i=0; i<4; i++) {
            const pos = slotPositions[`slot-f${i}`];
            const pile = state.foundations[i];
            if (pile.length > 0) {
                drawCard(pile[pile.length-1], pos.left, pos.top, 'foundation', i, pile.length-1);
            }
        }

        // ç¹ªè£½ä¸ƒåˆ—è¡¨æ ¼
        for(let i=0; i<7; i++) {
            const pos = slotPositions[`slot-t${i}`];
            const pile = state.tableau[i];
            let currentOffset = 0; // ç•¶å‰åç§»é‡
            pile.forEach((card, idx) => {
                if (idx > 0) {
                    const prevCard = pile[idx - 1];
                    
                    // åˆ†é–‹æ‰‹æ©Ÿç‰ˆå’Œç¶²é ç‰ˆçš„é‡ç–Šæ¯”ä¾‹è¨ˆç®—é‚è¼¯
                    let overlapRatio;
                    const isMobile = window.innerWidth < 600;
                    
                    if (isMobile) {
                        // æ‰‹æ©Ÿç‰ˆé‡ç–Šæ¯”ä¾‹è¨ˆç®—é‚è¼¯
                        if (prevCard.faceUp) {
                            overlapRatio = card.faceUp ? 0.5 : 0.9;
                        } else {
                            overlapRatio = 0.9;
                        }
                    } else {
                        // ç¶²é ç‰ˆé‡ç–Šæ¯”ä¾‹è¨ˆç®—é‚è¼¯ï¼ˆä¿æŒåŸæ¨£ä¸è®Šï¼‰
                        if (prevCard.faceUp) {
                            overlapRatio = card.faceUp ? 0.7 : 0.9;
                        } else {
                            overlapRatio = 0.9;
                        }
                    }
                    
                    currentOffset += cardSize.height * (1 - overlapRatio); // è¨ˆç®—åç§»é‡
                }
                drawCard(card, pos.left, pos.top + currentOffset, 'tableau', i, idx);
            });
        }
        
        // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
        updateMagicButton();
    }
    
    /**
     * ç¿»é–‹è¡¨æ ¼ä¸­çš„å¡ç‰‡
     * @param {number} pileIdx - è¡¨æ ¼åˆ—ç´¢å¼•
     */
    function flipTableauCard(pileIdx) {
        if (isAnimating) return;
        const pile = state.tableau[pileIdx];
        if (pile.length > 0) {
            const topCard = pile[pile.length - 1];
            if (!topCard.faceUp) {
                // æ’­æ”¾ç¿»ç‰ŒéŸ³æ•ˆ
                playFlipSound();
                
                topCard.faceUp = true; // ç¿»é–‹å¡ç‰‡
                state.moves++; // å¢åŠ ç§»å‹•æ¬¡æ•¸
                addScore(5); // ç¿»é–‹ä¸€å¼µç‰Œå¾—5åˆ†
                saveStateToHistory(); // å„²å­˜ç‹€æ…‹
                render(); // é‡æ–°æ¸²æŸ“
                updateTimer(); // æ›´æ–°è¨ˆæ™‚å™¨
                updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
            }
        }
    }

    // ==================== ç¿»ç‰Œå‹•ç•«é‚è¼¯ ====================
    /**
     * å¾ç‰Œå †æŠ½ç‰Œï¼ˆå¸¶å‹•ç•«ï¼‰
     */
    function drawStockWithAnimation() {
        if (isAnimating) return;
        if (state.stock.length === 0) return;
        
        isAnimating = true; // æ¨™è¨˜å‹•ç•«é–‹å§‹
        
        const drawCount = Math.min(state.drawMode, state.stock.length); // å¯¦éš›è¦ç¿»é–‹çš„ç‰Œæ•¸
        
        // å…ˆå¾ç‰Œå †ä¸­å–å‡ºç‰Œï¼Œä¿æŒæ­£ç¢ºçš„é †åº
        const cardsToDraw = [];
        for (let i = 0; i < drawCount; i++) {
            // å¾ç‰Œå †é ‚éƒ¨å–ç‰Œï¼ˆæœ€å¾Œä¸€å¼µæ˜¯æœ€ä¸Šé¢çš„ç‰Œï¼‰
            const cardIndex = state.stock.length - 1 - i;
            cardsToDraw.unshift(state.stock[cardIndex]); // ä½¿ç”¨ unshift ç¢ºä¿é †åºæ­£ç¢º
        }
        
        // å¾éŠæˆ²ç‹€æ…‹ä¸­ç§»é™¤é€™äº›ç‰Œï¼ˆç«‹å³æ›´æ–°ç‹€æ…‹ï¼‰
        for (let i = 0; i < drawCount; i++) {
            state.stock.pop();
        }
        
        // ç«‹å³é‡æ–°æ¸²æŸ“ï¼Œæ¶ˆé™¤è“‹ç‰Œå€çš„ç‰ŒèƒŒ
        render();
        
        // å–å¾—ç‰Œå †å’Œå»¢ç‰Œå †çš„è¦–çª—åº§æ¨™ï¼ˆåœ¨é‡æ–°æ¸²æŸ“å¾Œç²å–ï¼‰
        const stockSlot = document.getElementById('slot-stock');
        const wasteSlot = document.getElementById('slot-waste');
        
        if (!stockSlot || !wasteSlot) return;
        
        const stockRect = stockSlot.getBoundingClientRect();
        const wasteRect = wasteSlot.getBoundingClientRect();
        
        // ç‚ºæ¯å¼µç‰Œå‰µå»ºå‹•ç•«å¡ç‰‡
        const animationCards = [];
        
        // å‰µå»ºå‹•ç•«å¡ç‰‡ï¼Œå¾æœ€èˆŠçš„ç‰Œé–‹å§‹å‹•ç•«
        for (let i = 0; i < drawCount; i++) {
            const card = cardsToDraw[i];
            const animCard = document.createElement('div');
            animCard.className = `card draw-animation-card back`;
            animCard.style.left = stockRect.left + 'px';
            animCard.style.top = stockRect.top + 'px';
            animCard.style.width = stockRect.width + 'px';
            animCard.style.height = stockRect.height + 'px';
            
            // æ·»åŠ data-textå±¬æ€§ï¼Œä»¥ä¾¿CSSæ¨£å¼æ­£ç¢ºæ‡‰ç”¨
            animCard.dataset.text = card.text;
            
            // ç¢ºä¿èƒŒæ™¯ç‚ºç™½è‰²
            animCard.style.backgroundColor = 'white';
            
            document.body.appendChild(animCard);
            animationCards.push({card, element: animCard, index: i});
        }
        
        // ä¿æŒé †åºï¼Œæœ€èˆŠçš„ç‰Œå…ˆå‹•ç•«ï¼Œæœ€æ–°çš„ç‰Œæœ€å¾Œå‹•ç•«
        animationCards.forEach((item, animIndex) => {
            const {card, element: animCard, index: originalIndex} = item;
            
            // å¼·åˆ¶ç€è¦½å™¨ Reflow ä»¥ç¢ºä¿å‹•ç•«ç™¼ç”Ÿ
            void animCard.offsetWidth;
            
            // è¨ˆç®—ç›®æ¨™ä½ç½®
            // åœ¨å»¢ç‰Œå †ä¸­ï¼Œæœ€èˆŠçš„ç‰Œåœ¨å·¦é‚Šï¼ˆåç§»0ï¼‰ï¼Œæœ€æ–°çš„ç‰Œåœ¨å³é‚Šï¼ˆåç§»æœ€å¤§ï¼‰
            // originalIndex æ˜¯ cardsToDraw ä¸­çš„ç´¢å¼•ï¼Œ0=æœ€èˆŠï¼ŒdrawCount-1=æœ€æ–°
            // æ‰€ä»¥åç§»é‡æ˜¯ï¼šoriginalIndex * (cardSize.width * 0.3)
            let targetLeft = wasteRect.left + (originalIndex * (cardSize.width * 0.3));
            let targetTop = wasteRect.top;
            
            // è¨­ç½®å‹•ç•«
            animCard.style.left = targetLeft + 'px';
            animCard.style.top = targetTop + 'px';
            
            // æ¯å¼µç‰Œå»¶é²50æ¯«ç§’ç¿»é¢ï¼Œæœ€èˆŠçš„ç‰Œå…ˆç¿»é¢
            setTimeout(() => {
                animCard.classList.remove('back');
                animCard.classList.add(card.color);
                
                // é‡å°æ•¸å­—10çš„ç‰¹æ®Šè™•ç† - åªåœ¨æ‰‹æ©Ÿç‰ˆæ‡‰ç”¨
                let numHtml = `<div class="card-num ${card.color}">${card.text}</div>`;
                const isMobile = window.innerWidth < 600;
                if (card.text === "10" && isMobile) {
                    // å¦‚æœæ˜¯10ä¸”æ˜¯æ‰‹æ©Ÿç‰ˆï¼Œæ·»åŠ ç‰¹æ®Šçš„CSSé¡
                    numHtml = `<div class="card-num ${card.color}" style="font-size: 2.5rem; transform: scaleX(0.75); transform-origin: left top; left: 0.8px;">${card.text}</div>`;
                } else if (card.text === "10") {
                    // å¦‚æœæ˜¯10ä¸”æ˜¯æ¡Œé¢ç‰ˆï¼Œä½¿ç”¨æ­£å¸¸æ¨£å¼
                    numHtml = `<div class="card-num ${card.color}" style="font-size: 1.8rem;">${card.text}</div>`;
                }
                
                animCard.innerHTML = `
                    <div class="card-face">
                        ${numHtml}
                        <div class="card-suit-top ${card.color}">${card.suit}</div>
                        <div class="card-center-suit ${card.color}">${card.suit}</div>
                    </div>
                `;
                
                // æ’­æ”¾ç¿»ç‰ŒéŸ³æ•ˆ
                playFlipSound();
            }, animIndex * 50);
        });
        
        // å‹•ç•«å®Œæˆå¾Œæ›´æ–°éŠæˆ²ç‹€æ…‹
        setTimeout(() => {
            // ç§»é™¤å‹•ç•«å¡ç‰‡
            animationCards.forEach(item => item.element.remove());
            
            // å°‡å–å‡ºçš„ç‰ŒåŠ å…¥å»¢ç‰Œå †
            cardsToDraw.forEach(card => {
                card.faceUp = true;
                state.waste.push(card); // push ç¢ºä¿æœ€æ–°çš„ç‰Œåœ¨æœ€å¾Œï¼ˆæœ€ä¸Šé¢ï¼‰
            });
            
            state.moves++; // å¢åŠ ç§»å‹•æ¬¡æ•¸
            addScore(5 * drawCount); // æ¯å¼µç‰Œå¾—5åˆ†
            saveStateToHistory(); // å„²å­˜ç‹€æ…‹
            render(); // é‡æ–°æ¸²æŸ“
            updateTimer(); // æ›´æ–°è¨ˆæ™‚å™¨
            
            isAnimating = false; // æ¨™è¨˜å‹•ç•«çµæŸ
            updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
        }, 400 + (drawCount * 50));
    }

    /**
     * é‡ç½®ç‰Œå †ï¼ˆå°‡å»¢ç‰Œå †æ”¾å›ç‰Œå †ï¼‰
     */
    function resetStock() {
        if (isAnimating) return;
        if (state.waste.length === 0) return;
        
        // åœ¨ä¸‰å¼µæ¨¡å¼ä¸‹ï¼Œéœ€è¦ä¿æŒå»¢ç‰Œå †çš„é †åº
        // ç¶“å…¸æ¥é¾è¦å‰‡ï¼šç•¶ç‰Œå †ç”¨å®Œæ™‚ï¼Œå°‡å»¢ç‰Œå †çš„ç‰Œç¿»è½‰å¾Œé‡æ–°æˆç‚ºç‰Œå †ï¼Œé †åºä¸è®Š
        state.stock = state.waste.reverse().map(c => { 
            c.faceUp = false; // å°‡ç‰Œé¢æœä¸‹
            return c; 
        });
        state.waste = []; // æ¸…ç©ºå»¢ç‰Œå †
        state.moves++; // å¢åŠ ç§»å‹•æ¬¡æ•¸
        addScore(-100); // é‡æ–°å¾ªç’°å»¢ç‰Œå †æ‰£100åˆ†
        saveStateToHistory(); // å„²å­˜ç‹€æ…‹
        render(); // é‡æ–°æ¸²æŸ“
        updateTimer(); // æ›´æ–°è¨ˆæ™‚å™¨
        updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
    }

    // ==================== è‡ªå‹•ç§»å‹•å‹•ç•«å‡½æ•¸ ====================
    /**
     * åŸ·è¡Œå¡ç‰‡ç§»å‹•å‹•ç•«
     * @param {Array} cards - è¦ç§»å‹•çš„å¡ç‰‡é™£åˆ—
     * @param {Object} sourceRect - ä¾†æºä½ç½®çŸ©å½¢
     * @param {Object} targetRect - ç›®æ¨™ä½ç½®çŸ©å½¢
     * @param {Function} onComplete - å‹•ç•«å®Œæˆå¾Œçš„å›å‘¼å‡½æ•¸
     * @param {string} moveType - ç§»å‹•é¡å‹ ('tableau', 'foundation', 'waste')
     */
    function animateMove(cards, sourceRect, targetRect, onComplete, moveType = 'tableau') {
        isAnimating = true; // æ¨™è¨˜å‹•ç•«é–‹å§‹
        const ghosts = []; // å¹½éˆå¡ç‰‡é™£åˆ—
        
        // åˆ†é–‹æ‰‹æ©Ÿç‰ˆå’Œç¶²é ç‰ˆçš„é‡ç–Šæ¯”ä¾‹
        const isMobile = window.innerWidth < 600;
        const overlapRatio = isMobile ? 0.5 : 0.7; // æ‰‹æ©Ÿç‰ˆ50%ï¼Œç¶²é ç‰ˆ70%
        
        // å»ºç«‹å¹½éˆå¡ç‰‡
        cards.forEach((card, i) => {
            const ghost = document.createElement('div');
            ghost.className = `card flying-card ${card.color}`;
            ghost.style.backgroundColor = 'white'; // ç¢ºä¿èƒŒæ™¯ç‚ºç™½è‰²
            
            // æ·»åŠ data-textå±¬æ€§
            ghost.dataset.text = card.text;
            
            // é‡å°æ•¸å­—10çš„ç‰¹æ®Šè™•ç† - åªåœ¨æ‰‹æ©Ÿç‰ˆæ‡‰ç”¨
            let numHtml = `<div class="card-num ${card.color}">${card.text}</div>`;
            if (card.text === "10" && isMobile) {
                // å¦‚æœæ˜¯10ä¸”æ˜¯æ‰‹æ©Ÿç‰ˆï¼Œæ·»åŠ ç‰¹æ®Šçš„CSSæ¨£å¼
                numHtml = `<div class="card-num ${card.color}" style="font-size: 2.5rem; transform: scaleX(0.75); transform-origin: left top; left: 0.8px;">${card.text}</div>`;
            } else if (card.text === "10") {
                // å¦‚æœæ˜¯10ä¸”æ˜¯æ¡Œé¢ç‰ˆï¼Œä½¿ç”¨æ­£å¸¸æ¨£å¼
                numHtml = `<div class="card-num ${card.color}" style="font-size: 1.8rem;">${card.text}</div>`;
            }
            
            ghost.innerHTML = `
                <div class="card-face">
                    ${numHtml}
                    <div class="card-suit-top ${card.color}">${card.suit}</div>
                    <div class="card-center-suit ${card.color}">${card.suit}</div>
                </div>
            `;
            
            // è¨ˆç®—å †ç–Šåç§»é‡
            const overlapHeight = cardSize.height * overlapRatio;
            const offset = i * (cardSize.height - overlapHeight);

            // è¨­å®šåˆå§‹ä½ç½®
            ghost.style.left = sourceRect.left + 'px';
            ghost.style.top = (sourceRect.top + offset) + 'px';
            ghost.style.width = cardSize.width + 'px';
            ghost.style.height = cardSize.height + 'px';
            
            document.body.appendChild(ghost);
            ghosts.push(ghost);
        });

        // å¼·åˆ¶ç€è¦½å™¨ Reflow ä»¥ç¢ºä¿å‹•ç•«ç™¼ç”Ÿ
        void ghosts[0].offsetWidth;

        // è¨­å®šç›®æ¨™ä½ç½®
        ghosts.forEach((ghost, i) => {
            const overlapHeight = cardSize.height * overlapRatio;
            const offset = i * (cardSize.height - overlapHeight);
            
            ghost.style.left = targetRect.left + 'px';
            ghost.style.top = (targetRect.top + offset) + 'px';
        });

        // æ ¹æ“šç§»å‹•é¡å‹æ’­æ”¾å°æ‡‰éŸ³æ•ˆ
        if (moveType === 'foundation') {
            playFoundationSound();
        } else {
            playMoveSound();
        }

        // å‹•ç•«çµæŸå¾Œæ¸…ç†
        setTimeout(() => {
            ghosts.forEach(g => g.remove()); // ç§»é™¤å¹½éˆå¡ç‰‡
            isAnimating = false; // æ¨™è¨˜å‹•ç•«çµæŸ
            if (onComplete) onComplete(); // åŸ·è¡Œå›å‘¼å‡½æ•¸
            updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
        }, 300); // é…åˆ CSS transition 0.3s
    }

    // ==================== é­”æ³•æŒ‰éˆ•åŠŸèƒ½ ====================
    /**
     * é­”æ³•ç§»å‹•ï¼šéš¨æ©Ÿç¿»é–‹ä¸€å¼µè“‹ç‰Œä¸¦ç§»å‹•åˆ°å»¢ç‰Œå †
     */
    function magicMove() {
        if (isAnimating) return; // å‹•ç•«ä¸­ç¦æ­¢æ“ä½œ
        
        // æ”¶é›†æ‰€æœ‰è“‹è‘—çš„ç‰Œï¼ˆåªæ”¶é›†æ¯åˆ—æœ€ä¸Šé¢ä¸€å¼µè“‹ç‰Œï¼‰
        const facedDownCards = [];
        for (let col = 0; col < 7; col++) {
            const pile = state.tableau[col];
            // æ‰¾åˆ°æ¯åˆ—æœ€ä¸Šé¢ä¸€å¼µè“‹ç‰Œ
            for (let i = pile.length - 1; i >= 0; i--) {
                if (!pile[i].faceUp) {
                    // ç¢ºä¿é€™æ˜¯è©²åˆ—æœ€ä¸Šé¢çš„è“‹ç‰Œï¼ˆä¸Šé¢æ²’æœ‰å…¶ä»–è“‹ç‰Œï¼‰
                    if (i === pile.length - 1 || pile[i+1].faceUp) {
                        facedDownCards.push({
                            card: pile[i],
                            pileIdx: col,
                            cardIdx: i,
                            pile: pile
                        });
                        break; // åªå–æœ€ä¸Šé¢ä¸€å¼µè“‹ç‰Œ
                    }
                }
            }
        }
        
        // å¦‚æœæ²’æœ‰è“‹è‘—çš„ç‰Œï¼Œç¦ç”¨æŒ‰éˆ•ä¸¦è¿”å›
        if (facedDownCards.length === 0) {
            updateMagicButton();
            showMessage("æ²’æœ‰å¯ç¿»é–‹çš„è“‹ç‰Œ", 1500);
            return;
        }
        
        // éš¨æ©Ÿé¸æ“‡ä¸€å¼µè“‹ç‰Œ
        const randomIndex = Math.floor(Math.random() * facedDownCards.length);
        const selected = facedDownCards[randomIndex];
        const { card, pileIdx, cardIdx, pile } = selected;
        
        // å…ˆå¾è¡¨æ ¼ä¸­ç§»é™¤å¡ç‰‡
        pile.splice(cardIdx, 1);
        
        // å¦‚æœè¡¨æ ¼åˆ—é‚„æœ‰ç‰Œï¼Œç¢ºä¿æœ€ä¸Šé¢ä¸€å¼µæ˜¯ç¿»é–‹çš„
        if (state.tableau[pileIdx].length > 0) {
            const newTopCard = state.tableau[pileIdx][state.tableau[pileIdx].length - 1];
            if (!newTopCard.faceUp) {
                newTopCard.faceUp = true;
            }
        }
        
        // ç«‹å³æ¸²æŸ“ä¸€æ¬¡ï¼Œè®“è“‹ç‰Œæ¶ˆå¤±ï¼Œæ–°çš„ç‰Œç¿»é–‹
        render();
        
        isAnimating = true; // æ¨™è¨˜å‹•ç•«é–‹å§‹
        updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
        
        // å–å¾—å»¢ç‰Œå †ä½ç½®
        const wasteSlot = document.getElementById('slot-waste');
        if (!wasteSlot) return;
        
        const wasteRect = wasteSlot.getBoundingClientRect();
        
        // ç²å–é¸ä¸­å¡ç‰‡çš„ä½ç½®ï¼ˆæ³¨æ„ï¼šæ­¤æ™‚å¡ç‰‡å·²ç¶“å¾DOMä¸­ç§»é™¤ï¼Œæˆ‘å€‘éœ€è¦ä¹‹å‰è¨˜éŒ„çš„ä½ç½®ï¼‰
        // æˆ‘å€‘åœ¨æ›´æ–°ç‹€æ…‹å’Œæ¸²æŸ“ä¹‹å‰ï¼Œå…ˆç²å–å¡ç‰‡çš„ä½ç½®
        const cardElement = document.querySelector(`[data-id="${card.id}"]`);
        let sourceRect;
        if (cardElement) {
            sourceRect = cardElement.getBoundingClientRect();
        } else {
            // å¦‚æœå¡ç‰‡å…ƒç´ ä¸å­˜åœ¨ï¼Œå‰‡ä½¿ç”¨è©²åˆ—çš„slotä½ç½®ï¼ˆä¸ç²¾ç¢ºï¼Œä½†ä½œç‚ºå‚™ç”¨ï¼‰
            const slotEl = document.getElementById(`slot-t${pileIdx}`);
            if (slotEl) {
                sourceRect = slotEl.getBoundingClientRect();
            } else {
                // å¦‚æœéƒ½æ²’æœ‰ï¼Œå‰‡ä½¿ç”¨å»¢ç‰Œå †çš„ä½ç½®ï¼ˆé€™æ¨£å‹•ç•«å°±ä¸æœƒç§»å‹•ï¼‰
                sourceRect = wasteRect;
            }
        }
        
        // å‰µå»ºé­”æ³•å‹•ç•«å¡ç‰‡ï¼ˆå¸¶åŠ å¼·ç‰ˆé‡‘å…‰é–ƒé–ƒæ•ˆæœï¼‰
        const magicCard = document.createElement('div');
        magicCard.className = `card magic-animation-card back golden-glow`;
        magicCard.style.left = sourceRect.left + 'px';
        magicCard.style.top = sourceRect.top + 'px';
        magicCard.style.width = sourceRect.width + 'px';
        magicCard.style.height = sourceRect.height + 'px';
        
        // æ·»åŠ data-textå±¬æ€§
        magicCard.dataset.text = card.text;
        
        // ç¢ºä¿èƒŒæ™¯ç‚ºç™½è‰²
        magicCard.style.backgroundColor = 'white';
        
        document.body.appendChild(magicCard);
        
        // å¼·åˆ¶ç€è¦½å™¨ Reflow ä»¥ç¢ºä¿å‹•ç•«ç™¼ç”Ÿ
        void magicCard.offsetWidth;
        
        // è¨ˆç®—ç›®æ¨™ä½ç½®ï¼ˆå»¢ç‰Œå †æœ€å³é‚Šçš„ä½ç½®ï¼‰
        let targetLeft, targetTop;
        if (state.drawMode === 3 && state.waste.length >= 3) {
            // ä¸‰å¼µæ¨¡å¼ï¼Œå·²æœ‰ä¸‰å¼µç‰Œï¼Œæ–°ç‰Œæ”¾åœ¨æœ€å³é‚Š
            targetLeft = wasteRect.left + (2 * (cardSize.width * 0.3));
        } else if (state.drawMode === 3 && state.waste.length < 3) {
            // ä¸‰å¼µæ¨¡å¼ï¼Œç‰Œä¸å¤ ä¸‰å¼µï¼Œæ–°ç‰Œæ”¾åœ¨é©ç•¶ä½ç½®
            targetLeft = wasteRect.left + (state.waste.length * (cardSize.width * 0.3));
        } else {
            // ä¸€å¼µæ¨¡å¼ï¼Œæ–°ç‰Œæ”¾åœ¨å»¢ç‰Œå †ä½ç½®
            targetLeft = wasteRect.left;
        }
        targetTop = wasteRect.top;
        
        // è¨­ç½®å‹•ç•«
        magicCard.style.left = targetLeft + 'px';
        magicCard.style.top = targetTop + 'px';
        
        // å‹•ç•«ä¸­é€”ç¿»é–‹å¡ç‰‡
        setTimeout(() => {
            magicCard.classList.remove('back');
            magicCard.classList.add(card.color);
            
            // é‡å°æ•¸å­—10çš„ç‰¹æ®Šè™•ç† - åªåœ¨æ‰‹æ©Ÿç‰ˆæ‡‰ç”¨
            const isMobile = window.innerWidth < 600;
            let numHtml = `<div class="card-num ${card.color}">${card.text}</div>`;
            if (card.text === "10" && isMobile) {
                // å¦‚æœæ˜¯10ä¸”æ˜¯æ‰‹æ©Ÿç‰ˆï¼Œæ·»åŠ ç‰¹æ®Šçš„CSSæ¨£å¼
                numHtml = `<div class="card-num ${card.color}" style="font-size: 2.5rem; transform: scaleX(0.75); transform-origin: left top; left: 0.8px;">${card.text}</div>`;
            } else if (card.text === "10") {
                // å¦‚æœæ˜¯10ä¸”æ˜¯æ¡Œé¢ç‰ˆï¼Œä½¿ç”¨æ­£å¸¸æ¨£å¼
                numHtml = `<div class="card-num ${card.color}" style="font-size: 1.8rem;">${card.text}</div>`;
            }
            
            magicCard.innerHTML = `
                <div class="card-face">
                    ${numHtml}
                    <div class="card-suit-top ${card.color}">${card.suit}</div>
                    <div class="card-center-suit ${card.color}">${card.suit}</div>
                </div>
            `;
            
            // æ’­æ”¾ç¿»ç‰ŒéŸ³æ•ˆ
            playFlipSound();
        }, 250);
        
        // å‹•ç•«å®Œæˆå¾Œæ›´æ–°éŠæˆ²ç‹€æ…‹ï¼šå°‡ç‰Œæ·»åŠ åˆ°å»¢ç‰Œå †ï¼Œä¸¦æ›´æ–°åˆ†æ•¸ç­‰
        setTimeout(() => {
            // ç§»é™¤å‹•ç•«å¡ç‰‡
            magicCard.remove();
            
            // ç¿»é–‹å¡ç‰‡
            card.faceUp = true;
            
            // æ·»åŠ åˆ°å»¢ç‰Œå †ï¼ˆæœ€ä¸Šé¢ï¼‰
            state.waste.push(card);
            
            // æ›´æ–°éŠæˆ²ç‹€æ…‹
            state.moves++; // å¢åŠ ç§»å‹•æ¬¡æ•¸
            addScore(-20); // ä½¿ç”¨é­”æ³•æ‰£20åˆ†
            
            saveStateToHistory(); // å„²å­˜ç‹€æ…‹
            render(); // é‡æ–°æ¸²æŸ“ï¼Œè®“å»¢ç‰Œå †é¡¯ç¤ºé€™å¼µç‰Œ
            updateTimer(); // æ›´æ–°è¨ˆæ™‚å™¨
            
            isAnimating = false; // æ¨™è¨˜å‹•ç•«çµæŸ
            updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
            
            showMessage(`é­”æ³•ç™¼å‹•ï¼ç¿»é–‹äº†${card.text}${card.suit}`, 1500);
        }, 500);
    }
    
    // ==================== é›™æ“Šè‡ªå‹•ç§»å‹•é‚è¼¯ ====================
    /**
     * è™•ç†é›™æ“Šäº‹ä»¶
     * @param {string} type - å¡ç‰‡é¡å‹
     * @param {number} pileIdx - å †ç–Šç´¢å¼•
     * @param {number} cardIdx - å¡ç‰‡ç´¢å¼•
     * @param {string} cardId - å¡ç‰‡ID
     */
    function handleDoubleClick(type, pileIdx, cardIdx, cardId) {
        if (type === 'foundation') return; // èŠ±è‰²å€çš„ç‰Œä¸èƒ½é›™æ“Šç§»å‹•
        if (isAnimating) return; // å‹•ç•«ä¸­ç¦æ­¢æ“ä½œ
        
        let sourcePile;
        let card;
        let cardsToMove = [];
        
        // æ ¹æ“šå¡ç‰‡é¡å‹å–å¾—ä¾†æºå †ç–Šå’Œå¡ç‰‡
        if (type === 'tableau') {
            sourcePile = state.tableau[pileIdx];
            if (cardIdx < 0 || cardIdx >= sourcePile.length) return;
            card = sourcePile[cardIdx];
            
            if (!card.faceUp) return; // èƒŒé¢æœä¸Šçš„ç‰Œä¸èƒ½ç§»å‹•
            
            // æª¢æŸ¥å¡ç‰‡ä¸Šæ–¹æ˜¯å¦æœ‰æœªç¿»é–‹çš„ç‰Œ
            for (let i = cardIdx + 1; i < sourcePile.length; i++) {
                if (!sourcePile[i].faceUp) {
                    shakeCard(cardId); // éœ‡å‹•æç¤º
                    return;
                }
            }
            
            // å–å¾—è¦ç§»å‹•çš„æ‰€æœ‰ç‰Œï¼ˆå¾é»æ“Šçš„ç‰Œåˆ°æœ€å¾Œä¸€å¼µï¼‰
            cardsToMove = sourcePile.slice(cardIdx);
        } else if (type === 'waste') {
            sourcePile = state.waste;
            if (cardIdx !== sourcePile.length - 1) return; // åªèƒ½ç§»å‹•æœ€ä¸Šé¢çš„ç‰Œ
            card = sourcePile[cardIdx];
            cardsToMove = [card];
        } else {
            return;
        }

        // å–å¾—ä¾†æºä½ç½® (ç”¨æ–¼å‹•ç•«)
        const cardEl = document.querySelector(`[data-id="${cardId}"]`);
        if (!cardEl) return;
        const sourceRect = cardEl.getBoundingClientRect();
        
        // 1. å˜—è©¦ç§»å‹•åˆ°èŠ±è‰²å€
        for (let i = 0; i < 4; i++) {
            const foundation = state.foundations[i];
            if (canMoveToFoundation(card, foundation)) {
                // èŠ±è‰²å€åªèƒ½ç§»å‹•æœ€ä¸Šé¢çš„å–®å¼µç‰Œ
                if (cardsToMove.length > 1) {
                    shakeCard(cardId); // ä¸èƒ½ç§»å‹•å¤šå¼µç‰Œåˆ°èŠ±è‰²å€
                    return;
                }
                
                // å¾åŸå§‹ä½ç½®ç§»é™¤ç‰Œ
                if (type === 'tableau') {
                    state.tableau[pileIdx].splice(cardIdx, 1);
                    // å¦‚æœé‚„æœ‰ç‰Œï¼Œç¿»é–‹æœ€ä¸Šé¢ä¸€å¼µ
                    if (state.tableau[pileIdx].length > 0) {
                        state.tableau[pileIdx][state.tableau[pileIdx].length - 1].faceUp = true;
                    }
                } else if (type === 'waste') {
                    state.waste.pop();
                }
                
                // ç«‹å³é‡æ–°æ¸²æŸ“ä»¥ç§»é™¤åŸå§‹ä½ç½®çš„ç‰Œ
                render();
                
                // å–å¾—ç›®æ¨™ä½ç½®
                const targetEl = document.getElementById(`slot-f${i}`);
                const targetRect = targetEl.getBoundingClientRect();
                
                // æ’­æ”¾å‹•ç•«
                animateMove(cardsToMove, sourceRect, targetRect, () => {
                    // å‹•ç•«çµæŸå¾Œå°‡ç‰Œæ·»åŠ åˆ°ç›®æ¨™ä½ç½®
                    state.foundations[i].push(...cardsToMove);
                    
                    state.moves++;
                    // æ ¹æ“šç§»å‹•é¡å‹åŠ åˆ†
                    if (type === 'waste') {
                        addScore(10); // å¾å»¢ç‰Œå †ç§»å‹•åˆ°èŠ±è‰²å€å¾—10åˆ†
                    } else {
                        addScore(10); // å¾è¡¨æ ¼åˆ—ç§»å‹•åˆ°èŠ±è‰²å€å¾—10åˆ†
                    }
                    saveStateToHistory();
                    render(); // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºç›®æ¨™ä½ç½®çš„ç‰Œ
                    updateTimer();
                    updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
                    checkWin(); // æª¢æŸ¥æ˜¯å¦ç²å‹
                }, 'foundation');
                return; 
            }
        }
        
        // 2. å˜—è©¦ç§»å‹•åˆ°è¡¨æ ¼
        for (let targetIdx = 0; targetIdx < 7; targetIdx++) {
            if (type === 'tableau' && targetIdx === pileIdx) continue;
            const targetPile = state.tableau[targetIdx];
            
            if (card.rank === 13 && targetPile.length === 0 && type === 'tableau' && cardIdx === 0) continue; 

            if (canMoveToTableau(card, targetPile)) {
                // å¾åŸå§‹ä½ç½®ç§»é™¤ç‰Œ
                if (type === 'tableau') {
                    state.tableau[pileIdx].splice(cardIdx, cardsToMove.length);
                    // å¦‚æœé‚„æœ‰ç‰Œï¼Œç¿»é–‹æœ€ä¸Šé¢ä¸€å¼µ
                    if (state.tableau[pileIdx].length > 0) {
                        state.tableau[pileIdx][state.tableau[pileIdx].length - 1].faceUp = true;
                    }
                } else if (type === 'waste') {
                    state.waste.pop();
                }
                
                // ç«‹å³é‡æ–°æ¸²æŸ“ä»¥ç§»é™¤åŸå§‹ä½ç½®çš„ç‰Œ
                render();
                
                // å–å¾—ç›®æ¨™ä½ç½®
                let targetRect;
                if (targetPile.length > 0) {
                    const topCardId = targetPile[targetPile.length-1].id;
                    const topCardEl = document.querySelector(`[data-id="${topCardId}"]`);
                    const rect = topCardEl.getBoundingClientRect();
                    targetRect = { 
                        left: rect.left, 
                        top: rect.top + (cardSize.height * (window.innerWidth < 600 ? 0.5 : 0.3)) // ä½¿ç”¨æ­£ç¢ºçš„é‡ç–Šæ¯”ä¾‹
                    };
                } else {
                    const slotEl = document.getElementById(`slot-t${targetIdx}`);
                    targetRect = slotEl.getBoundingClientRect();
                }

                // æ’­æ”¾å‹•ç•«
                animateMove(cardsToMove, sourceRect, targetRect, () => {
                    // å‹•ç•«çµæŸå¾Œå°‡ç‰Œæ·»åŠ åˆ°ç›®æ¨™ä½ç½®
                    state.tableau[targetIdx].push(...cardsToMove);
                    
                    state.moves++;
                    // æ ¹æ“šç§»å‹•é¡å‹åŠ åˆ†
                    if (type === 'waste') {
                        addScore(5); // å¾å»¢ç‰Œå †ç§»å‹•åˆ°è¡¨æ ¼åˆ—å¾—5åˆ†
                    } else {
                        addScore(5 * cardsToMove.length); // å¾è¡¨æ ¼åˆ—ç§»å‹•åˆ°è¡¨æ ¼åˆ—ï¼Œæ¯å¼µç‰Œå¾—5åˆ†
                    }
                    saveStateToHistory();
                    render(); // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºç›®æ¨™ä½ç½®çš„ç‰Œ
                    updateTimer();
                    updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
                    checkWin(); // æª¢æŸ¥æ˜¯å¦ç²å‹
                }, 'tableau');
                return;
            }
        }
        
        // 3. å¤±æ•—å‰‡éœ‡å‹•
        shakeCard(cardId);
    }
    
    /**
     * éœ‡å‹•å¡ç‰‡æ•ˆæœ
     * @param {string} cardId - å¡ç‰‡ID
     */
    function shakeCard(cardId) {
        const cardElement = document.querySelector(`[data-id="${cardId}"]`);
        if (cardElement) {
            cardElement.classList.remove('shake');
            void cardElement.offsetWidth; // å¼·åˆ¶é‡ç¹ª
            cardElement.classList.add('shake');
            // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
            playErrorSound();
            setTimeout(() => { cardElement.classList.remove('shake'); }, 400);
        }
    }

    // ==================== æ‹–æ›³ç³»çµ±å‡½æ•¸ ====================
    /**
     * é–‹å§‹æ‹–æ›³
     * @param {Event} e - äº‹ä»¶ç‰©ä»¶
     * @param {string} type - å¡ç‰‡é¡å‹
     * @param {number} pileIdx - å †ç–Šç´¢å¼•
     * @param {number} cardIdx - å¡ç‰‡ç´¢å¼•
     */
    function startDrag(e, type, pileIdx, cardIdx) {
        if (isAnimating) return; // å‹•ç•«ä¸­ç¦æ­¢æ‹–æ›³
        e.stopPropagation(); // åœæ­¢äº‹ä»¶å†’æ³¡
        
        const now = Date.now(); // ç•¶å‰æ™‚é–“
        
        // æ ¹æ“šé¡å‹å–å¾—ä¾†æºå †ç–Šå’Œå¡ç‰‡
        let sourcePile = (type === 'tableau') ? state.tableau[pileIdx] : (type === 'waste' ? state.waste : []);
        if (type === 'foundation') sourcePile = state.foundations[pileIdx];
        const clickedCard = sourcePile[cardIdx];
        if (!clickedCard) return;

        // é›™æ“Šæª¢æ¸¬
        if (clickedCard.id === lastClickCardId && now - lastClickTime < 350) {
            handleDoubleClick(type, pileIdx, cardIdx, clickedCard.id);
            lastClickCardId = null;
            lastClickTime = 0;
            return;
        }
        
        lastClickCardId = clickedCard.id;
        lastClickTime = now;

        if (drag.isDragging || drag.pending) return; // å·²åœ¨æ‹–æ›³ä¸­

        if (!clickedCard.faceUp) return; // èƒŒé¢æœä¸Šçš„ç‰Œä¸èƒ½æ‹–æ›³
        
        // åœ¨ä¸‰å¼µæ¨¡å¼ä¸‹ï¼Œå»¢ç‰Œå †åªèƒ½æ‹–æ›³æœ€ä¸Šé¢çš„ç‰Œ
        if (type === 'waste' && cardIdx !== sourcePile.length - 1) return;
        
        if ((type === 'waste' || type === 'foundation') && cardIdx !== sourcePile.length - 1) return; // åªèƒ½æ‹–æ›³æœ€ä¸Šé¢çš„ç‰Œ
        
        drag.pending = true; // æ¨™è¨˜ç‚ºç­‰å¾…æ‹–æ›³
        drag.isDragging = false;
        
        // å–å¾—è§¸æ§/æ»‘é¼ åº§æ¨™
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        
        drag.startX = clientX;
        drag.startY = clientY;
        drag.origin = { type, pileIdx, cardIdx };
        
        // è¨­å®šè¦æ‹–æ›³çš„å¡ç‰‡
        drag.cards = [];
        if (type === 'tableau') {
            // è¡¨æ ¼ä¸­æ‹–æ›³å¾é»æ“Šä½ç½®åˆ°æœ€ä¸‹é¢çš„æ‰€æœ‰ç‰Œ
            for (let i = cardIdx; i < sourcePile.length; i++) {
                drag.cards.push(sourcePile[i]);
            }
        } else {
            // å»¢ç‰Œå †å’ŒèŠ±è‰²å€åªèƒ½æ‹–æ›³ä¸€å¼µç‰Œ
            drag.cards.push(clickedCard);
        }

        // å–å¾—éŠæˆ²å€åŸŸé‚Šç•Œ
        const gameBoard = document.getElementById('game-board');
        drag.gameBoardRect = gameBoard.getBoundingClientRect();
        
        // è¨ˆç®—åç§»é‡
        const cardEl = document.querySelector(`[data-id="${clickedCard.id}"]`);
        if (cardEl) {
            const rect = cardEl.getBoundingClientRect();
            drag.offset.x = clientX - rect.left;
            drag.offset.y = clientY - rect.top;
        }

        // æ·»åŠ äº‹ä»¶ç›£è½å™¨
        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('mouseup', onDragEnd);
        document.addEventListener('touchmove', onDragMove, { passive: false });
        document.addEventListener('touchend', onDragEnd);
    }

    /**
     * å»ºç«‹æ‹–æ›³æ™‚çš„å¹½éˆå¡ç‰‡
     */
    function createGhosts() {
        if (!drag.cards.length) return;
        
        const startCardEl = document.querySelector(`[data-id="${drag.cards[0].id}"]`);
        if (!startCardEl) return;
        const rect = startCardEl.getBoundingClientRect();

        // ç‚ºæ¯å¼µæ‹–æ›³ä¸­çš„å¡ç‰‡å»ºç«‹å¹½éˆå¡ç‰‡
        drag.cards.forEach((card, i) => {
            const ghost = document.createElement('div');
            ghost.className = `card dragging-card ${card.color}`;
            ghost.style.backgroundColor = 'white'; // ç¢ºä¿èƒŒæ™¯ç‚ºç™½è‰²
            
            // æ·»åŠ data-textå±¬æ€§
            ghost.dataset.text = card.text;
            
            // é‡å°æ•¸å­—10çš„ç‰¹æ®Šè™•ç† - åªåœ¨æ‰‹æ©Ÿç‰ˆæ‡‰ç”¨
            const isMobile = window.innerWidth < 600;
            let numHtml = `<div class="card-num ${card.color}">${card.text}</div>`;
            if (card.text === "10" && isMobile) {
                // å¦‚æœæ˜¯10ä¸”æ˜¯æ‰‹æ©Ÿç‰ˆï¼Œæ·»åŠ ç‰¹æ®Šçš„CSSæ¨£å¼
                numHtml = `<div class="card-num ${card.color}" style="font-size: 2.5rem; transform: scaleX(0.75); transform-origin: left top; left: 0.8px;">${card.text}</div>`;
            } else if (card.text === "10") {
                // å¦‚æœæ˜¯10ä¸”æ˜¯æ¡Œé¢ç‰ˆï¼Œä½¿ç”¨æ­£å¸¸æ¨£å¼
                numHtml = `<div class="card-num ${card.color}" style="font-size: 1.8rem;">${card.text}</div>`;
            }
            
            ghost.innerHTML = `
                <div class="card-face">
                    ${numHtml}
                    <div class="card-suit-top ${card.color}">${card.suit}</div>
                    <div class="card-center-suit ${card.color}">${card.suit}</div>
                </div>
            `;
            
            // åˆ†é–‹æ‰‹æ©Ÿç‰ˆå’Œç¶²é ç‰ˆçš„é‡ç–Šæ¯”ä¾‹
            const overlapRatio = isMobile ? 0.5 : 0.7; // æ‰‹æ©Ÿç‰ˆ50%ï¼Œç¶²é ç‰ˆ70%
            const overlapHeight = cardSize.height * overlapRatio;
            const ghostOffset = i * (cardSize.height - overlapHeight);
            
            // è¨­å®šåˆå§‹ä½ç½®
            ghost.style.left = rect.left + 'px';
            ghost.style.top = (rect.top + ghostOffset) + 'px';
            ghost.style.width = rect.width + 'px';
            ghost.style.height = rect.height + 'px';
            
            document.body.appendChild(ghost);
            drag.elGhosts.push(ghost);
        });

        // å°‡åŸå§‹å¡ç‰‡è¨­ç‚ºåŠé€æ˜
        drag.cards.forEach(card => {
            const el = document.querySelector(`[data-id="${card.id}"]`);
            if (el) el.style.opacity = '0.3';
        });
    }

    /**
     * æ‹–æ›³ç§»å‹•è™•ç†å‡½æ•¸
     * @param {Event} e - äº‹ä»¶ç‰©ä»¶
     */
    function onDragMove(e) {
        if (!drag.pending && !drag.isDragging) return;
        
        // å–å¾—è§¸æ§/æ»‘é¼ åº§æ¨™
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        
        // æª¢æŸ¥æ˜¯å¦çœŸæ­£é–‹å§‹æ‹–æ›³ï¼ˆç§»å‹•è·é›¢è¶…é5pxï¼‰
        if (drag.pending) {
            const moveX = Math.abs(clientX - drag.startX);
            const moveY = Math.abs(clientY - drag.startY);
            
            if (moveX > 5 || moveY > 5) {
                drag.pending = false;
                drag.isDragging = true;
                createGhosts(); // å»ºç«‹å¹½éˆå¡ç‰‡
            } else {
                return;
            }
        }
        
        // æ›´æ–°å¹½éˆå¡ç‰‡ä½ç½®
        if (drag.isDragging) {
            if (e.cancelable) e.preventDefault(); // é˜²æ­¢é è¨­è¡Œç‚º
            
            drag.elGhosts.forEach((el, i) => {
                // åˆ†é–‹æ‰‹æ©Ÿç‰ˆå’Œç¶²é ç‰ˆçš„é‡ç–Šæ¯”ä¾‹
                const isMobile = window.innerWidth < 600;
                const overlapRatio = isMobile ? 0.5 : 0.7; // æ‰‹æ©Ÿç‰ˆ50%ï¼Œç¶²é ç‰ˆ70%
                const overlapHeight = cardSize.height * overlapRatio;
                const ghostOffset = i * (cardSize.height - overlapHeight);
                
                el.style.left = (clientX - drag.offset.x) + 'px';
                el.style.top = (clientY - drag.offset.y + ghostOffset) + 'px';
            });
        }
    }

    /**
     * æ‹–æ›³çµæŸè™•ç†å‡½æ•¸
     * @param {Event} e - äº‹ä»¶ç‰©ä»¶
     */
    function onDragEnd(e) {
        // ç§»é™¤äº‹ä»¶ç›£è½å™¨
        document.removeEventListener('mousemove', onDragMove);
        document.removeEventListener('mouseup', onDragEnd);
        document.removeEventListener('touchmove', onDragMove);
        document.removeEventListener('touchend', onDragEnd);

        // è™•ç†ç­‰å¾…æ‹–æ›³ç‹€æ…‹
        if (drag.pending) {
            drag.pending = false;
            return;
        }

        if (!drag.isDragging) return; // æœªåœ¨æ‹–æ›³ä¸­

        // å–å¾—å¹½éˆå¡ç‰‡ä½ç½®
        const headGhost = drag.elGhosts[0];
        const ghostRect = headGhost.getBoundingClientRect();
        
        // è¨ˆç®—ç›¸å°éŠæˆ²å€åŸŸçš„ä½ç½®
        const ghostLeftRelative = ghostRect.left - drag.gameBoardRect.left;
        const ghostTopRelative = ghostRect.top - drag.gameBoardRect.top;
        const ghostCenterX = ghostLeftRelative + ghostRect.width / 2;
        const ghostCenterY = ghostTopRelative + ghostRect.height / 2;

        let target = null; // ç›®æ¨™ä½ç½®
        
        // æª¢æŸ¥æ˜¯å¦æ‹–æ›³åˆ°èŠ±è‰²å€
        for (let i = 0; i < 4; i++) {
            const s = slotPositions[`slot-f${i}`];
            if (!s) continue;
            if (ghostCenterX >= s.left && ghostCenterX <= s.right && 
                ghostCenterY >= s.top && ghostCenterY <= s.bottom + 50) {
                target = { type: 'foundation', idx: i };
                break;
            }
        }
        
        // æª¢æŸ¥æ˜¯å¦æ‹–æ›³åˆ°è¡¨æ ¼
        if (!target) {
            for (let i = 0; i < 7; i++) {
                const s = slotPositions[`slot-t${i}`];
                if (!s) continue;
                if (ghostCenterX >= s.left - 30 && ghostCenterX <= s.right + 30 && 
                    ghostCenterY >= s.top - 50) {
                    target = { type: 'tableau', idx: i };
                    break;
                }
            }
        }

        // å˜—è©¦ç§»å‹•å¡ç‰‡
        let success = false;
        if (target) {
            success = tryMove(drag.cards, drag.origin, target);
        }

        // æ¸…ç†å¹½éˆå¡ç‰‡
        drag.elGhosts.forEach(el => el.remove());
        drag.elGhosts = [];
        drag.isDragging = false;
        
        // æ¢å¾©åŸå§‹å¡ç‰‡é€æ˜åº¦
        drag.cards.forEach(card => {
            const el = document.querySelector(`[data-id="${card.id}"]`);
            if (el) el.style.opacity = '1';
        });

        // æ ¹æ“šç§»å‹•çµæœæ›´æ–°éŠæˆ²
        if (success) {
            state.moves++;
            saveStateToHistory();
            render();
            updateTimer();
            updateMagicButton(); // æ›´æ–°é­”æ³•æŒ‰éˆ•ç‹€æ…‹
            checkWin(); // æª¢æŸ¥æ˜¯å¦ç²å‹
        } else {
            render(); // ç§»å‹•å¤±æ•—ï¼Œé‡æ–°æ¸²æŸ“æ¢å¾©åŸç‹€
        }
    }

    /**
     * å˜—è©¦ç§»å‹•å¡ç‰‡
     * @param {Array} cards - è¦ç§»å‹•çš„å¡ç‰‡é™£åˆ—
     * @param {Object} source - ä¾†æºè³‡è¨Š
     * @param {Object} target - ç›®æ¨™è³‡è¨Š
     * @returns {boolean} - ç§»å‹•æ˜¯å¦æˆåŠŸ
     */
    function tryMove(cards, source, target) {
        if (!cards || cards.length === 0) return false;
        const moveCard = cards[0]; // ç§»å‹•çš„ç¬¬ä¸€å¼µå¡ç‰‡
        
        // ç§»å‹•åˆ°èŠ±è‰²å€
        if (target.type === 'foundation') {
            if (cards.length > 1) return false; // èŠ±è‰²å€åªèƒ½ç§»å‹•ä¸€å¼µç‰Œ
            const foundation = state.foundations[target.idx];
            if (foundation.length === 0) {
                if (moveCard.rank !== 1) return false; // ç©ºçš„èŠ±è‰²å€åªèƒ½æ”¾Ace
            } else {
                const topCard = foundation[foundation.length - 1];
                if (moveCard.suit !== topCard.suit || moveCard.rank !== topCard.rank + 1) return false; // å¿…é ˆåŒèŠ±è‰²ä¸”é€£çºŒ
            }
            performMove(source, target, cards); // åŸ·è¡Œç§»å‹•
            return true;
        }
        
        // ç§»å‹•åˆ°è¡¨æ ¼
        if (target.type === 'tableau') {
            if (source.type === 'tableau' && source.pileIdx === target.idx) return false; // ä¸èƒ½ç§»å‹•åˆ°åŒä¸€åˆ—
            const tableau = state.tableau[target.idx];
            if (tableau.length === 0) {
                if (moveCard.rank !== 13) return false; // ç©ºçš„è¡¨æ ¼åˆ—åªèƒ½æ”¾King
            } else {
                const topCard = tableau[tableau.length - 1];
                if (moveCard.color === topCard.color || moveCard.rank !== topCard.rank - 1) return false; // å¿…é ˆä¸åŒé¡è‰²ä¸”é€£çºŒ
            }
            performMove(source, target, cards); // åŸ·è¡Œç§»å‹•
            return true;
        }
        return false;
    }

    /**
     * åŸ·è¡Œç§»å‹•æ“ä½œ
     * @param {Object} source - ä¾†æºè³‡è¨Š
     * @param {Object} target - ç›®æ¨™è³‡è¨Š
     * @param {Array} cards - è¦ç§»å‹•çš„å¡ç‰‡é™£åˆ—
     */
    function performMove(source, target, cards) {
        // å¾ä¾†æºç§»é™¤å¡ç‰‡
        if (source.type === 'waste') {
            state.waste.splice(source.cardIdx, 1);
        } else if (source.type === 'tableau') {
            state.tableau[source.pileIdx].splice(source.cardIdx, cards.length);
            if (state.tableau[source.pileIdx].length > 0) {
                state.tableau[source.pileIdx][state.tableau[source.pileIdx].length - 1].faceUp = true; // ç¿»é–‹ä¸‹ä¸€å¼µç‰Œ
            }
        } else if (source.type === 'foundation') {
            state.foundations[source.pileIdx].splice(source.cardIdx, 1);
        }
        
        // æ·»åŠ åˆ°ç›®æ¨™
        if (target.type === 'foundation') {
            state.foundations[target.idx].push(...cards);
            // æ ¹æ“šä¾†æºåŠ åˆ†
            if (source.type === 'waste') {
                addScore(10); // å¾å»¢ç‰Œå †ç§»å‹•åˆ°èŠ±è‰²å€å¾—10åˆ†
            } else if (source.type === 'tableau') {
                addScore(10); // å¾è¡¨æ ¼åˆ—ç§»å‹•åˆ°èŠ±è‰²å€å¾—10åˆ†
            }
            // æ’­æ”¾æ”¾ç½®å€éŸ³æ•ˆ
            playFoundationSound();
        } else if (target.type === 'tableau') {
            state.tableau[target.idx].push(...cards);
            // æ ¹æ“šä¾†æºåŠ åˆ†
            if (source.type === 'waste') {
                addScore(5); // å¾å»¢ç‰Œå †ç§»å‹•åˆ°è¡¨æ ¼åˆ—å¾—5åˆ†
            } else if (source.type === 'tableau') {
                addScore(5 * cards.length); // å¾è¡¨æ ¼åˆ—ç§»å‹•åˆ°è¡¨æ ¼åˆ—ï¼Œæ¯å¼µç‰Œå¾—5åˆ†
            }
            // æ’­æ”¾ç§»å‹•éŸ³æ•ˆ
            playMoveSound();
        }
    }

    // ==================== éŠæˆ²çµæŸæª¢æŸ¥ ====================
    /**
     * æª¢æŸ¥æ˜¯å¦ç²å‹
     */
    function checkWin() {
        let totalCards = 0;
        state.foundations.forEach(pile => totalCards += pile.length); // è¨ˆç®—èŠ±è‰²å€ç¸½ç‰Œæ•¸
        if (totalCards === 52) { // æ‰€æœ‰ç‰Œéƒ½åœ¨èŠ±è‰²å€
            stopTimer(); // åœæ­¢è¨ˆæ™‚å™¨
            setTimeout(() => {
                showVictoryDialog(); // é¡¯ç¤ºå‹åˆ©ç•«é¢
            }, 500);
        }
    }

    // ==================== é é¢è¼‰å…¥å’Œäº‹ä»¶ç›£è½ ====================
    window.addEventListener('load', () => {
        // åˆå§‹åŒ–éŸ³æ•ˆç³»çµ±
        initAudio();
        
        // åˆå§‹åŒ–ç…™èŠ±æ•ˆæœ
        initFireworks();
        
        // å¾æœ¬åœ°å„²å­˜è¼‰å…¥è¨­å®š
        loadSettingsFromLocalStorage();
        
        // åˆå§‹åŒ–éŠæˆ²
        initGame('guaranteed'); // åˆå§‹åŒ–éŠæˆ²
        
        // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–
        window.addEventListener('resize', layoutSlots);
        
        // æ·»åŠ åˆ†æ•¸æ¡†é»æ“Šäº‹ä»¶ç›£è½å™¨ï¼ˆæ¸¬è©¦åŠŸèƒ½ï¼‰
        document.getElementById('score-display').addEventListener('click', handleScoreClick);
    });
    
    // é˜²æ­¢æ‰‹æ©Ÿé›™æŒ‡ç¸®æ”¾
    document.addEventListener('gesturestart', function (e) {
        e.preventDefault();
    });
</script>
</body>
</html>